{"version":3,"sources":["components/MessageInput/index.js"],"names":["UIHeightOffset","MessageInput","props","context","onChange","e","_lastValueChange","Date","now","value","currentTarget","newHeight","calculateNewHeight","state","height","onHeightChange","setState","updateMessageText","fn","onKeyDown","key","shiftKey","preventDefault","onSend","flush","disabled","attachments","onAttachmentIconClick","_fileInputRef","current","click","onSelectAttachment","files","length","addAttachment","file","name","endsWith","type","File","size","minHeight","React","createRef","nextProps","inputExpandable","textArea","style","scrollHeight","maxHeight","currentLocale","maxLength","supportAttachment","removeAttachment","inputHeight","styles","root","attachmentIcon","attachmentSvg","display","textField","target","i18n","getString","submitField","sendButton","map","attachment","attachmentItem","attachmentRemoveIcon","removeSvg","Component","propTypes","PropTypes","string","isRequired","bool","number","func","array","defaultProps","undefined"],"mappings":"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","sourcesContent":["import PropTypes from 'prop-types';\nimport classnames from 'classnames';\nimport React, { Component } from 'react';\nimport attachmentSvg from '@ringcentral/juno/icon/Attachment';\nimport removeSvg from '@ringcentral/juno/icon/Close';\nimport { RcIconButton } from '@ringcentral/juno';\nimport { debounce } from 'ringcentral-integration/lib/debounce-throttle/debounce';\n\nimport i18n from './i18n';\nimport styles from './styles.scss';\n\nconst UIHeightOffset = 23;\n// the extra height of the entire field with paddings and borders\n\nexport default class MessageInput extends Component {\n  static propTypes = {\n    value: PropTypes.string.isRequired,\n    currentLocale: PropTypes.string.isRequired,\n    disabled: PropTypes.bool,\n    minHeight: PropTypes.number,\n    maxHeight: PropTypes.number,\n    maxLength: PropTypes.number,\n    onSend: PropTypes.func,\n    onChange: PropTypes.func,\n    onHeightChange: PropTypes.func,\n    inputExpandable: PropTypes.bool,\n    supportAttachment: PropTypes.bool,\n    attachments: PropTypes.array,\n    addAttachment: PropTypes.func,\n    removeAttachment: PropTypes.func,\n  };\n\n  static defaultProps = {\n    disabled: false,\n    onSend: undefined,\n    onChange: undefined,\n    onHeightChange: undefined,\n    minHeight: 63,\n    maxHeight: 300,\n    maxLength: 5000,\n    inputExpandable: true,\n    supportAttachment: false,\n    attachments: [],\n    addAttachment: undefined,\n    removeAttachment: undefined,\n  };\n\n  constructor(props, context) {\n    super(props, context);\n    this.state = {\n      value: props.value,\n      height: props.minHeight,\n    };\n    this._lastValueChange = 0;\n    this._fileInputRef = React.createRef();\n  }\n\n  componentWillReceiveProps(nextProps) {\n    if (\n      nextProps.value !== this.state.value &&\n      // ignore value changes from props for 300ms after typing\n      // this is to prevent unnecessary value changes when used in chrome extension\n      // where value pushed back to background and back takes longer\n      Date.now() - this._lastValueChange > 300\n    ) {\n      // use setState(updater, callback) to recaculate height after value has been update to DOM\n      this.setState(\n        () => ({\n          value: nextProps.value,\n        }),\n        () => {\n          const newHeight = this.calculateNewHeight();\n          if (newHeight !== this.state.height) {\n            if (typeof this.props.onHeightChange === 'function') {\n              this.props.onHeightChange(newHeight);\n            }\n            this.setState({\n              height: newHeight,\n            });\n          }\n        },\n      );\n    }\n  }\n\n  componentDidMount() {\n    // do a initial size check in case the component is mounted with multi line value\n    const newHeight = this.calculateNewHeight();\n    if (newHeight !== this.state.height) {\n      if (typeof this.props.onHeightChange === 'function') {\n        this.props.onHeightChange(newHeight);\n      }\n      this.setState({\n        height: newHeight,\n      });\n    }\n  }\n\n  calculateNewHeight() {\n    if (!this.props.inputExpandable) {\n      return this.props.minHeight;\n    }\n    // temperarily set height to 0 to check scrollHeight\n    this.textArea.style.height = 0;\n    const newHeight = this.textArea.scrollHeight + 10 + UIHeightOffset;\n    // set height back to original to avoid messing with react\n    this.textArea.style.height = `${this.state.height - UIHeightOffset}px`;\n    const { minHeight, maxHeight } = this.props;\n    if (newHeight < minHeight) {\n      return minHeight;\n    }\n    if (newHeight > maxHeight) {\n      return maxHeight;\n    }\n    return newHeight;\n  }\n\n  onChange = (e) => {\n    this._lastValueChange = Date.now();\n    const {\n      currentTarget: { value },\n    } = e;\n    const newHeight = this.calculateNewHeight();\n    if (\n      newHeight !== this.state.height &&\n      typeof this.props.onHeightChange === 'function'\n    ) {\n      this.props.onHeightChange(newHeight);\n    }\n    this.setState({\n      value,\n      height: newHeight,\n    });\n    // ues debounce for avoiding frequent updates compose text module state\n    this.updateMessageText?.();\n  };\n\n  updateMessageText =\n    typeof this.props.onChange === 'function'\n      ? debounce({\n          fn: () => this.props.onChange(this.state.value),\n        })\n      : null;\n\n  onKeyDown = (e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      this.onSend();\n    }\n  };\n\n  onSend = () => {\n    this.updateMessageText?.flush();\n    if (!this.props.disabled && typeof this.props.onSend === 'function') {\n      this.props.onSend(this.state.value, this.props.attachments);\n    }\n  };\n\n  onAttachmentIconClick = () => {\n    this._fileInputRef.current.click();\n  };\n\n  onSelectAttachment = ({ currentTarget }) => {\n    if (currentTarget.files.length === 0) {\n      return;\n    }\n    const { addAttachment } = this.props;\n    let file = currentTarget.files[0];\n    if (\n      (file.name.endsWith('.vcard') || file.name.endsWith('.vcf')) &&\n      file.type !== 'text/vcard'\n    ) {\n      file = new File([file], file.name, { type: 'text/vcard' });\n    }\n    addAttachment({\n      name: file.name,\n      size: file.size,\n      file,\n    });\n  };\n\n  render() {\n    const {\n      currentLocale,\n      disabled,\n      maxLength,\n      supportAttachment,\n      attachments,\n      removeAttachment,\n    } = this.props;\n    const { value, height } = this.state;\n    const inputHeight = height - UIHeightOffset;\n    return (\n      <div\n        className={classnames(\n          styles.root,\n          supportAttachment && styles.supportAttachment,\n        )}\n      >\n        <div className={styles.attachmentIcon}>\n          <RcIconButton\n            variant=\"round\"\n            size=\"small\"\n            symbol={attachmentSvg}\n            onClick={this.onAttachmentIconClick}\n          />\n          <input\n            type=\"file\"\n            accept=\"image/tiff,image/gif,image/jpeg,image/bmp,image/png,image/svg+xml,text/vcard,application/rtf,video/mpeg,audio/mpeg,video/mp4,application/zip\"\n            style={{ display: 'none' }}\n            ref={this._fileInputRef}\n            onChange={this.onSelectAttachment}\n          />\n        </div>\n        <div className={styles.textField}>\n          <textarea\n            data-sign=\"messageInput\"\n            ref={(target) => {\n              this.textArea = target;\n            }}\n            placeholder={i18n.getString('typeMessage', currentLocale)}\n            value={value}\n            maxLength={maxLength}\n            onChange={this.onChange}\n            onKeyPressCapture={this.onKeyDown}\n            style={{\n              height: inputHeight,\n            }}\n          />\n        </div>\n        <div className={styles.submitField}>\n          <input\n            data-sign=\"messageButton\"\n            type=\"button\"\n            value={i18n.getString('send', currentLocale)}\n            onClick={this.onSend}\n            className={styles.sendButton}\n            disabled={disabled}\n          />\n        </div>\n        <div className={styles.attachments}>\n          {attachments.map((attachment) => {\n            return (\n              <div\n                className={styles.attachmentItem}\n                key={attachment.name}\n                title={attachment.name}\n              >\n                {attachment.name}\n                <div className={styles.attachmentRemoveIcon}>\n                  <RcIconButton\n                    size=\"small\"\n                    symbol={removeSvg}\n                    onClick={() => {\n                      removeAttachment(attachment);\n                    }}\n                  />\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </div>\n    );\n  }\n}\n"],"file":"index.js"}