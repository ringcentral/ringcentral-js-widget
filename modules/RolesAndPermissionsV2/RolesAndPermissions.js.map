{"version":3,"sources":["modules/RolesAndPermissionsV2/RolesAndPermissions.ts"],"names":["DEFAULT_TTL","RolesAndPermissions","name","deps","dep","optional","data","ready","_onDataReadyHandlers","_stopWatching","rolesAndPermissionsOptions","ttl","_source","DataSource","key","cleanOnReset","fetchFunction","_deps","client","account","extension","authzProfile","get","result","response","status","auth","logout","alert","danger","message","permissionsMessages","insufficientPrivilege","readyCheckFunction","loggedIn","dataFetcherV2","register","isCRM","tierEnabled","invalidTier","permissions","ReadUserInfo","hasPermissions","_statusAndData","handler","error","console","_checkTier","_checkReadUserInfo","fn","push","extensionInfo","fetchData","refreshServiceFeatures","flag","acc","item","permission","id","serviceFeatures","RingOut","enabled","WebPhone","webphoneEnabled","ringoutEnabled","feature","ReadCallLog","callingEnabled","ReadPresenceStatus","EditPresenceStatus","Pager","SMS","readTextPermissions","voicemailPermissions","readFaxPermissions","PagerReceiving","SMSReceiving","Voicemail","FaxReceiving","hasReadMessagesPermission","Conferencing","Glip","Meetings","DataFetcherV2Consumer"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIA;;AACA;;AAGA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA,IAAMA,WAAW,GAAG,KAAK,EAAL,GAAU,EAAV,GAAe,IAAnC;IAaaC,mB,WAXZ,gBAAO;AACNC,EAAAA,IAAI,EAAE,qBADA;AAENC,EAAAA,IAAI,EAAE,CACJ,MADI,EAEJ,OAFI,EAGJ,QAHI,EAIJ,eAJI,EAKJ,eALI,EAMJ;AAAEC,IAAAA,GAAG,EAAE,4BAAP;AAAqCC,IAAAA,QAAQ,EAAE;AAA/C,GANI;AAFA,CAAP,C,UAgFE,oBAA8B;AAAA,MAAGC,IAAH,QAAGA,IAAH;AAAA,SAAc,CAACA,IAAD,CAAd;AAAA,CAA9B,C,UA6BA,oBAA8B;AAAA,MAAGC,KAAH,SAAGA,KAAH;AAAA,MAAUD,IAAV,SAAUA,IAAV;AAAA,SAAqB,CAACC,KAAD,EAAQD,IAAR,CAArB;AAAA,CAA9B,C;;;;;AA3FD,+BAAYH,IAAZ,EAAwB;AAAA;;AAAA;;AAAA;;AACtB,8BAAM;AACJA,MAAAA,IAAI,EAAJA;AADI,KAAN;AADsB,UAHdK,oBAGc,GAHwB,EAGxB;AAAA,UAFdC,aAEc,GAFe,IAEf;AAItB,QAAMC,0BAA0B,4BAAGP,IAAI,CAACO,0BAAR,yEAAsC,EAAtE;AAJsB,gCAKQA,0BALR,CAKdC,GALc;AAAA,QAKdA,GALc,sCAKRX,WALQ;AAMtB,UAAKY,OAAL,GAAe,IAAIC,wBAAJ,iCACVH,0BADU;AAEbI,MAAAA,GAAG,EAAE,qBAFQ;AAGbH,MAAAA,GAAG,EAAHA,GAHa;AAIbI,MAAAA,YAAY,EAAE,IAJD;AAKbC,MAAAA,aAAa;AAAA,qFAAE;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yBAE+B,MAAKC,KAAL,CAAWC,MAAX,CACvCC,OADuC,GAEvCC,SAFuC,GAGvCC,YAHuC,GAIvCC,GAJuC,EAF/B;;AAAA;AAELC,kBAAAA,MAFK;AAAA,mDAOJA,MAPI;;AAAA;AAAA;AAAA;;AAAA,wBASP,gCAAMC,QAAN,oEAAgBC,MAAhB,MAA2B,GATpB;AAAA;AAAA;AAAA;;AAAA;AAAA,yBAUH,MAAKR,KAAL,CAAWS,IAAX,CAAgBC,MAAhB,EAVG;;AAAA;AAWT,wBAAKV,KAAL,CAAWW,KAAX,CAAiBC,MAAjB,CAAwB;AACtBC,oBAAAA,OAAO,EAAEC,yCAAoBC,qBADP;AAEtBrB,oBAAAA,GAAG,EAAE;AAFiB,mBAAxB;;AAXS,mDAeF,EAfE;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAF;;AAAA;AAAA;AAAA;;AAAA;AAAA,SALA;AAwBbsB,MAAAA,kBAAkB,EAAE;AAAA,eAClB,MAAKhB,KAAL,CAAWW,KAAX,CAAiBrB,KAAjB,IACA,MAAKU,KAAL,CAAWS,IAAX,CAAgBnB,KADhB,IAEA,MAAKU,KAAL,CAAWS,IAAX,CAAgBQ,QAFhB,IAGA,MAAKjB,KAAL,CAAWkB,aAAX,CAAyB5B,KAJP;AAAA;AAxBP,OAAf;;AA8BA,UAAKU,KAAL,CAAWkB,aAAX,CAAyBC,QAAzB,CAAkC,MAAKxB,OAAvC;;AApCsB;AAqCvB;;;;;;;;;;sBAYG,KAAKL,KAAL,IACA,KAAKU,KAAL,CAAWS,IAAX,CAAgBQ,QADhB,IAEA,KAAKG,KAFL,IAGA,KAAKC,WAAL,KAAqB,K;;;;;;uBAEf,KAAKrB,KAAL,CAAWS,IAAX,CAAgBC,MAAhB,E;;;AACN,qBAAKV,KAAL,CAAWW,KAAX,CAAiBC,MAAjB,CAAwB;AACtBC,kBAAAA,OAAO,EAAEC,yCAAoBQ,WADP;AAEtB5B,kBAAAA,GAAG,EAAE;AAFiB,iBAAxB;;;;;;;;;;;;;;;;;;;;;;;;;sBAqBA,KAAKJ,KAAL,IACA,KAAKU,KAAL,CAAWS,IAAX,CAAgBQ,QADhB,IAEA,CAAC,KAAKM,WAAL,CAAiBC,Y;;;;;AAEZC,gBAAAA,c,GAAiB,CAAC,CAAC,KAAKpC,I;;uBACxB,KAAKW,KAAL,CAAWS,IAAX,CAAgBC,MAAhB,E;;;AACN,oBAAIe,cAAJ,EAAoB;AAClB,uBAAKzB,KAAL,CAAWW,KAAX,CAAiBC,MAAjB,CAAwB;AACtBC,oBAAAA,OAAO,EAAEC,yCAAoBC,qBADP;AAEtBrB,oBAAAA,GAAG,EAAE;AAFiB,mBAAxB;AAID;;;;;;;;;;;;;;;;;;6BASI;AAAA;;AACP,WAAKF,aAAL,GAAqB,iBACnB,IADmB,EAEnB;AAAA,eAAM,MAAI,CAACkC,cAAX;AAAA,OAFmB,EAGnB,iBAAmB;AAAA;AAAA,YAAjBpC,KAAiB;AAAA,YAAVD,IAAU;;AACjB,YAAIC,KAAK,IAAID,IAAb,EAAmB;AAAA,qDACK,MAAI,CAACE,oBADV;AAAA;;AAAA;AACjB,gEAAiD;AAAA,kBAAtCoC,OAAsC;;AAC/C,kBAAI;AACFA,gBAAAA,OAAO;AACR,eAFD,CAEE,OAAOC,KAAP,EAAc;AACdC,gBAAAA,OAAO,CAACD,KAAR,CAAcA,KAAd;AACD;AACF;AAPgB;AAAA;AAAA;AAAA;AAAA;AAQlB;AACF,OAbkB,CAArB;AAeD;;;8BAES;AAAA;;AACR,kCAAKpC,aAAL;AACA,WAAKA,aAAL,GAAqB,IAArB;AACD;;;;;;;;;;uBAGO,KAAKsC,UAAL,E;;;;uBACA,KAAKC,kBAAL,E;;;;;;;;;;;;;;;;;;gCAGIC,E,EAAe;AACzB,WAAKzC,oBAAL,CAA0B0C,IAA1B,CAA+BD,EAA/B;AACD;;;6CAEwB;AACvB,WAAKhC,KAAL,CAAWkC,aAAX,CAAyBC,SAAzB;AACD;;;;;;;;;;uBAOO,KAAKC,sBAAL,E;;;;;;;;;;;;;;;;;;;;;wBAlGI;AAAA;;AACV,gEAAO,KAAKpC,KAAL,CAAWP,0BAAlB,2DAAO,uBAAuC2B,KAA9C,yEAAuD,KAAvD;AACD;;;wBAEU;AAAA;;AACT,iEAAO,KAAKpB,KAAL,CAAWP,0BAAlB,2DAAO,uBAAuC4C,IAA9C,2EAAsD,YAAtD;AACD;;;wBAkBiB;AAAA;;AAChB,aAAO,mBACL,UAACC,GAAD,EAAMC,IAAN,EAAe;AACbD,QAAAA,GAAG,CAACC,IAAI,CAACC,UAAL,CAAgBC,EAAjB,CAAH,GAA0B,IAA1B;AACA,eAAOH,GAAP;AACD,OAJI,EAKL,EALK,EAML,oBAAKjD,IAAL,0DAAWkC,WAAX,KAA2B,EANtB,CAAP;AAQD;;;wBAoBoD;AACnD,aAAO,CAAC,KAAKjC,KAAN,EAAa,KAAKD,IAAlB,CAAP;AACD;;;wBAsCqB;AACpB,aAAO,KAAKW,KAAL,CAAWkC,aAAX,CAAyBQ,eAAhC;AACD;;;wBAOoB;AAAA;;AACnB,aAAO,CAAC,2BAAC,KAAKA,eAAL,CAAqBC,OAAtB,0DAAC,sBAA8BC,OAA/B,CAAR;AACD;;;wBAEqB;AAAA;;AACpB,aAAO,CAAC,4BAAC,KAAKF,eAAL,CAAqBG,QAAtB,2DAAC,uBAA+BD,OAAhC,CAAR;AACD;;;wBAEoB;AACnB,aAAO,KAAKE,eAAL,IAAwB,KAAKC,cAApC;AACD;;;wBAEiB;AAChB,UAAMC,OAAO,GAAG,KAAKN,eAAL,CAAqB,KAAKL,IAA1B,CAAhB;AACA,aAAOW,OAAO,GAAGA,OAAO,CAACJ,OAAX,GAAqB,IAAnC;AACD;;;wBAE8B;AAC7B,aAAO,CAAC,EAAE,KAAKtD,KAAL,IAAc,KAAKiC,WAAL,CAAiB0B,WAAjC,CAAR;AACD;;;wBAE2B;AAC1B,aAAO,CAAC,EACN,KAAK3D,KAAL,IACA,KAAK4D,cADL,IAEA,KAAK3B,WAAL,CAAiB4B,kBAHX,CAAR;AAKD;;;wBAE+B;AAC9B,aAAO,CAAC,EACN,KAAK7D,KAAL,IACA,KAAK4D,cADL,IAEA,KAAK3B,WAAL,CAAiB6B,kBAHX,CAAR;AAKD;;;wBAE8B;AAAA;;AAC7B,aAAO,CAAC,EACN,gCAAKV,eAAL,CAAqBW,KAArB,kFAA4BT,OAA5B,gCAAuC,KAAKF,eAAL,CAAqBY,GAA5D,2DAAuC,uBAA0BV,OAAjE,CADM,CAAR;AAGD;;;wBAEyB;AAAA;;AACxB,aAAO,CAAC,EACN,gCAAKF,eAAL,CAAqBW,KAArB,kFAA4BT,OAA5B,KAAuC,4BAAC,KAAKF,eAAL,CAAqBY,GAAtB,2DAAC,uBAA0BV,OAA3B,CADjC,CAAR;AAGD;;;wBAE+B;AAC9B,aACE,KAAKtD,KAAL,KACC,KAAKiE,mBAAL,IACC,KAAKC,oBADN,IAEC,KAAKC,kBAHP,CADF;AAMD;;;wBAEyB;AAAA;;AACxB,aAAO,CAAC,EACN,gCAAKf,eAAL,CAAqBgB,cAArB,kFAAqCd,OAArC,gCACA,KAAKF,eAAL,CAAqBiB,YADrB,2DACA,uBAAmCf,OADnC,CADM,CAAR;AAID;;;wBAE0B;AAAA;;AACzB,aAAO,CAAC,EACN,2BAAKrB,WAAL,wEAAkBqC,SAAlB,gCAA+B,KAAKlB,eAAL,CAAqBkB,SAApD,2DAA+B,uBAAgChB,OAA/D,CADM,CAAR;AAGD;;;wBAEwB;AAAA;;AACvB,aAAO,CAAC,6BAAC,KAAKF,eAAL,CAAqBmB,YAAtB,4DAAC,wBAAmCjB,OAApC,CAAR;AACD;;;wBAE4B;AAC3B,aAAO,CAAC,EAAE,KAAKM,cAAL,IAAuB,KAAKY,yBAA9B,CAAR;AACD;;;wBAE+B;AAAA;;AAC9B,aAAO,CAAC,6BAAC,KAAKpB,eAAL,CAAqBqB,YAAtB,4DAAC,wBAAmCnB,OAApC,CAAR;AACD;;;wBAEuB;AACtB,aAAO,CAAC,CAAC,KAAKrB,WAAL,CAAiByC,IAA1B;AACD;;;wBAEiC;AAChC,aAAO,KAAKd,cAAL,IAAuB,KAAKJ,eAAnC;AACD;;;wBAE2B;AAC1B,aAAO,CAAC,CAAC,KAAKvB,WAAL,CAAiB0C,QAA1B;AACD;;;;EAjPsCC,mC","sourcesContent":["import {\n  ActivePermissionResource,\n  AuthProfileResource,\n} from '@rc-ex/core/definitions';\nimport { computed, watch } from '@ringcentral-integration/core';\nimport { reduce } from 'ramda';\nimport { Unsubscribe } from 'redux';\n\nimport { Module } from '../../lib/di';\nimport { DataFetcherV2Consumer, DataSource } from '../DataFetcherV2';\nimport { permissionsMessages } from '../RolesAndPermissions/permissionsMessages';\nimport { Deps } from './RolesAndPermissions.interface';\n\nconst DEFAULT_TTL = 24 * 60 * 60 * 1000;\n\n@Module({\n  name: 'RolesAndPermissions',\n  deps: [\n    'Auth',\n    'Alert',\n    'Client',\n    'DataFetcherV2',\n    'ExtensionInfo',\n    { dep: 'RolesAndPermissionsOptions', optional: true },\n  ],\n})\nexport class RolesAndPermissions extends DataFetcherV2Consumer<\n  Deps,\n  AuthProfileResource\n> {\n  protected _onDataReadyHandlers: (() => any)[] = [];\n  protected _stopWatching: Unsubscribe = null;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n    });\n    const rolesAndPermissionsOptions = deps.rolesAndPermissionsOptions ?? {};\n    const { ttl = DEFAULT_TTL } = rolesAndPermissionsOptions;\n    this._source = new DataSource({\n      ...rolesAndPermissionsOptions,\n      key: 'rolesAndPermissions',\n      ttl,\n      cleanOnReset: true,\n      fetchFunction: async () => {\n        try {\n          const result: AuthProfileResource = await this._deps.client\n            .account()\n            .extension()\n            .authzProfile()\n            .get();\n          return result;\n        } catch (error) {\n          if (error.response?.status === 403) {\n            await this._deps.auth.logout();\n            this._deps.alert.danger({\n              message: permissionsMessages.insufficientPrivilege,\n              ttl: 0,\n            });\n            return {} as AuthProfileResource;\n          }\n        }\n      },\n      readyCheckFunction: () =>\n        this._deps.alert.ready &&\n        this._deps.auth.ready &&\n        this._deps.auth.loggedIn &&\n        this._deps.dataFetcherV2.ready,\n    });\n    this._deps.dataFetcherV2.register(this._source);\n  }\n\n  get isCRM() {\n    return this._deps.rolesAndPermissionsOptions?.isCRM ?? false;\n  }\n\n  get flag() {\n    return this._deps.rolesAndPermissionsOptions?.flag ?? 'SalesForce';\n  }\n\n  protected async _checkTier() {\n    if (\n      this.ready &&\n      this._deps.auth.loggedIn &&\n      this.isCRM &&\n      this.tierEnabled === false\n    ) {\n      await this._deps.auth.logout();\n      this._deps.alert.danger({\n        message: permissionsMessages.invalidTier,\n        ttl: 0,\n      });\n    }\n  }\n\n  @computed<RolesAndPermissions>(({ data }) => [data])\n  get permissions() {\n    return reduce(\n      (acc, item) => {\n        acc[item.permission.id] = true;\n        return acc;\n      },\n      {} as Record<string, boolean>,\n      this.data?.permissions || ([] as ActivePermissionResource[]),\n    );\n  }\n\n  protected async _checkReadUserInfo() {\n    if (\n      this.ready &&\n      this._deps.auth.loggedIn &&\n      !this.permissions.ReadUserInfo\n    ) {\n      const hasPermissions = !!this.data;\n      await this._deps.auth.logout();\n      if (hasPermissions) {\n        this._deps.alert.danger({\n          message: permissionsMessages.insufficientPrivilege,\n          ttl: 0,\n        });\n      }\n    }\n  }\n\n  @computed<RolesAndPermissions>(({ ready, data }) => [ready, data])\n  get _statusAndData(): [boolean, AuthProfileResource] {\n    return [this.ready, this.data];\n  }\n\n  onInit() {\n    this._stopWatching = watch(\n      this,\n      () => this._statusAndData,\n      ([ready, data]) => {\n        if (ready && data) {\n          for (const handler of this._onDataReadyHandlers) {\n            try {\n              handler();\n            } catch (error) {\n              console.error(error);\n            }\n          }\n        }\n      },\n    );\n  }\n\n  onReset() {\n    this._stopWatching?.();\n    this._stopWatching = null;\n  }\n\n  async onStateChange() {\n    await this._checkTier();\n    await this._checkReadUserInfo();\n  }\n\n  onDataReady(fn: () => any) {\n    this._onDataReadyHandlers.push(fn);\n  }\n\n  refreshServiceFeatures() {\n    this._deps.extensionInfo.fetchData();\n  }\n\n  get serviceFeatures() {\n    return this._deps.extensionInfo.serviceFeatures;\n  }\n\n  async fetchData() {\n    await this.refreshServiceFeatures();\n    return super.fetchData();\n  }\n\n  get ringoutEnabled() {\n    return !!this.serviceFeatures.RingOut?.enabled;\n  }\n\n  get webphoneEnabled() {\n    return !!this.serviceFeatures.WebPhone?.enabled;\n  }\n\n  get callingEnabled() {\n    return this.webphoneEnabled || this.ringoutEnabled;\n  }\n\n  get tierEnabled() {\n    const feature = this.serviceFeatures[this.flag];\n    return feature ? feature.enabled : null;\n  }\n\n  get hasReadCallLogPermission() {\n    return !!(this.ready && this.permissions.ReadCallLog);\n  }\n\n  get hasPresencePermission() {\n    return !!(\n      this.ready &&\n      this.callingEnabled &&\n      this.permissions.ReadPresenceStatus\n    );\n  }\n\n  get hasEditPresencePermission() {\n    return !!(\n      this.ready &&\n      this.callingEnabled &&\n      this.permissions.EditPresenceStatus\n    );\n  }\n\n  get hasComposeTextPermission() {\n    return !!(\n      this.serviceFeatures.Pager?.enabled || this.serviceFeatures.SMS?.enabled\n    );\n  }\n\n  get onlyPagerPermission() {\n    return !!(\n      this.serviceFeatures.Pager?.enabled && !this.serviceFeatures.SMS?.enabled\n    );\n  }\n\n  get hasReadMessagesPermission() {\n    return (\n      this.ready &&\n      (this.readTextPermissions ||\n        this.voicemailPermissions ||\n        this.readFaxPermissions)\n    );\n  }\n\n  get readTextPermissions() {\n    return !!(\n      this.serviceFeatures.PagerReceiving?.enabled ||\n      this.serviceFeatures.SMSReceiving?.enabled\n    );\n  }\n\n  get voicemailPermissions() {\n    return !!(\n      this.permissions?.Voicemail && this.serviceFeatures.Voicemail?.enabled\n    );\n  }\n\n  get readFaxPermissions() {\n    return !!this.serviceFeatures.FaxReceiving?.enabled;\n  }\n\n  get hasUserGuidePermission() {\n    return !!(this.callingEnabled || this.hasReadMessagesPermission);\n  }\n\n  get hasConferencingPermission() {\n    return !!this.serviceFeatures.Conferencing?.enabled;\n  }\n\n  get hasGlipPermission() {\n    return !!this.permissions.Glip;\n  }\n\n  get hasConferenceCallPermission() {\n    return this.callingEnabled && this.webphoneEnabled;\n  }\n\n  get hasMeetingsPermission() {\n    return !!this.permissions.Meetings;\n  }\n}\n"],"file":"RolesAndPermissions.js"}