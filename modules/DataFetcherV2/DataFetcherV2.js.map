{"version":3,"sources":["modules/DataFetcherV2/DataFetcherV2.ts"],"names":["DataFetcherV2","name","deps","dep","optional","storageKey","enableCache","_sources","Set","_timeoutIds","Map","_promises","_deps","sleepDetector","on","events","detected","_handleSleepDetected","auth","loggedIn","ready","source","isFetching","key","data","timestamp","Date","now","disableCache","timestamps","storageData","cachedData","cachedTimestamps","_setData","_setFetching","ownerId","fetchFunction","polling","_startPolling","timeToRetry","_retry","has","clearTimeout","get","t","getTimestamp","pollingInterval","_clearTimeout","set","setTimeout","_checkIsActiveTab","readyCheckFunction","permissionCheckFunction","_expired","fetchData","_fetchData","ttl","isFreshLogin","tabManager","active","getSourceStatus","sourceStatus","pending","_setSourceStatus","initializing","_shouldFetch","getData","status","readyCheck","permissionCheck","_tryInitializeSource","cleanOnReset","Array","from","keys","forEach","add","registeredKeys","_getRegisteredKeys","k","Object","prototype","hasOwnProperty","call","_deleteKeys","_getInvalidCachedKeys","_cleanCache","_processSources","RcModuleV2","state","storage","action","proxify"],"mappings":"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","sourcesContent":["import {\n  RcModuleV2,\n  state,\n  storage,\n  action,\n} from '@ringcentral-integration/core';\nimport { forEach } from 'ramda';\nimport { Module } from '../../lib/di';\nimport { proxify } from '../../lib/proxy/proxify';\nimport { Deps } from './DataFetcherV2.interface';\nimport { SourceStatusType, sourceStatus } from './sourceStatus';\nimport { DataSource } from './DataSource';\n\n@Module({\n  name: 'DataFetcherV2',\n  deps: [\n    'Auth',\n    'Storage',\n    'SleepDetector',\n    { dep: 'TabManager', optional: true },\n    { dep: 'DataFetcherV2Options', optional: true },\n  ],\n})\nexport class DataFetcherV2 extends RcModuleV2<Deps> {\n  protected _sources = new Set<DataSource<any>>();\n  protected _timeoutIds = new Map<string, NodeJS.Timeout>();\n  protected _promises = new Map<string, Promise<void>>();\n\n  constructor(deps: Deps) {\n    super({\n      storageKey: 'dataFetcherV2',\n      enableCache: true,\n      deps,\n    });\n    this._deps.sleepDetector.on(this._deps.sleepDetector.events.detected, () =>\n      this._handleSleepDetected(),\n    );\n  }\n\n  _shouldInit() {\n    return this._deps.auth.loggedIn && super._shouldInit();\n  }\n\n  _shouldReset() {\n    return !!(\n      super._shouldReset() ||\n      (this.ready && !this._deps.auth.loggedIn)\n    );\n  }\n\n  @state\n  sourceStatus: Record<string, SourceStatusType> = {};\n\n  get cachedData() {\n    return this.storageData.cachedData;\n  }\n\n  get cachedTimestamps() {\n    return this.storageData.cachedTimestamps;\n  }\n\n  @storage\n  @state\n  storageData: {\n    cachedData: Record<string, any>;\n    cachedTimestamps: Record<string, number>;\n  } = {\n    cachedData: {},\n    cachedTimestamps: {},\n  };\n\n  @state\n  data: Record<string, any> = {};\n\n  @state\n  timestamps: Record<string, number> = {};\n\n  @state\n  isFetching: Record<string, boolean> = {};\n\n  @action\n  protected _setFetching(source: DataSource<any>, isFetching: boolean) {\n    this.isFetching[source.key] = isFetching;\n  }\n\n  getFetching<T>(source: DataSource<T>) {\n    return !!this.isFetching[source.key];\n  }\n\n  @action\n  protected _setData<T>(\n    source: DataSource<T>,\n    data: T,\n    timestamp = Date.now(),\n  ): void {\n    if (source.disableCache) {\n      this.data[source.key] = data;\n      this.timestamps[source.key] = timestamp;\n    } else {\n      this.storageData.cachedData[source.key] = data;\n      this.storageData.cachedTimestamps[source.key] = timestamp;\n    }\n  }\n\n  updateData<T>(source: DataSource<T>, data: T, timestamp: number): void {\n    this._setData(source, data, timestamp);\n  }\n\n  @proxify\n  protected async _fetchData<T>(source: DataSource<T>): Promise<void> {\n    this._setFetching(source, true);\n    const { ownerId } = this._deps.auth;\n    try {\n      const data = await source.fetchFunction();\n      if (this._deps.auth.ownerId === ownerId) {\n        this._setData(source, data, Date.now());\n        this._setFetching(source, false);\n        if (source.polling) {\n          this._startPolling(source);\n        }\n        this._promises.delete(source.key);\n      }\n    } catch (error) {\n      if (this._deps.auth.ownerId === ownerId) {\n        this._promises.delete(source.key);\n        this._setFetching(source, false);\n        if (source.polling) {\n          this._startPolling(source, source.timeToRetry);\n        } else {\n          this._retry(source);\n        }\n        throw error;\n      }\n    }\n  }\n\n  protected _clearTimeout<T>(source: DataSource<T>) {\n    if (this._timeoutIds.has(source.key)) {\n      clearTimeout(this._timeoutIds.get(source.key));\n      this._timeoutIds.delete(source.key);\n    }\n  }\n\n  protected _startPolling<T>(\n    source: DataSource<T>,\n    t = this.getTimestamp(source) + source.pollingInterval + 10 - Date.now(),\n  ) {\n    this._clearTimeout(source);\n    this._timeoutIds.set(\n      source.key,\n      setTimeout(() => {\n        this._timeoutIds.delete(source.key);\n        if (\n          this.ready &&\n          this._checkIsActiveTab(source) &&\n          source.readyCheckFunction() &&\n          source.permissionCheckFunction()\n        ) {\n          if (this._expired(source)) {\n            this.fetchData(source);\n          } else {\n            this._startPolling(source);\n          }\n        } else if (!this._expired(source)) {\n          this._startPolling(source);\n        } else {\n          this._startPolling(source, source.timeToRetry);\n        }\n      }, t),\n    );\n  }\n\n  protected _retry<T>(source: DataSource<T>, t = source.timeToRetry) {\n    this._clearTimeout(source);\n    this._timeoutIds.set(\n      source.key,\n      setTimeout(() => {\n        if (this._expired(source)) {\n          if (\n            this.ready &&\n            this._checkIsActiveTab(source) &&\n            source.readyCheckFunction() &&\n            source.permissionCheckFunction()\n          ) {\n            this.fetchData(source);\n          } else {\n            this._retry(source);\n          }\n        }\n      }, t),\n    );\n  }\n\n  @proxify\n  async fetchData(source: DataSource<any>): Promise<void> {\n    if (!this._promises.get(source.key)) {\n      this._promises.set(source.key, this._fetchData(source));\n    }\n    return this._promises.get(source.key);\n  }\n\n  getTimestamp<T>(source: DataSource<T>) {\n    if (source.disableCache) {\n      return this.timestamps[source.key] || null;\n    }\n    return this.cachedTimestamps[source.key] || null;\n  }\n\n  get sources() {\n    return this._sources;\n  }\n\n  protected _expired<T>(source: DataSource<T>) {\n    return Date.now() - this.getTimestamp(source) > source.ttl;\n  }\n\n  protected _shouldFetch<T>(source: DataSource<T>, isFreshLogin = false) {\n    return (\n      this._checkIsActiveTab<T>(source) &&\n      (isFreshLogin || this._expired(source))\n    );\n  }\n\n  private _checkIsActiveTab<T>(source: DataSource<T>) {\n    // if cache is disabled, then each tab should fetch its own data\n    // therefore tabManager should be ignored\n    return (\n      source.disableCache ||\n      !this._deps.tabManager ||\n      this._deps.tabManager.active\n    );\n  }\n\n  protected async _tryInitializeSource<T>(\n    source: DataSource<T>,\n  ): Promise<void> {\n    if (this.getSourceStatus(source) === sourceStatus.pending) {\n      this._setSourceStatus(source, sourceStatus.initializing);\n      if (this._shouldFetch(source)) {\n        try {\n          await this.fetchData(source);\n        } catch {\n          this._retry(source);\n        }\n      } else if (source.polling) {\n        this._startPolling(source);\n      } else {\n        this._retry(source);\n      }\n      return;\n    }\n    if (this.getData(source) !== null && this.getTimestamp(source) !== null) {\n      this._setSourceStatus(source, sourceStatus.ready);\n    }\n  }\n\n  @action\n  protected _setSourceStatus<T>(\n    source: DataSource<T>,\n    status: SourceStatusType,\n  ) {\n    this.sourceStatus[source.key] = status;\n  }\n\n  getSourceStatus<T>(source: DataSource<T>) {\n    return this.sourceStatus[source.key];\n  }\n\n  protected _processSources() {\n    if (this.ready) {\n      forEach((source) => {\n        if (!this.getSourceStatus(source)) {\n          this._setSourceStatus(source, sourceStatus.pending);\n        }\n        const status = this.getSourceStatus(source);\n        const readyCheck = this.ready && source.readyCheckFunction();\n        const permissionCheck = readyCheck && source.permissionCheckFunction();\n        if (readyCheck) {\n          if (\n            status === sourceStatus.pending ||\n            status === sourceStatus.initializing\n          ) {\n            // if user has no permission to fetch data, bypass the initialization process\n            if (!permissionCheck) {\n              this._setSourceStatus(source, sourceStatus.ready);\n              this._setData(source, null, 0);\n            } else {\n              this._tryInitializeSource(source);\n            }\n          } else if (status === sourceStatus.ready) {\n            if (\n              !permissionCheck &&\n              this.getData(source) !== null &&\n              this.getTimestamp(source) !== null\n            ) {\n              // no permission but has data, set data to null\n              // use 0 for timestamp so we know this is on purpose\n              this._setData(source, null, 0);\n            } else if (\n              permissionCheck &&\n              this.getData(source) === null &&\n              this.getTimestamp(source) === 0 &&\n              !this._promises.get(source.key)\n            ) {\n              // if the data set to null due to permission before\n              // but now there is permission, then fetch data\n              this.fetchData(source);\n            }\n          }\n        } else if (status === sourceStatus.ready) {\n          this._setSourceStatus(source, sourceStatus.pending);\n          if (source.cleanOnReset) {\n            this._setData(source, null, null);\n          }\n        }\n      }, Array.from(this._sources));\n    }\n  }\n\n  protected _handleSleepDetected() {\n    forEach((source) => {\n      if (this.ready && this._shouldFetch(source)) {\n        this.fetchData(source);\n      }\n    }, Array.from(this._sources));\n  }\n\n  protected _getRegisteredKeys() {\n    const keys = new Set<string>();\n    this._sources.forEach((source) => {\n      keys.add(source.key);\n    });\n    return keys;\n  }\n\n  protected _getInvalidCachedKeys() {\n    const registeredKeys = this._getRegisteredKeys();\n    const keys = new Set<string>();\n    for (const k in this.cachedData) {\n      if (\n        Object.prototype.hasOwnProperty.call(this.cachedData, k) &&\n        !registeredKeys.has(k)\n      ) {\n        keys.add(k);\n      }\n    }\n    for (const k in this.cachedTimestamps) {\n      if (\n        Object.prototype.hasOwnProperty.call(this.cachedTimestamps, k) &&\n        !registeredKeys.has(k)\n      ) {\n        keys.add(k);\n      }\n    }\n    return keys;\n  }\n\n  @action\n  protected _deleteKeys(keys: Set<string>) {\n    keys.forEach((k) => {\n      delete this.cachedData[k];\n      delete this.cachedTimestamps[k];\n    });\n  }\n\n  protected _cleanCache() {\n    this._deleteKeys(this._getInvalidCachedKeys());\n  }\n\n  onInit() {\n    // clean up cached sources that are no longer exist\n    this._cleanCache();\n  }\n\n  onReset() {\n    forEach((source) => {\n      // clear all pollings or retries\n      this._clearTimeout(source);\n      // clear all pending requests\n      this._promises.delete(source.key);\n      // reset isFetching\n      this._setFetching(source, false);\n      if (this.getSourceStatus(source) !== sourceStatus.pending) {\n        this._setSourceStatus(source, sourceStatus.pending);\n      }\n      if (\n        source.cleanOnReset &&\n        this.getData(source) !== null &&\n        this.getTimestamp(source) !== null\n      ) {\n        this._setData(source, null, null);\n      }\n    }, Array.from(this._sources));\n  }\n\n  onStateChange() {\n    this._processSources();\n  }\n\n  register<T>(source: DataSource<T>) {\n    this._sources.add(source);\n  }\n\n  getData<T>(source: DataSource<T>): T {\n    if (this._sources.has(source)) {\n      if (source.disableCache) {\n        return this.data[source.key] || null;\n      }\n      return this.cachedData[source.key] || null;\n    }\n    return null;\n  }\n}\n"],"file":"DataFetcherV2.js"}