{"version":3,"sources":["modules/CompanyContacts/index.js"],"names":["contactsRegExp","DEFAULT_TTL","DEFAULT_SHOW_DISABLED","DEFAULT_SHOW_NOT_ACTIVATED","DEFAULT_ALLOW_SETTINGS","DEFAULT_TYPE_FILTERS","extensionTypes","digitalUser","user","department","CompanyContacts","deps","dep","optional","client","rolesAndPermissions","storage","ttl","polling","showDisabled","extensionTypeFilters","showNotActivated","allowSettings","options","getReducer","getDataFetcherReducer","types","reducers","getDataReducer","getTimestampReducer","subscriptionFilters","companyContacts","subscriptionHandler","message","ready","test","event","body","contacts","contact","_processContact","fetchFunction","params","_client","account","directory","list","readyCheckFn","_rolesAndPermissions","_allowSettings","_storage","_settingsStorageKey","registerReducer","key","reducer","actionTypes","ensureExist","eventType","oldEtag","newEtag","store","dispatch","type","upsert","timestamp","Date","now","extensionNumber","item","filteredContacts","permissions","ReadExtensions","getItem","state","DataFetcher","selector","filters","typeFilter","acc","status","extensionStatusTypes","disabled","notActivated","data","_extensionFilter","extensionFilter"],"mappings":"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","sourcesContent":["import { find, filter, reduce } from 'ramda';\nimport { combineReducers } from 'redux';\nimport { Module } from '../../lib/di';\nimport DataFetcher from '../../lib/DataFetcher';\nimport { getDataFetcherReducer } from '../../lib/DataFetcher/getDataFetcherReducer';\nimport fetchList from '../../lib/fetchList';\nimport ensureExist from '../../lib/ensureExist';\nimport { selector } from '../../lib/selector';\n\nimport actionTypes from './actionTypes';\nimport {\n  getDataReducer,\n  getTimestampReducer,\n  getExtensionTypeFiltersReducer,\n  getShowDisabledReducer,\n  getShowNotActivatedReducer,\n} from './getReducers';\nimport subscriptionFilters from '../../enums/subscriptionFilters';\nimport extensionTypes from '../../enums/extensionTypes';\nimport { extensionStatusTypes } from '../../enums/extensionStatusTypes';\n\nconst contactsRegExp = /.*\\/directory\\/contacts$/;\n\nconst DEFAULT_TTL = 24 * 60 * 60 * 1000;\nconst DEFAULT_SHOW_DISABLED = false;\nconst DEFAULT_SHOW_NOT_ACTIVATED = false;\nconst DEFAULT_ALLOW_SETTINGS = false;\n\n// Consider enable all extension types and filter through selector if\n// we'll allow users to configure this through settings\nconst DEFAULT_TYPE_FILTERS = [\n  extensionTypes.digitalUser,\n  extensionTypes.user,\n  extensionTypes.department,\n  // extensionTypes.limited,\n  // extensionTypes.announcement,\n  // extensionTypes.applicationExtension,\n  // extensionTypes.bot,\n  // extensionTypes.faxUser,\n  // extensionTypes.ivrMenu,\n  // extensionTypes.pagingOnly,\n  // extensionTypes.parkLocation,\n  // extensionTypes.sharedLinesGroup,\n];\n\n/**\n * @class\n * @description Accound extension list managing module\n */\n@Module({\n  deps: [\n    'Client',\n    'RolesAndPermissions',\n    { dep: 'CompanyContactsOptions', optional: true },\n  ],\n})\nexport default class CompanyContacts extends DataFetcher {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {Number} params.ttl - local cache timestamp, default 24 hours\n   */\n  constructor({\n    client,\n    rolesAndPermissions,\n    storage,\n    ttl = DEFAULT_TTL,\n    polling = true,\n    showDisabled = DEFAULT_SHOW_DISABLED,\n    extensionTypeFilters = DEFAULT_TYPE_FILTERS,\n    showNotActivated = DEFAULT_SHOW_NOT_ACTIVATED,\n    allowSettings = DEFAULT_ALLOW_SETTINGS,\n    ...options\n  }) {\n    super({\n      ...options,\n      client,\n      storage,\n      ttl,\n      polling,\n      getReducer: allowSettings\n        ? getDataFetcherReducer\n        : (types, reducers = {}) =>\n            getDataFetcherReducer(types, {\n              ...reducers,\n              showDisabled: getShowDisabledReducer(types, showDisabled),\n              showNotActivated: getShowNotActivatedReducer(\n                types,\n                showNotActivated,\n              ),\n              extensionTypeFilters: getExtensionTypeFiltersReducer(\n                types,\n                extensionTypeFilters,\n              ),\n            }),\n      getDataReducer,\n      getTimestampReducer,\n      subscriptionFilters: [subscriptionFilters.companyContacts],\n      subscriptionHandler: async (message) => {\n        if (\n          this.ready &&\n          message &&\n          contactsRegExp.test(message.event) &&\n          message.body &&\n          message.body.contacts\n        ) {\n          for (const contact of message.body.contacts) {\n            await this._processContact(contact);\n          }\n        }\n      },\n      fetchFunction: () =>\n        fetchList((params) =>\n          this._client\n            .account()\n            .directory()\n            .contacts()\n            .list(params),\n        ),\n      readyCheckFn: () => this._rolesAndPermissions.ready,\n    });\n    this._allowSettings = allowSettings;\n\n    if (this._allowSettings) {\n      this._storage = ensureExist(storage, 'storage');\n      this._settingsStorageKey = 'CompanyContacts-settings';\n      this._storage.registerReducer({\n        key: this._settingsStorageKey,\n        reducer: combineReducers({\n          showDisabled: getShowDisabledReducer(this.actionTypes, showDisabled),\n          showNotActivated: getShowNotActivatedReducer(\n            this.actionTypes,\n            showNotActivated,\n          ),\n          extensionTypeFilters: getExtensionTypeFiltersReducer(\n            this.actionTypes,\n            extensionTypeFilters,\n          ),\n        }),\n      });\n    }\n    this._rolesAndPermissions = this::ensureExist(\n      rolesAndPermissions,\n      'rolesAndPermissions',\n    );\n  }\n\n  get _name() {\n    return 'CompanyContacts';\n  }\n\n  get _actionTypes() {\n    return actionTypes;\n  }\n\n  async _processContact({ eventType, oldEtag, newEtag, ...contact }) {\n    switch (eventType) {\n      case 'Create':\n      case 'Update':\n        this.store.dispatch({\n          type: this.actionTypes.upsert,\n          contact,\n          timestamp: Date.now(),\n        });\n        break;\n      case 'Delete':\n        this.store.dispatch({\n          type: this.actionTypes.delete,\n          contact,\n          timestamp: Date.now(),\n        });\n        break;\n      default:\n      /* do nothing */\n    }\n  }\n\n  /**\n   * TODO: Currently we don't have clearly defined business rule on\n   * what extension numbers are considered available for dialing.\n   * @param {String} extensionNumber\n   * @returns {Boolean}\n   */\n  isAvailableExtension(extensionNumber) {\n    return !!find(\n      (item) => item.extensionNumber === extensionNumber,\n      this.filteredContacts,\n    );\n  }\n\n  @selector\n  _extensionFilter = [\n    () => this.showDisabled,\n    () => this.showNotActivated,\n    () => this.extensionTypeFilters,\n    (showDisabled, showNotActivated, filters) => {\n      const typeFilter = reduce(\n        (acc, item) => {\n          acc[item] = true;\n          return acc;\n        },\n        {},\n        filters,\n      );\n      return filter(\n        (item) =>\n          !(\n            (!showDisabled && item.status === extensionStatusTypes.disabled) ||\n            (!showNotActivated &&\n              item.status === extensionStatusTypes.notActivated) ||\n            !typeFilter[item.type]\n          ),\n      );\n    },\n  ];\n\n  @selector\n  filteredContacts = [\n    () => this.data,\n    () => this._extensionFilter,\n    (data, extensionFilter) => extensionFilter(data),\n  ];\n\n  get _hasPermission() {\n    return !!this._rolesAndPermissions.permissions.ReadExtensions;\n  }\n\n  get allowSettings() {\n    return this._allowSettings;\n  }\n\n  get showDisabled() {\n    if (this.allowSettings) {\n      return this._storage.getItem(this._settingsStorageKey).showDisabled;\n    }\n    return this.state.showDisabled;\n  }\n\n  get showNotActivated() {\n    if (this.allowSettings) {\n      return this._storage.getItem(this._settingsStorageKey).showNotActivated;\n    }\n    return this.state.showNotActivated;\n  }\n\n  get extensionTypeFilters() {\n    if (this.allowSettings) {\n      return this._storage.getItem(this._settingsStorageKey)\n        .extensionTypeFilters;\n    }\n    return this.state.extensionTypeFilters;\n  }\n}\n"],"file":"index.js"}