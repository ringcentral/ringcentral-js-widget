{"version":3,"sources":["modules/UserGuide/index.js"],"names":["SUPPORTED_LOCALES","UserGuide","deps","dep","optional","auth","locale","storage","webphone","rolesAndPermissions","options","actionTypes","_auth","_locale","_storage","_webphone","_rolesAndPermissions","_reducer","_context","context","_storageKey","_guideReducer","registerReducer","key","reducer","store","subscribe","_onStateChange","pending","ready","loggedIn","dispatch","type","initSuccess","initUserGuide","preLoadImage","resetSuccess","ringSession","_lastRingSession","dismiss","url","Promise","resolve","reject","img","Image","src","onload","onerror","guides","_preLoadImage","preLoadImageStatus","locales","Object","keys","sort","map","reduce","prev","curr","forEach","push","updateCarousel","curIdx","entered","playing","firstLogin","loadGuides","state","hasUserGuidePermission","prevGuides","allGuides","resolveGuides","JSON","stringify","start","currentGuides","currentLocale","length","getItem","carouselState","status","RcModule","proxify"],"mappings":"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","sourcesContent":["import { contains } from 'ramda';\nimport RcModule from '../../lib/RcModule';\nimport proxify from '../../lib/proxy/proxify';\nimport { Module } from '../../lib/di';\nimport actionTypes from './actionTypes';\nimport getUserGuideReducer, { getGuidesReducer } from './getUserGuideReducer';\n\n/**\n * Support localization\n */\nconst SUPPORTED_LOCALES = {\n  'en-US': 'en-US',\n  'fr-CA': 'fr-CA',\n};\n\n@Module({\n  deps: [\n    'Auth',\n    'Locale',\n    'Storage',\n    'Webphone',\n    'RolesAndPermissions',\n    { dep: 'UserGuideOptions', optional: true },\n  ],\n})\nexport default class UserGuide extends RcModule {\n  constructor({\n    auth,\n    locale,\n    storage,\n    webphone,\n    rolesAndPermissions,\n    ...options\n  }) {\n    super({\n      actionTypes,\n      ...options,\n    });\n    this._auth = auth;\n    this._locale = locale;\n    this._storage = storage;\n    this._webphone = webphone;\n    this._rolesAndPermissions = rolesAndPermissions;\n    this._reducer = getUserGuideReducer(this.actionTypes);\n\n    this._context = options.context;\n\n    this._storageKey = 'userGuide';\n    this._guideReducer = getGuidesReducer(this.actionTypes);\n    this._storage.registerReducer({\n      key: this._storageKey,\n      reducer: this._guideReducer,\n    });\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  async _onStateChange() {\n    if (\n      this.pending &&\n      this._auth.ready &&\n      this._locale.ready &&\n      this._storage.ready &&\n      this._rolesAndPermissions.ready &&\n      this._auth.loggedIn\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n      await this.initUserGuide();\n      await this.preLoadImage();\n    } else if (\n      this.ready &&\n      (!this._auth.ready ||\n        !this._locale.ready ||\n        !this._storage.ready ||\n        !this._rolesAndPermissions.ready)\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n    }\n    // When there is an incoming call,\n    // the guide should be dismissed\n    if (\n      this._webphone.ready &&\n      this._webphone.ringSession &&\n      this._webphone.ringSession !== this._lastRingSession\n    ) {\n      this._lastRingSession = this._webphone.ringSession;\n      this.dismiss();\n    }\n  }\n\n  @proxify\n  async _preLoadImage(url) {\n    await new Promise((resolve, reject) => {\n      const img = new Image();\n      img.src = url;\n      img.onload = resolve;\n      img.onerror = resolve;\n    });\n  }\n\n  @proxify\n  async preLoadImage() {\n    const url = this.guides[0];\n    if (url) {\n      await this._preLoadImage(url);\n    }\n    this.store.dispatch({\n      type: this.actionTypes.preLoadImageStatus,\n    });\n  }\n\n  /**\n   * Using webpack `require.context` to load guides files.\n   * Image files will be ordered by file name ascendingly.\n   * @return {Map<String, Array<URI>>}\n   */\n  resolveGuides() {\n    if (this._context && typeof this._context === 'function') {\n      const locales = Object.keys(SUPPORTED_LOCALES);\n      return this._context\n        .keys()\n        .sort()\n        .map((key) => this._context(key))\n        .reduce((prev, curr) => {\n          locales.forEach((locale) => {\n            if (!prev[locale]) prev[locale] = [];\n            if (contains(locale, curr)) {\n              prev[locale].push(curr);\n            }\n          });\n          return prev;\n        }, {});\n    }\n    return {};\n  }\n\n  @proxify\n  dismiss() {\n    this.updateCarousel({\n      curIdx: 0,\n      entered: false,\n      playing: false,\n      firstLogin: false,\n    });\n  }\n\n  @proxify\n  async loadGuides(guides) {\n    if (guides) {\n      this.store.dispatch({\n        type: this.actionTypes.loadGuides,\n        guides,\n      });\n    }\n  }\n\n  @proxify\n  async updateCarousel({\n    curIdx,\n    entered,\n    playing,\n    firstLogin = this.state.firstLogin,\n  }) {\n    this.store.dispatch({\n      type: this.actionTypes.updateCarousel,\n      curIdx,\n      entered,\n      playing,\n      firstLogin,\n    });\n  }\n\n  @proxify\n  async initUserGuide() {\n    if (!this._rolesAndPermissions.hasUserGuidePermission) return;\n    // eslint-disable-next-line\n    const prevGuides = this.allGuides;\n    const guides = this.resolveGuides();\n    // Determine if it needs to be displayed when first log in,\n    // the principles behind this is to use webpack's file hash,\n    // i.e. if any of the guide files is changed, the file name hash\n    // will be changed as well, in this case, it will be displayed.\n    await this.loadGuides(guides);\n    if (JSON.stringify(guides) !== JSON.stringify(prevGuides)) {\n      this.start({ firstLogin: true });\n    }\n  }\n\n  @proxify\n  async start({ firstLogin = false } = {}) {\n    // Start guides only when images are ready\n    this.store.dispatch({\n      type: this.actionTypes.updateCarousel,\n      curIdx: 0,\n      entered: true,\n      playing: true,\n      firstLogin,\n    });\n  }\n\n  get guides() {\n    if (!this._locale.ready) return [];\n    if (this.allGuides) {\n      const currentGuides = this.allGuides[this._locale.currentLocale];\n      if (currentGuides && currentGuides.length > 0) return currentGuides;\n      return this.allGuides[SUPPORTED_LOCALES['en-US']] || [];\n    }\n    return [];\n  }\n\n  get allGuides() {\n    if (!this._storage.ready) return null;\n    return this._storage.getItem(this._storageKey);\n  }\n\n  get carouselState() {\n    return this.state.carouselState;\n  }\n\n  get started() {\n    return this.carouselState.entered && this.carouselState.playing;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get preLoadImageStatus() {\n    return this.state.preLoadImageStatus;\n  }\n}\n"],"file":"index.js"}