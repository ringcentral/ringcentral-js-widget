{"version":3,"sources":["modules/OAuth/index.js"],"names":["OAuth","name","deps","dep","optional","loginPath","redirectUri","routerInteraction","options","_routerInteraction","_loginPath","_loginWindow","_redirectCheckTimeout","_uuid","uuid","v4","window","addEventListener","close","error","data","callbackUri","_clearRedirectCheckTimeout","_handleCallbackUri","e","key","callbackUriStorageKey","newValue","localStorage","removeItem","ready","_auth","loggedIn","currentPath","oAuthReady","setupOAuth","destroyOAuth","oAuthCallback","store","dispatch","type","actionTypes","oAuthUri","isRedirectUriSameOrigin","_setupRedirectCheckTimeout","clearTimeout","setTimeout","closed","location","href","indexOf","origin","btoa","Date","now","prefix","encodeURIComponent","OAuthBase","background","proxify"],"mappings":"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","sourcesContent":["import background from 'ringcentral-integration/lib/background';\nimport { Module } from 'ringcentral-integration/lib/di';\nimport proxify from 'ringcentral-integration/lib/proxy/proxify';\nimport ensureExist from 'ringcentral-integration/lib/ensureExist';\nimport uuid from 'uuid';\n\nimport popWindow from '../../lib/popWindow';\n\nimport OAuthBase from '../../lib/OAuthBase';\n\n@Module({\n  name: 'OAuth',\n  deps: ['RouterInteraction', { dep: 'OAuthOptions', optional: true }],\n})\nexport default class OAuth extends OAuthBase {\n  constructor({\n    loginPath = '/',\n    redirectUri = './redirect.html',\n    routerInteraction,\n    ...options\n  }) {\n    super({\n      redirectUri,\n      ...options,\n    });\n    this._routerInteraction = ensureExist(\n      routerInteraction,\n      'routerInteraction',\n    );\n    this._loginPath = loginPath;\n    this._loginWindow = null;\n    this._redirectCheckTimeout = null;\n    this._uuid = uuid.v4();\n  }\n\n  initialize() {\n    super.initialize();\n    // close login window when unload and login window exist\n    window.addEventListener('beforeunload', () => {\n      if (this._loginWindow) {\n        try {\n          this._loginWindow.close();\n        } catch (error) {\n          /* ignore error */\n        }\n      }\n    });\n    // listen callback uri from redirect page, works with coss origin redirect page\n    window.addEventListener('message', ({ data = {} }) => {\n      if (!data) {\n        return;\n      }\n      const { callbackUri } = data;\n      if (callbackUri) {\n        this._clearRedirectCheckTimeout();\n        this._handleCallbackUri(callbackUri);\n      }\n    });\n    // listen callback uri from storage, works only with same origin\n    window.addEventListener('storage', (e) => {\n      if (\n        e.key === this.callbackUriStorageKey &&\n        e.newValue &&\n        e.newValue !== ''\n      ) {\n        const callbackUri = e.newValue;\n        localStorage.removeItem(this.callbackUriStorageKey);\n        this._clearRedirectCheckTimeout();\n        this._handleCallbackUri(callbackUri);\n      }\n    });\n  }\n\n  _onStateChange() {\n    super._onStateChange();\n    if (\n      this.ready &&\n      !this._auth.loggedIn &&\n      this._routerInteraction.currentPath === this._loginPath &&\n      !this.oAuthReady\n    ) {\n      this.setupOAuth();\n    }\n    if (\n      this._auth.loggedIn ||\n      this._routerInteraction.currentPath !== this._loginPath\n    ) {\n      this.destroyOAuth();\n    }\n  }\n\n  get name() {\n    return 'OAuth';\n  }\n\n  @background\n  async setupOAuth() {\n    if (!this.oAuthReady) {\n      window.oAuthCallback = (callbackUri) => {\n        this._clearRedirectCheckTimeout();\n        this._handleCallbackUri(callbackUri);\n      };\n      this.store.dispatch({\n        type: this.actionTypes.setupOAuth,\n      });\n    }\n  }\n\n  @background\n  async destroyOAuth() {\n    if (this.oAuthReady) {\n      window.oAuthCallback = null;\n      this.store.dispatch({\n        type: this.actionTypes.destroyOAuth,\n      });\n    }\n  }\n\n  @proxify\n  openOAuthPage() {\n    if (this.oAuthReady) {\n      this._loginWindow = popWindow(this.oAuthUri, 'rc-oauth', 600, 600);\n      if (this.isRedirectUriSameOrigin) {\n        this._setupRedirectCheckTimeout();\n      }\n    }\n  }\n\n  _clearRedirectCheckTimeout() {\n    if (this._redirectCheckTimeout === null) {\n      return;\n    }\n    clearTimeout(this._redirectCheckTimeout);\n  }\n\n  _setupRedirectCheckTimeout() {\n    this._clearRedirectCheckTimeout();\n    this._redirectCheckTimeout = setTimeout(() => {\n      this._redirectCheckTimeout = null;\n      if (\n        !this._loginWindow ||\n        !this._loginWindow.window ||\n        this._loginWindow.closed\n      ) {\n        this._loginWindow = null;\n        return;\n      }\n      try {\n        const callbackUri = this._loginWindow.location.href;\n        if (callbackUri.indexOf(this.redirectUri) !== -1) {\n          this._loginWindow.close();\n          this._loginWindow = null;\n          this._handleCallbackUri(callbackUri);\n          return;\n        }\n      } catch (e) {\n        // ignore e\n        // console.log('checking redirect uri');\n      }\n      this._setupRedirectCheckTimeout();\n    }, 1000);\n  }\n\n  get isRedirectUriSameOrigin() {\n    return this.redirectUri.indexOf(window.origin) === 0;\n  }\n\n  get authState() {\n    return `${btoa(Date.now())}-${this.prefix}-${encodeURIComponent(\n      btoa(this._uuid),\n    )}`;\n  }\n\n  get callbackUriStorageKey() {\n    return `${this.prefix}-${encodeURIComponent(btoa(this._uuid))}-callbackUri`;\n  }\n}\n"],"file":"index.js"}