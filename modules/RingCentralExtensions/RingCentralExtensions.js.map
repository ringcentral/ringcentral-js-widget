{"version":3,"sources":["modules/RingCentralExtensions/RingCentralExtensions.ts"],"names":["RingCentralExtensions","name","deps","dep","optional","_sdk","_core","_webSocketExtension","_currentWs","_onSignedIn","_setLoggedIn","_onSignedOff","_syncWsStatusHandler","_syncWebSocketReadyState","CoreExtension","debugMode","debugExtension","DebugExtension","_deps","ringCentralExtensionsOptions","debugOptions","installExtension","client","service","rcSdkExtension","RcSdkExtension","rcSdk","WebSocketExtension","webSocketOptions","console","error","platform","addListener","events","loginSuccess","loginError","logoutSuccess","logoutError","refreshSuccess","refreshError","removeListener","_setupInfra","_exposeConnectionEvents","eventEmitter","Events","newWebSocketObject","options","autoRecover","autoRecoverSuccess","autoRecoverFailed","sleepDetector","on","detected","ready","recoverWebSocketConnection","isLoggedIn","revokeWebSocketConnection","ex","_bindPlatformEvents","loggedIn","_unbindPlatformEvents","recover","revoke","removeEventListener","ws","addEventListener","readyState","WebSocket","CONNECTING","webSocketReadyState","webSocketReadyStates","connecting","OPEN","open","CLOSING","closing","CLOSED","closed","log","RcModuleV2","action","state","proxify"],"mappings":"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","sourcesContent":["import { SDK } from '@ringcentral/sdk';\nimport CoreExtension from '@rc-ex/core';\nimport DebugExtension from '@rc-ex/debug';\nimport RcSdkExtension from '@rc-ex/rcsdk';\nimport WebSocketExtension, { Events } from '@rc-ex/ws';\n\nimport {\n  RcModuleV2,\n  state,\n  action,\n  watch,\n} from '@ringcentral-integration/core';\nimport WebSocket from 'isomorphic-ws';\nimport { proxify } from '../../lib/proxy/proxify';\nimport { Module } from '../../lib/di';\nimport {\n  WebSocketReadyState,\n  webSocketReadyStates,\n} from './webSocketReadyStates';\nimport { Deps } from './RingCentralExtensions.interface';\n\n@Module({\n  name: 'RingCentralExtensions',\n  deps: [\n    'Client',\n    { dep: 'SleepDetector', optional: true },\n    { dep: 'RingCentralExtensionsOptions', optional: true },\n  ],\n})\nexport class RingCentralExtensions extends RcModuleV2<Deps> {\n  // infra\n  private _sdk: SDK;\n  private _core: CoreExtension;\n  private _webSocketExtension: WebSocketExtension;\n  // refs\n  private _currentWs: WebSocket;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n    });\n  }\n\n  private async _setupInfra() {\n    this._core = new CoreExtension();\n\n    // install DebugExtension\n    if (this.debugMode) {\n      const debugExtension = new DebugExtension(\n        this._deps.ringCentralExtensionsOptions?.debugOptions,\n      );\n      await this._core.installExtension(debugExtension);\n    }\n\n    // install RcSdkExtension\n    this._sdk = this._deps.client.service;\n    const rcSdkExtension = new RcSdkExtension({ rcSdk: this._sdk });\n    await this._core.installExtension(rcSdkExtension);\n\n    // install WebSocketExtension\n    this._webSocketExtension = new WebSocketExtension(\n      this._deps.ringCentralExtensionsOptions?.webSocketOptions,\n    );\n    try {\n      await this._core.installExtension(this._webSocketExtension);\n    } catch (ex) {\n      // It tries to establish connection on install.\n      // Catch the connection issue and ignore.\n      console.error('[RingCentralExtensions] Establish websocket failed', ex);\n    }\n  }\n\n  private _onSignedIn = () => {\n    this._setLoggedIn(true);\n  };\n\n  private _onSignedOff = () => {\n    this._setLoggedIn(false);\n  };\n\n  private _bindPlatformEvents() {\n    const platform = this._sdk.platform();\n    platform.addListener(platform.events.loginSuccess, this._onSignedIn);\n    platform.addListener(platform.events.loginError, this._onSignedOff);\n    platform.addListener(platform.events.logoutSuccess, this._onSignedOff);\n    platform.addListener(platform.events.logoutError, this._onSignedOff);\n    platform.addListener(platform.events.refreshSuccess, this._onSignedIn);\n    platform.addListener(platform.events.refreshError, this._onSignedOff);\n  }\n\n  private _unbindPlatformEvents() {\n    const platform = this._sdk.platform();\n    platform.removeListener(platform.events.loginSuccess, this._onSignedIn);\n    platform.removeListener(platform.events.loginError, this._onSignedOff);\n    platform.removeListener(platform.events.logoutSuccess, this._onSignedOff);\n    platform.removeListener(platform.events.logoutError, this._onSignedOff);\n    platform.removeListener(platform.events.refreshSuccess, this._onSignedIn);\n    platform.removeListener(platform.events.refreshError, this._onSignedOff);\n  }\n\n  async onInitOnce() {\n    await this._setupInfra();\n\n    // expose WebSocket events\n    this._exposeConnectionEvents();\n    this._webSocketExtension.eventEmitter.addListener(\n      Events.newWebSocketObject,\n      () => {\n        this._exposeConnectionEvents();\n      },\n    );\n    if (this._webSocketExtension.options.autoRecover) {\n      this._webSocketExtension.eventEmitter.addListener(\n        Events.autoRecoverSuccess,\n        () => {\n          this._exposeConnectionEvents();\n        },\n      );\n      this._webSocketExtension.eventEmitter.addListener(\n        Events.autoRecoverFailed,\n        () => {\n          this._exposeConnectionEvents();\n        },\n      );\n    }\n\n    // register SleepDetector\n    this._deps.sleepDetector?.on(\n      this._deps.sleepDetector.events.detected,\n      async () => {\n        if (this.ready) {\n          await this.recoverWebSocketConnection();\n        }\n      },\n    );\n\n    watch(\n      this,\n      () => this.isLoggedIn,\n      () => {\n        if (!this.ready) {\n          return;\n        }\n        try {\n          if (this.isLoggedIn) {\n            this.recoverWebSocketConnection();\n          } else {\n            this.revokeWebSocketConnection();\n          }\n        } catch (ex) {\n          console.error('[RingCentralExtensions]', ex);\n        }\n      },\n    );\n  }\n\n  async onInit() {\n    this._bindPlatformEvents();\n    const platform = this._sdk.platform();\n    const loggedIn = await platform.loggedIn();\n    this._setLoggedIn(loggedIn);\n  }\n\n  async onReset() {\n    this._unbindPlatformEvents();\n  }\n\n  @action\n  private _setLoggedIn(loggedIn: boolean) {\n    this.isLoggedIn = loggedIn;\n  }\n\n  @state\n  isLoggedIn: boolean = false;\n\n  @proxify\n  async recoverWebSocketConnection() {\n    await this._webSocketExtension.recover();\n    this._exposeConnectionEvents();\n  }\n\n  @proxify\n  async revokeWebSocketConnection() {\n    await this._webSocketExtension.revoke();\n    this._exposeConnectionEvents();\n  }\n\n  private _exposeConnectionEvents() {\n    if (this._currentWs) {\n      this._currentWs.removeEventListener('close', this._syncWsStatusHandler);\n      this._currentWs.removeEventListener('open', this._syncWsStatusHandler);\n      this._currentWs.removeEventListener('error', this._syncWsStatusHandler);\n      this._currentWs = null;\n    }\n    this._currentWs = this._webSocketExtension.ws;\n    if (this._currentWs) {\n      this._currentWs.addEventListener('close', this._syncWsStatusHandler);\n      this._currentWs.addEventListener('open', this._syncWsStatusHandler);\n      this._currentWs.addEventListener('error', this._syncWsStatusHandler);\n    }\n    this._syncWebSocketReadyState();\n  }\n\n  private _syncWsStatusHandler = () => {\n    this._syncWebSocketReadyState();\n  };\n\n  @action\n  private _syncWebSocketReadyState() {\n    const readyState = this._webSocketExtension.ws?.readyState;\n    switch (readyState) {\n      case WebSocket.CONNECTING:\n        this.webSocketReadyState = webSocketReadyStates.connecting;\n        break;\n      case WebSocket.OPEN:\n        this.webSocketReadyState = webSocketReadyStates.open;\n        break;\n      case WebSocket.CLOSING:\n        this.webSocketReadyState = webSocketReadyStates.closing;\n        break;\n      case WebSocket.CLOSED:\n        this.webSocketReadyState = webSocketReadyStates.closed;\n        break;\n      default:\n        this.webSocketReadyState = null;\n        break;\n    }\n    console.log(\n      `[RingCentralExtensions] > webSocketReadyState > ${this.webSocketReadyState}`,\n    );\n  }\n\n  @state\n  webSocketReadyState?: WebSocketReadyState = null;\n\n  get debugMode(): boolean {\n    return this._deps.ringCentralExtensionsOptions?.debugMode ?? false;\n  }\n\n  get sdk(): SDK {\n    return this._sdk;\n  }\n\n  get core(): CoreExtension {\n    return this._core;\n  }\n\n  get webSocketExtension(): WebSocketExtension {\n    return this._webSocketExtension;\n  }\n}\n"],"file":"RingCentralExtensions.js"}