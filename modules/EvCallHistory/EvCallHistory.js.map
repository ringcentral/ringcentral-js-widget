{"version":3,"sources":["modules/EvCallHistory/EvCallHistory.ts"],"names":["EvCallHistory","name","deps","dep","optional","that","rawCalls","contactMatches","activityMatches","formattedCalls","_deps","contactMatcher","addQuerySource","getQueriesFn","uniqueIdentifies","readyCheckFn","evCallMonitor","ready","activityMatcher","callLogsIds","phoneNumber","countryCode","currentLocale","locale","now","lastWeekDay","clone","subtract","startOf","valueOf","evSubscription","subscribe","EvCallbackTypes","DIRECT_AGENT_TRANSFER_NOTIF","data","status","directTransferNotificationTypes","VOICEMAIL","dataMapping","callLogs","callsMapping","lastWeekDayTimestamp","_getLastWeekDayTimestamp","calls","slice","filter","call","timestamp","map","contactMatchIdentify","ani","callType","id","getCallId","session","direction","toLowerCase","callDirection","outbound","inbound","agent","agentId","_formatPhoneNumber","length","activity","matched","find","match","contact","from","to","fromName","toName","fromMatches","toMatches","startTime","RcModuleV2"],"mappings":"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","sourcesContent":["import moment from 'moment';\nimport { computed, RcModuleV2 } from '@ringcentral-integration/core';\nimport { Module } from 'ringcentral-integration/lib/di';\nimport { callDirection } from 'ringcentral-integration/enums/callDirections';\n\nimport { directTransferNotificationTypes } from '../../enums/directTransferNotificationTypes';\nimport { makeCallsUniqueIdentifies } from '../../lib/callUniqueIdentifies';\nimport { contactMatchIdentifyEncode } from '../../lib/contactMatchIdentify';\nimport { EvCallbackTypes } from '../../lib/EvClient/enums/callbackTypes';\nimport { CallHistory, Deps } from './EvCallHistory.interface';\nimport { formatPhoneNumber } from '../../lib/FormatPhoneNumber';\n\n@Module({\n  name: 'EvCallHistory',\n  deps: [\n    'EvCallMonitor',\n    'EvSubscription',\n    'Locale',\n    { dep: 'ContactMatcher', optional: true },\n    { dep: 'ActivityMatcher', optional: true },\n  ],\n})\nclass EvCallHistory extends RcModuleV2<Deps> implements CallHistory {\n  constructor(deps: Deps) {\n    super({\n      deps,\n    });\n    this._deps.contactMatcher?.addQuerySource({\n      getQueriesFn: () => this.uniqueIdentifies,\n      readyCheckFn: () => this._deps.evCallMonitor.ready,\n    });\n    this._deps.activityMatcher?.addQuerySource({\n      getQueriesFn: () => this.callLogsIds,\n      readyCheckFn: () => this._deps.evCallMonitor.ready,\n    });\n  }\n\n  // TODO: dataMapping type\n  get contactMatches(): any {\n    return this._deps.contactMatcher.dataMapping || {};\n  }\n\n  get activityMatches() {\n    return this._deps.activityMatcher.dataMapping || {};\n  }\n\n  get rawCalls() {\n    return this._deps.evCallMonitor.callLogs;\n  }\n\n  get callLogsIds() {\n    return this._deps.evCallMonitor.callLogsIds;\n  }\n\n  get callsMapping() {\n    return this._deps.evCallMonitor.callsMapping;\n  }\n\n  @computed((that: EvCallHistory) => [\n    that.rawCalls,\n    that.contactMatches,\n    that.activityMatches,\n  ])\n  get formattedCalls() {\n    const lastWeekDayTimestamp = this._getLastWeekDayTimestamp();\n    // max 250 and 7 days\n    const calls = this.rawCalls\n      .slice(0, 250)\n      .filter((call) => call.timestamp >= lastWeekDayTimestamp);\n\n    return calls.map((call) => {\n      const contactMatchIdentify = contactMatchIdentifyEncode({\n        phoneNumber: call.ani,\n        callType: call.callType,\n      });\n\n      const id = this._deps.evCallMonitor.getCallId(call.session);\n      const direction =\n        call.callType.toLowerCase() === 'outbound'\n          ? callDirection.outbound\n          : callDirection.inbound;\n      const contactMatches = this.contactMatches[contactMatchIdentify] || [];\n      const activityMatches = this.activityMatches[id] || [];\n      const agent = {\n        name: call.agentId,\n        phoneNumber: this._formatPhoneNumber(call.agentId),\n      };\n\n      let name = '';\n      if (contactMatches.length && activityMatches.length) {\n        // need to convert 18 digit ID to 15 for compatible in classic mode\n        // https://developer.salesforce.com/forums/?id=906F0000000BQGnIAO\n        const activity = activityMatches[0].slice(0, 15);\n        const matched = contactMatches.find(\n          (match: { id: string }) => match.id.slice(0, 15) === activity,\n        );\n        if (matched) {\n          name = matched.name;\n        }\n      }\n      const contact = {\n        name,\n        phoneNumber: this._formatPhoneNumber(call.ani),\n      };\n\n      return {\n        id,\n        direction,\n        from: direction === callDirection.outbound ? agent : contact,\n        to: direction === callDirection.outbound ? contact : agent,\n        fromName:\n          direction === callDirection.outbound\n            ? agent.name || agent.phoneNumber\n            : contact.name || contact.phoneNumber,\n        toName:\n          direction === callDirection.outbound\n            ? contact.name || contact.phoneNumber\n            : agent.name || agent.phoneNumber,\n        fromMatches: contactMatches,\n        toMatches: contactMatches,\n        activityMatches,\n        startTime: call.timestamp,\n      };\n    });\n  }\n\n  private _formatPhoneNumber(phoneNumber: string) {\n    // TODO: support countryCode\n    return formatPhoneNumber({\n      phoneNumber,\n      countryCode: 'US',\n      currentLocale: this._deps.locale.currentLocale,\n    });\n  }\n\n  @computed((that: EvCallHistory) => [that.formattedCalls])\n  get lastEndedCall() {\n    return this.formattedCalls.length > 0 ? this.formattedCalls[0] : null;\n  }\n\n  @computed((that: EvCallHistory) => [that.rawCalls])\n  get uniqueIdentifies() {\n    return makeCallsUniqueIdentifies(this.rawCalls);\n  }\n\n  private _getLastWeekDayTimestamp() {\n    const now = moment();\n    const lastWeekDay = now.clone().subtract(7, 'days').startOf('day');\n    return lastWeekDay.valueOf();\n  }\n\n  onInitOnce() {\n    this._deps.evSubscription.subscribe(\n      EvCallbackTypes.DIRECT_AGENT_TRANSFER_NOTIF,\n      (data) => {\n        if (data.status === directTransferNotificationTypes.VOICEMAIL) {\n          // TODO add `data` for list and alert message about 'Direct Transfer: data.ani, Click to view call detail.'\n        }\n      },\n    );\n  }\n}\n\nexport { EvCallHistory };\n"],"file":"EvCallHistory.js"}