{"version":3,"sources":["modules/Locale/Locale.ts"],"names":["Locale","deps","dep","optional","defaultLocale","DEFAULT_LOCALE","detectBrowser","polling","pollingInterval","options","_defaultLocale","_detectBrowser","_polling","_pollingInterval","setLocale","browserLocale","store","dispatch","type","actionTypes","initSuccess","_syncBrowserLocale","debugMode","currentLocale","setTimeout","proxyInit","_setLocale","proxyInitSuccess","subscribe","state","proxyState","proxyLocale","syncProxyLocale","locale","toggleDebugMode","PSEUDO_LOCALE","I18n","formatMessage","setup","setLocaleSuccess","setLocaleError","error","Enum","Object","keys","moduleActionTypes","proxyActionTypes","status","_transport","RcModule","proxify"],"mappings":"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","sourcesContent":["import formatMessage from 'format-message';\nimport { combineReducers } from 'redux';\nimport I18n, {\n  DEFAULT_LOCALE,\n  PSEUDO_LOCALE,\n} from '@ringcentral-integration/i18n';\nimport RcModule from '../../lib/RcModule';\nimport proxify from '../../lib/proxy/proxify';\nimport { Module } from '../../lib/di';\nimport {\n  getCurrentLocaleReducer,\n  getProxyLocaleReducer,\n  getToggleDebugMode,\n} from './reducers';\nimport getModuleStatusReducer from '../../lib/getModuleStatusReducer';\nimport getProxyStatusReducer from '../../lib/getProxyStatusReducer';\nimport detectBrowserLocale from '../../lib/detectBrowserLocale';\nimport Enum from '../../lib/Enum';\nimport { moduleActionTypes } from '../../enums/moduleActionTypes';\nimport proxyActionTypes from '../../enums/proxyActionTypes';\n\n/**\n * @class\n * @description Locale managing module\n */\n@Module({\n  deps: [{ dep: 'LocaleOptions', optional: true }],\n})\nexport default class Locale extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {String} params.defaultLocale - default 'en-US'\n   */\n  constructor({\n    defaultLocale = DEFAULT_LOCALE,\n    detectBrowser = true,\n    polling = false,\n    pollingInterval = 2000,\n    ...options\n  } = {}) {\n    super({\n      ...options,\n    });\n    this._defaultLocale = defaultLocale;\n    this._detectBrowser = detectBrowser;\n    this._polling = polling;\n    this._pollingInterval = pollingInterval;\n  }\n\n  get _actionTypes() {\n    return new Enum(\n      [\n        ...Object.keys(moduleActionTypes),\n        ...Object.keys(proxyActionTypes),\n        'setLocale',\n        'setLocaleSuccess',\n        'setLocaleError',\n        'syncProxyLocale',\n        'toggleDebugMode',\n      ],\n      'locale',\n    );\n  }\n\n  get reducer() {\n    return combineReducers({\n      status: getModuleStatusReducer(this.actionTypes),\n      currentLocale: getCurrentLocaleReducer(this.actionTypes),\n      debugMode: getToggleDebugMode(this.actionTypes),\n    });\n  }\n\n  get proxyReducer() {\n    return combineReducers({\n      status: getProxyStatusReducer(this.actionTypes),\n      proxyLocale: getProxyLocaleReducer(this.actionTypes),\n    });\n  }\n\n  async initialize() {\n    await this.setLocale(\n      this._detectBrowser ? this.browserLocale : this._defaultLocale,\n    );\n    this.store.dispatch({\n      type: this.actionTypes.initSuccess,\n    });\n    if (this._polling) {\n      this._syncBrowserLocale();\n    }\n  }\n\n  async _syncBrowserLocale() {\n    if (!this.debugMode && this.browserLocale !== this.currentLocale) {\n      await this.setLocale(this.browserLocale);\n    }\n    setTimeout(() => this._syncBrowserLocale(), this._pollingInterval);\n  }\n\n  async initializeProxy() {\n    this.store.dispatch({\n      type: this.actionTypes.proxyInit,\n    });\n    await this._setLocale(this.currentLocale);\n    this.store.dispatch({\n      type: this.actionTypes.proxyInitSuccess,\n    });\n    this.store.subscribe(async () => {\n      if (this.state.currentLocale !== this.proxyState.proxyLocale) {\n        await this._setLocale(this.state.currentLocale);\n        this.store.dispatch({\n          type: this.actionTypes.syncProxyLocale,\n          locale: this.state.currentLocale,\n        });\n      }\n    });\n  }\n\n  /**\n   * @property {String} currentLocale\n   */\n  get currentLocale() {\n    return (\n      (this._transport &&\n        this.proxyState &&\n        (this.proxyState.proxyLocale || this._defaultLocale)) ||\n      this.state.currentLocale ||\n      this._defaultLocale\n    );\n  }\n\n  get browserLocale() {\n    return detectBrowserLocale(this._defaultLocale);\n  }\n\n  get status() {\n    return (this.proxyState && this.proxyState.status) || this.state.status;\n  }\n\n  get proxyStatus() {\n    return this.proxyState.status;\n  }\n\n  get debugMode() {\n    return this.state.debugMode;\n  }\n\n  @proxify\n  async toggleDebugMode() {\n    this.store.dispatch({\n      type: this.actionTypes.toggleDebugMode,\n      debugMode: this.debugMode,\n    });\n    if (this.debugMode) {\n      this.setLocale(PSEUDO_LOCALE);\n    }\n  }\n\n  async _setLocale(locale) {\n    await I18n.setLocale(locale);\n    formatMessage.setup({\n      locale:\n        this.currentLocale === PSEUDO_LOCALE\n          ? DEFAULT_LOCALE\n          : this.currentLocale,\n    });\n  }\n\n  /**\n   *  @function\n   *  @description Sets the desired locale as the current locale. This will also\n   *    set all I18n instances to the same locale, as well as set formatMessage to use\n   *    the same locale.\n   *  @param {String} locale\n   *  @return {Promise}\n   */\n  @proxify\n  async setLocale(locale) {\n    this.store.dispatch({\n      type: this.actionTypes.setLocale,\n      locale,\n    });\n    try {\n      await this._setLocale(locale);\n      this.store.dispatch({\n        type: this.actionTypes.setLocaleSuccess,\n        locale,\n      });\n    } catch (error) {\n      this.store.dispatch({\n        type: this.actionTypes.setLocaleError,\n        error,\n      });\n    }\n  }\n}\n"],"file":"Locale.js"}