{"version":3,"sources":["modules/Locale/Locale.ts"],"names":["Locale","deps","dep","optional","brand","defaultLocale","DEFAULT_LOCALE","detectBrowser","polling","pollingInterval","options","_defaultLocale","_detectBrowser","_polling","_pollingInterval","_transport","_brand","I18n","setDefaultLocale","setLocale","browserLocale","store","dispatch","type","actionTypes","initSuccess","_syncBrowserLocale","inputLocale","locale","target","_supportedLocales","map","item","find","split","debugMode","currentLocale","setTimeout","proxyInit","_setLocale","proxyInitSuccess","subscribe","state","proxyState","proxyLocale","syncProxyLocale","toggleDebugMode","PSEUDO_LOCALE","formatMessage","setup","setLocaleSuccess","setLocaleError","error","brandConfig","supportedLocales","ObjectMap","prefixKeys","keys","moduleActionTypes","proxyActionTypes","status","RcModule","proxify"],"mappings":"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","sourcesContent":["import formatMessage from 'format-message';\nimport { ObjectMap } from '@ringcentral-integration/core/lib/ObjectMap';\nimport { combineReducers } from 'redux';\nimport I18n, {\n  DEFAULT_LOCALE,\n  PSEUDO_LOCALE,\n} from '@ringcentral-integration/i18n';\nimport RcModule from '../../lib/RcModule';\nimport proxify from '../../lib/proxy/proxify';\nimport { Module } from '../../lib/di';\nimport {\n  getCurrentLocaleReducer,\n  getProxyLocaleReducer,\n  getToggleDebugMode,\n} from './reducers';\nimport getModuleStatusReducer from '../../lib/getModuleStatusReducer';\nimport getProxyStatusReducer from '../../lib/getProxyStatusReducer';\nimport detectBrowserLocale from '../../lib/detectBrowserLocale';\nimport { moduleActionTypes } from '../../enums/moduleActionTypes';\nimport { proxyActionTypes } from '../../enums/proxyActionTypes';\nimport formatLocale from '@ringcentral-integration/i18n/lib/formatLocale';\n\n/**\n * @class\n * @description Locale managing module\n */\n@Module({\n  deps: ['Brand', { dep: 'LocaleOptions', optional: true }],\n})\nexport default class Locale extends RcModule {\n  _defaultLocale: string;\n  _detectBrowser: boolean;\n  _polling: boolean;\n  _pollingInterval: number;\n  _transport: any;\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {String} params.defaultLocale - default 'en-US'\n   */\n  constructor({\n    brand,\n    defaultLocale = DEFAULT_LOCALE,\n    detectBrowser = true,\n    polling = false,\n    pollingInterval = 2000,\n    ...options\n  } = {}) {\n    super({\n      ...options,\n    });\n    this._brand = brand;\n    this._defaultLocale = defaultLocale;\n    this._detectBrowser = detectBrowser;\n    this._polling = polling;\n    this._pollingInterval = pollingInterval;\n    I18n.setDefaultLocale(this._defaultLocale);\n  }\n\n  _onStateChange() {\n    /* do nothing */\n  }\n\n  get _supportedLocales() {\n    return this._brand.brandConfig?.supportedLocales ?? [this._defaultLocale];\n  }\n\n  get _actionTypes() {\n    return ObjectMap.prefixKeys(\n      [\n        ...ObjectMap.keys(moduleActionTypes),\n        ...ObjectMap.keys(proxyActionTypes),\n        'setLocale',\n        'setLocaleSuccess',\n        'setLocaleError',\n        'syncProxyLocale',\n        'toggleDebugMode',\n      ],\n      'locale',\n    );\n  }\n\n  get reducer() {\n    return combineReducers({\n      status: getModuleStatusReducer(this.actionTypes),\n      currentLocale: getCurrentLocaleReducer(this.actionTypes),\n      debugMode: getToggleDebugMode(this.actionTypes),\n    });\n  }\n\n  get proxyReducer() {\n    return combineReducers({\n      status: getProxyStatusReducer(this.actionTypes),\n      proxyLocale: getProxyLocaleReducer(this.actionTypes),\n    });\n  }\n\n  async initialize() {\n    await this.setLocale(\n      this._detectBrowser ? this.browserLocale : this._defaultLocale,\n    );\n    this.store.dispatch({\n      type: this.actionTypes.initSuccess,\n    });\n    if (this._polling) {\n      this._syncBrowserLocale();\n    }\n  }\n\n  normalizeLocale(inputLocale: string) {\n    const locale = formatLocale(inputLocale);\n\n    const target = this._supportedLocales\n      .map((item) => formatLocale(item))\n      .find((item) => item === locale || item.split('-')[0] === locale);\n    return target ?? this._defaultLocale;\n  }\n\n  async _syncBrowserLocale() {\n    if (!this.debugMode && this.browserLocale !== this.currentLocale) {\n      await this.setLocale(this.browserLocale);\n    }\n    setTimeout(() => this._syncBrowserLocale(), this._pollingInterval);\n  }\n\n  async initializeProxy() {\n    this.store.dispatch({\n      type: this.actionTypes.proxyInit,\n    });\n    await this._setLocale(this.currentLocale);\n    this.store.dispatch({\n      type: this.actionTypes.proxyInitSuccess,\n    });\n    this.store.subscribe(async () => {\n      if (this.state.currentLocale !== this.proxyState.proxyLocale) {\n        await this._setLocale(this.state.currentLocale);\n        this.store.dispatch({\n          type: this.actionTypes.syncProxyLocale,\n          locale: this.state.currentLocale,\n        });\n      }\n    });\n  }\n\n  /**\n   * @property {String} currentLocale\n   */\n  get currentLocale() {\n    return (\n      (this._transport &&\n        this.proxyState &&\n        (this.proxyState.proxyLocale || this._defaultLocale)) ||\n      this.state.currentLocale ||\n      this._defaultLocale\n    );\n  }\n\n  get browserLocale() {\n    return detectBrowserLocale(this._defaultLocale);\n  }\n\n  get status() {\n    return (this.proxyState && this.proxyState.status) || this.state.status;\n  }\n\n  get proxyStatus() {\n    return this.proxyState.status;\n  }\n\n  get debugMode() {\n    return this.state.debugMode;\n  }\n\n  @proxify\n  async toggleDebugMode() {\n    this.store.dispatch({\n      type: this.actionTypes.toggleDebugMode,\n      debugMode: this.debugMode,\n    });\n    if (this.debugMode) {\n      this.setLocale(PSEUDO_LOCALE);\n    }\n  }\n\n  async _setLocale(locale) {\n    await I18n.setLocale(locale);\n    formatMessage.setup({\n      locale:\n        this.currentLocale === PSEUDO_LOCALE\n          ? DEFAULT_LOCALE\n          : this.currentLocale,\n    });\n  }\n\n  /**\n   *  @function\n   *  @description Sets the desired locale as the current locale. This will also\n   *    set all I18n instances to the same locale, as well as set formatMessage to use\n   *    the same locale.\n   *  @param {String} locale\n   *  @return {Promise}\n   */\n  @proxify\n  async setLocale(locale) {\n    this.store.dispatch({\n      type: this.actionTypes.setLocale,\n      locale,\n    });\n    try {\n      await this._setLocale(locale);\n      this.store.dispatch({\n        type: this.actionTypes.setLocaleSuccess,\n        locale,\n      });\n    } catch (error) {\n      this.store.dispatch({\n        type: this.actionTypes.setLocaleError,\n        error,\n      });\n    }\n  }\n}\n"],"file":"Locale.js"}