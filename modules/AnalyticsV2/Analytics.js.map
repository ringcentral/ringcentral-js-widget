{"version":3,"sources":["modules/AnalyticsV2/Analytics.ts"],"names":["Analytics","name","deps","dep","optional","_useLog","_deps","analyticsOptions","useLog","_lingerThreshold","lingerThreshold","_enablePendo","enablePendo","_trackRouters","trackRouters","_segment","_logs","_lingerTimeout","routerInteraction","trackRouter","currentPath","accountInfo","ready","accountInfoReady","_identify","userId","auth","ownerId","accountId","id","servicePlanId","servicePlan","edition","CRMEnabled","rolesAndPermissions","tierEnabled","target","getTrackTarget","trackNavigation","clearTimeout","setTimeout","trackLinger","analyticsKey","load","integrations","All","Mixpanel","Pendo","props","analytics","identify","companyName","extensionInfo","info","contact","company","event","properties","trackProps","track","push","timeStamp","Date","toISOString","blob","Blob","JSON","stringify","type","router","eventPostfix","appName","brandConfig","appVersion","brand","brandCode","routes","split","formatRoute","needMatchSecondRoutes","length","indexOf","find","global","locale","currentLocale","browserLocale","RcModuleV2"],"mappings":"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","sourcesContent":["import { RcModuleV2, watch } from '@ringcentral-integration/core';\nimport { Segment } from '../../lib/Analytics';\nimport { Module } from '../../lib/di';\nimport saveBlob from '../../lib/saveBlob';\nimport { Deps, TrackLog, TrackProps, TrackRouter } from './Analytics.interface';\nimport { trackRouters } from './analyticsRouters';\n\n// TODO: refactoring the module against `https://docs.google.com/spreadsheets/d/1xufV6-C-RJR6OJgwFYHYzNQwhIdN4BXXCo8ABs7RT-8/edit#gid=1480480736`\n// TODO: if use `dialerUI`/`callLogSection`/`adapter`, make sure they should all be RcModuleV2\n@Module({\n  name: 'Analytics',\n  deps: [\n    'Auth',\n    'BrandConfig',\n    'AnalyticsOptions',\n    { dep: 'AccountInfo', optional: true },\n    { dep: 'ExtensionInfo', optional: true },\n    { dep: 'RolesAndPermissions', optional: true },\n    { dep: 'RouterInteraction', optional: true },\n    { dep: 'Locale', optional: true },\n  ],\n})\nexport class Analytics extends RcModuleV2<Deps> {\n  protected _useLog = this._deps.analyticsOptions.useLog ?? false;\n\n  protected _lingerThreshold =\n    this._deps.analyticsOptions.lingerThreshold ?? 1000;\n\n  protected _enablePendo = this._deps.analyticsOptions.enablePendo ?? false;\n\n  protected _trackRouters =\n    this._deps.analyticsOptions.trackRouters ?? trackRouters;\n\n  private _segment: any;\n\n  protected _logs: TrackLog[] = [];\n\n  protected _lingerTimeout?: NodeJS.Timeout = null;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n    });\n    this._segment = Segment();\n  }\n\n  onInitOnce() {\n    if (this._deps.routerInteraction) {\n      // make sure that track if refresh app\n      this.trackRouter();\n      watch(\n        this,\n        () => this._deps.routerInteraction.currentPath,\n        (currentPath) => {\n          this.trackRouter(currentPath);\n        },\n      );\n    }\n\n    if (this._deps.accountInfo) {\n      watch(\n        this,\n        () => this._deps.accountInfo.ready,\n        (accountInfoReady) => {\n          if (accountInfoReady) {\n            this._identify({\n              userId: this._deps.auth.ownerId,\n              accountId: this._deps.accountInfo.id,\n              servicePlanId: this._deps.accountInfo.servicePlan.id,\n              edition: this._deps.accountInfo.servicePlan.edition,\n              CRMEnabled: this._deps.rolesAndPermissions?.tierEnabled,\n            });\n          }\n        },\n      );\n    }\n  }\n\n  trackRouter(currentPath = this._deps.routerInteraction.currentPath) {\n    const target = this.getTrackTarget(currentPath);\n    if (target) {\n      this.trackNavigation(target);\n    }\n\n    if (this._lingerTimeout) {\n      clearTimeout(this._lingerTimeout);\n    }\n    this._lingerTimeout = setTimeout(() => {\n      this._lingerTimeout = null;\n      if (target && this._deps.routerInteraction.currentPath === currentPath) {\n        this.trackLinger(target);\n      }\n    }, this._lingerThreshold);\n  }\n\n  onInit() {\n    if (this._deps.analyticsOptions.analyticsKey && this._segment) {\n      this._segment.load(this._deps.analyticsOptions.analyticsKey, {\n        integrations: {\n          All: true,\n          Mixpanel: true,\n          Pendo: this._enablePendo,\n        },\n      });\n    }\n  }\n\n  setUserId() {\n    this._identify({\n      userId: this._deps.auth.ownerId,\n    });\n  }\n\n  protected _identify({\n    userId,\n    ...props\n  }: { userId: string } & Record<string, any>) {\n    if (this.analytics) {\n      this.analytics.identify(\n        userId,\n        {\n          ...props,\n          companyName: this._deps.extensionInfo?.info?.contact?.company,\n        },\n        {\n          integrations: {\n            All: true,\n            Mixpanel: true,\n            Pendo: this._enablePendo,\n          },\n        },\n      );\n    }\n  }\n\n  track(event: string, properties: any = {}) {\n    if (!this.analytics) {\n      return;\n    }\n    const trackProps: TrackProps = {\n      ...this.trackProps,\n      ...properties,\n    };\n    this.analytics.track(event, trackProps, {\n      integrations: {\n        All: true,\n        Mixpanel: true,\n        Pendo: this._enablePendo,\n      },\n    });\n    if (this._useLog) {\n      this._logs.push({\n        timeStamp: new Date().toISOString(),\n        event,\n        trackProps,\n      });\n    }\n  }\n\n  downloadLogs() {\n    if (!this._useLog) {\n      return;\n    }\n    const blob = new Blob([JSON.stringify(this._logs, null, 2)], {\n      type: 'application/json',\n    });\n    saveBlob('logs.json', blob);\n  }\n\n  trackNavigation({ router, eventPostfix }: TrackRouter) {\n    const trackProps = {\n      router,\n      appName: this._deps.brandConfig.appName,\n      appVersion: this._deps.analyticsOptions.appVersion,\n      brand: this._deps.brandConfig.brandCode,\n    };\n    this.track(`Navigation: Click/${eventPostfix}`, trackProps);\n  }\n\n  trackLinger({ router, eventPostfix }: TrackRouter) {\n    const trackProps = {\n      router,\n      appName: this._deps.brandConfig.appName,\n      appVersion: this._deps.analyticsOptions.appVersion,\n      brand: this._deps.brandConfig.brandCode,\n    };\n    this.track(`Navigation: View/${eventPostfix}`, trackProps);\n  }\n\n  getTrackTarget(\n    currentPath = this._deps.routerInteraction?.currentPath,\n  ): TrackRouter {\n    if (!currentPath) {\n      return null;\n    }\n    const routes = currentPath.split('/');\n    let formatRoute: string = null;\n    const needMatchSecondRoutes = ['calls'];\n    if (routes.length >= 3 && needMatchSecondRoutes.indexOf(routes[1]) !== -1) {\n      formatRoute = `/${routes[1]}/${routes[2]}`;\n    } else if (routes.length > 1) {\n      formatRoute = `/${routes[1]}`;\n    }\n    const target = this._trackRouters.find(\n      (target) => formatRoute === target.router,\n    );\n    return target;\n  }\n\n  get analytics() {\n    return (global as any).analytics;\n  }\n\n  get trackProps(): TrackProps {\n    return {\n      appName: this._deps.brandConfig.appName,\n      appVersion: this._deps.analyticsOptions.appVersion,\n      brand: this._deps.brandConfig.brandCode,\n      'App Language': this._deps.locale?.currentLocale || '',\n      'Browser Language': this._deps.locale?.browserLocale || '',\n      'Extension Type': this._deps.extensionInfo?.info.type || '',\n    };\n  }\n}\n"],"file":"Analytics.js"}