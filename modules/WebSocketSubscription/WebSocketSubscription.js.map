{"version":3,"sources":["modules/WebSocketSubscription/WebSocketSubscription.ts"],"names":["DEFAULT_REFRESH_DELAY","WebSocketSubscription","deps","dep","optional","_wsSubscription","_debouncedUpdateSubscription","fn","_updateSubscription","threshold","_refreshDelay","readyState","_deps","ringCentralExtensions","webSocketReadyState","webSocketReadyStates","open","closing","_isWebSocketOpened","isOpened","ready","cancel","webSocketExtension","subscribe","filters","message","_notifyMessage","eventFilters","refresh","revoke","length","_revokeSubscription","_createSubscription","map","x","sort","join","subscriptionInfo","_refreshSubscription","eventsFilters","oldLength","_addFilters","_removeFilters","concat","filter","index","array","indexOf","includes","delay","webSocketSubscriptionOptions","refreshDelay","Math","max","RcModuleV2","proxify","action","state"],"mappings":"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","sourcesContent":["import Subscription from '@rc-ex/ws/lib/subscription';\nimport {\n  RcModuleV2,\n  state,\n  action,\n  watch,\n} from '@ringcentral-integration/core';\nimport { Module } from '../../lib/di';\nimport proxify from '../../lib/proxy/proxify';\nimport { debounce } from '../../lib/debounce-throttle';\nimport { SubscriptionFilter } from '../../enums/subscriptionFilters';\nimport { webSocketReadyStates } from '../RingCentralExtensions/webSocketReadyStates';\nimport { normalizeEventFilter } from './normalizeEventFilter';\nimport { Deps } from './WebSocketSubscription.interface';\n\nconst DEFAULT_REFRESH_DELAY = 2 * 1000;\n\n@Module({\n  deps: [\n    'RingCentralExtensions',\n    { dep: 'WebSocketSubscriptionOptions', optional: true },\n  ],\n})\nexport class WebSocketSubscription extends RcModuleV2<Deps> {\n  private _wsSubscription: Subscription;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n    });\n  }\n\n  private _isWebSocketOpened() {\n    const readyState = this._deps.ringCentralExtensions.webSocketReadyState;\n    return (\n      readyState === webSocketReadyStates.open ||\n      readyState === webSocketReadyStates.closing\n    );\n  }\n\n  onInitOnce() {\n    watch(\n      this,\n      () => this._isWebSocketOpened(),\n      (isOpened) => {\n        if (!this.ready) {\n          return;\n        }\n        if (isOpened) {\n          this._debouncedUpdateSubscription();\n        } else {\n          this._debouncedUpdateSubscription.cancel();\n        }\n      },\n    );\n  }\n\n  async onInit() {\n    if (this._isWebSocketOpened()) {\n      await this._debouncedUpdateSubscription();\n    }\n  }\n\n  async onReset() {\n    await this._debouncedUpdateSubscription.cancel();\n    this._wsSubscription = null;\n  }\n\n  private async _createSubscription() {\n    this._wsSubscription = await this._deps.ringCentralExtensions.webSocketExtension.subscribe(\n      this.filters,\n      (message) => {\n        this._notifyMessage(message);\n      },\n    );\n  }\n\n  private async _refreshSubscription() {\n    if (this._wsSubscription) {\n      this._wsSubscription.eventFilters = this.filters;\n      await this._wsSubscription.refresh();\n    }\n  }\n\n  private async _revokeSubscription() {\n    if (this._wsSubscription) {\n      await this._wsSubscription.revoke();\n      this._wsSubscription = null;\n    }\n  }\n\n  private async _updateSubscription() {\n    if (this.filters.length === 0) {\n      await this._revokeSubscription();\n      return;\n    }\n    if (!this._wsSubscription) {\n      await this._createSubscription();\n    } else if (\n      this.filters\n        .map((x) => normalizeEventFilter(x))\n        .sort()\n        .join(',') !==\n      this._wsSubscription.subscriptionInfo?.eventFilters\n        .map((x) => normalizeEventFilter(x))\n        .sort()\n        .join(',')\n    ) {\n      await this._refreshSubscription();\n    }\n  }\n\n  private get _refreshDelay() {\n    const delay = this._deps.webSocketSubscriptionOptions?.refreshDelay;\n    return Math.max(0, delay ?? DEFAULT_REFRESH_DELAY);\n  }\n\n  private _debouncedUpdateSubscription = debounce({\n    fn: this._updateSubscription,\n    threshold: this._refreshDelay,\n  });\n\n  @proxify\n  async subscribe(eventsFilters: SubscriptionFilter[] = []) {\n    if (!this.ready) {\n      return;\n    }\n    const oldLength = this.filters.length;\n    this._addFilters(eventsFilters);\n    if (oldLength !== this.filters.length) {\n      await this._debouncedUpdateSubscription();\n    }\n  }\n\n  @proxify\n  async unsubscribe(eventsFilters: SubscriptionFilter[] = []) {\n    if (!this.ready) {\n      return;\n    }\n    const oldLength = this.filters.length;\n    this._removeFilters(eventsFilters);\n    if (oldLength !== this.filters.length) {\n      await this._debouncedUpdateSubscription();\n    }\n  }\n\n  @action\n  private _addFilters(eventsFilters: SubscriptionFilter[]) {\n    this.filters = this.filters\n      .concat(eventsFilters)\n      .filter((x, index, array) => array.indexOf(x) === index); // remove duplicates\n  }\n\n  @action\n  private _removeFilters(eventsFilters: SubscriptionFilter[]) {\n    this.filters = this.filters.filter((x) => !eventsFilters.includes(x));\n  }\n\n  @action\n  private _notifyMessage(message: any) {\n    this.message = message;\n  }\n\n  @state\n  filters: SubscriptionFilter[] = [];\n\n  @state\n  message: any = null;\n}\n"],"file":"WebSocketSubscription.js"}