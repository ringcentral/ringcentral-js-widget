{"version":3,"sources":["modules/WebSocketSubscription/WebSocketSubscription.ts"],"names":["DEFAULT_REFRESH_DELAY","WebSocketSubscription","deps","dep","optional","_wsExtension","_wsSubscription","_currentWs","_syncWsStatusHandler","_debouncedRefreshSubscription","_syncWebSocketReadyState","fn","_refreshSubscription","threshold","_refreshDelay","_deps","auth","loggedIn","ready","notLoggedIn","rc","RingCentral","sdk","client","service","ringCentralExtension","RingCentralExtension","installExtension","WebSocketExtension","restOverWebSocket","webSocketSubscriptionOptions","debugMode","autoRecover","_exposeConnectionEvents","eventEmitter","on","Events","autoRecoverSuccess","autoRecoverFailed","sleepDetector","events","detected","_recoverConnection","filters","length","cancel","_revokeConnection","recover","revoke","removeEventListener","ws","addEventListener","subscribe","message","_notifyMessage","_createSubscription","map","x","sort","subscriptionInfo","eventFilters","refresh","eventsFilters","oldFilters","_addFilters","_removeFilters","_revokeSubscription","filterMap","concat","filter","f","forEach","wsReadyState","readyState","WebSocket","CONNECTING","webSocketReadyState","connecting","OPEN","open","CLOSING","closing","CLOSED","closed","console","log","Math","max","refreshDelay","RcModuleV2","proxify","action","state"],"mappings":"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","sourcesContent":["import RingCentral from '@rc-ex/core';\nimport RingCentralExtension from '@rc-ex/rcsdk';\nimport WebSocketExtension, { Events } from '@rc-ex/ws';\nimport Subscription from '@rc-ex/ws/lib/subscription';\nimport WebSocket from 'isomorphic-ws';\n\nimport { equals } from 'ramda';\nimport { RcModuleV2, state, action } from '@ringcentral-integration/core';\nimport { Module } from '../../lib/di';\nimport proxify from '../../lib/proxy/proxify';\nimport {\n  promisedDebounce,\n  PromisedDebounceFunction,\n} from '../../lib/debounce-throttle';\n\nimport { normalizeEventFilter } from './normalizeEventFilter';\nimport { webSocketReadyState } from './webSocketReadyState';\nimport { Deps } from './WebSocketSubscription.interface';\n\nconst DEFAULT_REFRESH_DELAY = 2 * 1000;\n\n@Module({\n  deps: [\n    'Client',\n    'Auth',\n    'SleepDetector',\n    { dep: 'WebSocketSubscriptionOptions', optional: true },\n  ],\n})\nexport class WebSocketSubscription extends RcModuleV2<Deps> {\n  private _wsExtension: WebSocketExtension;\n  private _wsSubscription: Subscription;\n\n  private _currentWs: WebSocket;\n  private _syncWsStatusHandler: () => void;\n\n  private _debouncedRefreshSubscription: PromisedDebounceFunction<\n    WebSocketSubscription['_refreshSubscription']\n  >;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n    });\n\n    this._syncWsStatusHandler = () => {\n      this._syncWebSocketReadyState();\n    };\n\n    this._debouncedRefreshSubscription = promisedDebounce({\n      fn: this._refreshSubscription,\n      threshold: this._refreshDelay,\n    });\n  }\n\n  private get _refreshDelay() {\n    return Math.max(\n      0,\n      this._deps.webSocketSubscriptionOptions?.refreshDelay ??\n        DEFAULT_REFRESH_DELAY,\n    );\n  }\n\n  _shouldInit() {\n    return super._shouldInit() && this._deps.auth.loggedIn;\n  }\n\n  _shouldReset() {\n    return super._shouldReset() || (this.ready && this._deps.auth.notLoggedIn);\n  }\n\n  async onInitOnce() {\n    const rc = new RingCentral();\n\n    const sdk = this._deps.client.service;\n    const ringCentralExtension = new RingCentralExtension(sdk);\n    await rc.installExtension(ringCentralExtension);\n\n    this._wsExtension = new WebSocketExtension({\n      restOverWebSocket: this._deps.webSocketSubscriptionOptions\n        ?.restOverWebSocket,\n      debugMode: this._deps.webSocketSubscriptionOptions?.debugMode,\n      autoRecover: this._deps.webSocketSubscriptionOptions?.autoRecover,\n    });\n    await rc.installExtension(this._wsExtension);\n    this._exposeConnectionEvents();\n    if (this._wsExtension.autoRecover) {\n      this._wsExtension.eventEmitter.on(Events.autoRecoverSuccess, () => {\n        this._exposeConnectionEvents();\n      });\n      this._wsExtension.eventEmitter.on(Events.autoRecoverFailed, () => {\n        this._exposeConnectionEvents();\n      });\n    }\n\n    this._deps.sleepDetector.on(\n      this._deps.sleepDetector.events.detected,\n      async () => {\n        if (this.ready) {\n          await this._recoverConnection();\n        }\n      },\n    );\n  }\n\n  async onInit() {\n    if (this.filters.length) {\n      await this._recoverConnection();\n      await this._debouncedRefreshSubscription();\n    }\n  }\n\n  async onReset() {\n    this._debouncedRefreshSubscription.cancel();\n    await this._revokeConnection();\n  }\n\n  private async _recoverConnection() {\n    await this._wsExtension.recover();\n    this._exposeConnectionEvents();\n  }\n\n  private async _revokeConnection() {\n    await this._wsExtension.revoke();\n    this._exposeConnectionEvents();\n  }\n\n  private _exposeConnectionEvents() {\n    if (this._currentWs) {\n      this._currentWs.removeEventListener('close', this._syncWsStatusHandler);\n      this._currentWs.removeEventListener('open', this._syncWsStatusHandler);\n      this._currentWs.removeEventListener('error', this._syncWsStatusHandler);\n    }\n    this._currentWs = this._wsExtension.ws;\n    if (this._currentWs) {\n      this._currentWs.addEventListener('close', this._syncWsStatusHandler);\n      this._currentWs.addEventListener('open', this._syncWsStatusHandler);\n      this._currentWs.addEventListener('error', this._syncWsStatusHandler);\n    }\n    this._syncWebSocketReadyState();\n  }\n\n  private async _createSubscription() {\n    this._wsSubscription = await this._wsExtension.subscribe(\n      this.filters,\n      (message) => {\n        this._notifyMessage(message);\n      },\n    );\n  }\n\n  private async _revokeSubscription() {\n    if (this._wsSubscription) {\n      await this._wsSubscription.revoke();\n      this._wsSubscription = null;\n    }\n  }\n\n  private async _refreshSubscription() {\n    if (!this._wsSubscription) {\n      await this._createSubscription();\n    } else if (\n      !equals(\n        this.filters.map((x) => normalizeEventFilter(x)).sort(),\n        this._wsSubscription.subscriptionInfo?.eventFilters\n          .map((x) => normalizeEventFilter(x))\n          .sort(),\n      )\n    ) {\n      this._wsSubscription.eventFilters = this.filters;\n      await this._wsSubscription.refresh();\n    }\n  }\n\n  @proxify\n  async subscribe(eventsFilters: string[] = []) {\n    if (this.ready) {\n      const oldFilters = this.filters;\n      this._addFilters(eventsFilters);\n      if (oldFilters.length !== this.filters.length) {\n        await this._debouncedRefreshSubscription();\n      }\n    }\n  }\n\n  @proxify\n  async unsubscribe(eventsFilters: string[] = []) {\n    const oldFilters = this.filters;\n    this._removeFilters(eventsFilters);\n    if (this.filters.length === 0) {\n      await this._revokeSubscription();\n    } else if (oldFilters.length !== this.filters.length) {\n      await this._debouncedRefreshSubscription();\n    }\n  }\n\n  @action\n  private _addFilters(eventsFilters: string[]) {\n    const filterMap: { [key: string]: boolean } = {};\n    this.filters = this.filters.concat(eventsFilters).filter((f) => {\n      if (!filterMap[f]) {\n        filterMap[f] = true;\n        return true;\n      }\n      return false;\n    });\n  }\n\n  @action\n  private _removeFilters(eventsFilters: string[]) {\n    const filterMap: { [key: string]: boolean } = {};\n    eventsFilters.forEach((f) => {\n      filterMap[f] = true;\n    });\n    this.filters = this.filters.filter((f) => !filterMap[f]);\n  }\n\n  @action\n  private _notifyMessage(message: any) {\n    this.message = message;\n  }\n\n  @action\n  private _syncWebSocketReadyState() {\n    const wsReadyState = this._wsExtension.ws?.readyState;\n    switch (wsReadyState) {\n      case WebSocket.CONNECTING:\n        this.wsReadyState = webSocketReadyState.connecting;\n        break;\n      case WebSocket.OPEN:\n        this.wsReadyState = webSocketReadyState.open;\n        break;\n      case WebSocket.CLOSING:\n        this.wsReadyState = webSocketReadyState.closing;\n        break;\n      case WebSocket.CLOSED:\n        this.wsReadyState = webSocketReadyState.closed;\n        break;\n      default:\n        this.wsReadyState = null;\n        break;\n    }\n    console.log(this.wsReadyState);\n  }\n\n  @state\n  filters: string[] = [];\n\n  @state\n  message: any = null;\n\n  @state\n  wsReadyState: string = null;\n}\n"],"file":"WebSocketSubscription.js"}