{"version":3,"sources":["modules/EvWorkingState/EvWorkingState.ts"],"names":["PendingDisposition","rank","agentState","agentAuxState","EvWorkingState","name","deps","dep","optional","that","isPendingDisposition","agentConfig","agentSettings","availableAgentStates","agentStates","enableCache","storageKey","_hasSetInitialState","_deps","evAgentSession","onTriggerConfig","evAuth","agent","initLoginState","evClient","setAgentState","initLoginStateLabel","tabManagerEnabled","tabManager","send","tabManagerEvents","RESET_WORKING_STATE","resetWorkingState","agentStateTypes","breakAfterCall","time","Date","now","evCallMonitor","onCallEnded","setIsPendingDisposition","evSubscription","subscribe","EvCallbackTypes","AGENT_STATE","currentAuxState","currentState","ready","event","isOnCall","transition","engaged","indexOf","presence","calls","length","onBreak","alert","danger","message","messageTypes","INVALID_STATE_CHANGE","allowDuplicates","ttl","state","workingAgentState","changeWorkingState","OVER_BREAK_TIME","enable","defaultAgentStateTexts","find","working","RcModuleV2","storage","available","action"],"mappings":"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","sourcesContent":["import {\n  action,\n  computed,\n  RcModuleV2,\n  state,\n  storage,\n} from '@ringcentral-integration/core';\nimport { Module } from 'ringcentral-integration/lib/di';\n\nimport {\n  agentStateTypes,\n  DefaultAgentStateTexts,\n  defaultAgentStateTexts,\n  messageTypes,\n  tabManagerEvents,\n} from '../../enums';\nimport { EvAgentState, EvAvailableAgentState } from '../../lib/EvClient';\nimport { EvCallbackTypes } from '../../lib/EvClient/enums/callbackTypes';\nimport { Deps, State, WorkingState } from './EvWorkingState.interface';\n\nconst PendingDisposition: EvAvailableAgentState = {\n  // TODO: here seems need i18n\n  rank: '0',\n  agentState: 'PENDING-DISPOSITION',\n  agentAuxState: 'Pending Disposition',\n};\n\n@Module({\n  name: 'EvWorkingState',\n  deps: [\n    'Auth',\n    'EvAuth',\n    'EvSubscription',\n    'EvClient',\n    'Presence',\n    'EvCallMonitor',\n    'Alert',\n    'Storage',\n    'EvAgentSession',\n    'TabManager',\n    { dep: 'EvWorkingStateOptions', optional: true },\n  ],\n})\nclass EvWorkingState extends RcModuleV2<Deps> implements WorkingState {\n  private _hasSetInitialState = false;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'EvWorkingState',\n    });\n    this._deps.evAgentSession.onTriggerConfig(() => {\n      const { agentConfig } = this._deps.evAuth.agent;\n      if (agentConfig?.agentSettings?.initLoginState) {\n        // if that tab is not activity, that wi\n        this._deps.evClient.setAgentState(\n          agentConfig.agentSettings.initLoginState,\n          agentConfig.agentSettings.initLoginStateLabel,\n        );\n      }\n\n      if (this.tabManagerEnabled) {\n        this._deps.tabManager.send(tabManagerEvents.RESET_WORKING_STATE);\n      }\n      this.resetWorkingState();\n    });\n\n    this._deps.evAgentSession.onTriggerConfig(async () => {\n      this._hasSetInitialState = true;\n    });\n  }\n\n  get tabManagerEnabled() {\n    return this._deps.tabManager?.enable;\n  }\n\n  @storage\n  @state\n  time = Date.now();\n\n  @storage\n  @state\n  agentState: EvAgentState = {\n    agentState: agentStateTypes.available,\n    agentAuxState: 'Available',\n  };\n\n  @storage\n  @state\n  isPendingDisposition = false;\n\n  get agentConfig() {\n    return this._deps.evAuth.agent.agentConfig;\n  }\n\n  @computed((that: EvWorkingState) => [\n    that.agentState,\n    that.isPendingDisposition,\n  ])\n  get workingState() {\n    return this.isPendingDisposition\n      ? PendingDisposition\n      : {\n          ...this.agentState,\n          agentAuxState:\n            this.agentState.agentAuxState ||\n            defaultAgentStateTexts[\n              this.agentState.agentState as DefaultAgentStateTexts\n            ],\n        };\n  }\n\n  @computed((that: EvWorkingState) => [\n    that.agentConfig,\n    that.isPendingDisposition,\n    that.agentConfig.agentSettings.availableAgentStates,\n  ])\n  get agentStates() {\n    const { availableAgentStates } = this.agentConfig.agentSettings;\n\n    const agentStates = this.isPendingDisposition\n      ? [PendingDisposition, ...availableAgentStates]\n      : availableAgentStates;\n\n    return this.agentConfig ? agentStates : [];\n  }\n\n  @computed((that: EvWorkingState) => [that.agentStates])\n  get workingAgentState() {\n    return this.agentStates.find(\n      (state) => state.agentState === agentStateTypes.working,\n    );\n  }\n\n  @action\n  setAgentState(agentState: EvAgentState) {\n    this.agentState = agentState;\n    if (agentState.agentState !== agentStateTypes.breakAfterCall) {\n      this.time = Date.now();\n    }\n  }\n\n  @action\n  setIsPendingDisposition(isPendingDisposition: State['isPendingDisposition']) {\n    this.isPendingDisposition = isPendingDisposition;\n  }\n\n  @action\n  resetWorkingState() {\n    this.time = Date.now();\n    this.isPendingDisposition = false;\n  }\n\n  @action\n  setTime(time: number) {\n    this.time = time;\n  }\n\n  onInitOnce() {\n    this._deps.evCallMonitor.onCallEnded(() => {\n      this.setIsPendingDisposition(true);\n    });\n\n    this._deps.evSubscription.subscribe(\n      EvCallbackTypes.AGENT_STATE,\n      ({ currentAuxState, currentState }) => {\n        // login with multi-tabs and skip the first agent notification for reset timer.\n        if (\n          !this._hasSetInitialState ||\n          this.agentState.agentState !== currentState\n        ) {\n          this.setAgentState({\n            agentState: currentState,\n            agentAuxState: currentAuxState,\n          });\n        }\n        this._hasSetInitialState = false;\n      },\n    );\n  }\n\n  async onStateChange() {\n    if (this.ready && this.tabManagerEnabled && this._deps.tabManager.ready) {\n      const { event } = this._deps.tabManager;\n      if (event) {\n        switch (event.name) {\n          case tabManagerEvents.RESET_WORKING_STATE:\n            this.resetWorkingState();\n            break;\n          default:\n            break;\n        }\n      }\n    }\n  }\n\n  changeWorkingState({ agentState, agentAuxState }: EvAgentState) {\n    const isOnCall =\n      [agentStateTypes.transition, agentStateTypes.engaged].indexOf(\n        this.agentState.agentState,\n      ) > -1 || this._deps.presence.calls.length > 0;\n\n    if (isOnCall && agentState !== agentStateTypes.onBreak) {\n      return this._deps.alert.danger({\n        message: messageTypes.INVALID_STATE_CHANGE,\n        allowDuplicates: false,\n        ttl: 0,\n      });\n    }\n\n    this._deps.evClient.setAgentState(agentState, agentAuxState);\n  }\n\n  setWorkingStateWorking() {\n    const state = this.workingAgentState;\n    if (state) {\n      this.changeWorkingState(state);\n    }\n  }\n\n  alertOverBreakTime() {\n    this._deps.alert.danger({\n      message: messageTypes.OVER_BREAK_TIME,\n      allowDuplicates: false,\n      ttl: 0,\n    });\n  }\n}\n\nexport { EvWorkingState };\n"],"file":"EvWorkingState.js"}