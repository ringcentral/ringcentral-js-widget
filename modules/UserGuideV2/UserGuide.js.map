{"version":3,"sources":["modules/UserGuideV2/UserGuide.ts"],"names":["SUPPORTED_LOCALES","UserGuide","name","deps","dep","optional","that","options","curIdx","playing","trackEvents","whatsNew","_deps","locale","ready","allGuides","currentLocale","enableCache","storageKey","_context","context","preLoadImageStatus","guides","firstLogin","carouselState","initUserGuide","preLoadImage","pending","auth","storage","rolesAndPermissions","loggedIn","webphone","ringSession","dismiss","url","Promise","resolve","reject","img","Image","src","onload","onerror","_preLoadImage","setPreLoadImageStatus","locales","Object","keys","sort","map","key","reduce","prev","curr","forEach","push","updateCarousel","entered","setGuides","setCarousel","hasUserGuidePermission","prevGuides","resolveGuides","loadGuides","JSON","stringify","start","currentGuides","length","RcModuleV2","state","action","proxify"],"mappings":"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","sourcesContent":["import { contains } from 'ramda';\nimport {\n  action,\n  RcModuleV2,\n  state,\n  storage,\n  computed,\n  watch,\n  track,\n} from '@ringcentral-integration/core';\nimport proxify from '../../lib/proxy/proxify';\nimport { Module } from '../../lib/di';\nimport { trackEvents } from '../Analytics';\nimport {\n  CarouselOptions,\n  CarouselState,\n  Context,\n  Deps,\n  Guides,\n} from './UserGuide.interface';\n\nconst SUPPORTED_LOCALES = {\n  'en-US': 'en-US',\n  'fr-CA': 'fr-CA',\n};\n\n@Module({\n  name: 'UserGuide',\n  deps: [\n    'Auth',\n    'Locale',\n    'Storage',\n    'Webphone',\n    'RolesAndPermissions',\n    { dep: 'UserGuideOptions', optional: true },\n  ],\n})\nexport class UserGuide extends RcModuleV2<Deps> {\n  protected _context: Context;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'UserGuide',\n    });\n    // TODO: refactor providing context without DI\n    this._context = deps.context;\n  }\n\n  @storage\n  @state\n  allGuides: Guides = {};\n\n  @state\n  carouselState: CarouselState = {\n    curIdx: 0,\n    entered: false,\n    playing: false,\n  };\n\n  @state\n  preLoadImageStatus = false;\n\n  @state\n  firstLogin = false;\n\n  @action\n  setPreLoadImageStatus() {\n    this.preLoadImageStatus = true;\n  }\n\n  @action\n  setGuides(guides: Guides) {\n    this.allGuides = guides;\n  }\n\n  @track((that: UserGuide, options: Required<CarouselOptions>) => {\n    if (options.curIdx === 0 && options.playing) {\n      return [trackEvents.whatsNew];\n    }\n  })\n  @action\n  setCarousel({ firstLogin, ...carouselState }: Required<CarouselOptions>) {\n    this.carouselState = carouselState;\n    this.firstLogin = firstLogin;\n  }\n\n  async onInitSuccess() {\n    await this.initUserGuide();\n    await this.preLoadImage();\n  }\n\n  _shouldInit() {\n    return !!(\n      this.pending &&\n      this._deps.auth.ready &&\n      this._deps.locale.ready &&\n      this._deps.storage.ready &&\n      this._deps.rolesAndPermissions.ready &&\n      this._deps.auth.loggedIn\n    );\n  }\n\n  _shouldReset() {\n    return !!(\n      this.ready &&\n      (!this._deps.auth.ready ||\n        !this._deps.locale.ready ||\n        !this._deps.storage.ready ||\n        !this._deps.rolesAndPermissions.ready)\n    );\n  }\n\n  onInitOnce() {\n    // When there is an incoming call,\n    // the guide should be dismissed\n    watch(\n      this,\n      () => this._deps.webphone.ringSession,\n      (ringSession) => {\n        if (this._deps.webphone.ready && ringSession) {\n          this.dismiss();\n        }\n      },\n    );\n  }\n\n  @proxify\n  async _preLoadImage(url: string) {\n    await new Promise((resolve, reject) => {\n      const img = new Image();\n      img.src = url;\n      img.onload = resolve;\n      img.onerror = reject;\n    });\n  }\n\n  @proxify\n  async preLoadImage() {\n    const url = this.guides[0];\n    if (url) {\n      await this._preLoadImage(url);\n    }\n    this.setPreLoadImageStatus();\n  }\n\n  /**\n   * Using webpack `require.context` to load guides files.\n   * Image files will be ordered by file name ascendingly.\n   * @return {Map<String, Array<URI>>}\n   */\n  resolveGuides() {\n    if (this._context && typeof this._context === 'function') {\n      const locales = Object.keys(SUPPORTED_LOCALES);\n      return this._context\n        .keys()\n        .sort()\n        .map((key) => this._context(key))\n        .reduce((prev, curr) => {\n          locales.forEach((locale) => {\n            if (!prev[locale]) prev[locale] = [];\n            if (contains(locale, curr)) {\n              prev[locale].push(curr);\n            }\n          });\n          return prev;\n        }, {} as Record<string, string[]>);\n    }\n    return {};\n  }\n\n  @proxify\n  async dismiss() {\n    this.updateCarousel({\n      curIdx: 0,\n      entered: false,\n      playing: false,\n      firstLogin: false,\n    });\n  }\n\n  @proxify\n  async loadGuides(guides: Guides) {\n    if (guides) {\n      this.setGuides(guides);\n    }\n  }\n\n  @proxify\n  async updateCarousel({\n    curIdx,\n    entered,\n    playing,\n    firstLogin = this.firstLogin,\n  }: CarouselOptions) {\n    this.setCarousel({\n      curIdx,\n      entered,\n      playing,\n      firstLogin,\n    });\n  }\n\n  @proxify\n  async initUserGuide() {\n    if (!this._deps.rolesAndPermissions.hasUserGuidePermission) return;\n    const prevGuides = this.allGuides;\n    const guides = this.resolveGuides();\n    // Determine if it needs to be displayed when first log in,\n    // the principles behind this is to use webpack's file hash,\n    // i.e. if any of the guide files is changed, the file name hash\n    // will be changed as well, in this case, it will be displayed.\n    await this.loadGuides(guides);\n    if (JSON.stringify(guides) !== JSON.stringify(prevGuides)) {\n      this.start({ firstLogin: true });\n    }\n  }\n\n  @proxify\n  async start({ firstLogin = false } = {}) {\n    // Start guides only when images are ready\n    this.setCarousel({\n      curIdx: 0,\n      entered: true,\n      playing: true,\n      firstLogin,\n    });\n  }\n\n  @computed<UserGuide>((that) => [\n    that._deps.locale.ready,\n    that.allGuides,\n    that._deps.locale.currentLocale,\n  ])\n  get guides() {\n    if (!this._deps.locale.ready) return [];\n    if (this.allGuides) {\n      const currentGuides = this.allGuides[this._deps.locale.currentLocale];\n      if (currentGuides && currentGuides.length > 0) return currentGuides;\n      return this.allGuides[SUPPORTED_LOCALES['en-US']] || [];\n    }\n    return [];\n  }\n\n  get started() {\n    return this.carouselState.entered && this.carouselState.playing;\n  }\n}\n"],"file":"UserGuide.js"}