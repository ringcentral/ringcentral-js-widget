{"version":3,"sources":["modules/EvAgentSession/EvAgentSession.ts"],"names":["ACCEPTABLE_LOGIN_TYPES","loginTypes","integratedSoftphone","RC_PHONE","externalPhone","DEFAULT_LOGIN_TYPE","NONE","dropDownOptions","None","WAIT_EV_SERVER_ROLLBACK_DELAY","DEFAULT_FORM_GROUP","selectedInboundQueueIds","loginType","selectedSkillProfileId","extensionNumber","autoAnswer","EvAgentSession","name","deps","dep","optional","that","_deps","locale","currentLocale","evAuth","agent","auth","isFreshLogin","skillProfileList","inboundQueues","_","type","trackEvents","agentSessionSetLoginType","value","skillProfileId","agentSessionSetSkillProfileId","ids","agentSessionSetInboundQueueIds","takingCall","agentSessionSetTakingCall","agentSessionSetAutoAnswer","formGroup","agentSessionConfigureAgent","selectedSkillProfile","selectedInboundQueues","_tabConfigSuccess","alive","_tabConfigWorking","tabManagerEnabled","isAlive","isIntegratedSoftphone","hasMultipleTabs","enableCache","storageKey","isForceLogin","_isReConfiguring","isReconnected","_eventEmitter","EventEmitter","_loginPromise","_isAgentUpdating","_updateSessionBlockId","_isLogin","TabLife","tabManager","prefix","_mainTabBeforeunloadHandler","console","log","isMainTab","firstTabIdExcludeMainTab","_mainTabAfterUnloadHandler","setMainTabId","_sendTabManager","tabManagerEvents","MAIN_TAB_WILL_UNLOAD","onceLoginSuccess","beforeAgentLogout","_resetAllState","presence","beforeunloadHandler","shouldBlockBrowser","configSuccess","configured","token","accessToken","status","_emitConfigSuccess","_clearCalls","defaultAutoAnswerOn","defaultSkillProfile","map","inboundQueue","gateId","data","setFormGroup","loggedIn","checkIsMainTabAlive","id","beforeunload","add","onAfterUnload","_init","onConfigSuccess","calls","length","setDialoutStatus","dialoutStatuses","idle","routerInteraction","push","block","next","configureAgent","triggerEvent","error","_emitReConfigFail","_configWorkingAlive","_mainTabHandle","_configSuccessAlive","connected","_tabReConfig","onLeave","isFirstTab","isLeave","_pollAskIfCanBeNewMainTab","_initTabLife","_initAgentSession","onLoginSuccess","_afterLogin","_autoConfigureAgent","e","setFreshConfig","resetFormGroup","_navigateToSessionConfigPage","resetAllConfig","setConfigSuccess","_destroyTabLife","clear","removeAfterUnloadListener","ready","_checkTabManagerEvent","event","args","AGENT_CONFIG_SUCCESS","UPDATE_SESSION","SET_MIAN_TAB_ID","UPDATE_SESSION_SUCCESS","UPDATE_SESSION_SUCCESS_ALERT","UPDATE_SESSION_FAIL","_othersTabConfigureAgent","onceLogoutThenLogin","then","loginPromise","tabbie","_newMainTabReConfig","mainTabId","setMainTabIdInThisTab","_unblockUpdateSession","window","location","reload","_showUpdateSuccessAlert","unblock","init","destroy","checkSelectIsInList","some","profile","profileId","setSkillProfileId","checkedInboundQueues","reduce","result","inboundQueueId","setInboundQueueIds","emit","agentSessionEvents","TRIGGER_CONFIG","callback","on","CONFIG_SUCCESS","RECONFIG_FAIL","_setMainTabId","evClient","getRefreshedToken","emitSetMainTabComplete","getAgentConfig","agentConfig","setAgent","config","_checkFieldsResult","needAssignFormGroupValue","_connectEvServer","newReconnect","_handleAgentResult","_emitTriggerConfig","voiceConnectionChanged","reLoginAgent","isForce","isAgentUpdating","updateAgentConfigs","goToSettingsPage","sendLogoutTabEvent","refreshToken","access_token","setAccessToken","logoutAgent","loginAgent","Promise","resolve","onceLogout","alert","success","message","messageTypes","UPDATE_AGENT_SUCCESS","danger","AGENT_CONFIG_DETAIL_ERROR","ttl","payload","UPDATE_AGENT_ERROR","AGENT_CONFIG_ERROR","Error","assignFormGroupValue","resolves","race","res","once","tabs","checkIsAlive","off","forEach","r","multiLoginRequest","find","item","isDefault","EXISTING_LOGIN_FOUND","modal","confirmSync","title","i18n","getString","content","okText","cancelText","onOK","modalId","EXISTING_LOGIN_ENGAGED","NO_AGENT_SELECTED","dialDest","_getDialDest","queueIds","EMPTY_PHONE_NUMBER","formatPhoneNumber","phoneNumber","input","parsedNumber","isValid","INVALID_PHONE_NUMBER","send","clearCalls","localStorage","enable","label","inboundSettings","availableQueues","queue","gateName","checked","defaultSkill","_pickSkillProfile","availableSkillProfiles","profileName","results","filter","agentPermissions","sessionConfigs","RcModuleV2","storage","state","action"],"mappings":"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","sourcesContent":["import {\n  action,\n  computed,\n  RcModuleV2,\n  state,\n  storage,\n  track,\n} from '@ringcentral-integration/core';\nimport { format, parse } from '@ringcentral-integration/phone-number';\nimport { EventEmitter } from 'events';\nimport { equals } from 'ramda';\nimport { Module } from 'ringcentral-integration/lib/di';\nimport sleep from 'ringcentral-integration/lib/sleep';\n\nimport {\n  agentSessionEvents,\n  dialoutStatuses,\n  dropDownOptions,\n  LoginTypes,\n  loginTypes,\n  messageTypes,\n  tabManagerEvents,\n} from '../../enums';\nimport { LoginType } from '../../interfaces/EvAgentSessionUI.interface';\nimport {\n  EvAgentConfig,\n  EvAvailableSkillProfile,\n  EvConfigureAgentOptions,\n} from '../../lib/EvClient';\nimport { TabLife } from '../../lib/tabLife';\nimport { trackEvents } from '../../lib/trackEvents';\nimport { AgentSession, Deps, FormGroup } from './EvAgentSession.interface';\nimport { tabManagerEnabled } from './tabManagerEnabled.decorator';\nimport i18n from './i18n';\n\nconst ACCEPTABLE_LOGIN_TYPES = [\n  loginTypes.integratedSoftphone,\n  loginTypes.RC_PHONE,\n  loginTypes.externalPhone,\n];\nconst DEFAULT_LOGIN_TYPE = loginTypes.integratedSoftphone;\n\nconst NONE = dropDownOptions.None;\n\n// ! wait all tab is logout complete, server has some delay after logout\nconst WAIT_EV_SERVER_ROLLBACK_DELAY = 2000;\n\nconst DEFAULT_FORM_GROUP = {\n  selectedInboundQueueIds: [] as any,\n  loginType: DEFAULT_LOGIN_TYPE,\n  selectedSkillProfileId: NONE,\n  extensionNumber: '',\n  autoAnswer: false,\n};\n\ntype AutoConfigType = 'already success' | 'other tab config' | 'config';\n\ntype ConfigureAgentParams = {\n  config?: EvConfigureAgentOptions;\n  triggerEvent?: boolean;\n  needAssignFormGroupValue?: boolean;\n};\n\n@Module({\n  name: 'EvAgentSession',\n  deps: [\n    'EvClient',\n    'Auth',\n    'EvAuth',\n    'Storage',\n    'Alert',\n    'Auth',\n    'Locale',\n    'Presence',\n    'RouterInteraction',\n    'Modal',\n    'Block',\n    'Beforeunload',\n    { dep: 'TabManager', optional: true },\n    { dep: 'EvAgentSessionOptions', optional: true },\n  ],\n})\nclass EvAgentSession extends RcModuleV2<Deps> implements AgentSession {\n  isForceLogin = false;\n\n  _isReConfiguring = false;\n\n  isReconnected = false;\n\n  private _eventEmitter = new EventEmitter();\n  private _loginPromise: Promise<void>;\n\n  private _isAgentUpdating = false;\n  private _updateSessionBlockId: string;\n  private _isLogin = false;\n\n  private _tabConfigWorking = new TabLife(\n    `${this._deps.tabManager.prefix}sessionConfig_working`,\n  );\n\n  private _tabConfigSuccess = new TabLife(\n    `${this._deps.tabManager.prefix}sessionConfig_success`,\n  );\n\n  @tabManagerEnabled()\n  private _configSuccessAlive() {\n    this._tabConfigSuccess.alive();\n  }\n\n  @tabManagerEnabled()\n  private _configWorkingAlive() {\n    this._tabConfigWorking.alive();\n  }\n\n  async isConfigTabAlive() {\n    return !this.tabManagerEnabled || this._tabConfigSuccess?.isAlive();\n  }\n\n  get shouldBlockBrowser() {\n    // when there is not integrated softphone and not has multiple tabs\n    return !this.isIntegratedSoftphone && !this.hasMultipleTabs;\n  }\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'EvAgentSession',\n    });\n    // ! that onceLoginSuccess for get event before onInitOnce.\n    this._deps.evAuth.onceLoginSuccess(() => {\n      // when that is seconds time get onLoginSuccess\n      console.log('----------onLoginSuccess1');\n      this._isLogin = true;\n    });\n    // ! logout event should in constructor, when logout that will not call init.\n    this._deps.evAuth.beforeAgentLogout(() => {\n      this._resetAllState();\n    });\n\n    this._deps.presence.beforeunloadHandler = () => this.shouldBlockBrowser;\n  }\n\n  @storage\n  @state\n  selectedSkillProfileId: string = NONE;\n\n  @storage\n  @state\n  selectedInboundQueueIds: string[] = [];\n\n  @storage\n  @state\n  loginType: LoginTypes = DEFAULT_LOGIN_TYPE;\n\n  @storage\n  @state\n  extensionNumber = '';\n\n  @storage\n  @state\n  takingCall = true;\n\n  @storage\n  @state\n  autoAnswer = false;\n\n  @storage\n  @state\n  configured = false;\n\n  @state\n  configSuccess = false;\n\n  @storage\n  @state\n  formGroup: FormGroup = DEFAULT_FORM_GROUP;\n\n  @storage\n  @state\n  accessToken = '';\n\n  get isExternalPhone() {\n    return this.formGroup.loginType === loginTypes.externalPhone;\n  }\n\n  get isIntegratedSoftphone() {\n    return this.loginType === loginTypes.integratedSoftphone;\n  }\n\n  get localStorage() {\n    return window?.localStorage;\n  }\n\n  get tabManagerEnabled() {\n    return this._deps.tabManager?.enable;\n  }\n\n  get hasMultipleTabs() {\n    return this._deps.tabManager?.hasMultipleTabs;\n  }\n\n  @computed((that: EvAgentSession) => [that._deps.locale.currentLocale])\n  get loginTypeList() {\n    const { currentLocale } = this._deps.locale;\n\n    return ACCEPTABLE_LOGIN_TYPES.map(\n      (type) =>\n        ({\n          id: type,\n          label: i18n.getString(type, currentLocale),\n        } as LoginType),\n    );\n  }\n\n  @computed((that: EvAgentSession) => [\n    that._deps.evAuth.agent,\n    that._deps.auth.isFreshLogin,\n  ])\n  get inboundQueues() {\n    const { agentConfig } = this._deps.evAuth.agent || {};\n\n    if (!agentConfig || !agentConfig.inboundSettings) {\n      return [];\n    }\n    const {\n      inboundSettings: { availableQueues = [] },\n    } = agentConfig;\n\n    const { isFreshLogin } = this._deps.auth;\n\n    return availableQueues.map((queue) => ({\n      gateId: queue.gateId,\n      gateName: queue.gateName,\n      checked: isFreshLogin,\n    }));\n  }\n\n  @computed((that: EvAgentSession) => [that.skillProfileList])\n  get defaultSkillProfile() {\n    const defaultSkill = this._pickSkillProfile(this.skillProfileList);\n    return defaultSkill ? defaultSkill.profileId : NONE;\n  }\n\n  @computed((that: EvAgentSession) => [\n    that._deps.evAuth.agent,\n    that._deps.locale.currentLocale,\n  ])\n  get skillProfileList() {\n    const { agentConfig } = this._deps.evAuth.agent || {};\n\n    if (!agentConfig || !agentConfig.inboundSettings) {\n      return [];\n    }\n    const {\n      inboundSettings: { availableSkillProfiles = [] },\n    } = agentConfig;\n\n    const defaultSkill = this._pickSkillProfile(availableSkillProfiles);\n\n    if (!defaultSkill && availableSkillProfiles.length > 0) {\n      return [\n        {\n          profileId: NONE,\n          profileName: i18n.getString(NONE, this._deps.locale.currentLocale),\n        },\n        ...availableSkillProfiles,\n      ];\n    }\n\n    return availableSkillProfiles;\n  }\n\n  @computed((that: EvAgentSession) => [\n    that.skillProfileList,\n    that.selectedSkillProfileId,\n  ])\n  get selectedSkillProfile() {\n    const selectedSkillProfile = this.skillProfileList.find(\n      (profile) => profile.profileId === this.formGroup.selectedSkillProfileId,\n    );\n    return selectedSkillProfile?.profileName;\n  }\n\n  @computed((that: EvAgentSession) => [\n    that.inboundQueues,\n    that.selectedInboundQueueIds,\n  ])\n  get selectedInboundQueues() {\n    const results = this.formGroup.selectedInboundQueueIds.map((id) => {\n      return this.inboundQueues.find((queue) => queue.gateId === id);\n    });\n    return results.filter((result) => result).map((result) => result.gateName);\n  }\n\n  @action\n  resetAllConfig() {\n    this.selectedInboundQueueIds = [];\n    this.selectedSkillProfileId = NONE;\n    this.loginType = DEFAULT_LOGIN_TYPE;\n    this.extensionNumber = '';\n    this.takingCall = true;\n    this.autoAnswer = false;\n    this.configSuccess = false;\n    this.configured = false;\n  }\n\n  @action\n  setAccessToken(token: string) {\n    this.accessToken = token;\n  }\n\n  @action\n  setConfigSuccess(status: boolean) {\n    console.log('setConfigSuccess~', status);\n    if (status) {\n      this._emitConfigSuccess();\n    }\n\n    this.configSuccess = status;\n    this.configured = status;\n  }\n\n  @track((_: EvAgentSession, type: LoginTypes) => [\n    trackEvents.agentSessionSetLoginType,\n    { value: type },\n  ])\n  @action\n  setLoginType(type: LoginTypes) {\n    this.loginType = type;\n  }\n\n  @track((_: EvAgentSession, skillProfileId: string) => [\n    trackEvents.agentSessionSetSkillProfileId,\n    { value: skillProfileId },\n  ])\n  @action\n  setSkillProfileId(skillProfileId: string) {\n    this.selectedSkillProfileId = skillProfileId;\n  }\n\n  @track((_: EvAgentSession, ids: string[]) => [\n    trackEvents.agentSessionSetInboundQueueIds,\n    { value: ids },\n  ])\n  @action\n  setInboundQueueIds(ids: string[]) {\n    this.selectedInboundQueueIds = ids;\n  }\n\n  @action\n  setExtensionNumber(extensionNumber: string) {\n    this.extensionNumber = extensionNumber;\n  }\n\n  @track((_: EvAgentSession, takingCall: boolean) => [\n    trackEvents.agentSessionSetTakingCall,\n    { value: takingCall },\n  ])\n  @action\n  setTakingCall(takingCall: boolean) {\n    this.takingCall = takingCall;\n  }\n\n  @track((_: EvAgentSession, autoAnswer: boolean) => [\n    trackEvents.agentSessionSetAutoAnswer,\n    { value: autoAnswer },\n  ])\n  @action\n  setAutoAnswer(autoAnswer: boolean) {\n    this.autoAnswer = autoAnswer;\n  }\n\n  @action\n  setFreshConfig() {\n    this._clearCalls();\n\n    this.loginType = DEFAULT_LOGIN_TYPE;\n    this.extensionNumber = '';\n    this.takingCall = true;\n    this.autoAnswer = this.defaultAutoAnswerOn;\n    this.configSuccess = false;\n    this.configured = false;\n\n    this.selectedSkillProfileId = this.defaultSkillProfile;\n    this.selectedInboundQueueIds = this.inboundQueues.map(\n      (inboundQueue) => inboundQueue.gateId,\n    );\n  }\n\n  get defaultAutoAnswerOn() {\n    return this._deps.evAuth.agentPermissions.defaultAutoAnswerOn;\n  }\n\n  @action\n  assignFormGroupValue() {\n    const {\n      selectedInboundQueueIds,\n      extensionNumber,\n      loginType,\n      selectedSkillProfileId,\n      autoAnswer,\n    } = this.formGroup;\n    this.selectedInboundQueueIds = selectedInboundQueueIds;\n    this.extensionNumber = extensionNumber;\n    this.loginType = loginType;\n    this.selectedSkillProfileId = selectedSkillProfileId;\n    this.autoAnswer = autoAnswer;\n  }\n\n  @action\n  setFormGroup(data: FormGroup) {\n    this.formGroup = { ...this.formGroup, ...data };\n  }\n\n  resetFormGroup() {\n    this.setFormGroup({\n      selectedInboundQueueIds: this.selectedInboundQueueIds,\n      selectedSkillProfileId: this.selectedSkillProfileId,\n      loginType: this.loginType,\n      extensionNumber: this.extensionNumber,\n      autoAnswer: this.autoAnswer,\n    });\n  }\n\n  @computed((that: EvAgentSession) => [\n    that.selectedInboundQueueIds,\n    that.selectedSkillProfileId,\n    that.loginType,\n    that.extensionNumber,\n    that.formGroup,\n  ])\n  get isSessionChanged() {\n    const sessionConfigs = {\n      selectedInboundQueueIds: this.selectedInboundQueueIds,\n      selectedSkillProfileId: this.selectedSkillProfileId,\n      loginType: this.loginType,\n      extensionNumber: this.extensionNumber,\n      autoAnswer: this.autoAnswer,\n    };\n    return !equals(sessionConfigs, this.formGroup);\n  }\n\n  _shouldReset() {\n    return super._shouldReset() && !this._deps.auth.loggedIn;\n  }\n\n  async checkIsMainTabAlive() {\n    return this._deps.tabManager.checkIsMainTabAlive();\n  }\n\n  private _mainTabBeforeunloadHandler = () => {\n    console.log(\n      '_mainTabBeforeunloadHandler~~',\n      this._deps.tabManager.hasMultipleTabs,\n      this.isMainTab,\n      this._deps.tabManager.firstTabIdExcludeMainTab,\n    );\n\n    if (\n      this._deps.tabManager.hasMultipleTabs &&\n      this.isMainTab &&\n      this._deps.tabManager.firstTabIdExcludeMainTab\n    ) {\n      return true;\n    }\n    return false;\n  };\n\n  private _mainTabAfterUnloadHandler = () => {\n    console.log(\n      '_mainTabAfterUnloadHandler~~',\n      this._deps.tabManager.firstTabIdExcludeMainTab,\n    );\n    if (!this.isMainTab) return;\n    const firstTabIdExcludeMainTab = this._deps.tabManager\n      .firstTabIdExcludeMainTab;\n\n    this._deps.tabManager.setMainTabId(firstTabIdExcludeMainTab);\n\n    this._sendTabManager(\n      tabManagerEvents.MAIN_TAB_WILL_UNLOAD,\n      firstTabIdExcludeMainTab,\n    );\n  };\n\n  @tabManagerEnabled()\n  private _setMainTabId() {\n    console.log('_setMainTabId~~~');\n    const { id } = this._deps.tabManager;\n    this._deps.tabManager.setMainTabId(id);\n    this._deps.beforeunload.add(this._mainTabBeforeunloadHandler);\n    this._deps.beforeunload.onAfterUnload(\n      this._mainTabAfterUnloadHandler,\n      true,\n    );\n  }\n\n  onInitOnce() {\n    this._init();\n\n    this.onConfigSuccess(() => {\n      if (this._deps.presence.calls.length === 0) {\n        this._deps.presence.setDialoutStatus(dialoutStatuses.idle);\n      }\n\n      if (this._isAgentUpdating) {\n        this._isAgentUpdating = false;\n      } else {\n        console.log('!!!!to Dialer');\n        this._deps.routerInteraction.push('/dialer');\n      }\n    });\n  }\n\n  private async _tabReConfig() {\n    console.log('_tabReConfig~~~', this._isReConfiguring);\n    if (this._isReConfiguring) return;\n\n    this._isReConfiguring = true;\n\n    if (this.isIntegratedSoftphone) {\n      try {\n        await this._deps.block.next(async () => {\n          // !! sip resiter need to configure agent at fisrt\n          await this.configureAgent({\n            triggerEvent: false,\n          });\n        });\n      } catch (error) {\n        console.error('re config fail', error);\n        this._emitReConfigFail();\n        return;\n      }\n    } else {\n      this._configWorkingAlive();\n    }\n\n    this.isReconnected = true;\n\n    this._mainTabHandle();\n    this._configSuccessAlive();\n\n    this._isReConfiguring = false;\n  }\n\n  // _newMainTabReConfig and _pollAskIfCanBeNewMainTab are all for handle new main tab\n  private async _newMainTabReConfig() {\n    console.log(\n      '_newMainTabReConfig~',\n      !this.isReconnected,\n      this._deps.evAuth.connected,\n      this.configSuccess,\n      this.isMainTab,\n    );\n\n    if (\n      !this.isReconnected &&\n      this._deps.evAuth.connected &&\n      this.configSuccess &&\n      this.isMainTab\n    ) {\n      console.log('_newMainTabReConfig success~');\n      await this._tabReConfig();\n    }\n  }\n\n  @tabManagerEnabled()\n  private _pollAskIfCanBeNewMainTab() {\n    console.log('_pollAskIfCanBeNewMainTab~~');\n    this._tabConfigSuccess.onLeave(async () => {\n      console.log(\n        '_tabReConfig in _pollAskIfCanBeNewMainTab~',\n        this._deps.tabManager.isFirstTab,\n        this._deps.evAuth.connected,\n        this.configSuccess,\n        !this._isReConfiguring,\n      );\n      if (\n        this._deps.tabManager.isFirstTab &&\n        this._deps.evAuth.connected &&\n        this.configSuccess &&\n        !this._isReConfiguring &&\n        (await this._tabConfigWorking.isLeave())\n      ) {\n        await this._tabReConfig();\n      } else if (!this.isMainTab) {\n        this._pollAskIfCanBeNewMainTab();\n      }\n    }, 3000);\n  }\n\n  private async _init() {\n    if (this._isLogin) {\n      this._initTabLife();\n      await this._initAgentSession();\n    }\n    // ! that must call after onInitOnce, because when that is not in init once,\n    // ! that configured will some times to be false because storage block\n    this._deps.evAuth.onLoginSuccess(() => {\n      // when that is seconds time get onLoginSuccess\n      console.log('----------onLoginSuccess2');\n      this._initTabLife();\n      this._initAgentSession();\n    });\n  }\n\n  private _initAgentSession() {\n    console.log('_initAgentSession~', this._isAgentUpdating);\n    if (this._isAgentUpdating) {\n      return;\n    }\n    this._afterLogin();\n\n    console.log('autoconfig~', !this._deps.auth.isFreshLogin, this.configured);\n\n    if (this._deps.auth.isFreshLogin === false && this.configured) {\n      try {\n        return this._autoConfigureAgent();\n      } catch (e) {\n        console.error(e);\n      }\n    }\n\n    this.setFreshConfig();\n\n    this.resetFormGroup();\n\n    this._navigateToSessionConfigPage();\n  }\n\n  private _navigateToSessionConfigPage() {\n    this._deps.routerInteraction.push('/sessionConfig');\n    console.log('to sessionConfig~~');\n  }\n\n  // ! also reset in onReset for auth logout by rc\n  onReset() {\n    console.log('onReset in EvAgentSession~~');\n    try {\n      this._resetAllState();\n      this._isAgentUpdating = false;\n    } catch (error) {\n      // ignore error\n    }\n  }\n\n  private _resetAllState() {\n    console.log('_resetAllState~~', this.isMainTab);\n    if (!this._isAgentUpdating) {\n      this.resetAllConfig();\n    }\n    if (this.isMainTab) {\n      this._deps.tabManager.setMainTabId(null);\n    }\n    this.setConfigSuccess(false);\n    this.isReconnected = false;\n    this._destroyTabLife();\n    this._deps.beforeunload.clear();\n    this._deps.beforeunload.removeAfterUnloadListener(\n      this._mainTabAfterUnloadHandler,\n    );\n  }\n\n  async onStateChange() {\n    if (this.ready && this.tabManagerEnabled && this._deps.tabManager.ready) {\n      await this._checkTabManagerEvent();\n    }\n  }\n\n  private async _checkTabManagerEvent() {\n    const { event } = this._deps.tabManager;\n    const data = event?.args[0];\n    if (event) {\n      switch (event.name) {\n        case tabManagerEvents.AGENT_CONFIG_SUCCESS:\n          console.log('!!!from other');\n          await this._othersTabConfigureAgent();\n          break;\n        case tabManagerEvents.UPDATE_SESSION:\n          this._updateSessionBlockId = this._deps.block.block();\n          this._isAgentUpdating = true;\n\n          // if voiceConnectionChanged\n          if (data) {\n            this.onceLogoutThenLogin().then((loginPromise) => {\n              this._loginPromise = loginPromise;\n            });\n          }\n          break;\n        case tabManagerEvents.MAIN_TAB_WILL_UNLOAD:\n          console.log(\n            'MAIN_TAB_WILL_UNLOAD~~',\n            data === this._deps.tabManager.tabbie.id,\n            this.isMainTab,\n          );\n          if (data === this._deps.tabManager.tabbie.id || this.isMainTab) {\n            // now this tab is the new main tab\n            await this._newMainTabReConfig();\n          }\n          break;\n        case tabManagerEvents.SET_MIAN_TAB_ID:\n          if (this._deps.tabManager.mainTabId !== data) {\n            console.log('SET_MIAN_TAB_ID in this tab~');\n            this._deps.tabManager.setMainTabIdInThisTab(data);\n          }\n          break;\n        case tabManagerEvents.UPDATE_SESSION_SUCCESS:\n          try {\n            console.log('UPDATE_SESSION_SUCCESS~~', data);\n            // if voiceConnectionChanged\n            if (data) {\n              this._destroyTabLife();\n              this._initTabLife();\n              await this._loginPromise;\n              await this._othersTabConfigureAgent();\n            } else {\n              this.setConfigSuccess(true);\n            }\n\n            this._unblockUpdateSession();\n\n            this._isAgentUpdating = false;\n          } catch (error) {\n            // when that auto config fail, just reload that tab\n            console.log(error);\n            window.location.reload();\n          }\n          break;\n        case tabManagerEvents.UPDATE_SESSION_SUCCESS_ALERT:\n          this._showUpdateSuccessAlert();\n          break;\n        case tabManagerEvents.UPDATE_SESSION_FAIL:\n          this._unblockUpdateSession();\n          break;\n        default:\n          break;\n      }\n    }\n  }\n\n  private _unblockUpdateSession() {\n    this._deps.block.unblock(this._updateSessionBlockId);\n  }\n\n  @tabManagerEnabled()\n  private _initTabLife() {\n    console.log('initTabLife~');\n    this._tabConfigWorking.init();\n    this._tabConfigSuccess.init();\n  }\n\n  @tabManagerEnabled()\n  private _destroyTabLife() {\n    this._tabConfigWorking?.destroy();\n    this._tabConfigSuccess?.destroy();\n  }\n\n  private _afterLogin() {\n    // if that is not first login set SessionConfig data again\n    if (!this._deps.auth.isFreshLogin) {\n      const checkSelectIsInList = this.skillProfileList.some(\n        (profile) => profile.profileId === this.selectedSkillProfileId,\n      );\n      if (!checkSelectIsInList) {\n        this.setSkillProfileId(this.defaultSkillProfile);\n      }\n\n      // check all selected queue is in inboundQueue list\n      const checkedInboundQueues = this.selectedInboundQueueIds.reduce(\n        (result, inboundQueueId) => {\n          if (\n            this.inboundQueues.some(\n              (inboundQueue) => inboundQueue.gateId === inboundQueueId,\n            )\n          ) {\n            result.push(inboundQueueId);\n          }\n          return result;\n        },\n        [],\n      );\n      this.setInboundQueueIds(checkedInboundQueues);\n    }\n  }\n\n  private _emitTriggerConfig() {\n    this._eventEmitter.emit(agentSessionEvents.TRIGGER_CONFIG);\n  }\n\n  onTriggerConfig(callback: () => void) {\n    this._eventEmitter.on(agentSessionEvents.TRIGGER_CONFIG, callback);\n    return this;\n  }\n\n  private _emitConfigSuccess() {\n    this._eventEmitter.emit(agentSessionEvents.CONFIG_SUCCESS);\n  }\n\n  onConfigSuccess(callback: () => void) {\n    this._eventEmitter.on(agentSessionEvents.CONFIG_SUCCESS, callback);\n    return this;\n  }\n\n  private _emitReConfigFail() {\n    this._eventEmitter.emit(agentSessionEvents.RECONFIG_FAIL);\n  }\n\n  onReConfigFail(callback: () => void) {\n    this._eventEmitter.on(agentSessionEvents.RECONFIG_FAIL, callback);\n    return this;\n  }\n\n  private _mainTabHandle() {\n    console.log('_mainTabHandle~~');\n    this._setMainTabId();\n    // refresh token prevent get token fail to get sip_info\n    this._deps.evClient.getRefreshedToken();\n    this._deps.tabManager.emitSetMainTabComplete();\n  }\n\n  async updateAgentConfigs() {\n    const agentConfig = await this._deps.evClient.getAgentConfig();\n    const agent = {\n      ...this._deps.evAuth.agent,\n      agentConfig,\n    };\n    this._deps.evAuth.setAgent(agent);\n    // !! update agentConfig need before set config success.\n    this.setConfigSuccess(true);\n  }\n\n  /**\n   * config agent in session config page\n   * @param triggerEvent is that should trigger event, default is true\n   */\n  @track((that: EvAgentSession) => [\n    trackEvents.agentSessionConfigureAgent,\n    {\n      'Voice Connection': that.loginType,\n      'Persistent Voice Connection': that.takingCall,\n      'Skill Profile': that.selectedSkillProfile,\n      'Inbound Queues': that.selectedInboundQueues,\n      'Auto Answer': that.autoAnswer,\n    },\n  ])\n  async configureAgent({\n    config = this._checkFieldsResult(this.formGroup),\n    triggerEvent = true,\n    needAssignFormGroupValue = false,\n  }: ConfigureAgentParams = {}) {\n    this._configWorkingAlive();\n    console.log('configureAgent~~', triggerEvent);\n    this._clearCalls();\n    let result = await this._connectEvServer(config);\n\n    // Session timeout\n    // this will occur when stay in session config page for long time\n    if (result.data.status !== 'SUCCESS') {\n      this._navigateToSessionConfigPage();\n      await this._deps.evAuth.newReconnect(false);\n\n      result = await this._connectEvServer(config);\n    }\n\n    this._handleAgentResult({ config: result.data, needAssignFormGroupValue });\n\n    if (triggerEvent) {\n      this._mainTabHandle();\n      this._emitTriggerConfig();\n      this._configSuccessAlive();\n      this._sendTabManager(tabManagerEvents.AGENT_CONFIG_SUCCESS);\n      this.setConfigSuccess(true);\n    }\n  }\n\n  async updateAgent(voiceConnectionChanged: boolean) {\n    try {\n      await this._deps.block.next(async () => {\n        if (voiceConnectionChanged) this._configWorkingAlive();\n        const config = this._checkFieldsResult(this.formGroup);\n\n        this._clearCalls();\n\n        this._isAgentUpdating = true;\n\n        this._sendTabManager(\n          tabManagerEvents.UPDATE_SESSION,\n          voiceConnectionChanged,\n        );\n\n        if (voiceConnectionChanged) await this.reLoginAgent();\n\n        config.isForce = true;\n        const result = await this._connectEvServer(config);\n        this._handleAgentResult({\n          config: result.data,\n          isAgentUpdating: true,\n          needAssignFormGroupValue: true,\n        });\n\n        if (voiceConnectionChanged) {\n          this._mainTabHandle();\n          this._emitTriggerConfig();\n        }\n\n        await this.updateAgentConfigs();\n\n        if (voiceConnectionChanged) this._configSuccessAlive();\n\n        // * update session complete, and config ready\n        this._sendTabManager(\n          tabManagerEvents.UPDATE_SESSION_SUCCESS,\n          voiceConnectionChanged,\n        );\n\n        this.goToSettingsPage();\n\n        this._sendTabManager(tabManagerEvents.UPDATE_SESSION_SUCCESS_ALERT);\n        this._showUpdateSuccessAlert();\n      });\n    } catch (error) {\n      this._sendTabManager(tabManagerEvents.UPDATE_SESSION_FAIL);\n      this._unblockUpdateSession();\n\n      console.error('error', error);\n    }\n  }\n\n  async reLoginAgent() {\n    this._deps.evAuth.sendLogoutTabEvent();\n\n    const { access_token } = await this._deps.auth.refreshToken();\n    this.setAccessToken(access_token);\n\n    // * then do logout send to every tab\n    await this._deps.evAuth.logoutAgent();\n\n    // ! wait all tab is logout complete, server has some delay after logout\n    await sleep(WAIT_EV_SERVER_ROLLBACK_DELAY);\n\n    await this._deps.evAuth.loginAgent(this.accessToken);\n  }\n\n  onceLogoutThenLogin() {\n    return new Promise<Promise<void>>((resolve) => {\n      this._deps.evAuth.onceLogout(async () => {\n        // ! wait all tab is logout complete, server has some delay after logout\n        await sleep(WAIT_EV_SERVER_ROLLBACK_DELAY);\n        resolve(this._deps.evAuth.loginAgent(this.accessToken));\n      });\n    });\n  }\n\n  goToSettingsPage() {\n    this._deps.routerInteraction.push('/settings');\n  }\n\n  private _showUpdateSuccessAlert() {\n    this._deps.alert.success({\n      message: messageTypes.UPDATE_AGENT_SUCCESS,\n    });\n  }\n\n  private _handleAgentResult({\n    config: { message, status },\n    isAgentUpdating,\n    needAssignFormGroupValue,\n  }: {\n    config: EvAgentConfig;\n    isAgentUpdating?: boolean;\n    needAssignFormGroupValue?: boolean;\n  }) {\n    if (status !== 'SUCCESS') {\n      if (typeof message === 'string') {\n        this._deps.alert.danger({\n          message: messageTypes.AGENT_CONFIG_DETAIL_ERROR,\n          ttl: 0,\n          payload: message,\n        });\n      } else {\n        this._deps.alert.danger({\n          message: isAgentUpdating\n            ? messageTypes.UPDATE_AGENT_ERROR\n            : messageTypes.AGENT_CONFIG_ERROR,\n          ttl: 0,\n        });\n      }\n      throw new Error(message);\n    }\n    if (needAssignFormGroupValue) {\n      this.assignFormGroupValue();\n    }\n  }\n\n  private async _autoConfigureAgent() {\n    console.log('_autoConfigureAgent~', this.tabManagerEnabled);\n    if (this.tabManagerEnabled) {\n      const resolves: ((\n        value?: AutoConfigType | PromiseLike<AutoConfigType>,\n      ) => void)[] = [null, null, null];\n      return Promise.race<AutoConfigType>([\n        new Promise<AutoConfigType>((res) => {\n          resolves[0] = () => res('already success');\n\n          this._eventEmitter.once(\n            agentSessionEvents.CONFIG_SUCCESS,\n            resolves[0],\n          );\n        }),\n        new Promise<AutoConfigType>((res) => {\n          resolves[1] = res;\n          // check isSuccess first\n          if (\n            this._isAgentUpdating ||\n            this._deps.tabManager.tabs.length !== 1\n          ) {\n            const checkIsAlive = () => {\n              this._tabConfigSuccess.isAlive().then(async (result) => {\n                if (result) {\n                  res('other tab config');\n                } else {\n                  checkIsAlive();\n                }\n              });\n            };\n\n            checkIsAlive();\n          }\n        }),\n        new Promise<AutoConfigType>((res) => {\n          resolves[2] = res;\n          // when there is too many tab, that event will block\n          // then check local\n          if (this._deps.tabManager.isFirstTab) {\n            this._tabConfigWorking.isLeave().then(async (result) => {\n              if (result) {\n                this._configWorkingAlive();\n                res('config');\n              }\n            });\n          }\n        }),\n      ])\n        .then((result) => {\n          this._eventEmitter.off(\n            agentSessionEvents.CONFIG_SUCCESS,\n            resolves[0],\n          );\n          // clear all memory with promise\n          resolves.forEach((r) => r());\n          resolves.length = 0;\n\n          console.log('!!!!!', result);\n\n          switch (result) {\n            case 'other tab config':\n              console.log('_othersTabConfigureAgent in auto config~~');\n              return this._othersTabConfigureAgent();\n            case 'config': {\n              console.log('configureAgent in auto config~~');\n              //! when reConfig, if that change queue or others field in ev admin, that will get error, should redirect to sessionPage\n              const config = this._checkFieldsResult({\n                selectedInboundQueueIds: this.selectedInboundQueueIds,\n                selectedSkillProfileId: this.selectedSkillProfileId,\n                loginType: this.loginType,\n                extensionNumber: this.extensionNumber,\n              });\n              return this.configureAgent({ config });\n            }\n            case 'already success':\n            default:\n              return Promise.resolve();\n          }\n        })\n        .catch((e) => {\n          this.setConfigSuccess(false);\n          this._navigateToSessionConfigPage();\n          return e;\n        });\n    }\n\n    return this.configureAgent();\n  }\n\n  async _othersTabConfigureAgent() {\n    console.log('_othersTabConfigureAgent~~', this.configSuccess);\n    if (this.configSuccess) {\n      return;\n    }\n\n    try {\n      await this._deps.evClient.multiLoginRequest();\n\n      await this.updateAgentConfigs();\n\n      this._pollAskIfCanBeNewMainTab();\n\n      return;\n    } catch (e) {\n      console.log(e);\n    }\n  }\n\n  private _pickSkillProfile(skillProfileList: EvAvailableSkillProfile[]) {\n    return skillProfileList.find((item) => item.isDefault === '1');\n  }\n\n  private async _connectEvServer(config: EvConfigureAgentOptions) {\n    console.log('configure ev agent in _connectEvServer~~');\n    let result = await this._deps.evClient.configureAgent(config);\n    const { status } = result.data;\n\n    if (status === messageTypes.EXISTING_LOGIN_FOUND) {\n      const { currentLocale } = this._deps.locale;\n\n      // TODO: think about sync up in all tabs?\n      const modalId = await this._deps.modal.confirmSync({\n        title: i18n.getString('multipleLoginsTitle', currentLocale),\n        content: i18n.getString('multipleLoginsContent', currentLocale),\n        okText: i18n.getString('multipleLoginsConfirm', currentLocale),\n        cancelText: i18n.getString('multipleLoginsCancel', currentLocale),\n        onOK: async () => {\n          result = await this._deps.evClient.configureAgent({\n            ...config,\n            isForce: true,\n          });\n          this.isForceLogin = true;\n        },\n      });\n\n      if (!modalId) {\n        this.isForceLogin = false;\n        throw new Error(status);\n      }\n    } else if (status === messageTypes.EXISTING_LOGIN_ENGAGED) {\n      this._deps.alert.danger({\n        message: messageTypes.EXISTING_LOGIN_ENGAGED,\n        ttl: 0,\n      });\n\n      throw new Error(messageTypes.EXISTING_LOGIN_ENGAGED);\n    }\n\n    return result;\n  }\n\n  private _checkFieldsResult(formGroup: FormGroup): EvConfigureAgentOptions {\n    const { selectedInboundQueueIds, selectedSkillProfileId } = formGroup;\n\n    if (selectedInboundQueueIds.length === 0) {\n      this._deps.alert.danger({\n        message: messageTypes.NO_AGENT_SELECTED,\n        ttl: 0,\n      });\n      throw new Error(`'queueIds' is an empty array.`);\n    }\n\n    return {\n      dialDest: this._getDialDest(formGroup),\n      queueIds: selectedInboundQueueIds,\n      skillProfileId:\n        selectedSkillProfileId === NONE ? '' : selectedSkillProfileId,\n    };\n  }\n\n  private _getDialDest({ loginType, extensionNumber }: FormGroup) {\n    // Only external phone has number input\n    switch (loginType) {\n      case loginTypes.externalPhone: {\n        if (!extensionNumber) {\n          this._deps.alert.danger({\n            message: messageTypes.EMPTY_PHONE_NUMBER,\n            ttl: 0,\n          });\n          throw new Error(`'extensionNumber' is an empty number.`);\n        }\n        const formatPhoneNumber = format({\n          phoneNumber: extensionNumber,\n        });\n        const { parsedNumber, isValid } = parse({\n          input: formatPhoneNumber,\n        });\n        if (!isValid || !parsedNumber || parsedNumber === '') {\n          this._deps.alert.danger({\n            message: messageTypes.INVALID_PHONE_NUMBER,\n            ttl: 0,\n          });\n          throw new Error(`'extensionNumber' is not a valid number.`);\n        }\n        this.setFormGroup({ extensionNumber: parsedNumber });\n        return extensionNumber;\n      }\n      case loginTypes.integratedSoftphone:\n        return 'integrated';\n      case loginTypes.RC_PHONE:\n      default:\n        return 'RC_PHONE';\n    }\n  }\n\n  private _sendTabManager(event: string, value?: any) {\n    this._deps.tabManager?.send(event, value);\n  }\n\n  private _clearCalls() {\n    this._deps.presence.clearCalls();\n  }\n\n  get isMainTab() {\n    return this._deps.tabManager.isMainTab;\n  }\n}\n\nexport { EvAgentSession };\n"],"file":"EvAgentSession.js"}