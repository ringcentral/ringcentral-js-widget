{"version":3,"sources":["modules/ConferenceCall/index.js"],"names":["DEFAULT_TIMEOUT","DEFAULT_TTL","MAXIMUM_CAPACITY","_fromSessionId","_lastCallInfo","ascendSortParties","parties","filter","party","conferenceRole","toLowerCase","host","sort","last","next","id","split","ConferenceCall","deps","dep","optional","auth","alert","call","callingSettings","client","rolesAndPermissions","contactMatcher","webphone","availabilityMonitor","connectivityMonitor","pulling","capacity","timeout","options","actionTypes","_eventEmitter","EventEmitter","_auth","ensureExist","_alert","_call","_availabilityMonitor","_callingSettings","_client","_webphone","_connectivityMonitor","_contactMatcher","_rolesAndPermissions","_reducer","_ttl","_timout","_timers","_pulling","sessionId","res","findConferenceWithSession","isMerging","session","sessions","find","Object","values","conferences","c","store","dispatch","type","updateConference","conference","state","service","platform","get","rawResponse","response","json","storedconference","assign","updateConferenceSucceeded","updateConferenceFailed","message","toString","terminateConference","conferenceData","hangup","terminateConferenceSucceeded","terminateConferenceFailed","checkIfHAError","warning","conferenceCallErrors","webphoneSession","propagete","conferenceState","ready","isOverload","connectivity","danger","modeError","ttl","bringInConference","partyProfile","_getProfile","post","partyData","updateConferenceStatus","newConference","newParties","length","bringInConferenceSucceeded","bringInConferenceFailed","partyId","removeFromConference","removeFromConferenceSucceeded","removeFromConferenceFailed","propagate","_checkPermission","permissionsMessages","insufficientPrivilege","callingMode","callingModes","_makeConference","subscribe","_onStateChange","webphoneSessions","isConferenceSession","bringInFailed","mergeStart","conferenceId","sipInstances","map","_sessions","sessionIds","x","setSessionCaching","pSips","instance","p","Promise","resolve","on","all","_mergeToConference","then","mergeSucceeded","emit","profiles","mergeFailed","clearSessionCaching","fromSessionId","toSessionId","updateFromSession","updateToSession","mergingPair","closeMergingPair","reduce","accum","idx","status","code","partyStatusCode","disconnected","push","i","getOnlineParties","Array","isArray","countOnlineParties","setTimeout","stopPollingConferenceStatus","startPollingConferenceStatus","clearTimeout","Error","func","isOnce","once","off","updateCurrentConferenceId","initSuccess","_shouldInit","_init","_shouldReset","_reset","resetSuccess","loggedIn","pending","hasConferenceCallPermission","forEach","evt","bringInToConference","makeConference","confereceAccepted","race","reject","sipSession","phoneNumber","voiceCallToken","isConference","prototype","_hookConference","makeConferenceSucceeded","makeConferenceFailed","rcId","avatarUrl","calleeType","calleeTypes","unknown","partyName","direction","callDirections","outbound","toUserName","fromUserName","partyNumber","to","from","matchedContact","contactMatch","nameMatches","dataMapping","profileImageUrl","name","contacts","sessionIdToMergeWith","sessionToMergeWith","validateCallRecording","conferenceSession","setMergeParty","mergeToConference","resume","currentConferenceSession","isCurrentConferenceOnhold","isOnHold","callIsRecording","participantListClickHangupTrack","removeParticipantClickCancelTrack","removeParticipantClickRemoveTrack","conferenceCallStatus","currentConferenceId","RcModule","proxify","selector","partyProfiles","sessionName","sessionNumber","sessionStatus","fromSession","callStatus","lastCalleeType","sessionStatusEnum","finished","partiesAvatarUrls","profile","extraNum","lastCallContact","getOnlinePartyProfiles"],"mappings":"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","sourcesContent":["import { find } from 'ramda';\nimport EventEmitter from 'events';\nimport { Module } from '../../lib/di';\nimport RcModule from '../../lib/RcModule';\nimport proxify from '../../lib/proxy/proxify';\nimport ensureExist from '../../lib/ensureExist';\nimport calleeTypes from '../../enums/calleeTypes';\nimport callDirections from '../../enums/callDirections';\nimport { selector } from '../../lib/selector';\n\nimport callingModes from '../CallingSettings/callingModes';\nimport permissionsMessages from '../RolesAndPermissions/permissionsMessages';\nimport { isConferenceSession, isRecording } from '../Webphone/webphoneHelper';\nimport sessionStatusEnum from '../Webphone/sessionStatus';\n\nimport actionTypes from './actionTypes';\nimport conferenceRole from './conferenceRole';\nimport partyStatusCode from './partyStatusCode';\nimport conferenceCallErrors from './conferenceCallErrors';\nimport getConferenceCallReducer from './getConferenceCallReducer';\n\nconst DEFAULT_TIMEOUT = 30000; // time out for conferencing session being accepted.\nconst DEFAULT_TTL = 5000; // timer to update the conference information\nconst MAXIMUM_CAPACITY = 10;\n\nlet _fromSessionId;\nlet _lastCallInfo;\n\nfunction ascendSortParties(parties) {\n  return parties\n    .filter(\n      (party) => party.conferenceRole.toLowerCase() !== conferenceRole.host,\n    )\n    .sort((last, next) => +last.id.split('-')[1] - +next.id.split('-')[1]);\n}\n\n/**\n * @class\n * @description ConferenceCall managing module\n */\n@Module({\n  deps: [\n    'Auth',\n    'Alert',\n    'Call',\n    'CallingSettings',\n    'ConnectivityMonitor',\n    'Client',\n    'Webphone',\n    'RolesAndPermissions',\n    {\n      dep: 'ContactMatcher',\n      optional: true,\n    },\n    {\n      dep: 'Webphone',\n      optional: true,\n    },\n    {\n      dep: 'AvailabilityMonitor',\n      optional: true,\n    },\n    {\n      dep: 'ConferenceCallOptions',\n      optional: true,\n    },\n  ],\n})\nexport default class ConferenceCall extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {RegionSettings} params.regionSettings - regionSettings module instance\n   * @param {Client} params.client - client module instance\n   */\n  constructor({\n    auth,\n    alert,\n    call,\n    callingSettings,\n    client,\n    rolesAndPermissions,\n    contactMatcher,\n    webphone,\n    availabilityMonitor,\n    connectivityMonitor,\n    pulling = true,\n    capacity = MAXIMUM_CAPACITY,\n    timeout = DEFAULT_TIMEOUT,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._eventEmitter = new EventEmitter();\n    this._auth = this::ensureExist(auth, 'auth');\n    this._alert = this::ensureExist(alert, 'alert');\n    this._call = this::ensureExist(call, 'call');\n    this._availabilityMonitor = availabilityMonitor;\n    this._callingSettings = this::ensureExist(\n      callingSettings,\n      'callingSettings',\n    );\n    this._client = this::ensureExist(client, 'client');\n    // in order to run the integeration test, we need it to be optional\n    this._webphone = webphone;\n    this._connectivityMonitor = connectivityMonitor;\n    this._contactMatcher = contactMatcher;\n    this._rolesAndPermissions = this::ensureExist(\n      rolesAndPermissions,\n      'rolesAndPermissions',\n    );\n    // we need the constructed actions\n    this._reducer = getConferenceCallReducer(this.actionTypes);\n    this._ttl = DEFAULT_TTL;\n    this._timout = timeout;\n    this._timers = {};\n    this._pulling = pulling;\n    this.capacity = capacity;\n  }\n\n  isConferenceSession(sessionId) {\n    // only can be used after webphone._onCallStartFunc\n    let res = !!this.findConferenceWithSession(sessionId);\n\n    if (this.isMerging && !res) {\n      const session = this._webphone.sessions.find(\n        (session) => session.id === sessionId,\n      );\n      res = isConferenceSession(session);\n    }\n\n    return res;\n  }\n\n  findConferenceWithSession(sessionId) {\n    return Object.values(this.conferences).find(\n      (c) => c.sessionId === sessionId,\n    );\n  }\n\n  /**\n   *\n   * @param {string} id: conference id\n   */\n  @proxify\n  async updateConferenceStatus(id) {\n    this.store.dispatch({\n      type: this.actionTypes.updateConference,\n      conference: this.state.conferences[id],\n    });\n    try {\n      const rawResponse = await this._client.service\n        .platform()\n        .get(`/account/~/telephony/sessions/${id}`);\n      const response = rawResponse.json();\n      const storedconference = this.state.conferences[response.id];\n      const conference = Object.assign({}, storedconference.conference);\n      conference.parties = response.parties;\n      const { sessionId } = storedconference;\n      this.store.dispatch({\n        type: this.actionTypes.updateConferenceSucceeded,\n        conference,\n        sessionId,\n      });\n    } catch (e) {\n      // TODO: alert\n      this.store.dispatch({\n        type: this.actionTypes.updateConferenceFailed,\n        conference: this.state.conferences[id],\n        message: e.toString(),\n      });\n      // need to propagate to out side try...catch block\n      throw e;\n    } finally {\n      // eslint-disable-next-line no-unsafe-finally\n      return this.state.conferences[id];\n    }\n  }\n\n  /**\n   * terminate a conference.\n   * @param {string} id: conference id\n   */\n  @proxify\n  async terminateConference(id) {\n    this.store.dispatch({\n      type: this.actionTypes.terminateConference,\n      conference: this.state.conferences[id],\n    });\n    const conferenceData = this.conferences[id];\n\n    try {\n      if (this._webphone) {\n        if (conferenceData) {\n          this._webphone.hangup(conferenceData.sessionId);\n          // Help server to do the GC, and we don't care the whether it's successful or not\n          this._client.service\n            .platform()\n            .delete(`/account/~/telephony/sessions/${id}`);\n          this.store.dispatch({\n            type: this.actionTypes.terminateConferenceSucceeded,\n            conference: conferenceData.conference,\n          });\n        } else {\n          this.store.dispatch({\n            type: this.actionTypes.terminateConferenceFailed,\n          });\n        }\n      } else {\n        await this._client.service\n          .platform()\n          .delete(`/account/~/telephony/sessions/${id}`);\n        this.store.dispatch({\n          type: this.actionTypes.terminateConferenceSucceeded,\n          conference: conferenceData.conference,\n        });\n      }\n    } catch (e) {\n      if (\n        !this._availabilityMonitor ||\n        !this._availabilityMonitor.checkIfHAError(e)\n      ) {\n        this._alert.warning({\n          message: conferenceCallErrors.terminateConferenceFailed,\n        });\n      }\n\n      this.store.dispatch({\n        type: this.actionTypes.terminateConferenceFailed,\n        message: e.toString(),\n      });\n    } finally {\n      // eslint-disable-next-line no-unsafe-finally\n      return conferenceData;\n    }\n  }\n\n  /**\n   * Bring-in an outbound call into conference.\n   * @param {string} id: conference id\n   * @param {webphone.session} webphoneSession: get it from callMonitor.\\w+Calls[\\d+]\n   * interface SessionData{\n   *  \"party-id\": String,\n   *  \"session-id\": String\n   * }\n   */\n  @proxify\n  async bringInToConference(id, webphoneSession, propagete = false) {\n    const conferenceState = this.state.conferences[id];\n    if (\n      !conferenceState ||\n      !this.ready ||\n      !webphoneSession ||\n      this.isOverload(id) ||\n      !this._connectivityMonitor.connectivity\n    ) {\n      this._alert.danger({\n        message: conferenceCallErrors.modeError,\n        ttl: 0,\n      });\n      return null;\n    }\n    const { sessionId } = conferenceState;\n    let { conference } = conferenceState;\n\n    this.store.dispatch({\n      type: this.actionTypes.bringInConference,\n      conference,\n      sessionId,\n    });\n\n    try {\n      const partyProfile = this._getProfile(webphoneSession.id);\n      await this._client.service\n        .platform()\n        .post(\n          `/account/~/telephony/sessions/${id}/parties/bring-in`,\n          webphoneSession.partyData,\n        );\n      const newConference = await this.updateConferenceStatus(id);\n      conference = newConference.conference;\n\n      if (partyProfile) {\n        const conferenceState = this.state.conferences[id];\n        const newParties = ascendSortParties(\n          conferenceState.conference.parties,\n        );\n        partyProfile.id = newParties[newParties.length - 1].id;\n      }\n\n      this.store.dispatch({\n        type: this.actionTypes.bringInConferenceSucceeded,\n        conference,\n        sessionId,\n        partyProfile,\n      });\n\n      return id;\n    } catch (e) {\n      this.store.dispatch({\n        type: this.actionTypes.bringInConferenceFailed,\n        message: e.toString(),\n      });\n      if (!propagete) {\n        return null;\n      }\n      throw e;\n    }\n  }\n\n  /**\n   * remove a participant from conference.\n   * @param {string} id: conference id\n   * @param {SessionData} partyId: one participant's id of an conference's `parties` list\n   */\n  @proxify\n  async removeFromConference(id, partyId) {\n    this.store.dispatch({\n      type: this.actionTypes.removeFromConference,\n      conference: this.state.conferences[id],\n    });\n\n    try {\n      await this._client.service\n        .platform()\n        .delete(`/account/~/telephony/sessions/${id}/parties/${partyId}`);\n      await this.updateConferenceStatus(id);\n      this.store.dispatch({\n        type: this.actionTypes.removeFromConferenceSucceeded,\n        conference: this.state.conferences[id],\n      });\n    } catch (e) {\n      if (\n        !this._availabilityMonitor ||\n        !this._availabilityMonitor.checkIfHAError(e)\n      ) {\n        this._alert.warning({\n          message: conferenceCallErrors.removeFromConferenceFailed,\n        });\n      }\n\n      this.store.dispatch({\n        type: this.actionTypes.removeFromConferenceFailed,\n        message: e.toString(),\n      });\n    } finally {\n      // eslint-disable-next-line no-unsafe-finally\n      return this.state.conferences[id];\n    }\n  }\n\n  /**\n   * start a conference call, return the session\n   */\n  @proxify\n  async makeConference(propagate = false) {\n    if (!this.ready || !this._connectivityMonitor.connectivity) {\n      this._alert.danger({\n        message: conferenceCallErrors.modeError,\n        ttl: 0,\n      });\n      return null;\n    }\n    if (!this._checkPermission()) {\n      if (!propagate) {\n        this._alert.danger({\n          message: permissionsMessages.insufficientPrivilege,\n          ttl: 0,\n        });\n      }\n\n      return null;\n    }\n    if (!this._callingSettings.callingMode === callingModes.webphone) {\n      if (!propagate) {\n        this._alert.danger({\n          message: conferenceCallErrors.modeError,\n          ttl: 0,\n        });\n      }\n\n      return null;\n    }\n    const conference = await this._makeConference(propagate);\n    return conference;\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  /**\n   * Merge calls to (or create) a conference.\n   * @param {webphone.sessions} webphoneSessions\n   * FIXME: dynamically construct this function during the construction\n   * to avoid `this._webphone` criterias to improve performance ahead of time\n   */\n  @proxify\n  async mergeToConference(webphoneSessions = []) {\n    webphoneSessions = webphoneSessions\n      .filter((session) => !!session)\n      .filter((session) => !this.isConferenceSession(session.id));\n\n    if (!webphoneSessions.length) {\n      this._alert.warning({\n        message: conferenceCallErrors.bringInFailed,\n      });\n      return;\n    }\n\n    this.store.dispatch({\n      type: this.actionTypes.mergeStart,\n    });\n    let sipInstances;\n    let conferenceId = null;\n\n    if (this._webphone) {\n      /**\n       * Because the concurrency behaviour of the server,\n       * we cannot sure the merging process is over when\n       * the function's procedure has finshed.\n       */\n      sipInstances = webphoneSessions.map((webphoneSession) =>\n        this._webphone._sessions.get(webphoneSession.id),\n      );\n      /**\n       * HACK: we need to preserve the merging session in prevent the glitch of\n       * the call control page.\n       */\n      const sessionIds = webphoneSessions.map((x) => x.id);\n      this._webphone.setSessionCaching(sessionIds);\n\n      const pSips = sipInstances.map((instance) => {\n        const p = new Promise((resolve) => {\n          instance.on('terminated', () => {\n            resolve();\n          });\n        });\n        return p;\n      });\n\n      await Promise.all([\n        this._mergeToConference(webphoneSessions),\n        ...pSips,\n      ]).then(\n        () => {\n          this.store.dispatch({\n            type: this.actionTypes.mergeSucceeded,\n          });\n          const conferenceState = Object.values(this.conferences)[0];\n\n          this._eventEmitter.emit(\n            this.actionTypes.mergeSucceeded,\n            conferenceState,\n          );\n        },\n        () => {\n          const conferenceState = Object.values(this.conferences)[0];\n\n          /**\n           * if create conference successfully but failed to bring-in,\n           *  then terminate the conference.\n           */\n          if (conferenceState && conferenceState.profiles.length < 1) {\n            this.terminateConference(conferenceState.conference.id);\n          }\n          this._alert.warning({\n            message: conferenceCallErrors.bringInFailed,\n          });\n          this.store.dispatch({\n            type: this.actionTypes.mergeFailed,\n          });\n        },\n      );\n      this._webphone.clearSessionCaching();\n    } else {\n      try {\n        conferenceId = await this._mergeToConference(webphoneSessions);\n\n        this.store.dispatch({\n          type: this.actionTypes.mergeSucceeded,\n        });\n        this._eventEmitter.emit(this.actionTypes.mergeSucceeded);\n      } catch (e) {\n        const conferenceState = Object.values(this.conferences)[0];\n        /**\n         * if create conference successfully but failed to bring-in,\n         *  then terminate the conference.\n         */\n        if (conferenceState && conferenceState.conference.parties.length < 1) {\n          this.terminateConference(conferenceState.conference.id);\n        }\n\n        if (\n          !this._availabilityMonitor ||\n          !this._availabilityMonitor.checkIfHAError(e)\n        ) {\n          this._alert.warning({\n            message: conferenceCallErrors.bringInFailed,\n          });\n        }\n      }\n\n      if (!sipInstances || conferenceId === null) {\n        this.store.dispatch({\n          type: this.actionTypes.mergeFailed,\n        });\n      }\n    }\n  }\n\n  @proxify\n  setMergeParty({ fromSessionId, toSessionId }) {\n    if (fromSessionId) {\n      this.store.dispatch({\n        type: this.actionTypes.updateFromSession,\n        fromSessionId,\n      });\n      return;\n    }\n    this.store.dispatch({\n      type: this.actionTypes.updateToSession,\n      toSessionId,\n    });\n  }\n\n  /**\n   * we need to remove the fromSessionId in mergingPair when the outbound call is hang-up\n   */\n  @proxify\n  closeMergingPair() {\n    if (this.mergingPair.fromSessionId) {\n      return this.store.dispatch({\n        type: this.actionTypes.closeMergingPair,\n      });\n    }\n\n    return null;\n  }\n\n  getOnlinePartyProfiles(id) {\n    const conferenceData = this.conferences[id];\n\n    if (conferenceData) {\n      return ascendSortParties(conferenceData.conference.parties)\n        .reduce((accum, party, idx) => {\n          if (\n            party.status.code.toLowerCase() !== partyStatusCode.disconnected\n          ) {\n            // 0 position is the host\n            accum.push({ idx, party });\n          }\n          return accum;\n        }, [])\n        .map(({ idx, party }) => ({\n          ...party,\n          ...conferenceData.profiles[idx],\n        }))\n        .filter((i) => !!i);\n    }\n    return null;\n  }\n\n  getOnlineParties(id) {\n    const conferenceData = this.conferences[id];\n    if (conferenceData) {\n      return conferenceData.conference.parties.filter(\n        (p) => p.status.code.toLowerCase() !== partyStatusCode.disconnected,\n      );\n    }\n    return null;\n  }\n\n  countOnlineParties(id) {\n    const res = this.getOnlineParties(id);\n    return Array.isArray(res) ? res.length : null;\n  }\n\n  isOverload(id) {\n    return this.countOnlineParties(id) >= this.capacity;\n  }\n\n  @proxify\n  async startPollingConferenceStatus(id) {\n    if (this._timers[id] || !this._pulling) {\n      return;\n    }\n\n    await this.updateConferenceStatus(id);\n    this._timers[id] = setTimeout(async () => {\n      await this.updateConferenceStatus(id);\n      this.stopPollingConferenceStatus(id);\n      if (this.conferences[id]) {\n        this.startPollingConferenceStatus(id);\n      }\n    }, this._ttl);\n  }\n\n  stopPollingConferenceStatus(id) {\n    clearTimeout(this._timers[id]);\n    delete this._timers[id];\n  }\n\n  openPulling() {\n    this._pulling = true;\n  }\n\n  closePulling() {\n    this._pulling = false;\n  }\n\n  togglePulling() {\n    this._pulling = !this.pulling;\n  }\n\n  setCapatity(capacity = MAXIMUM_CAPACITY) {\n    if (typeof capacity !== 'number') {\n      throw new Error('The capcity must be a number');\n    }\n    this.capacity = capacity;\n    return capacity;\n  }\n\n  setTimeout(timeout = DEFAULT_TIMEOUT) {\n    if (typeof timeout !== 'number') {\n      throw new Error('The timeout must be a number');\n    }\n    this._timout = timeout;\n    return timeout;\n  }\n\n  onMergeSuccess(func, isOnce) {\n    if (isOnce) {\n      this._eventEmitter.once(this.actionTypes.mergeSucceeded, func);\n      return;\n    }\n    this._eventEmitter.on(this.actionTypes.mergeSucceeded, func);\n  }\n\n  removeMergeSuccess(func) {\n    this.off(this.actionTypes.mergeSucceeded, func);\n  }\n\n  @proxify\n  loadConference(conferenceId) {\n    return this.store.dispatch({\n      type: this.actionTypes.updateCurrentConferenceId,\n      conferenceId,\n    });\n  }\n\n  _init() {\n    this.store.dispatch({\n      type: this.actionTypes.initSuccess,\n    });\n  }\n\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this._init();\n    } else if (this._shouldReset()) {\n      this._reset();\n    }\n  }\n\n  _reset() {\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess,\n    });\n  }\n\n  _shouldInit() {\n    return (\n      this._auth.loggedIn &&\n      this._auth.ready &&\n      this._alert.ready &&\n      this._callingSettings.ready &&\n      this._call.ready &&\n      this._rolesAndPermissions.ready &&\n      this._connectivityMonitor.ready &&\n      (!this._availabilityMonitor || this._availabilityMonitor.ready) &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (!this._auth.loggedIn ||\n        !this._auth.ready ||\n        !this._alert.ready ||\n        !this._callingSettings.ready ||\n        !this._call.ready ||\n        !this._rolesAndPermissions.ready ||\n        !this._connectivityMonitor.ready ||\n        (!!this._availabilityMonitor && !this._availabilityMonitor.ready)) &&\n      this.ready\n    );\n  }\n\n  _checkPermission() {\n    if (!this._rolesAndPermissions.hasConferenceCallPermission) {\n      this._alert.danger({\n        message: permissionsMessages.insufficientPrivilege,\n        ttl: 0,\n      });\n      return false;\n    }\n    return true;\n  }\n\n  @proxify\n  _hookConference(conference, session) {\n    ['accepted'].forEach((evt) =>\n      session.on(evt, () => this.startPollingConferenceStatus(conference.id)),\n    );\n    ['terminated', 'failed', 'rejected'].forEach((evt) =>\n      session.on(evt, () => {\n        this.store.dispatch({\n          type: this.actionTypes.terminateConferenceSucceeded,\n          conference,\n        });\n        this.stopPollingConferenceStatus(conference.id);\n      }),\n    );\n  }\n\n  @proxify\n  async _mergeToConference(webphoneSessions = []) {\n    const conferenceState = Object.values(this.conferences)[0];\n    if (conferenceState) {\n      const conferenceId = conferenceState.conference.id;\n      this.stopPollingConferenceStatus(conferenceId);\n      // for the sake of participants ordering, we can't concurrently bring in the participants\n      for (const webphoneSession of webphoneSessions) {\n        await this.bringInToConference(conferenceId, webphoneSession, true);\n      }\n      if (!this.conferences[conferenceId].profiles.length) {\n        throw new Error(\n          'bring-in operations failed, not all intended parties were brought in',\n        );\n      }\n      this.startPollingConferenceStatus(conferenceId);\n      return conferenceId;\n    }\n    const { id } = await this.makeConference(true);\n    let confereceAccepted = false;\n    await Promise.race([\n      new Promise((resolve, reject) => {\n        const sipSession = this._webphone._sessions.get(\n          this.conferences[id].sessionId,\n        );\n        sipSession.on('accepted', () => {\n          confereceAccepted = true;\n          resolve();\n        });\n        sipSession.on('cancel', () => reject(new Error('conferecing cancel')));\n        sipSession.on('failed', () => reject(new Error('conferecing failed')));\n        sipSession.on('rejected', () =>\n          reject(new Error('conferecing rejected')),\n        );\n        sipSession.on('terminated', () =>\n          reject(new Error('conferecing terminated')),\n        );\n      }),\n      new Promise((resolve, reject) => {\n        setTimeout(\n          () =>\n            confereceAccepted\n              ? resolve()\n              : reject(new Error('conferecing timeout')),\n          this._timout,\n        );\n      }),\n    ]);\n    await this._mergeToConference(webphoneSessions);\n    return id;\n  }\n\n  @proxify\n  async _makeConference(propagate = false) {\n    try {\n      this.store.dispatch({\n        type: this.actionTypes.makeConference,\n      });\n\n      // TODO: replace with SDK function chaining calls\n      const rawResponse = await this._client.service\n        .platform()\n        .post('/account/~/telephony/conference', {});\n      const response = rawResponse.json();\n      const conference = response.session;\n      const phoneNumber = conference.voiceCallToken;\n      // whether to mutate the session to mark the conference?\n      const session = await this._call.call({\n        phoneNumber,\n        isConference: true,\n      });\n      if (\n        typeof session === 'object' &&\n        Object.prototype.toString.call(session.on).toLowerCase() ===\n          '[object function]'\n      ) {\n        this._hookConference(conference, session);\n\n        this.store.dispatch({\n          type: this.actionTypes.makeConferenceSucceeded,\n          conference,\n          sessionId: session.id,\n          parties: [],\n        });\n      } else {\n        this.store.dispatch({\n          type: this.actionTypes.makeConferenceFailed,\n        });\n      }\n      return conference;\n    } catch (e) {\n      this.store.dispatch({\n        type: this.actionTypes.makeConferenceFailed,\n        message: e.toString(),\n      });\n\n      if (\n        !propagate ||\n        (!this._availabilityMonitor ||\n          !this._availabilityMonitor.checkIfHAError(e))\n      ) {\n        this._alert.warning({\n          message: conferenceCallErrors.makeConferenceFailed,\n        });\n        return null;\n      }\n      // need to propagate to out side try...catch block\n      throw e;\n    }\n  }\n\n  _getProfile(sessionId) {\n    const session = this._webphone.sessions.find(\n      (session) => session.id === sessionId,\n    );\n\n    let rcId;\n    let avatarUrl;\n    let calleeType = calleeTypes.unknown;\n    let partyName =\n      session.direction === callDirections.outbound\n        ? session.toUserName\n        : session.fromUserName;\n    const partyNumber =\n      session.direction === callDirections.outbound ? session.to : session.from;\n\n    let matchedContact = session.contactMatch;\n    if (!matchedContact && this._contactMatcher) {\n      const nameMatches = this._contactMatcher.dataMapping[partyNumber];\n      if (nameMatches && nameMatches.length) {\n        matchedContact = nameMatches[0];\n      }\n    }\n\n    if (matchedContact) {\n      rcId = matchedContact.id;\n      avatarUrl = matchedContact.profileImageUrl;\n      partyName = matchedContact.name;\n      calleeType = calleeTypes.contacts;\n    }\n\n    return {\n      rcId,\n      avatarUrl,\n      partyName,\n      partyNumber,\n      calleeType,\n    };\n  }\n\n  @proxify\n  async parseMergingSessions({ sessionId, sessionIdToMergeWith }) {\n    const session = find((x) => x.id === sessionId, this._webphone.sessions);\n\n    const sessionToMergeWith = find(\n      (x) => x.id === (sessionIdToMergeWith || this.mergingPair.fromSessionId),\n      this._webphone.sessions,\n    );\n\n    const webphoneSessions = sessionToMergeWith\n      ? [sessionToMergeWith, session]\n      : [session];\n\n    for (const session of webphoneSessions) {\n      if (!this.validateCallRecording(session)) {\n        return null;\n      }\n    }\n\n    const conferenceState = Object.values(this.conferences)[0];\n    if (conferenceState) {\n      const conferenceSession = find(\n        (x) => x.id === conferenceState.sessionId,\n        this._webphone.sessions,\n      );\n      if (!this.validateCallRecording(conferenceSession)) {\n        return null;\n      }\n    }\n\n    return {\n      session,\n      sessionToMergeWith,\n    };\n  }\n\n  @proxify\n  async mergeSessions({ session, sessionToMergeWith }) {\n    this.setMergeParty({\n      toSessionId: session.id,\n    });\n\n    const webphoneSessions = sessionToMergeWith\n      ? [sessionToMergeWith, session]\n      : [session];\n    await this.mergeToConference(webphoneSessions);\n\n    const conferenceData = Object.values(this.conferences)[0];\n    if (!conferenceData) {\n      await this._webphone.resume(session.id);\n      return null;\n    }\n    const currentConferenceSession = find(\n      (x) => x.id === conferenceData.sessionId,\n      this._webphone.sessions,\n    );\n    const isCurrentConferenceOnhold = currentConferenceSession.isOnHold;\n\n    if (isCurrentConferenceOnhold) {\n      this._webphone.resume(conferenceData.sessionId);\n    }\n\n    return conferenceData;\n  }\n\n  validateCallRecording(session) {\n    if (isRecording(session)) {\n      this._alert.warning({\n        message: conferenceCallErrors.callIsRecording,\n      });\n      return false;\n    }\n    return true;\n  }\n\n  /*\n   * User action track dispatchs\n   * */\n\n  participantListClickHangupTrack() {\n    this.store.dispatch({\n      type: this.actionTypes.participantListClickHangupTrack,\n    });\n  }\n\n  removeParticipantClickCancelTrack() {\n    this.store.dispatch({\n      type: this.actionTypes.removeParticipantClickCancelTrack,\n    });\n  }\n\n  removeParticipantClickRemoveTrack() {\n    this.store.dispatch({\n      type: this.actionTypes.removeParticipantClickRemoveTrack,\n    });\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get conferences() {\n    return this.state.conferences;\n  }\n\n  get conferenceCallStatus() {\n    return this.state.conferenceCallStatus;\n  }\n\n  get isMerging() {\n    return this.state.isMerging;\n  }\n\n  get mergingPair() {\n    return this.state.mergingPair;\n  }\n\n  get currentConferenceId() {\n    return this.state.currentConferenceId;\n  }\n\n  @selector\n  lastCallInfo = [\n    () => this._webphone.sessions,\n    () => this.mergingPair.fromSessionId,\n    () => this.partyProfiles,\n    (sessions, fromSessionId, partyProfiles) => {\n      if (!fromSessionId) {\n        _lastCallInfo = null;\n        return _lastCallInfo;\n      }\n\n      let sessionName;\n      let sessionNumber;\n      let sessionStatus;\n      let matchedContact;\n      const fromSession = sessions.find(\n        (session) => session.id === fromSessionId,\n      );\n      if (fromSession) {\n        sessionName =\n          fromSession.direction === callDirections.outbound\n            ? fromSession.toUserName\n            : fromSession.fromUserName;\n        sessionNumber =\n          fromSession.direction === callDirections.outbound\n            ? fromSession.to\n            : fromSession.from;\n        sessionStatus = fromSession.callStatus;\n        matchedContact = fromSession.contactMatch;\n        if (!matchedContact && this._contactMatcher) {\n          const nameMatches = this._contactMatcher.dataMapping[sessionNumber];\n          if (nameMatches && nameMatches.length) {\n            matchedContact = nameMatches[0];\n          }\n        }\n      }\n\n      let lastCalleeType;\n      if (fromSession) {\n        if (matchedContact) {\n          lastCalleeType = calleeTypes.contacts;\n        } else if (this.isConferenceSession(fromSession.id)) {\n          lastCalleeType = calleeTypes.conference;\n        } else {\n          lastCalleeType = calleeTypes.unknown;\n        }\n      } else if (\n        _fromSessionId === fromSessionId &&\n        _lastCallInfo &&\n        _lastCallInfo.calleeType\n      ) {\n        _lastCallInfo = {\n          ..._lastCallInfo,\n          status: sessionStatusEnum.finished,\n        };\n        return _lastCallInfo;\n      } else {\n        return {\n          calleeType: calleeTypes.unknown,\n        };\n      }\n\n      let partiesAvatarUrls = null;\n      if (lastCalleeType === calleeTypes.conference) {\n        partiesAvatarUrls = (partyProfiles || []).map(\n          (profile) => profile.avatarUrl,\n        );\n      }\n      switch (lastCalleeType) {\n        case calleeTypes.conference:\n          _lastCallInfo = {\n            calleeType: calleeTypes.conference,\n            avatarUrl: partiesAvatarUrls[0],\n            extraNum: partiesAvatarUrls.length - 1,\n            name: null,\n            phoneNumber: null,\n            status: sessionStatus,\n            lastCallContact: null,\n          };\n          break;\n        case calleeTypes.contacts:\n          _lastCallInfo = {\n            calleeType: calleeTypes.contacts,\n            avatarUrl: matchedContact.profileImageUrl,\n            name: matchedContact.name,\n            status: sessionStatus,\n            phoneNumber: sessionNumber,\n            extraNum: 0,\n            lastCallContact: matchedContact,\n          };\n          break;\n        default:\n          _lastCallInfo = {\n            calleeType: calleeTypes.unknown,\n            avatarUrl: null,\n            name: sessionName,\n            status: sessionStatus,\n            phoneNumber: sessionNumber,\n            extraNum: 0,\n            lastCallContact: null,\n          };\n      }\n\n      _fromSessionId = fromSessionId;\n      return _lastCallInfo;\n    },\n  ];\n\n  @selector\n  partyProfiles = [\n    () => this.currentConferenceId,\n    () => this.conferences,\n    (currentConferenceId, conferences) => {\n      const conferenceData = conferences && conferences[currentConferenceId];\n      if (!conferenceData) {\n        return [];\n      }\n      return this.getOnlinePartyProfiles(currentConferenceId);\n    },\n  ];\n}\n"],"file":"index.js"}