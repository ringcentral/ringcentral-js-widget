{"version":3,"sources":["modules/GlipPersons/index.js"],"names":["MaximumBatchGetPersons","DEFAULT_BATCH_FETCH_DELAY","GlipPersons","deps","dep","optional","client","auth","storage","tabManager","rolesAndPermissions","batchFetchDelay","options","actionTypes","_rolesAndPermissions","ensureExist","_client","_auth","_tabManager","_storage","_fetchingIds","_batchFetchDelay","_dataStorageKey","_reducer","registerReducer","key","reducer","glipPersonStore","store","subscribe","_onStateChange","_shouldInit","dispatch","type","init","isFreshLogin","cleanUp","_hasPermission","loadMe","initSuccess","_shouldReset","resetSuccess","loggedIn","ready","pending","loadPerson","ownerId","id","fetch","glip","persons","get","person","fetchSuccess","fetchError","personIds","newPersonIds","forEach","personsMap","push","length","ids","slice","_batchGetPersons","batchFetchSuccess","lastIds","loadPersons","response","join","platform","service","url","multipartResponse","responses","filter","r","ok","map","x","json","getItem","state","status","moduleStatuses","hasGlipPermission","RcModule","proxify"],"mappings":"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","sourcesContent":["import { Module } from '../../lib/di';\nimport RcModule from '../../lib/RcModule';\nimport sleep from '../../lib/sleep';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport { batchGetApi } from '../../lib/batchApiHelper';\nimport proxify from '../../lib/proxy/proxify';\nimport ensureExist from '../../lib/ensureExist';\n\nimport actionTypes from './actionTypes';\nimport getReducer, { getGlipPersonStoreReducer } from './getReducer';\n\nconst MaximumBatchGetPersons = 30;\nconst DEFAULT_BATCH_FETCH_DELAY = 500;\n\n@Module({\n  deps: [\n    'Client',\n    'Auth',\n    'RolesAndPermissions',\n    { dep: 'Storage', optional: true },\n    { dep: 'TabManager', optional: true },\n    { dep: 'GlipPersonsOptions', optional: true },\n  ],\n})\nexport default class GlipPersons extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {Auth} params.auth - auth module instance\n   * @param {RolesAndPermissions} params.rolesAndPermissions - rolesAndPermission module instance\n   * @param {Storage} params.storage - storage module instance\n   * @param {TabManager} params.tabManager - tabManager module instance\n   */\n  constructor({\n    client,\n    auth,\n    storage,\n    tabManager,\n    rolesAndPermissions,\n    batchFetchDelay = DEFAULT_BATCH_FETCH_DELAY,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n\n    this._rolesAndPermissions = this::ensureExist(\n      rolesAndPermissions,\n      'rolesAndPermissions',\n    );\n    this._client = this::ensureExist(client, 'client');\n    this._auth = this::ensureExist(auth, 'auth');\n    this._tabManager = tabManager;\n    this._storage = storage;\n\n    this._fetchingIds = {};\n    this._batchFetchDelay = batchFetchDelay;\n\n    this._dataStorageKey = 'glipPersonsData';\n    if (this._storage) {\n      this._reducer = getReducer(this.actionTypes);\n      this._storage.registerReducer({\n        key: this._dataStorageKey,\n        reducer: getGlipPersonStoreReducer(this.actionTypes),\n      });\n    } else {\n      this._reducer = getReducer(this.actionTypes, {\n        glipPersonStore: getGlipPersonStoreReducer(this.actionTypes),\n      });\n    }\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      if (this._auth.isFreshLogin) {\n        this.store.dispatch({\n          type: this.actionTypes.cleanUp,\n        });\n      }\n      if (!this._hasPermission) return;\n      await this.loadMe();\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (this._shouldReset()) {\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._auth.loggedIn &&\n      this._rolesAndPermissions.ready &&\n      (!this._storage || this._storage.ready) &&\n      (!this._tabManager || this._tabManager.ready) &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      ((this._storage && !this._storage.ready) ||\n        (this._tabManager && !this._tabManager.ready) ||\n        !this._rolesAndPermissions.ready ||\n        !this._auth.loggedIn) &&\n      this.ready\n    );\n  }\n\n  @proxify\n  async loadMe() {\n    await this.loadPerson(this._auth.ownerId);\n  }\n\n  @proxify\n  async loadPerson(id) {\n    try {\n      this.store.dispatch({\n        type: this.actionTypes.fetch,\n      });\n      const person = await this._client\n        .glip()\n        .persons(id)\n        .get();\n      this.store.dispatch({\n        type: this.actionTypes.fetchSuccess,\n        person,\n      });\n    } catch (e) {\n      this.store.dispatch({\n        type: this.actionTypes.fetchError,\n      });\n    }\n  }\n\n  @proxify\n  async loadPersons(personIds) {\n    if (!this._auth.loggedIn) {\n      return;\n    }\n    if (!personIds) {\n      return;\n    }\n    const { ownerId } = this._auth;\n    const newPersonIds = [];\n    personIds.forEach((id) => {\n      if (!this.personsMap[id] && !this._fetchingIds[id]) {\n        newPersonIds.push(id);\n      }\n    });\n    if (newPersonIds.length === 0) {\n      return;\n    }\n    const ids = newPersonIds.slice(0, MaximumBatchGetPersons);\n    ids.forEach((id) => {\n      this._fetchingIds[id] = 1;\n    });\n    try {\n      this.store.dispatch({\n        type: this.actionTypes.fetch,\n      });\n      const persons = await this._batchGetPersons(ids);\n      this.store.dispatch({\n        type: this.actionTypes.batchFetchSuccess,\n        persons,\n      });\n      ids.forEach((id) => {\n        delete this._fetchingIds[id];\n      });\n    } catch (e) {\n      this.store.dispatch({\n        type: this.actionTypes.fetchError,\n      });\n      ids.forEach((id) => {\n        delete this._fetchingIds[id];\n      });\n    }\n    if (ownerId !== this._auth.ownerId) {\n      return;\n    }\n    const lastIds = newPersonIds.slice(MaximumBatchGetPersons);\n    if (lastIds.length > 0) {\n      await sleep(this._batchFetchDelay);\n      await this.loadPersons(lastIds);\n    }\n  }\n\n  async _batchGetPersons(personIds) {\n    if (!personIds || personIds.length === 0) {\n      return [];\n    }\n    if (personIds.length === 1) {\n      const response = await this._client\n        .glip()\n        .persons(personIds[0])\n        .get();\n      return [response];\n    }\n    const ids = personIds.join(',');\n    const multipartResponse = await batchGetApi({\n      platform: this._client.service.platform(),\n      url: `/glip/persons/${ids}`,\n    });\n    const responses = multipartResponse\n      .filter((r) => r.ok())\n      .map((x) => x.json());\n    return responses;\n  }\n\n  get _actionTypes() {\n    return actionTypes;\n  }\n\n  get personsMap() {\n    if (this._storage) {\n      return this._storage.getItem(this._dataStorageKey) || {};\n    }\n    return this.state.glipPersonStore;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.status === moduleStatuses.ready;\n  }\n\n  get me() {\n    return this.personsMap[this._auth.ownerId];\n  }\n\n  get _hasPermission() {\n    return this._rolesAndPermissions.hasGlipPermission;\n  }\n}\n"],"file":"index.js"}