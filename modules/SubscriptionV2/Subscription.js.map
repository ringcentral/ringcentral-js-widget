{"version":3,"sources":["modules/SubscriptionV2/Subscription.ts"],"names":["DEFAULT_TIME_TO_RETRY","DEFAULT_REGISTER_DELAY","DEFAULT_CREATE_DELAY","Subscription","name","deps","dep","optional","storageKey","enableCache","_subscription","_retryTimeoutId","_debouncedRegister","_retry","_handleSleep","ready","_removeSubscription","_createSubscription","_onBeforeLogout","fn","_register","threshold","_registerDelay","_timeToRetry","maxThreshold","filters","_setStates","message","status","subscriptionStatus","cachedSubscription","_deps","tabManager","active","debouncedCreateSubscription","auth","loggedIn","sleepDetector","on","events","detected","addBeforeLogoutHandler","notSubscribed","off","cancel","removeBeforeLogoutHandler","reset","error","subscribed","subscription","flush","sdk","client","service","Subscriptions","createSubscription","setSubscription","notification","_onNotification","removeSuccess","_onRemoveSuccess","removeError","_onRemoveError","renewSuccess","_onRenewSuccess","renewError","_onRenewError","subscribeSuccess","_onSubscribeSuccess","subscribeError","_onSubscribeError","normalizeEventFilter","eventFilters","sort","_shouldUpdateSubscription","subscribing","setEventFilters","register","unsubscribing","remove","oldFiltersCount","length","_addFilters","concat","Math","max","subscriptionOptions","timeToRetry","registerDelay","RcModuleV2","state","storage","action","proxify"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AASA;;AAEA;;AAGA;;AAMA;;AACA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA,IAAMA,qBAAqB,GAAG,KAAK,IAAnC;AACA,IAAMC,sBAAsB,GAAG,IAAI,IAAnC;AACA;AACA;AACA;;AACA,IAAMC,oBAAoB,GAAG,IAAI,IAAjC;IAaaC,Y,WAXZ,gBAAO;AACNC,EAAAA,IAAI,EAAE,cADA;AAENC,EAAAA,IAAI,EAAE,CACJ,MADI,EAEJ,QAFI,EAGJ,SAHI,EAIJ,eAJI,EAKJ;AAAEC,IAAAA,GAAG,EAAE,YAAP;AAAqBC,IAAAA,QAAQ,EAAE;AAA/B,GALI,EAMJ;AAAED,IAAAA,GAAG,EAAE,qBAAP;AAA8BC,IAAAA,QAAQ,EAAE;AAAxC,GANI;AAFA,CAAP,C;;;;;AAwBC,wBAAYF,IAAZ,EAAwB;AAAA;;AAAA;;AACtB,8BAAM;AACJA,MAAAA,IAAI,EAAJA,IADI;AAEJG,MAAAA,UAAU,EAAE,cAFR;AAGJC,MAAAA,WAAW,EAAE;AAHT,KAAN;AADsB,UAZdC,aAYc,GAVpB,IAUoB;AAAA,UARdC,eAQc,GARoB,IAQpB;AAAA,UANdC,kBAMc;AAAA,UAFdC,MAEc;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA,UAyGxBC,YAzGwB,wEAyGT;AAAA;AAAA;AAAA;AAAA;AAAA,oBACT,MAAKC,KAAL,IAAc,MAAKL,aADV;AAAA;AAAA;AAAA;;AAAA;AAAA,qBAGL,MAAKM,mBAAL,EAHK;;AAAA;AAIX,oBAAKC,mBAAL;;AAJW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAzGS;AAAA,UAiHdC,eAjHc,wEAiHI;AAAA;AAAA;AAAA;AAAA;AAAA,mBACtB,MAAKR,aADiB;AAAA;AAAA;AAAA;;AAAA;AAAA,qBAElB,MAAKM,mBAAL,EAFkB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAjHJ;AAMtB,UAAKJ,kBAAL,GAA0B,wCAAiB;AACzCO,MAAAA,EAAE,EAAE,MAAKC,SADgC;AAEzCC,MAAAA,SAAS,EAAE,MAAKC;AAFyB,KAAjB,CAA1B;AAIA,UAAKT,MAAL,GAAc,gCAAS;AACrBM,MAAAA,EAAE,EAAE,MAAKF,mBADY;AAErBI,MAAAA,SAAS,EAAE,MAAKE,YAFK;AAGrBC,MAAAA,YAAY,EAAE,MAAKD;AAHE,KAAT,CAAd;AAVsB;AAevB;;;;gCAQqBE,O,EAAkC;AACtD,WAAKC,UAAL,CAAgB;AAAED,QAAAA,OAAO,EAAE,iBAAK,mBAAOA,OAAP,EAAgB,KAAKA,OAArB,CAAL;AAAX,OAAhB;AACD;;;sCAgBE;AAAA,gCAJDE,OAIC;AAAA,UAJDA,OAIC,8BAJS,KAAKA,OAId;AAAA,gCAHDF,OAGC;AAAA,UAHDA,OAGC,8BAHS,KAAKA,OAGd;AAAA,+BAFDG,MAEC;AAAA,UAFDA,MAEC,6BAFQ,KAAKC,kBAEb;AAAA,wCADDC,kBACC;AAAA,UADDA,kBACC,sCADoB,KAAKA,kBACzB;AACD,WAAKH,OAAL,GAAeA,OAAf;AACA,WAAKF,OAAL,GAAeA,OAAf;AACA,WAAKI,kBAAL,GAA0BD,MAA1B;AACA,WAAKE,kBAAL,GAA0BA,kBAA1B;AACD;;;iCAgBY;AAAA;;AACX,UAAI,KAAKC,KAAL,CAAWC,UAAf,EAA2B;AACzB,yBACE,IADF,EAEE;AAAA,iBAAM,MAAI,CAACF,kBAAX;AAAA,SAFF,uEAGE;AAAA;AAAA;AAAA;AAAA;AACE,sBAAI,MAAI,CAACf,KAAL,IAAc,CAAC,MAAI,CAACgB,KAAL,CAAWC,UAAX,CAAsBC,MAAzC,EAAiD;AAC/C,oBAAA,MAAI,CAAChB,mBAAL;AACD;;AAHH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAHF,IADyB,CAUzB;AACA;AACA;AACA;;AACA,YAAMiB,2BAA2B,GAAG,gCAAS;AAC3Cf,UAAAA,EAAE,EAAE,cAAM;AACR,gBAAI,MAAI,CAACY,KAAL,CAAWC,UAAX,CAAsBC,MAA1B,EAAkC;AAChC,cAAA,MAAI,CAAChB,mBAAL;AACD;AACF,WAL0C;AAM3CI,UAAAA,SAAS,EAAEnB,oBAAoB,GAAG,KAAKoB;AANI,SAAT,CAApC;AAQA,yBACE,IADF,EAEE;AAAA,iBAAM,MAAI,CAACS,KAAL,CAAWC,UAAX,CAAsBC,MAA5B;AAAA,SAFF,EAGE,YAAM;AACJ,cAAI,CAAC,MAAI,CAACH,kBAAN,IAA4B,MAAI,CAACC,KAAL,CAAWC,UAAX,CAAsBC,MAAtD,EAA8D;AAC5DC,YAAAA,2BAA2B;AAC5B;AACF,SAPH;AASD;AACF;;;kCAEa;AACZ,aAAO,iFAAuB,KAAKH,KAAL,CAAWI,IAAX,CAAgBC,QAA9C;AACD;;;mCAEc;AACb,aAAO,kFAAyB,KAAKrB,KAAL,IAAc,CAAC,KAAKgB,KAAL,CAAWI,IAAX,CAAgBC,QAA/D;AACD;;;6BAgBQ;AACP,WAAKL,KAAL,CAAWM,aAAX,CAAyBC,EAAzB,CACE,KAAKP,KAAL,CAAWM,aAAX,CAAyBE,MAAzB,CAAgCC,QADlC,EAEE,KAAK1B,YAFP;;AAIA,WAAKiB,KAAL,CAAWI,IAAX,CAAgBM,sBAAhB,CAAuC,KAAKvB,eAA5C;AACD;;;;;;;;;AAGC,qBAAKQ,UAAL,CAAgB;AACdD,kBAAAA,OAAO,EAAE,EADK;AAEdE,kBAAAA,OAAO,EAAE,IAFK;AAGdC,kBAAAA,MAAM,EAAEC,uCAAmBa;AAHb,iBAAhB;;AAKA,qBAAKX,KAAL,CAAWM,aAAX,CAAyBM,GAAzB,CACE,KAAKZ,KAAL,CAAWM,aAAX,CAAyBE,MAAzB,CAAgCC,QADlC,EAEE,KAAK1B,YAFP;;AAIA,qBAAKD,MAAL,CAAY+B,MAAZ;;AACA,qBAAKb,KAAL,CAAWI,IAAX,CAAgBU,yBAAhB,CAA0C,KAAK3B,eAA/C;;AACA,qBAAKN,kBAAL,CAAwBgC,MAAxB;;AACA,oBAAI,KAAKlC,aAAT,EAAwB;AACtB,uBAAKA,aAAL,CAAmBoC,KAAnB;;AACA,uBAAKpC,aAAL,GAAqB,IAArB;AACD;;;;;;;;;;;;;;;;;;uCAG0B;AAC3B,WAAKgB,UAAL,CAAgB;AACdE,QAAAA,MAAM,EAAEC,uCAAmBa,aADb;AAEdZ,QAAAA,kBAAkB,EAAE;AAFN,OAAhB;AAID;;;mCAEwBiB,K,EAAyB;AAChD,WAAKrB,UAAL,CAAgB;AACdE,QAAAA,MAAM,EAAEC,uCAAmBa,aADb;AAEdZ,QAAAA,kBAAkB,EAAE;AAFN,OAAhB;AAID;;;sCAE2B;AAC1B,UAAI,KAAKpB,aAAT,EAAwB;AACtB,aAAKgB,UAAL,CAAgB;AACdE,UAAAA,MAAM,EAAEC,uCAAmBmB,UADb;AAEdlB,UAAAA,kBAAkB,EAAE,KAAKpB,aAAL,CAAmBuC,YAAnB;AAFN,SAAhB;AAID;AACF;;;kCAEuBF,K,EAAyB;AAC/C,UAAI,KAAKrC,aAAT,EAAwB;AACtB,aAAKA,aAAL,CAAmBoC,KAAnB;;AACA,aAAKpC,aAAL,GAAqB,IAArB;AACD;;AACD,WAAKgB,UAAL,CAAgB;AACdE,QAAAA,MAAM,EAAEC,uCAAmBa,aADb;AAEdZ,QAAAA,kBAAkB,EAAE;AAFN,OAAhB;;AAIA,UAAI,KAAKf,KAAT,EAAgB;AACd;AACA,aAAKF,MAAL;;AACA,aAAKA,MAAL,CAAYqC,KAAZ;AACD;AACF;;;0CAE+B;AAC9B,UAAI,KAAKxC,aAAT,EAAwB;AACtB,aAAKgB,UAAL,CAAgB;AACdE,UAAAA,MAAM,EAAEC,uCAAmBmB,UADb;AAEdlB,UAAAA,kBAAkB,EAAE,KAAKpB,aAAL,CAAmBuC,YAAnB;AAFN,SAAhB;AAID;AACF;;;sCAE2BF,K,EAAyB;AACnD,WAAKrB,UAAL,CAAgB;AACdE,QAAAA,MAAM,EAAEC,uCAAmBa,aADb;AAEdZ,QAAAA,kBAAkB,EAAE;AAFN,OAAhB;;AAIA,UAAI,KAAKf,KAAT,EAAgB;AACd,aAAKF,MAAL;AACD;AACF;;;oCAEyBc,O,EAAsB;AAC9C,WAAKD,UAAL,CAAgB;AACdC,QAAAA,OAAO,EAAPA;AADc,OAAhB;AAGD;;;;;;;;;;;;AAGC,oBAAI,KAAKZ,KAAL,IAAc,CAAC,KAAKL,aAAxB,EAAuC;AAC/ByC,kBAAAA,GAD+B,GACzB,KAAKpB,KAAL,CAAWqB,MAAX,CAAkBC,OADO;AAErC,uBAAK3C,aAAL,GAAqB,IAAI4C,yBAAJ,CAAkB;AAAEH,oBAAAA,GAAG,EAAHA;AAAF,mBAAlB,EAA2BI,kBAA3B,EAArB;;AACA,sBAAI,KAAKzB,kBAAT,EAA6B;AAC3B,wBAAI;AACF,2BAAKpB,aAAL,CAAmB8C,eAAnB,CAAmC,KAAK1B,kBAAxC;AACD,qBAFD,CAEE,OAAOiB,KAAP,EAAc;AACd,2BAAKrC,aAAL,GAAqB,IAAI4C,yBAAJ,CAAkB;AAAEH,wBAAAA,GAAG,EAAHA;AAAF,uBAAlB,EAA2BI,kBAA3B,EAArB;AACD;AACF;;AACD,uBAAK7C,aAAL,CAAmB4B,EAAnB,CACE,KAAK5B,aAAL,CAAmB6B,MAAnB,CAA0BkB,YAD5B,EAEE,UAAC9B,OAAD;AAAA,2BAA0B,MAAI,CAAC+B,eAAL,CAAqB/B,OAArB,CAA1B;AAAA,mBAFF;;AAIA,uBAAKjB,aAAL,CAAmB4B,EAAnB,CAAsB,KAAK5B,aAAL,CAAmB6B,MAAnB,CAA0BoB,aAAhD,EAA+D;AAAA,2BAC7D,MAAI,CAACC,gBAAL,EAD6D;AAAA,mBAA/D;;AAGA,uBAAKlD,aAAL,CAAmB4B,EAAnB,CAAsB,KAAK5B,aAAL,CAAmB6B,MAAnB,CAA0BsB,WAAhD,EAA6D,UAACd,KAAD;AAAA,2BAC3D,MAAI,CAACe,cAAL,CAAoBf,KAApB,CAD2D;AAAA,mBAA7D;;AAGA,uBAAKrC,aAAL,CAAmB4B,EAAnB,CAAsB,KAAK5B,aAAL,CAAmB6B,MAAnB,CAA0BwB,YAAhD,EAA8D;AAAA,2BAC5D,MAAI,CAACC,eAAL,EAD4D;AAAA,mBAA9D;;AAGA,uBAAKtD,aAAL,CAAmB4B,EAAnB,CAAsB,KAAK5B,aAAL,CAAmB6B,MAAnB,CAA0B0B,UAAhD,EAA4D,UAAClB,KAAD;AAAA,2BAC1D,MAAI,CAACmB,aAAL,CAAmBnB,KAAnB,CAD0D;AAAA,mBAA5D;;AAGA,uBAAKrC,aAAL,CAAmB4B,EAAnB,CAAsB,KAAK5B,aAAL,CAAmB6B,MAAnB,CAA0B4B,gBAAhD,EAAkE;AAAA,2BAChE,MAAI,CAACC,mBAAL,EADgE;AAAA,mBAAlE;;AAGA,uBAAK1D,aAAL,CAAmB4B,EAAnB,CAAsB,KAAK5B,aAAL,CAAmB6B,MAAnB,CAA0B8B,cAAhD,EAAgE,UAACtB,KAAD;AAAA,2BAC9D,MAAI,CAACuB,iBAAL,CAAuBvB,KAAvB,CAD8D;AAAA,mBAAhE;AAGD;;;;uBAEO,KAAKnC,kBAAL,E;;;;;;;;;;sBAEF,aAAMe,OAAN,KAAkB,W;;;;;;;;;;;;;;;;;;;;;;;gDAMY;AACpC,aAAO,CAAC,EACN,KAAKjB,aAAL,IACA,CAAC,mBACC,gBAAI6D,0CAAJ,EAA0B,KAAK7D,aAAL,CAAmB8D,YAAnB,EAA1B,EAA6DC,IAA7D,EADD,EAEC,gBAAIF,0CAAJ,EAA0B,KAAK9C,OAA/B,EAAwCgD,IAAxC,EAFD,CAFK,CAAR;AAOD;;;;;;;;;qBAGK,KAAKC,yBAAL,E;;;;;AACF,qBAAKhD,UAAL,CAAgB;AACdE,kBAAAA,MAAM,EAAEC,uCAAmB8C;AADb,iBAAhB;;AAGA,qBAAKjE,aAAL,CAAmBkE,eAAnB,oBAAuC,KAAKnD,OAA5C;;;uBACM,KAAKf,aAAL,CAAmBmE,QAAnB,E;;;;;;;;;;;;;;;;;;;;;;;;qBAKJ,KAAKnE,a;;;;;AACP,qBAAKgB,UAAL,CAAgB;AACdE,kBAAAA,MAAM,EAAEC,uCAAmBiD;AADb,iBAAhB;;;;uBAIQ,KAAKpE,aAAL,CAAmBqE,MAAnB,E;;;;;;;;;;;AAIR,oBAAI,KAAKrE,aAAT,EAAwB;AACtB,uBAAKA,aAAL,CAAmBoC,KAAnB;;AACA,uBAAKpC,aAAL,GAAqB,IAArB;AACD;;AACD,qBAAKgB,UAAL,CAAgB;AACdE,kBAAAA,MAAM,EAAEC,uCAAmBa;AADb,iBAAhB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAOYH,gBAAAA,M,8DAAkC,E;;qBAC5C,KAAKxB,K;;;;;AACDiE,gBAAAA,e,mDAAkB,KAAKtE,a,wDAAL,oBAAoB8D,YAApB,GAAmCS,M,yEAAU,C,EACrE;;AACA,qBAAKC,WAAL,CAAiB,GAAGC,MAAH,CAAU5C,MAAV,CAAjB;;sBAEEyC,eAAe,KAAK,KAAKvD,OAAL,CAAawD,MAAjC,KACC,CAAC,KAAKlD,KAAL,CAAWC,UAAZ,IAA0B,KAAKD,KAAL,CAAWC,UAAX,CAAsBC,MADjD,C;;;;;;uBAGM,KAAKhB,mBAAL,E;;;;;;;;;;;;;;;;;;wBA/PO;AAAA;;AACjB,aAAOmE,IAAI,CAACC,GAAL,CACL,CADK,qDAEL,KAAKtD,KAAL,CAAWuD,mBAFN,2DAEL,uBAAgCC,WAF3B,yEAE0CvF,qBAF1C,CAAP;AAID;;;wBAEoB;AAAA;;AACnB,aAAOoF,IAAI,CAACC,GAAL,CACL,CADK,sDAEL,KAAKtD,KAAL,CAAWuD,mBAFN,2DAEL,uBAAgCE,aAF3B,2EAE4CvF,sBAF5C,CAAP;AAID;;;;EAzE+BwF,gB,2EA8B/BC,W;;;;;WACsB,I;;4EAEtBA,W;;;;;WACuD,E;;uFAMvDC,a,EACAD,W;;;;;WACsC,I;;uFAEtCA,W;;;;;WAEC7D,uCAAmBa,a;;gEAEpBkD,Y,oJAkQAC,mB","sourcesContent":["import {\n  action,\n  RcModuleV2,\n  state,\n  storage,\n  watch,\n} from '@ringcentral-integration/core';\nimport { ObjectMapValue } from '@ringcentral-integration/core/lib/ObjectMap';\nimport { ApiError } from '@ringcentral/sdk';\nimport Subscriptions from '@ringcentral/subscriptions';\nimport { SubscriptionData } from '@ringcentral/subscriptions/src/subscription/Subscription';\nimport { concat, equals, map, uniq } from 'ramda';\n\nimport { subscriptionFilters } from '../../enums/subscriptionFilters';\nimport {\n  debounce,\n  promisedDebounce,\n  PromisedDebounceFunction,\n  DebouncedFunction,\n} from '../../lib/debounce-throttle';\nimport { Module } from '../../lib/di';\nimport proxify from '../../lib/proxy/proxify';\nimport { normalizeEventFilter } from '../Subscription/normalizeEventFilter';\nimport { subscriptionStatus } from '../Subscription/subscriptionStatus';\nimport { Deps, MessageBase } from './Subscription.interface';\n\nconst DEFAULT_TIME_TO_RETRY = 60 * 1000;\nconst DEFAULT_REGISTER_DELAY = 2 * 1000;\n/**\n * 5 seconds\n */\nconst DEFAULT_CREATE_DELAY = 5 * 1000;\n\n@Module({\n  name: 'Subscription',\n  deps: [\n    'Auth',\n    'Client',\n    'Storage',\n    'SleepDetector',\n    { dep: 'TabManager', optional: true },\n    { dep: 'SubscriptionOptions', optional: true },\n  ],\n})\nexport class Subscription extends RcModuleV2<Deps> {\n  protected _subscription: ReturnType<\n    Subscriptions['createSubscription']\n  > = null;\n\n  protected _retryTimeoutId: NodeJS.Timeout = null;\n\n  protected _debouncedRegister: PromisedDebounceFunction<\n    Subscription['_register']\n  >;\n\n  protected _retry: DebouncedFunction<Subscription['_createSubscription']>;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n      storageKey: 'subscription',\n      enableCache: true,\n    });\n    this._debouncedRegister = promisedDebounce({\n      fn: this._register,\n      threshold: this._registerDelay,\n    });\n    this._retry = debounce({\n      fn: this._createSubscription,\n      threshold: this._timeToRetry,\n      maxThreshold: this._timeToRetry,\n    });\n  }\n\n  @state\n  message: MessageBase = null;\n\n  @state\n  filters: ObjectMapValue<typeof subscriptionFilters>[] = [];\n\n  protected _addFilters(filters: Subscription['filters']) {\n    this._setStates({ filters: uniq(concat(filters, this.filters)) });\n  }\n\n  @storage\n  @state\n  cachedSubscription: SubscriptionData = null;\n\n  @state\n  subscriptionStatus: ObjectMapValue<typeof subscriptionStatus> =\n    subscriptionStatus.notSubscribed;\n\n  @action\n  protected _setStates({\n    message = this.message,\n    filters = this.filters,\n    status = this.subscriptionStatus,\n    cachedSubscription = this.cachedSubscription,\n  }) {\n    this.message = message;\n    this.filters = filters;\n    this.subscriptionStatus = status;\n    this.cachedSubscription = cachedSubscription;\n  }\n\n  get _timeToRetry() {\n    return Math.max(\n      0,\n      this._deps.subscriptionOptions?.timeToRetry ?? DEFAULT_TIME_TO_RETRY,\n    );\n  }\n\n  get _registerDelay() {\n    return Math.max(\n      0,\n      this._deps.subscriptionOptions?.registerDelay ?? DEFAULT_REGISTER_DELAY,\n    );\n  }\n\n  onInitOnce() {\n    if (this._deps.tabManager) {\n      watch(\n        this,\n        () => this.cachedSubscription,\n        async () => {\n          if (this.ready && !this._deps.tabManager.active) {\n            this._createSubscription();\n          }\n        },\n      );\n      // When closing the current tab before successfully registering a subscription,\n      // app create a subscription and register the subscription at the default delay of 5s on the delayed registration time.\n      // And when registering a subscription request for more than 5s will accidentally trigger a subscription request in other tabs that were once active,\n      // but this is an edge case and only up to two tabs registering for subscriptions is not enough to trigger the subscription limit in server side.\n      const debouncedCreateSubscription = debounce({\n        fn: () => {\n          if (this._deps.tabManager.active) {\n            this._createSubscription();\n          }\n        },\n        threshold: DEFAULT_CREATE_DELAY + this._registerDelay,\n      });\n      watch(\n        this,\n        () => this._deps.tabManager.active,\n        () => {\n          if (!this.cachedSubscription && this._deps.tabManager.active) {\n            debouncedCreateSubscription();\n          }\n        },\n      );\n    }\n  }\n\n  _shouldInit() {\n    return super._shouldInit() && this._deps.auth.loggedIn;\n  }\n\n  _shouldReset() {\n    return super._shouldReset() || (this.ready && !this._deps.auth.loggedIn);\n  }\n\n  _handleSleep = async () => {\n    if (this.ready && this._subscription) {\n      // forcibly recreate subscription to ensure pubnub is alive\n      await this._removeSubscription();\n      this._createSubscription();\n    }\n  };\n\n  protected _onBeforeLogout = async () => {\n    if (this._subscription) {\n      await this._removeSubscription();\n    }\n  };\n\n  onInit() {\n    this._deps.sleepDetector.on(\n      this._deps.sleepDetector.events.detected,\n      this._handleSleep,\n    );\n    this._deps.auth.addBeforeLogoutHandler(this._onBeforeLogout);\n  }\n\n  async onReset() {\n    this._setStates({\n      filters: [],\n      message: null,\n      status: subscriptionStatus.notSubscribed,\n    });\n    this._deps.sleepDetector.off(\n      this._deps.sleepDetector.events.detected,\n      this._handleSleep,\n    );\n    this._retry.cancel();\n    this._deps.auth.removeBeforeLogoutHandler(this._onBeforeLogout);\n    this._debouncedRegister.cancel();\n    if (this._subscription) {\n      this._subscription.reset();\n      this._subscription = null;\n    }\n  }\n\n  protected _onRemoveSuccess() {\n    this._setStates({\n      status: subscriptionStatus.notSubscribed,\n      cachedSubscription: null,\n    });\n  }\n\n  protected _onRemoveError(error: ApiError | Error) {\n    this._setStates({\n      status: subscriptionStatus.notSubscribed,\n      cachedSubscription: null,\n    });\n  }\n\n  protected _onRenewSuccess() {\n    if (this._subscription) {\n      this._setStates({\n        status: subscriptionStatus.subscribed,\n        cachedSubscription: this._subscription.subscription(),\n      });\n    }\n  }\n\n  protected _onRenewError(error: ApiError | Error) {\n    if (this._subscription) {\n      this._subscription.reset();\n      this._subscription = null;\n    }\n    this._setStates({\n      status: subscriptionStatus.notSubscribed,\n      cachedSubscription: null,\n    });\n    if (this.ready) {\n      // immediately start the retry process after the first renewError\n      this._retry();\n      this._retry.flush();\n    }\n  }\n\n  protected _onSubscribeSuccess() {\n    if (this._subscription) {\n      this._setStates({\n        status: subscriptionStatus.subscribed,\n        cachedSubscription: this._subscription.subscription(),\n      });\n    }\n  }\n\n  protected _onSubscribeError(error: ApiError | Error) {\n    this._setStates({\n      status: subscriptionStatus.notSubscribed,\n      cachedSubscription: null,\n    });\n    if (this.ready) {\n      this._retry();\n    }\n  }\n\n  protected _onNotification(message: MessageBase) {\n    this._setStates({\n      message,\n    });\n  }\n\n  protected async _createSubscription() {\n    if (this.ready && !this._subscription) {\n      const sdk = this._deps.client.service;\n      this._subscription = new Subscriptions({ sdk }).createSubscription();\n      if (this.cachedSubscription) {\n        try {\n          this._subscription.setSubscription(this.cachedSubscription);\n        } catch (error) {\n          this._subscription = new Subscriptions({ sdk }).createSubscription();\n        }\n      }\n      this._subscription.on(\n        this._subscription.events.notification,\n        (message: MessageBase) => this._onNotification(message),\n      );\n      this._subscription.on(this._subscription.events.removeSuccess, () =>\n        this._onRemoveSuccess(),\n      );\n      this._subscription.on(this._subscription.events.removeError, (error) =>\n        this._onRemoveError(error),\n      );\n      this._subscription.on(this._subscription.events.renewSuccess, () =>\n        this._onRenewSuccess(),\n      );\n      this._subscription.on(this._subscription.events.renewError, (error) =>\n        this._onRenewError(error),\n      );\n      this._subscription.on(this._subscription.events.subscribeSuccess, () =>\n        this._onSubscribeSuccess(),\n      );\n      this._subscription.on(this._subscription.events.subscribeError, (error) =>\n        this._onSubscribeError(error),\n      );\n    }\n    try {\n      await this._debouncedRegister();\n    } catch (error) {\n      if (error.message !== 'cancelled') {\n        throw error;\n      }\n    }\n  }\n\n  protected _shouldUpdateSubscription() {\n    return !!(\n      this._subscription &&\n      !equals(\n        map(normalizeEventFilter, this._subscription.eventFilters()).sort(),\n        map(normalizeEventFilter, this.filters).sort(),\n      )\n    );\n  }\n\n  protected async _register() {\n    if (this._shouldUpdateSubscription()) {\n      this._setStates({\n        status: subscriptionStatus.subscribing,\n      });\n      this._subscription.setEventFilters([...this.filters]);\n      await this._subscription.register();\n    }\n  }\n\n  protected async _removeSubscription() {\n    if (this._subscription) {\n      this._setStates({\n        status: subscriptionStatus.unsubscribing,\n      });\n      try {\n        await this._subscription.remove();\n      } catch (error) {\n        /* removeError is handled elsewhere */\n      }\n      if (this._subscription) {\n        this._subscription.reset();\n        this._subscription = null;\n      }\n      this._setStates({\n        status: subscriptionStatus.notSubscribed,\n      });\n    }\n  }\n\n  @proxify\n  async subscribe(events: Subscription['filters'] = []) {\n    if (this.ready) {\n      const oldFiltersCount = this._subscription?.eventFilters().length ?? 0;\n      // use [].concat for potential compatibility issue\n      this._addFilters([].concat(events));\n      if (\n        oldFiltersCount !== this.filters.length &&\n        (!this._deps.tabManager || this._deps.tabManager.active)\n      ) {\n        await this._createSubscription();\n      }\n    }\n  }\n}\n"],"file":"Subscription.js"}