{"version":3,"sources":["modules/RolesAndPermissions/index.js"],"names":["DEFAULT_TTL","extractData","permissions","output","forEach","item","permission","id","RolesAndPermissions","deps","dep","optional","isCRM","flag","client","alert","extensionInfo","ttl","options","fetchFunction","_client","account","extension","authzProfile","get","readyCheckFn","_extensionInfo","ready","forbiddenHandler","_auth","logout","_alert","danger","message","permissionsMessages","insufficientPrivilege","cleanOnReset","_isCRM","_flag","_onDataReadyHandler","_isDataReady","handler","loginStatus","loggedIn","tierEnabled","invalidTier","ReadUserInfo","hasPermissions","data","fn","push","fetchData","serviceFeatures","RingOut","enabled","WebPhone","webphoneEnabled","ringoutEnabled","ReadCallLog","callingEnabled","ReadPresenceStatus","EditPresenceStatus","Pager","SMS","readTextPermissions","voicemailPermissions","readFaxPermissions","PagerReceiving","SMSReceiving","Voicemail","FaxReceiving","hasReadMessagesPermission","Conferencing","Glip","Meetings","token","scope","indexOf","DataFetcher","selector"],"mappings":"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","sourcesContent":["import { Module } from '../../lib/di';\nimport { selector } from '../../lib/selector';\nimport DataFetcher from '../../lib/DataFetcher';\nimport permissionsMessages from './permissionsMessages';\nimport loginStatus from '../Auth/loginStatus';\nimport ensureExist from '../../lib/ensureExist';\n\nconst DEFAULT_TTL = 24 * 60 * 60 * 1000;\n\nfunction extractData(permissions) {\n  const output = {};\n  permissions.permissions.forEach((item) => {\n    output[item.permission.id] = true;\n  });\n  return output;\n}\n\n/**\n * @class\n * @description Roles and permission module\n */\n@Module({\n  deps: [\n    'Client',\n    'Alert',\n    'ExtensionInfo',\n    { dep: 'RolesAndPermissionsOptions', optional: true },\n  ],\n})\nexport default class RolesAndPermissions extends DataFetcher {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {Alert} params.alert - alert module instance\n   * @param {ExtensionInfo} params.extensionInfo - extensionInfo module instance\n   * @param {Bool} params.isCRM - if it is CRM\n   * @param {String} params.flag - app flag\n   * @param {Number} params.ttl - local cache time\n   */\n  constructor({\n    isCRM,\n    flag,\n    client,\n    alert,\n    extensionInfo,\n    ttl = DEFAULT_TTL,\n    ...options\n  }) {\n    super({\n      ...options,\n      client,\n      ttl,\n      fetchFunction: async () =>\n        extractData(\n          await this._client\n            .account()\n            .extension()\n            .authzProfile()\n            .get(),\n        ),\n      readyCheckFn: () => this._extensionInfo.ready,\n      forbiddenHandler: async () => {\n        await this._auth.logout();\n        this._alert.danger({\n          message: permissionsMessages.insufficientPrivilege,\n          ttl: 0,\n        });\n        return {};\n      },\n      cleanOnReset: true,\n    });\n    this._isCRM = !!isCRM;\n    this._flag = flag || 'SalesForce';\n    this._alert = ensureExist(alert, 'alert');\n    this._extensionInfo = ensureExist(extensionInfo, 'extensionInfo');\n    this._onDataReadyHandler = [];\n  }\n\n  get _name() {\n    return 'rolesAndPermissions';\n  }\n\n  async _onStateChange() {\n    // fire event handler when data is ready\n    if (this._isDataReady()) {\n      for (const handler of this._onDataReadyHandler) {\n        handler();\n      }\n    }\n    await super._onStateChange();\n    if (\n      this.ready &&\n      this._auth.loginStatus === loginStatus.loggedIn &&\n      this._isCRM &&\n      this.tierEnabled !== null &&\n      !this.tierEnabled\n    ) {\n      await this._auth.logout();\n      this._alert.danger({\n        message: permissionsMessages.invalidTier,\n        ttl: 0,\n      });\n    }\n    if (\n      this.ready &&\n      this._auth.loginStatus === loginStatus.loggedIn &&\n      !this.permissions.ReadUserInfo\n    ) {\n      const hasPermissions = !!this.data;\n      await this._auth.logout();\n      if (hasPermissions) {\n        this._alert.danger({\n          message: permissionsMessages.insufficientPrivilege,\n          ttl: 0,\n        });\n      }\n    }\n  }\n\n  onDataReady(fn) {\n    this._onDataReadyHandler.push(fn);\n  }\n\n  refreshServiceFeatures() {\n    if (this._extensionInfo.ready) {\n      this._extensionInfo.fetchData();\n    }\n  }\n\n  get serviceFeatures() {\n    return this._extensionInfo.serviceFeatures;\n  }\n\n  @selector\n  permissions = [() => this.data, (data) => data || {}];\n\n  get ringoutEnabled() {\n    return !!(\n      this._extensionInfo.serviceFeatures &&\n      this._extensionInfo.serviceFeatures.RingOut &&\n      this._extensionInfo.serviceFeatures.RingOut.enabled\n    );\n  }\n\n  get webphoneEnabled() {\n    return !!(\n      this._extensionInfo.serviceFeatures &&\n      this._extensionInfo.serviceFeatures.WebPhone &&\n      this._extensionInfo.serviceFeatures.WebPhone.enabled\n    );\n  }\n\n  get callingEnabled() {\n    return this.webphoneEnabled || this.ringoutEnabled;\n  }\n\n  get tierEnabled() {\n    if (\n      !this._extensionInfo.serviceFeatures ||\n      !this._extensionInfo.serviceFeatures[this._flag]\n    ) {\n      return null;\n    }\n    return this._extensionInfo.serviceFeatures[this._flag].enabled;\n  }\n\n  get hasReadCallLogPermission() {\n    return !!(this.ready && this.permissions && this.permissions.ReadCallLog);\n  }\n\n  get hasPresencePermission() {\n    return !!(\n      this.ready &&\n      this.callingEnabled &&\n      this.permissions &&\n      this.permissions.ReadPresenceStatus\n    );\n  }\n\n  get hasEditPresencePermission() {\n    return !!(\n      this.ready &&\n      this.callingEnabled &&\n      this.permissions &&\n      this.permissions.EditPresenceStatus\n    );\n  }\n\n  get hasComposeTextPermission() {\n    return !!(\n      this.serviceFeatures &&\n      ((this.serviceFeatures.Pager && this.serviceFeatures.Pager.enabled) ||\n        (this.serviceFeatures.SMS && this.serviceFeatures.SMS.enabled))\n    );\n  }\n\n  get onlyPagerPermission() {\n    return !!(\n      this.serviceFeatures &&\n      this.serviceFeatures.Pager &&\n      this.serviceFeatures.Pager.enabled &&\n      this.serviceFeatures.SMS &&\n      !this.serviceFeatures.SMS.enabled\n    );\n  }\n\n  get hasReadMessagesPermission() {\n    return (\n      this.ready &&\n      (this.readTextPermissions ||\n        this.voicemailPermissions ||\n        this.readFaxPermissions)\n    );\n  }\n\n  get readTextPermissions() {\n    return !!(\n      this.serviceFeatures &&\n      ((this.serviceFeatures.PagerReceiving &&\n        this.serviceFeatures.PagerReceiving.enabled) ||\n        (this.serviceFeatures.SMSReceiving &&\n          this.serviceFeatures.SMSReceiving.enabled))\n    );\n  }\n\n  get voicemailPermissions() {\n    return !!(\n      this.permissions &&\n      this.permissions.Voicemail &&\n      this.serviceFeatures &&\n      this.serviceFeatures.Voicemail &&\n      this.serviceFeatures.Voicemail.enabled\n    );\n  }\n\n  get readFaxPermissions() {\n    return !!(\n      this.serviceFeatures &&\n      this.serviceFeatures.FaxReceiving &&\n      this.serviceFeatures.FaxReceiving.enabled\n    );\n  }\n\n  get hasUserGuidePermission() {\n    return !!(this.callingEnabled || this.hasReadMessagesPermission);\n  }\n\n  get hasConferencingPermission() {\n    return !!(\n      this.serviceFeatures &&\n      this.serviceFeatures.Conferencing &&\n      this.serviceFeatures.Conferencing.enabled\n    );\n  }\n\n  get hasGlipPermission() {\n    return !!(this.permissions && this.permissions.Glip);\n  }\n\n  get hasConferenceCallPermission() {\n    return this.callingEnabled && this.webphoneEnabled;\n  }\n\n  get hasMeetingsPermission() {\n    return !!(this.permissions && this.permissions.Meetings);\n  }\n\n  get hasCallControlPermission() {\n    return (\n      this._auth.token.scope?.indexOf('CallControl') > -1 ||\n      this._auth.token.scope?.indexOf('TelephonySession') > -1\n    );\n  }\n}\n"],"file":"index.js"}