{"version":3,"sources":["modules/ExtensionFeatures/ExtensionFeatures.ts"],"names":["ExtensionFeatures","name","deps","dep","optional","data","_stopWatching","_handleSubscription","message","ready","_source","disableCache","_deps","tabManager","active","body","hints","includes","subscriptionHints","limits","features","permissions","fetchData","DataSource","polling","extensionFeaturesOptions","key","cleanOnReset","fetchFunction","client","service","platform","get","response","json","readyCheckFunction","subscription","dataFetcherV2","register","subscribe","subscriptionFilters","extensionInfo","item","id","records","CRMFlag","available","RingOut","WebPhone","isRingOutEnabled","isWebPhoneEnabled","PagesSending","SMSSending","hasReadTextPermission","hasVoicemailPermission","hasReadFaxPermission","PagesReceiving","SMSReceiving","Voicemail","FaxReceiving","RoomConnectorBeta","DataFetcherV2Consumer"],"mappings":"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","sourcesContent":["import {\n  ExtensionInfoEvent,\n  FeatureInfo,\n  FeatureList,\n} from '@rc-ex/core/definitions';\nimport { computed, watch } from '@ringcentral-integration/core';\nimport { reduce } from 'ramda';\nimport { Unsubscribe } from 'redux';\nimport { subscriptionFilters } from '../../enums/subscriptionFilters';\nimport { subscriptionHints } from '../../enums/subscriptionHints';\nimport { Module } from '../../lib/di';\nimport { DataFetcherV2Consumer, DataSource } from '../DataFetcherV2';\nimport { Deps } from './ExtensionFeatures.interface';\n\n@Module({\n  name: 'ExtensionFeatures',\n  deps: [\n    'Client',\n    'DataFetcherV2',\n    { dep: 'Subscription', optional: true },\n    { dep: 'TabManager', optional: true },\n    { dep: 'ExtensionFeaturesOptions', optional: true },\n  ],\n})\nexport class ExtensionFeatures extends DataFetcherV2Consumer<\n  Deps,\n  FeatureList\n> {\n  protected _stopWatching: Unsubscribe = null;\n  constructor(deps: Deps) {\n    super({\n      deps,\n    });\n\n    this._source = new DataSource({\n      polling: deps.extensionFeaturesOptions?.polling ?? true,\n      ...deps.extensionFeaturesOptions,\n      key: 'extensionFeatures',\n      cleanOnReset: true,\n      fetchFunction: async () => {\n        const response = await this._deps.client.service\n          .platform()\n          .get('/restapi/v1.0/account/~/extension/~/features');\n        return response.json();\n      },\n      readyCheckFunction: () => this._deps.subscription?.ready ?? true,\n    });\n    this._deps.dataFetcherV2.register(this._source);\n  }\n\n  protected _handleSubscription = (message: ExtensionInfoEvent) => {\n    if (\n      this.ready &&\n      (this._source.disableCache || (this._deps.tabManager?.active ?? true)) &&\n      message?.body?.hints &&\n      (message.body.hints.includes(subscriptionHints.limits) ||\n        message.body.hints.includes(subscriptionHints.features) ||\n        message.body.hints.includes(subscriptionHints.permissions))\n    ) {\n      this.fetchData();\n    }\n  };\n\n  onInit() {\n    if (this._deps.subscription) {\n      this._deps.subscription.subscribe([subscriptionFilters.extensionInfo]);\n      this._stopWatching = watch(\n        this,\n        () => this._deps.subscription.message,\n        this._handleSubscription,\n      );\n    }\n  }\n\n  onReset() {\n    this._stopWatching?.();\n    this._stopWatching = null;\n  }\n\n  @computed(({ data }: ExtensionFeatures) => [data])\n  get features() {\n    return reduce(\n      (features, item) => {\n        features[item.id] = item;\n        return features;\n      },\n      {} as Record<string, FeatureInfo>,\n      this.data?.records ?? [],\n    );\n  }\n\n  get CRMFlag() {\n    return this._deps.extensionFeaturesOptions?.CRMFlag ?? 'SalesForce';\n  }\n\n  get isCRMEnabled() {\n    return this.features?.[this.CRMFlag]?.available ?? false;\n  }\n\n  get isRingOutEnabled() {\n    return this.features?.RingOut?.available ?? false;\n  }\n\n  get isWebPhoneEnabled() {\n    return this.features?.WebPhone?.available ?? false;\n  }\n\n  get isCallingEnabled() {\n    return this.isRingOutEnabled || this.isWebPhoneEnabled;\n  }\n\n  get hasComposeTextPermission() {\n    return !!(\n      this.features?.PagesSending?.available ||\n      this.features?.SMSSending?.available\n    );\n  }\n\n  get hasReadMessagesPermission() {\n    return (\n      this.hasReadTextPermission ||\n      this.hasVoicemailPermission ||\n      this.hasReadFaxPermission\n    );\n  }\n\n  get hasReadTextPermission() {\n    return !!(\n      this.features?.PagesReceiving?.available ||\n      this.features?.SMSReceiving?.available\n    );\n  }\n\n  get hasVoicemailPermission() {\n    return this.features?.Voicemail?.available ?? false;\n  }\n\n  get hasReadFaxPermission() {\n    return this.features?.FaxReceiving?.available ?? false;\n  }\n\n  get hasRoomConnectorBeta() {\n    return this.features?.RoomConnectorBeta?.available ?? false;\n  }\n\n  get hasOutboundSMSPermission() {\n    return this.features?.SMSSending?.available ?? false;\n  }\n\n  get hasInternalSMSPermission() {\n    return this.features?.PagesSending?.available ?? false;\n  }\n}\n"],"file":"ExtensionFeatures.js"}