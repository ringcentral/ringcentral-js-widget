{"version":3,"sources":["modules/EvCallDisposition/EvCallDisposition.ts"],"names":["EvCallDisposition","name","deps","dep","optional","enableCache","storageKey","_deps","evCallMonitor","onCallRing","call","outdialDispositions","disposition","dispositions","find","isDefault","id","getCallId","session","setDisposition","dispositionId","notes","data","callsMapping","disposed","dispositionStateMapping","evCallHistory","callDisposition","isDisposed","evClient","dispositionCall","uii","dispId","evAgentScript","isAgentScript","scriptId","saveScriptResult","setDispositionState","RcModuleV2","storage","state","action"],"mappings":"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","sourcesContent":["import {\n  action,\n  RcModuleV2,\n  state,\n  storage,\n} from '@ringcentral-integration/core';\nimport { Module } from 'ringcentral-integration/lib/di';\n\nimport {\n  CallDisposition,\n  Deps,\n  EvCallDispositionMapping,\n  EvDispositionStateMapping,\n} from './EvCallDisposition.interface';\n\n@Module({\n  name: 'EvCallDisposition',\n  deps: [\n    'Storage',\n    'EvCallMonitor',\n    'EvCallHistory',\n    'EvClient',\n    'EvAgentScript',\n    { dep: 'ContactMatcher', optional: true },\n    { dep: 'ActivityMatcher', optional: true },\n    { dep: 'EvCallDispositionOptions', optional: true },\n  ],\n})\nclass EvCallDisposition extends RcModuleV2<Deps> implements CallDisposition {\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'EvCallDisposition',\n    });\n\n    this._deps.evCallMonitor.onCallRing((call) => {\n      if (call?.outdialDispositions) {\n        const disposition = call.outdialDispositions.dispositions.find(\n          ({ isDefault }) => isDefault,\n        );\n        const id = this._deps.evCallMonitor.getCallId(call.session);\n        this.setDisposition(id, {\n          dispositionId: disposition ? disposition.dispositionId : null,\n          notes: '',\n        });\n      }\n    });\n  }\n\n  @storage\n  @state\n  callsMapping: EvCallDispositionMapping = {};\n\n  @storage\n  @state\n  dispositionStateMapping: EvDispositionStateMapping = {};\n\n  @action\n  setDisposition(id: string, data: EvCallDispositionMapping[string]) {\n    this.callsMapping[id] = data;\n  }\n\n  @action\n  removeDisposition(id: string) {\n    delete this.callsMapping[id];\n  }\n\n  @action\n  setDispositionState(id: string, disposed: EvDispositionStateMapping[string]) {\n    this.dispositionStateMapping[id] = disposed;\n  }\n\n  async disposeCall(id: string) {\n    const call = this._deps.evCallHistory.callsMapping[id];\n    const callDisposition = this.callsMapping[id];\n    const isDisposed =\n      this.dispositionStateMapping[id] &&\n      this.dispositionStateMapping[id].disposed;\n    if (!call.outdialDispositions || isDisposed) return;\n\n    this._deps.evClient.dispositionCall({\n      uii: call.uii,\n      dispId: callDisposition.dispositionId,\n      notes: callDisposition.notes,\n    });\n\n    const { evAgentScript } = this._deps;\n    if (evAgentScript.isAgentScript && call.scriptId) {\n      await evAgentScript.saveScriptResult(call);\n    }\n\n    this.setDispositionState(id, { disposed: true });\n  }\n}\n\nexport { EvCallDisposition };\n"],"file":"EvCallDisposition.js"}