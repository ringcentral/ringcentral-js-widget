{"version":3,"sources":["modules/ContactList/ContactList.ts"],"names":["FILTER_THRESHOLD","ContactList","name","deps","that","checkSourcesUpdated","filteredContacts","_sourcesLastStatus","Map","_sourcesUpdatedAt","_currentFilterCriteria","_nextFilterCriteria","_debouncedFilterContactSources","fn","_filterContactSources","threshold","_deps","auth","loggedIn","allSourcesReady","ready","notLoggedIn","applyFilters","_resetFilters","_clearFilteredContacts","cancel","contactSources","source","updated","size","length","clear","lastStatus","get","sourceName","sourceReady","contacts","set","Date","now","sourceFilter","searchFilter","filterStamp","Math","random","AllContactSourceName","isFiltering","concat","criteria","_setIsFiltering","sources","filter","filterContacts","Promise","all","map","promise","resolve","then","items","_appendFilteredContacts","error","console","next","_updateFilters","contact","useCache","find","x","getPresence","type","result","names","push","RcModuleV2","state","action","proxify"],"mappings":"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","sourcesContent":["import {\n  state,\n  action,\n  watch,\n  computed,\n  RcModuleV2,\n} from '@ringcentral-integration/core';\nimport { Module } from '../../lib/di';\nimport proxify from '../../lib/proxy/proxify';\nimport { debounce } from '../../lib/debounce-throttle';\nimport {\n  uniqueContactItems,\n  sortContactItemsByName,\n  groupByFirstLetterOfName,\n  AllContactSourceName,\n} from '../../lib/contactHelper';\nimport { IContact } from '../../interfaces/Contact.model';\nimport {\n  Deps,\n  FilterCriteria,\n  StampedFilterCriteria,\n  ContactSourceLastStatus,\n} from './ContactList.interface';\n\nexport const FILTER_THRESHOLD: number = 500;\n\n@Module({\n  name: 'ContactList',\n  deps: ['Auth', 'ContactSources'],\n})\nexport class ContactList extends RcModuleV2<Deps> {\n  private _sourcesLastStatus: Map<string, ContactSourceLastStatus> = new Map();\n  private _sourcesUpdatedAt: number = 0;\n  private _currentFilterCriteria: StampedFilterCriteria = null;\n  private _nextFilterCriteria: StampedFilterCriteria = null;\n\n  constructor(deps: Deps) {\n    super({ deps });\n  }\n\n  _shouldInit() {\n    return (\n      super._shouldInit() && this._deps.auth.loggedIn && this.allSourcesReady()\n    );\n  }\n\n  _shouldReset() {\n    return (\n      super._shouldReset() ||\n      (this.ready && (this._deps.auth.notLoggedIn || !this.allSourcesReady()))\n    );\n  }\n\n  onInitOnce() {\n    this.checkSourcesUpdated();\n    watch(\n      this,\n      () => this.checkSourcesUpdated(),\n      () => {\n        if (this.ready) {\n          this.applyFilters();\n        }\n      },\n    );\n  }\n\n  onInitSuccess() {\n    this.applyFilters();\n  }\n\n  onReset() {\n    this._resetFilters();\n    this._clearFilteredContacts();\n    if (this._debouncedFilterContactSources) {\n      this._debouncedFilterContactSources.cancel();\n    }\n  }\n\n  allSourcesReady() {\n    let ready = true;\n    for (const source of this._deps.contactSources) {\n      if (!source.ready) {\n        ready = false;\n        break;\n      }\n    }\n    return ready;\n  }\n\n  checkSourcesUpdated() {\n    let updated = false;\n    if (this._sourcesLastStatus.size !== this._deps.contactSources.length) {\n      updated = true;\n      this._sourcesLastStatus.clear();\n    }\n    for (const source of this._deps.contactSources) {\n      const lastStatus = this._sourcesLastStatus.get(source.sourceName);\n      if (\n        !lastStatus ||\n        lastStatus.sourceReady !== source.sourceReady ||\n        lastStatus.contacts !== source.contacts\n      ) {\n        updated = true;\n        this._sourcesLastStatus.set(source.sourceName, {\n          sourceReady: source.sourceReady,\n          contacts: source.contacts,\n        });\n      }\n    }\n    if (updated) {\n      this._sourcesUpdatedAt = Date.now();\n    }\n    return this._sourcesUpdatedAt;\n  }\n\n  @state\n  sourceFilter: string = AllContactSourceName;\n\n  @state\n  searchFilter: string = '';\n\n  @state\n  filterStamp: number = 0;\n\n  @state\n  isFiltering: boolean = false;\n\n  @state\n  filteredContacts: IContact[] = [];\n\n  @action\n  private _updateFilters({ sourceFilter, searchFilter }: FilterCriteria) {\n    this.sourceFilter = sourceFilter;\n    this.searchFilter = searchFilter;\n    this.filterStamp = Math.random();\n  }\n\n  @action\n  private _resetFilters() {\n    this.sourceFilter = AllContactSourceName;\n    this.searchFilter = '';\n    this.filterStamp = 0;\n    this.isFiltering = false;\n    this._currentFilterCriteria = null;\n    this._nextFilterCriteria = null;\n  }\n\n  @action\n  private _setIsFiltering(isFiltering: boolean) {\n    this.isFiltering = isFiltering;\n  }\n\n  @action\n  private _clearFilteredContacts() {\n    this.filteredContacts = [];\n  }\n\n  @action\n  private _appendFilteredContacts(contacts: IContact[]) {\n    this.filteredContacts = this.filteredContacts.concat(contacts);\n  }\n\n  private _debouncedFilterContactSources = debounce({\n    fn: this._filterContactSources,\n    threshold: FILTER_THRESHOLD,\n  });\n\n  private async _filterContactSources(criteria: StampedFilterCriteria) {\n    if (this._currentFilterCriteria) {\n      this._nextFilterCriteria = criteria;\n      return;\n    }\n    this._setIsFiltering(true);\n    this._clearFilteredContacts();\n    this._currentFilterCriteria = criteria;\n    const sources = this._deps.contactSources.filter(\n      (source) =>\n        source.sourceReady &&\n        typeof source.filterContacts === 'function' &&\n        (source.sourceName === criteria.sourceFilter ||\n          AllContactSourceName === criteria.sourceFilter),\n    );\n    await Promise.all(\n      sources.map((source) => {\n        const promise = Promise.resolve(\n          source.filterContacts(criteria.searchFilter),\n        );\n        return promise\n          .then((items) => {\n            if (\n              !criteria.filterStamp ||\n              criteria.filterStamp === this.filterStamp\n            ) {\n              this._appendFilteredContacts(items);\n            }\n          })\n          .catch((error) => {\n            console.error(\n              `[ContactList > ContactSource(${source.sourceName}) > filterContacts] ${error}`,\n            );\n          });\n      }),\n    );\n    this._currentFilterCriteria = null;\n    this._setIsFiltering(false);\n    if (this._nextFilterCriteria) {\n      const next = this._nextFilterCriteria;\n      this._nextFilterCriteria = null;\n      this._filterContactSources(next);\n    }\n  }\n\n  @proxify\n  async applyFilters({\n    sourceFilter = this.sourceFilter,\n    searchFilter = this.searchFilter,\n  }: FilterCriteria = {}) {\n    this._updateFilters({\n      sourceFilter,\n      searchFilter,\n    });\n    this._debouncedFilterContactSources({\n      sourceFilter,\n      searchFilter,\n      filterStamp: this.filterStamp,\n    });\n  }\n\n  @proxify\n  async getPresence(contact: IContact, useCache: boolean = true) {\n    const source = this._deps.contactSources.find(\n      (x) =>\n        x.sourceReady &&\n        typeof x.getPresence === 'function' &&\n        x.sourceName === (contact && contact.type),\n    );\n    if (source) {\n      const result = await source.getPresence(contact, useCache);\n      return result;\n    }\n    return null;\n  }\n\n  @computed<ContactList>((that) => [that.checkSourcesUpdated()])\n  get sourceNames() {\n    const names = [AllContactSourceName];\n    for (const source of this._deps.contactSources) {\n      if (source.sourceReady) {\n        names.push(source.sourceName);\n      }\n    }\n    return names;\n  }\n\n  @computed<ContactList>((that) => [that.filteredContacts])\n  get contactGroups() {\n    return groupByFirstLetterOfName(\n      sortContactItemsByName(uniqueContactItems(this.filteredContacts)),\n    );\n  }\n}\n"],"file":"ContactList.js"}