{"version":3,"sources":["modules/ActiveCallControlV2/ActiveCallControl.ts"],"names":["DEFAULT_TTL","DEFAULT_TIME_TO_RETRY","DEFAULT_BUSY_TIMEOUT","telephonySessionsEndPoint","subscribeEvent","subscriptionFilters","telephonySessions","ActiveCallControl","name","deps","dep","optional","that","_getTrackEventName","trackEvents","mute","unmute","record","stopRecord","hangup","voicemail","confirmSwitch","hold","unhold","transfer","confirmForward","answer","holdAndAnswer","ignore","endAndAnswer","activeSessionId","activeSessions","ringSessionId","sessions","timestamp","_deps","presence","calls","inboundWebRTCCallConnected","dialpadOpen","dialpadClose","clickTransfer","forward","enableCache","activeCallControlOptions","storageKey","_ttl","_timeToRetry","_polling","_enableCache","_promise","_rcCall","_tabActive","_connectivity","_onCallEndFunc","_timeoutId","_lastSubscriptionMessage","_permissionCheck","_autoMergeSignCallIdKey","_autoMergeCallsKey","_enableAutoSwitchFeature","_autoMergeWebphoneSessionsMap","_onCallSwitchedFunc","_activeSession","_updateSessionsHandler","updateActiveSessions","ttl","timeToRetry","polling","permissionCheck","enableAutoSwitchFeature","prefix","Map","ready","hasPermission","_subscriptionHandler","_checkConnectivity","_checkTabActive","_createOtherInstanceListener","tabManager","window","addEventListener","e","_onStorageChangeEvent","key","_triggerCurrentClientAutoMerge","_autoMergeCallsHandler","JSON","parse","newValue","telephoneSessionId","ids","filter","s","webphoneSession","telephonySessionId","map","id","data","length","localStorage","setItem","stringify","err","console","log","active","client","service","platform","get","detailedPresence","response","json","activeCalls","callsList","find","item","telephonySession","activeCall","call","forEach","transferUnmuteHandler","switchSession","switchCallFromActiveCall","homeCountryId","regionSettings","set","once","_addTrackToActiveSession","activeRCCallSession","rcCallSessions","webphone","_remoteVideo","_localVideo","addTrack","subscription","subscribe","RingCentralCall","sdk","subscriptions","enableSubscriptionHander","callControlOptions","preloadDevices","preloadSessions","extensionInfo","info","account","accountInfo","_webphone","on","callEvents","NEW","session","_newSessionHandler","WEBPHONE_INVITE","_onWebphoneInvite","WEBPHONE_INVITE_SENT","_callControl","_onNewCall","_shouldFetch","fetchData","_retry","_startPolling","connected","setWebphone","resetState","busyTimestamp","_fetchData","clearTimeout","message","test","event","body","_checkRingOutCallDirection","onNotificationEvent","originType","origin","type","parties","Array","isArray","party","ringOutRole","direction","tempFrom","from","to","t","_clearTimeout","setTimeout","Date","now","_syncData","loadSessions","ringSession","x","_setRingSessionId","ringSessions","callControlSessions","activeCallId","otherParties","recordings","sessionId","startTime","status","webphoneSessionConnected","webphoneSessionId","removeListener","eventsEnum","STATUS","MUTED","RECORDINGS","DISCONNECTED","WEBPHONE_SESSION_CONNECTED","normalizedWebphoneSession","isToVoicemail","isForwarded","isReplied","partyData","lastEndedSessionIds","indexOf","concat","slice","connectivityMonitor","connectivity","storage","restoreSessions","currentPath","routerInteraction","showCallLog","parentModule","callLogSection","show","showNotification","includes","setCallControlBusyTimestamp","clearCallControlBusyTimestamp","_text","clone","text","alert","warning","callControlError","muteConflictError","availabilityMonitor","checkIfHAError","generalError","unMuteConflictError","muted","recordingId","getRecordingId","startRecord","errors","error","danger","webphoneErrors","recordError","payload","errorCode","recording","recodingId","toVoicemail","__rc_isToVoicemail","switchCall","switchedSession","_triggerAutoMergeEvent","_holdOtherCalls","callDirection","outbound","code","PartyStatusCode","proceeding","__rc_callStatus","sessionStatus","onHold","holdConflictError","setActiveSessionId","unHoldConflictError","transferNumber","numberValidate","validateNumbers","validatedResult","result","isHAError","callErrors","phoneNumber","validPhoneNumber","numbers","e164","mainCompanyNumber","join","flipValue","flip","callFlipId","forwardNumber","brand","__rc_isForwarded","acceptOptions","success","forwardSuccess","forwardError","dtmfValue","dtmf","__rc_creationTime","__rc_lastActiveTime","_setActiveSessionIdFromOnHoldCalls","_onCallAccepted","onHoldSessions","l","r","otherSessions","answered","localHold","holdOtherSessions","Promise","all","deviceId","device","_trackWebRTCCallAnswer","_answer","reject","busy","currentActiveCall","params","toNumber","isVoIPOnlyMode","_fetchDL","phoneLines","noOutboundCallWithoutDL","sdkMakeCallParams","fromNumber","makeCall","extension","list","devices","records","getActiveSession","reduce","accumulator","auth","token","scope","sessionDescriptionHandlerOptions","constraints","audio","audioSettings","inputDeviceId","video","some","RcModuleV2","state","proxify","action"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA;;AASA;;AACA;;AAMA;;AACA;;AAEA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAUA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAWA,IAAMA,WAAW,GAAG,KAAK,EAAL,GAAU,IAA9B;AACA,IAAMC,qBAAqB,GAAG,KAAK,IAAnC;AACA,IAAMC,oBAAoB,GAAG,IAAI,IAAjC;AACA,IAAMC,yBAAyB,GAAG,wBAAlC;AACA,IAAMC,cAAc,GAAGC,gCAAoBC,iBAA3C;IA0BaC,iB,WAxBZ,gBAAO;AACNC,EAAAA,IAAI,EAAE,mBADA;AAENC,EAAAA,IAAI,EAAE,CACJ,MADI,EAEJ,OAFI,EAGJ,OAHI,EAIJ,QAJI,EAKJ,UALI,EAMJ,aANI,EAOJ,cAPI,EAQJ,eARI,EASJ,gBATI,EAUJ,gBAVI,EAWJ,qBAXI,EAYJ;AAAEC,IAAAA,GAAG,EAAE,QAAP;AAAiBC,IAAAA,QAAQ,EAAE;AAA3B,GAZI,EAaJ;AAAED,IAAAA,GAAG,EAAE,SAAP;AAAkBC,IAAAA,QAAQ,EAAE;AAA5B,GAbI,EAcJ;AAAED,IAAAA,GAAG,EAAE,UAAP;AAAmBC,IAAAA,QAAQ,EAAE;AAA7B,GAdI,EAeJ;AAAED,IAAAA,GAAG,EAAE,YAAP;AAAqBC,IAAAA,QAAQ,EAAE;AAA/B,GAfI,EAgBJ;AAAED,IAAAA,GAAG,EAAE,eAAP;AAAwBC,IAAAA,QAAQ,EAAE;AAAlC,GAhBI,EAiBJ;AAAED,IAAAA,GAAG,EAAE,qBAAP;AAA8BC,IAAAA,QAAQ,EAAE;AAAxC,GAjBI,EAkBJ;AAAED,IAAAA,GAAG,EAAE,0BAAP;AAAmCC,IAAAA,QAAQ,EAAE;AAA7C,GAlBI,EAmBJ;AAAED,IAAAA,GAAG,EAAE,mBAAP;AAA4BC,IAAAA,QAAQ,EAAE;AAAtC,GAnBI;AAFA,CAAP,C,UAylBE,iBAAM,UAACC,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYC,IAApC,CADkC,CAA7B;AAAA,CAAN,C,UA6BA,iBAAM,UAACH,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYE,MAApC,CADkC,CAA7B;AAAA,CAAN,C,UA2CA,iBAAM,UAACJ,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYG,MAApC,CADkC,CAA7B;AAAA,CAAN,C,UAqCA,iBAAM,UAACL,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYI,UAApC,CADkC,CAA7B;AAAA,CAAN,C,UAoBA,iBAAM,UAACN,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYK,MAApC,CADkC,CAA7B;AAAA,CAAN,C,UAwBA,iBAAM,UAACP,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYM,SAApC,CADkC,CAA7B;AAAA,CAAN,C,UAuBA,iBAAM,UAACR,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYO,aAApC,CADkC,CAA7B;AAAA,CAAN,C,UA4BA,iBAAM,UAACT,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYQ,IAApC,CADkC,CAA7B;AAAA,CAAN,C,WA4CA,iBAAM,UAACV,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYS,MAApC,CADkC,CAA7B;AAAA,CAAN,C,WAuCA,iBAAMT,uBAAYU,QAAlB,C,WAiEA,iBAAM,UAACZ,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYW,cAApC,CADkC,CAA7B;AAAA,CAAN,C,WA4MA,iBAAM,UAACb,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYY,MAApC,CADkC,CAA7B;AAAA,CAAN,C,WAYA,iBAAM,UAACd,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYa,aAApC,CADkC,CAA7B;AAAA,CAAN,C,WAoBA,iBAAM,UAACf,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYc,MAApC,CADkC,CAA7B;AAAA,CAAN,C,WAoBA,iBAAM,UAAChB,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAYe,YAApC,CADkC,CAA7B;AAAA,CAAN,C,WA0GA,oBAAS;AAAA,MAAGC,eAAH,QAAGA,eAAH;AAAA,MAAoBC,cAApB,QAAoBA,cAApB;AAAA,SAA4D,CACpED,eADoE,EAEpEC,cAFoE,CAA5D;AAAA,CAAT,C,WAQA,oBAAS;AAAA,MAAGC,aAAH,SAAGA,aAAH;AAAA,MAAkBD,cAAlB,SAAkBA,cAAlB;AAAA,SAA0D,CAClEC,aADkE,EAElED,cAFkE,CAA1D;AAAA,CAAT,C,WAQA,oBAAS;AAAA,MAAGE,QAAH,SAAGA,QAAH;AAAA,SAAqC,CAACA,QAAD,CAArC;AAAA,CAAT,C,WAUA,oBAAS,UAACrB,IAAD;AAAA,SAA6B,CAACA,IAAI,CAACqB,QAAN,EAAgBrB,IAAI,CAACsB,SAArB,CAA7B;AAAA,CAAT,C,WASA,oBAAS,UAACtB,IAAD;AAAA,SAA6B,CAACA,IAAI,CAACuB,KAAL,CAAWC,QAAX,CAAoBC,KAArB,CAA7B;AAAA,CAAT,C,WA+EA,iBAAMvB,uBAAYwB,0BAAlB,C,WAGA,iBAAMxB,uBAAYyB,WAAlB,C,WAGA,iBAAMzB,uBAAY0B,YAAlB,C,WAGA,iBAAM,UAAC5B,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAY2B,aAApC,CADkC,CAA7B;AAAA,CAAN,C,WAKA,iBAAM,UAAC7B,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,uBAAY4B,OAApC,CADkC,CAA7B;AAAA,CAAN,C,WAKA,iBAAM,UAAC9B,IAAD;AAAA,SAA6B,CAClCA,IAAI,CAACC,kBAAL,CAAwBC,gCAAxB,CADkC,CAA7B;AAAA,CAAN,C;;;;;AA53CD,6BAAYL,IAAZ,EAAwB;AAAA;;AAAA;;AAAA;;AACtB,8BAAM;AACJA,MAAAA,IAAI,EAAJA,IADI;AAEJkC,MAAAA,WAAW,qDAAElC,IAAI,CAACmC,wBAAP,2DAAE,uBAA+BD,WAAjC,yEAAgD,IAFvD;AAGJE,MAAAA,UAAU,EAAE;AAHR,KAAN;AADsB,UAnBxBC,IAmBwB;AAAA,UAlBxBC,YAkBwB;AAAA,UAjBxBC,QAiBwB;AAAA,UAhBxBC,YAgBwB;AAAA,UAfhBC,QAegB,GAfU,IAeV;AAAA,UAdhBC,OAcgB;AAAA,UAbhBC,UAagB;AAAA,UAZhBC,aAYgB;AAAA,UAXhBC,cAWgB;AAAA,UAVhBC,UAUgB,GAV4B,IAU5B;AAAA,UAThBC,wBASgB;AAAA,UARhBC,gBAQgB;AAAA,UAPhBC,uBAOgB;AAAA,UANhBC,kBAMgB;AAAA,UALhBC,wBAKgB;AAAA,UAJhBC,6BAIgB;AAAA,UAHhBC,mBAGgB;AAAA,UAFhBC,cAEgB;;AAAA;;AAAA;;AAAA;;AAAA,UAmYxBC,sBAnYwB,GAmYC,YAAM;AAC7B,YAAKC,oBAAL;AACD,KArYuB;;AAAA,QAMdrB,wBANc,GAMe,MAAKT,KANpB,CAMdS,wBANc;AAOtB,UAAKE,IAAL,4BAAYF,wBAAZ,aAAYA,wBAAZ,uBAAYA,wBAAwB,CAAEsB,GAAtC,yEAA6ClE,WAA7C;AACA,UAAK+C,YAAL,6BACEH,wBADF,aACEA,wBADF,uBACEA,wBAAwB,CAAEuB,WAD5B,2EAC2ClE,qBAD3C;AAEA,UAAK+C,QAAL,6BAAgBJ,wBAAhB,aAAgBA,wBAAhB,uBAAgBA,wBAAwB,CAAEwB,OAA1C,2EAAqD,KAArD;AACA,UAAKnB,YAAL,6BAAoBL,wBAApB,aAAoBA,wBAApB,uBAAoBA,wBAAwB,CAAED,WAA9C,2EAA6D,IAA7D;AACA,UAAKO,QAAL,GAAgB,IAAhB;AACA,UAAKC,OAAL,GAAe,IAAf;AACA,UAAKM,gBAAL,6BAAwBb,wBAAxB,aAAwBA,wBAAxB,uBAAwBA,wBAAwB,CAAEyB,eAAlD,2EAAqE,IAArE;AACA,UAAKT,wBAAL,6BACEhB,wBADF,aACEA,wBADF,uBACEA,wBAAwB,CAAE0B,uBAD5B,2EACuD,KADvD;AAEA,UAAKZ,uBAAL,aAAkCjD,IAAI,CAAC8D,MAAvC;AACA,UAAKZ,kBAAL,aAA6BlD,IAAI,CAAC8D,MAAlC;AACA,UAAKV,6BAAL,GAAqC,IAAIW,GAAJ,EAArC;AAnBsB;AAoBvB;;;;;;;;;;sBAGK,KAAKC,KAAL,IAAc,KAAKC,a;;;;;AACrB,qBAAKC,oBAAL;;AACA,qBAAKC,kBAAL;;;uBACM,KAAKC,eAAL,E;;;;;;;;;;;;;;;;;;;;;;;;AAKR,qBAAKC,4BAAL;;;;;;;;;;;;;;;;;;;;;mDAI6B;AAAA;;AAC7B,UAAI,CAAC,KAAK3C,KAAL,CAAW4C,UAAZ,IAA0B,CAAC,KAAKnB,wBAApC,EAA8D;AAC5D;AACD;;AACDoB,MAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAmC,UAACC,CAAD,EAAO;AACxC,QAAA,MAAI,CAACC,qBAAL,CAA2BD,CAA3B;AACD,OAFD;AAGD;;;0CAEqBA,C,EAAiB;AACrC,cAAQA,CAAC,CAACE,GAAV;AACE,aAAK,KAAK1B,uBAAV;AACE,eAAK2B,8BAAL,CAAoCH,CAApC;;AACA;;AACF,aAAK,KAAKvB,kBAAV;AACE,eAAK2B,sBAAL,CAA4BJ,CAA5B;;AACA;;AACF;AACE;AARJ;AAUD;;;mDAE8BA,C,EAAiB;AAC9C,UAAI;AAAA,0BAC6DK,IAAI,CAACC,KAAL,CAC7DN,CAAC,CAACO,QAD2D,CAD7D;AAAA,YACMC,kBADN,eACMA,kBADN;;AAIF,YAAMC,GAAG,GAAG,KAAK1D,QAAL,CACT2D,MADS,CAER,UAACC,CAAD;AAAA,iBACE,CAAC,wBAAUA,CAAV,CAAD,IACA,CAAC,CAACA,CAAC,CAACC,eADJ,IAEAD,CAAC,CAACE,kBAAF,KAAyBL,kBAH3B;AAAA,SAFQ,EAOTM,GAPS,CAOL,UAACH,CAAD;AAAA,iBAAqCA,CAAC,CAACE,kBAAvC;AAAA,SAPK,CAAZ;AAQA,YAAME,EAAE,GAAG,eAAX;AACA,YAAMC,IAAI,GAAG;AAAED,UAAAA,EAAE,EAAFA,EAAF;AAAMN,UAAAA,GAAG,EAAHA;AAAN,SAAb;;AACA,YAAIA,GAAG,CAACQ,MAAR,EAAgB;AACdC,UAAAA,YAAY,CAACC,OAAb,CAAqB,KAAK1C,kBAA1B,EAA8C4B,IAAI,CAACe,SAAL,CAAeJ,IAAf,CAA9C;AACD;AACF,OAjBD,CAiBE,OAAOK,GAAP,EAAY;AACZC,QAAAA,OAAO,CAACC,GAAR,CAAY,kCAAZ;AACD;AACF;;;;8GAE4BvB,C;;;;;;;;;oBACtB,KAAK/C,KAAL,CAAW4C,UAAX,CAAsB2B,M;;;;;;;;;+BAGUnB,IAAI,CAACC,KAAL,CAAWN,CAAC,CAACO,QAAb,C,EAA3BE,G,gBAAAA,G;;uBACe,KAAKxD,KAAL,CAAWwE,MAAX,CAAkBC,OAAlB,CACpBC,QADoB,GAEpBC,GAFoB,CAEhBzG,gCAAoB0G,gBAFJ,C;;;AAAjBC,gBAAAA,Q;;uBAGaA,QAAQ,CAACC,IAAT,E;;;AAAbf,gBAAAA,I;AACAgB,gBAAAA,W,GAAgChB,IAAI,CAACgB,W;AACrCC,gBAAAA,S,GAAYxB,GAAG,CACnB;AADmB,iBAElBC,MAFe,CAER,UAACK,EAAD;AAAA,yBACN,MAAI,CAAChE,QAAL,CAAcmF,IAAd,CACE,UAACC,IAAD;AAAA,2BACEA,IAAI,CAACtB,kBAAL,KAA4BE,EAA5B,IACA,CAAC,CAACoB,IAAI,CAACC,gBADP,IAEA,CAAC,oBAAQD,IAAI,CAACC,gBAAb,CAHH;AAAA,mBADF,CADM;AAAA,iBAFQ,EAUhB;AAVgB,iBAWftB,GAXe,CAWX,UAACD,kBAAD,EAAgC;AACnC,sBAAMwB,UAAU,GAAGL,WAAW,CAACE,IAAZ,CACjB,UAACI,IAAD;AAAA,2BAAUA,IAAI,CAACzB,kBAAL,KAA4BA,kBAAtC;AAAA,mBADiB,CAAnB;AAGA,sBAAI,CAACwB,UAAL,EACEf,OAAO,CAACC,GAAR,sDACgDV,kBADhD;AAGF,yBAAOwB,UAAP;AACD,iBApBe,EAqBf3B,MArBe,CAqBR,UAACyB,IAAD;AAAA,yBAAe,CAAC,CAACA,IAAjB;AAAA,iBArBQ,C;;AAuBlB,oBAAIF,SAAS,CAAChB,MAAd,EAAsB;AACpBgB,kBAAAA,SAAS,CAACM,OAAV;AAAA,wFAAkB,kBAAOF,UAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qCACV,MAAI,CAACG,qBAAL,CAA2BH,UAAU,CAACxB,kBAAtC,CADU;;AAAA;AAEV4B,8BAAAA,aAFU,GAEM,MAAI,CAACxE,OAAL,CAAayE,wBAAb,CACpBL,UADoB,EAEpB;AACEM,gCAAAA,aAAa,EAAE,MAAI,CAAC1F,KAAL,CAAW2F,cAAX,CAA0BD;AAD3C,+BAFoB,CAFN;;AAQhB,8BAAA,MAAI,CAAChE,6BAAL,CAAmCkE,GAAnC,CACEJ,aAAa,CAAC7B,eADhB,EAEE,IAFF;;AAIA6B,8BAAAA,aAAa,CAAC7B,eAAd,CAA8B/E,IAA9B;AACA4G,8BAAAA,aAAa,CAAC7B,eAAd,CAA8BkC,IAA9B,CAAmC,UAAnC,uEAA+C;AAAA;AAAA;AAAA;AAAA;AAC7CL,wCAAAA,aAAa,CAAC7B,eAAd,CAA8B9E,MAA9B;AAD6C;AAAA,+CAEvC2G,aAAa,CAAC7B,eAAd,CAA8BxE,IAA9B,EAFuC;;AAAA;AAG7C,wCAAA,MAAI,CAAC2G,wBAAL;;AAH6C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAA/C;;AAbgB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAAlB;;AAAA;AAAA;AAAA;AAAA;AAmBD;;;;;;;;AAEDzB,gBAAAA,OAAO,CAACC,GAAR;AACAD,gBAAAA,OAAO,CAACC,GAAR,CAAY,yCAAZ;;;;;;;;;;;;;;;;;;2CAImBf,kB,EAA6B;AAClD,UAAI,CAAC,KAAKvD,KAAL,CAAW4C,UAAZ,IAA0B,CAAC,KAAKnB,wBAApC,EAA8D;AAE9D,UAAMqC,EAAE,GAAG,eAAX;AACA,UAAMC,IAAI,GAAG;AACXD,QAAAA,EAAE,EAAFA,EADW;AAEXP,QAAAA,kBAAkB,EAAlBA;AAFW,OAAb;AAIAU,MAAAA,YAAY,CAACC,OAAb,CAAqB,KAAK3C,uBAA1B,EAAmD6B,IAAI,CAACe,SAAL,CAAeJ,IAAf,CAAnD;AACD;;;+CAE0B;AACzB,UAAMH,kBAAkB,GAAG,KAAKjE,eAAhC;;AACA,UAAMoG,mBAAmB,GACvB,KAAKC,cAAL,CAAoBf,IAApB,CACE,UAACvB,CAAD;AAAA,eAAOA,CAAC,CAACE,kBAAF,KAAyBA,kBAAhC;AAAA,OADF,KAEK,KAAKhC,cAHZ;;AAIA,UAAImE,mBAAmB,IAAIA,mBAAmB,CAACpC,eAA/C,EAAgE;AAAA,mCACxB,KAAK3D,KAAL,CAAWiG,QADa;AAAA,YACtDC,YADsD,wBACtDA,YADsD;AAAA,YACxCC,WADwC,wBACxCA,WADwC;AAE9DJ,QAAAA,mBAAmB,CAACpC,eAApB,CAAoCyC,QAApC,CAA6CF,YAA7C,EAA2DC,WAA3D;AACD;AACF;;;;;;;;;;;;;;;oBA2BM,KAAK5D,a;;;;;;;;AACV,qBAAKvC,KAAL,CAAWqG,YAAX,CAAwBC,SAAxB,CAAkC,CAACrI,cAAD,CAAlC;;AACA,qBAAK+C,OAAL,GAAe,IAAIuF,gCAAJ,CAAoB;AACjCC,kBAAAA,GAAG,EAAE,KAAKxG,KAAL,CAAWwE,MAAX,CAAkBC,OADU;AAEjCgC,kBAAAA,aAAa,EAAE,IAFkB;AAGjCC,kBAAAA,wBAAwB,EAAE,KAHO;AAIjCC,kBAAAA,kBAAkB,EAAE;AAClBC,oBAAAA,cAAc,EAAE,KADE;AAElBC,oBAAAA,eAAe,EAAE,KAFC;AAGlBC,oBAAAA,aAAa,kCACR,KAAK9G,KAAL,CAAW8G,aAAX,CAAyBC,IADjB;AAEX;AACA;AACAC,sBAAAA,OAAO,EAAE,KAAKhH,KAAL,CAAWiH,WAAX,CAAuBF;AAJrB;AAHK,mBAJa;AAcjCd,kBAAAA,QAAQ,2BAAE,KAAKjG,KAAL,CAAWiG,QAAb,0DAAE,sBAAqBiB;AAdE,iBAApB,CAAf;;AAgBA,qBAAKlG,OAAL,CAAamG,EAAb,CAAgBC,wBAAWC,GAA3B,EAAgC,UAACC,OAAD,EAAsB;AACpD,kBAAA,MAAI,CAACC,kBAAL,CAAwBD,OAAxB;AACD,iBAFD;;AAGA,qBAAKtG,OAAL,CAAamG,EAAb,CAAgBC,wBAAWI,eAA3B,EAA4C,UAACF,OAAD;AAAA,yBAC1C,MAAI,CAACG,iBAAL,CAAuBH,OAAvB,CAD0C;AAAA,iBAA5C;;AAGA,qBAAKtG,OAAL,CAAamG,EAAb,CACEC,wBAAWM,oBADb,EAEE,UAACJ,OAAD;AAAA,yBAA8B,MAAI,CAACG,iBAAL,CAAuBH,OAAvB,CAA9B;AAAA,iBAFF,E,CAIA;AACA;;;AACA,sCAAKtG,OAAL,yFAAc2G,YAAd,gFAA4BR,EAA5B,CAA+B,KAA/B,EAAsC,UAACG,OAAD;AAAA,yBACpC,MAAI,CAACM,UAAL,CAAgBN,OAAhB,CADoC;AAAA,iBAAtC;AAGA,qBAAKrG,UAAL,4BAAkB,KAAKjB,KAAL,CAAW4C,UAA7B,0DAAkB,sBAAuB2B,MAAzC;;qBACI,KAAKsD,YAAL,E;;;;;;;uBAEM,KAAKC,SAAL,E;;;;;;;;;;AAEN,qBAAKC,MAAL;;;;;;;AAEG,oBAAI,KAAKlH,QAAT,EAAmB;AACxB,uBAAKmH,aAAL;AACD,iBAFM,MAEA;AACL,uBAAKD,MAAL;AACD;;;;;;;;;;;;;;;;;;iCAGU;AAAA;;AACX,UAAI,KAAK/H,KAAL,CAAWiG,QAAf,EAAyB;AACvB,yBACE,IADF,EAEE;AAAA,iBAAM,MAAI,CAACjG,KAAL,CAAWiG,QAAX,CAAoBgC,SAA1B;AAAA,SAFF,EAGE,UAAC3E,QAAD,EAAc;AACZ,cAAIA,QAAQ,IAAI,MAAI,CAACtD,KAAL,CAAWiG,QAAX,CAAoBiB,SAApC,EAA+C;AAC7C,YAAA,MAAI,CAAClG,OAAL,CAAakH,WAAb,CAAyB,MAAI,CAAClI,KAAL,CAAWiG,QAAX,CAAoBiB,SAA7C;AACD;AACF,SAPH;AASD;AACF;;;8BAES;AACR,WAAKiB,UAAL;AACD;;;iCAGY;AACX,WAAKpE,IAAL,CAAUpE,eAAV,GAA4B,IAA5B;AACA,WAAKoE,IAAL,CAAUqE,aAAV,GAA0B,CAA1B;AACA,WAAKrE,IAAL,CAAUhE,SAAV,GAAsB,CAAtB;AACA,WAAKgE,IAAL,CAAUjE,QAAV,GAAqB,EAArB;AACD;;;mCAEc;AACb,aAAO,CAAC,KAAKE,KAAL,CAAW4C,UAAZ,IAA0B,KAAK5C,KAAL,CAAW4C,UAAX,CAAsB2B,MAAvD;AACD;;;;;;;;;AAIC,oBAAI,CAAC,KAAKxD,QAAV,EAAoB;AAClB,uBAAKA,QAAL,GAAgB,KAAKsH,UAAL,EAAhB;AACD;;;uBACK,KAAKtH,Q;;;;;;;;;;;;;;;;;;oCAGG;AACd,UAAI,KAAKK,UAAT,EAAqBkH,YAAY,CAAC,KAAKlH,UAAN,CAAZ;AACtB;;;2CAEsB;AACrB,UAAI,CAAC,KAAKkB,KAAV,EAAiB;AACf;AACD;;AAHoB,UAIfiG,OAJe,GAIH,KAAKvI,KAAL,CAAWqG,YAJR,CAIfkC,OAJe;;AAKrB,UACEA,OAAO,IACPA,OAAO,KAAK,KAAKlH,wBADjB,IAEArD,yBAAyB,CAACwK,IAA1B,CAA+BD,OAAO,CAACE,KAAvC,CAFA,IAGAF,OAAO,CAACG,IAJV,EAKE;AACAH,QAAAA,OAAO,GAAG,KAAKI,0BAAL,CAAgCJ,OAAhC,CAAV;AACA,aAAKlH,wBAAL,GAAgCkH,OAAhC;;AACA,YAAI,KAAKvH,OAAT,EAAkB;AAChB,eAAKA,OAAL,CAAa4H,mBAAb,CAAiCL,OAAjC;AACD;AACF;AACF,K,CAED;AACA;;;;+CAC2BA,O,EAA0C;AAAA;;AAAA,UAC3DG,IAD2D,GAClDH,OADkD,CAC3DG,IAD2D;AAEnE,UAAMG,UAAU,GAAGH,IAAH,aAAGA,IAAH,uCAAGA,IAAI,CAAEI,MAAT,iDAAG,aAAcC,IAAjC;;AACA,UAAIF,UAAU,KAAK,SAAnB,EAA8B;AAAA,YACpBG,OADoB,GACRN,IADQ,CACpBM,OADoB;;AAE5B,YAAIC,KAAK,CAACC,OAAN,CAAcF,OAAd,KAA0BA,OAAO,CAAChF,MAAtC,EAA8C;AAC5C,8BAAQ,UAACmF,KAAD,EAAgB;AACtB,gBACEA,KAAK,CAACC,WAAN,IACAD,KAAK,CAACC,WAAN,KAAsB,WADtB,IAEAD,KAAK,CAACE,SAAN,KAAoB,SAHtB,EAIE;AACA,kBAAMC,QAAQ,qBAAQH,KAAK,CAACI,IAAd,CAAd;;AACAJ,cAAAA,KAAK,CAACE,SAAN,GAAkB,UAAlB;AACAF,cAAAA,KAAK,CAACI,IAAN,GAAaJ,KAAK,CAACK,EAAnB;AACAL,cAAAA,KAAK,CAACK,EAAN,GAAWF,QAAX;AACD;AACF,WAXD,EAWGN,OAXH;AAYD;AACF;;AACD,aAAOT,OAAP;AACD;;;6BAE4B;AAAA;;AAAA,UAAtBkB,CAAsB,uEAAlB,KAAKzH,WAAa;;AAC3B,WAAK0H,aAAL;;AACA,WAAKtI,UAAL,GAAkBuI,UAAU,CAAC,YAAM;AACjC,QAAA,MAAI,CAACvI,UAAL,GAAkB,IAAlB;;AACA,YAAI,CAAC,MAAI,CAACrB,SAAN,IAAmB6J,IAAI,CAACC,GAAL,KAAa,MAAI,CAAC9J,SAAlB,GAA8B,MAAI,CAACgC,GAA1D,EAA+D;AAC7D,cAAI,CAAC,MAAI,CAAC/B,KAAL,CAAW4C,UAAZ,IAA0B,MAAI,CAAC5C,KAAL,CAAW4C,UAAX,CAAsB2B,MAApD,EAA4D;AAC1D,YAAA,MAAI,CAACuD,SAAL;AACD,WAFD,MAEO;AACL;AACA,YAAA,MAAI,CAACC,MAAL;AACD;AACF;AACF,OAV2B,EAUzB0B,CAVyB,CAA5B;AAWD;;;;;;;;;;;uBAKS,KAAKK,SAAL,E;;;AACN,oBAAI,KAAKjJ,QAAT,EAAmB;AACjB,uBAAKmH,aAAL;AACD;;AACD,qBAAKjH,QAAL,GAAgB,IAAhB;;;;;;;AAEA,qBAAKA,QAAL,GAAgB,IAAhB;;AACA,oBAAI,KAAKF,QAAT,EAAmB;AACjB,uBAAKmH,aAAL,CAAmB,KAAKhG,WAAxB;AACD,iBAFD,MAEO;AACL,uBAAK+F,MAAL;AACD;;;;;;;;;;;;;;;;;;;;oCAK0D;AAAA;;AAAA,UAAjD0B,CAAiD,uEAA7C,KAAK1J,SAAL,GAAiB,KAAKgC,GAAtB,GAA4B,EAA5B,GAAiC6H,IAAI,CAACC,GAAL,EAAY;;AAC7D,WAAKH,aAAL;;AACA,WAAKtI,UAAL,GAAkBuI,UAAU,CAAC,YAAM;AAAA;;AACjC,QAAA,MAAI,CAACvI,UAAL,GAAkB,IAAlB;;AACA,YAAI,CAAC,MAAI,CAACpB,KAAL,CAAW4C,UAAZ,8BAA0B,MAAI,CAAC5C,KAAL,CAAW4C,UAArC,0DAA0B,sBAAuB2B,MAAjD,CAAJ,EAA6D;AAC3D,cAAI,CAAC,MAAI,CAACxE,SAAN,IAAmB6J,IAAI,CAACC,GAAL,KAAa,MAAI,CAAC9J,SAAlB,GAA8B,MAAI,CAACgC,GAA1D,EAA+D;AAC7D,YAAA,MAAI,CAAC+F,SAAL;AACD,WAFD,MAEO;AACL,YAAA,MAAI,CAACE,aAAL;AACD;AACF,SAND,MAMO,IAAI,MAAI,CAACjI,SAAL,IAAkB6J,IAAI,CAACC,GAAL,KAAa,MAAI,CAAC9J,SAAlB,GAA8B,MAAI,CAACgC,GAAzD,EAA8D;AACnE,UAAA,MAAI,CAACiG,aAAL;AACD,SAFM,MAEA;AACL,UAAA,MAAI,CAACA,aAAL,CAAmB,MAAI,CAAChG,WAAxB;AACD;AACF,OAb2B,EAazByH,CAbyB,CAA5B;AAcD;;;;;;;;;;;;;AAIS1E,gBAAAA,W,GAAc,KAAK/E,KAAL,CAAWC,QAAX,CAAoBC,K;;uBAClC,KAAKc,OAAL,CAAa+I,YAAb,CAA0BhF,WAA1B,C;;;AACN,qBAAKjD,oBAAL;;AACA,qBAAKd,OAAL,CAAalB,QAAb,CAAsBwF,OAAtB,CAA8B,UAACgC,OAAD,EAAsB;AAClD,kBAAA,MAAI,CAACC,kBAAL,CAAwBD,OAAxB;AACD,iBAFD;;;;;;;;AAIAjD,gBAAAA,OAAO,CAACC,GAAR,CAAY,kBAAZ;;;;;;;;;;;;;;;;;;;;mGAUagD,O;;;;;;AACf,qBAAKxF,oBAAL;AACMkI,gBAAAA,W,GAAc,iBAClB,UAACC,CAAD;AAAA,yBAAO,wBAAUA,CAAV,KAAgBA,CAAC,CAACnG,EAAF,KAASwD,OAAO,CAACxD,EAAxC;AAAA,iBADkB,EAElB,KAAKhE,QAFa,C;;AAIpB,qBAAKoK,iBAAL,CAAuBF,WAAvB,aAAuBA,WAAvB,uBAAuBA,WAAW,CAAElG,EAApC;;;;;;;;;;;;;;;;;;oCAIcF,kB,EAA4B;AAC1C,UAAI,KAAK/D,aAAL,KAAuB+D,kBAA3B,EAA+C;AAC7C,YAAMuG,YAAY,GAAG,KAAKrK,QAAL,CAAc2D,MAAd,CAAqB,UAACwG,CAAD;AAAA,iBAAO,wBAAUA,CAAV,CAAP;AAAA,SAArB,CAArB;AACA,aAAKlG,IAAL,CAAUlE,aAAV,GAA2BsK,YAAY,CAAC,CAAD,CAAZ,IAAmBA,YAAY,CAAC,CAAD,CAAZ,CAAgBrG,EAApC,IAA2C,IAArE;AACD;AACF;;;2CAGsB;AAAA;;AACrB,WAAKC,IAAL,CAAUhE,SAAV,GAAsB6J,IAAI,CAACC,GAAL,EAAtB;AACA,UAAMO,mBAAmB,GAAG,CAAC,wBAAKpJ,OAAL,kEAAclB,QAAd,KAA0B,EAA3B,EACzB2D,MADyB,CAClB,UAAC6D,OAAD;AAAA,eAAsB,sCAAwBA,OAAxB,CAAtB;AAAA,OADkB,EAEzBzD,GAFyB,CAErB,UAACyD,OAAD,EAAsB;AAAA;;AACzB,+CACKA,OAAO,CAACvD,IADb;AAEEsG,UAAAA,YAAY,EAAE/C,OAAO,CAAC+C,YAFxB;AAGEhB,UAAAA,SAAS,EAAE/B,OAAO,CAAC+B,SAHrB;AAIEE,UAAAA,IAAI,EAAEjC,OAAO,CAACiC,IAJhB;AAKEzF,UAAAA,EAAE,EAAEwD,OAAO,CAACxD,EALd;AAMEwG,UAAAA,YAAY,EAAEhD,OAAO,CAACgD,YANxB;AAOEnB,UAAAA,KAAK,EAAE7B,OAAO,CAAC6B,KAAR,IAAiB,EAP1B;AAQEoB,UAAAA,UAAU,EAAEjD,OAAO,CAACiD,UARtB;AASEC,UAAAA,SAAS,EAAElD,OAAO,CAACkD,SATrB;AAUEC,UAAAA,SAAS,EAAEnD,OAAO,CAACmD,SAVrB;AAWEC,UAAAA,MAAM,EAAEpD,OAAO,CAACoD,MAXlB;AAYE9G,UAAAA,kBAAkB,EAAE0D,OAAO,CAAC1D,kBAZ9B;AAaEuB,UAAAA,gBAAgB,EAAE,wCAA0BmC,OAAO,CAACnC,gBAAlC,CAbpB;AAcEqE,UAAAA,EAAE,EAAElC,OAAO,CAACkC,EAdd;AAeEmB,UAAAA,wBAAwB,EAAErD,OAAO,CAACqD,wBAfpC;AAgBEhH,UAAAA,eAAe,EAAE,sCAAyB2D,OAAO,CAAC3D,eAAjC,CAhBnB;AAiBEiH,UAAAA,iBAAiB,2BAAEtD,OAAO,CAAC3D,eAAV,0DAAE,sBAAyBG;AAjB9C;AAmBD,OAtByB,CAA5B;AAuBA,WAAKC,IAAL,CAAUjE,QAAV,GAAqBsK,mBAAmB,IAAI,EAA5C;AACD;;;uCAEkB9C,O,EAAkB;AACnCA,MAAAA,OAAO,CAACuD,cAAR,CAAuBC,iBAAWC,MAAlC,EAA0C,KAAKlJ,sBAA/C;AACAyF,MAAAA,OAAO,CAACuD,cAAR,CAAuBC,iBAAWE,KAAlC,EAAyC,KAAKnJ,sBAA9C;AACAyF,MAAAA,OAAO,CAACuD,cAAR,CAAuBC,iBAAWG,UAAlC,EAA8C,KAAKpJ,sBAAnD;AACAyF,MAAAA,OAAO,CAACuD,cAAR,CACEC,iBAAWI,YADb,EAEE,KAAKrJ,sBAFP;AAIAyF,MAAAA,OAAO,CAACuD,cAAR,CACEC,iBAAWK,0BADb,EAEE,KAAKtJ,sBAFP;AAIAyF,MAAAA,OAAO,CAACH,EAAR,CAAW2D,iBAAWC,MAAtB,EAA8B,KAAKlJ,sBAAnC;AACAyF,MAAAA,OAAO,CAACH,EAAR,CAAW2D,iBAAWE,KAAtB,EAA6B,KAAKnJ,sBAAlC;AACAyF,MAAAA,OAAO,CAACH,EAAR,CAAW2D,iBAAWG,UAAtB,EAAkC,KAAKpJ,sBAAvC;AACAyF,MAAAA,OAAO,CAACH,EAAR,CAAW2D,iBAAWI,YAAtB,EAAoC,KAAKrJ,sBAAzC;AACAyF,MAAAA,OAAO,CAACH,EAAR,CACE2D,iBAAWK,0BADb,EAEE,KAAKtJ,sBAFP,EAhBmC,CAoBnC;AACA;;AACA,WAAKA,sBAAL;AACD;;;0CAGqB;AACpB,WAAKkC,IAAL,CAAUpE,eAAV,GAA4B,IAA5B;AACD,K,CAED;;;;uCAEmBiE,kB,EAA4B;AAC7C,UAAI,CAACA,kBAAL,EAAyB;AACzB,WAAKG,IAAL,CAAUpE,eAAV,GAA4BiE,kBAA5B;AACD;;;2CAGsB0D,O,EAA0B;AAC/C;AACJ;AACA;AACA;AACI,UAAM8D,yBAAyB,GAAG,sCAAyB9D,OAAzB,CAAlC;;AACA,UACE,CAAC8D,yBAAyB,CAACX,SAA3B,IACA,CAACW,yBAAyB,CAACC,aAD3B,IAEA,CAACD,yBAAyB,CAACE,WAF3B,IAGA,CAACF,yBAAyB,CAACG,SAJ7B,EAKE;AACA;AACD;;AAb8C,UAcvCC,SAduC,GAczBJ,yBAdyB,CAcvCI,SAduC;AAe/C,UAAI,CAACA,SAAL,EAAgB;;AAChB,UAAI,KAAKC,mBAAL,CAAyBC,OAAzB,CAAiCF,SAAS,CAAChB,SAA3C,MAA0D,CAAC,CAA/D,EAAkE;AAChE,aAAKiB,mBAAL,GAA2B,CAACD,SAAS,CAAChB,SAAX,EACxBmB,MADwB,CACjB,KAAKF,mBADY,EAExBG,KAFwB,CAElB,CAFkB,EAEf,CAFe,CAA3B;AAGD;AACF;;;yCAEoB;AACnB,UACE,KAAK5L,KAAL,CAAW6L,mBAAX,IACA,KAAK7L,KAAL,CAAW6L,mBAAX,CAA+BvJ,KAD/B,IAEA,KAAKpB,aAAL,KAAuB,KAAKlB,KAAL,CAAW6L,mBAAX,CAA+BC,YAHxD,EAIE;AACA,aAAK5K,aAAL,GAAqB,KAAKlB,KAAL,CAAW6L,mBAAX,CAA+BC,YAApD;;AACA,YAAI,KAAK5K,aAAT,EAAwB;AACtB,eAAK4G,SAAL;AACD;AACF;AACF;;;;;;;;;;;;;;sBAGK,CAAC,KAAK9H,KAAL,CAAW4C,UAAZ,IAA0B,CAAC,KAAK5C,KAAL,CAAW+L,OAAtC,IAAiD,CAAC,KAAKjL,Y;;;;;;;;sBAGvD,KAAKG,UAAL,gCAAoB,KAAKjB,KAAL,CAAW4C,UAA/B,2DAAoB,uBAAuB2B,MAA3C,C;;;;;AACF,qBAAKtD,UAAL,6BAAkB,KAAKjB,KAAL,CAAW4C,UAA7B,2DAAkB,uBAAuB2B,MAAzC;;sBACI,gCAAKvE,KAAL,CAAW4C,UAAX,kFAAuB2B,MAAvB,KAAiC,KAAKvD,O;;;;;;uBAClC,KAAKA,OAAL,CAAagL,eAAb,CAA6B,KAAKlM,QAAlC,C;;;AACN,qBAAKkB,OAAL,CAAalB,QAAb,CAAsBwF,OAAtB,CAA8B,UAACgC,OAAD,EAAsB;AAClD,kBAAA,MAAI,CAACC,kBAAL,CAAwBD,OAAxB;AACD,iBAFD;;;;;;;;;;;;;;;;;;uCAOajJ,I,EAAc;AAAA;;AAC/B;AACA,UAAM4N,WAAW,4BAAG,KAAKjM,KAAL,CAAWkM,iBAAd,0DAAG,sBAA8BD,WAAlD;AACA,UAAME,WAAW,4BAAG,KAAKC,YAAL,CAAkBC,cAArB,0DAAG,sBAAkCC,IAAtD;AACA,UAAMC,gBAAgB,6BAAG,KAAKH,YAAL,CAAkBC,cAArB,2DAAG,uBAAkCE,gBAA3D;;AACA,UAAIA,gBAAJ,EAAsB;AACpB,yBAAUlO,IAAV;AACD;;AACD,UAAI8N,WAAJ,EAAiB;AACf,yBAAU9N,IAAV;AACD;;AACD,UAAI4N,WAAW,KAAK,QAApB,EAA8B;AAC5B,yBAAU5N,IAAV;AACD;;AACD,UAAI4N,WAAW,CAACO,QAAZ,CAAqB,mBAArB,CAAJ,EAA+C;AAC7C,yBAAUnO,IAAV;AACD;;AACD,aAAOA,IAAP;AACD;;;kDAG6B;AAC5B,WAAK0F,IAAL,CAAUqE,aAAV,GAA0BwB,IAAI,CAACC,GAAL,EAA1B;AACD;;;oDAG+B;AAC9B,WAAK9F,IAAL,CAAUqE,aAAV,GAA0B,CAA1B;AACD;;;;6FAMUxE,kB;;;;;;;;AAEP,qBAAK6I,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CACd,UAACvB,CAAD;AAAA,yBAAgBA,CAAC,CAACI,EAAF,KAASF,kBAAzB;AAAA,iBADc,C;;uBAGV0D,OAAO,CAAC1I,IAAR,E;;;AACN,qBAAK8N,6BAAL;;;;;;;;sBAEI,cAAM7H,QAAN,IAAkB,CAAC,cAAMA,QAAN,CAAe8H,K;;;;;;uBACP,cAAM9H,QAAN,CAAe+H,KAAf,GAAuBC,IAAvB,E;;;AAA7B,8BAAMhI,QAAN,CAAe8H,K;;;qBAEb,0C;;;;;AACF,qBAAK3M,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AACvBxE,kBAAAA,OAAO,EAAEyE,6BAAiBC;AADH,iBAAzB;;;;;;;gDAIQ,KAAKjN,KAAL,CAAWkN,mB,0DAAX,sBAAgCC,cAAhC,e;;;;;;;;AAER,qBAAKnN,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AAAExE,kBAAAA,OAAO,EAAEyE,6BAAiBI;AAA5B,iBAAzB;;;AAEF,qBAAKV,6BAAL;;;;;;;;;;;;;;;;;;;+FAQS9I,kB;;;;;;;;AAET,qBAAK6I,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CACd,UAACvB,CAAD;AAAA,yBAAgBA,CAAC,CAACI,EAAF,KAASF,kBAAzB;AAAA,iBADc,C;;uBAGV0D,OAAO,CAACzI,MAAR,E;;;AACN,qBAAK6N,6BAAL;;;;;;;;sBAEI,cAAM7H,QAAN,IAAkB,CAAC,cAAMA,QAAN,CAAe8H,K;;;;;;uBACP,cAAM9H,QAAN,CAAe+H,KAAf,GAAuBC,IAAvB,E;;;AAA7B,8BAAMhI,QAAN,CAAe8H,K;;;qBAEb,0C;;;;;AACF,qBAAK3M,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AACvBxE,kBAAAA,OAAO,EAAEyE,6BAAiBK;AADH,iBAAzB;;;;;;;iDAIQ,KAAKrN,KAAL,CAAWkN,mB,2DAAX,uBAAgCC,cAAhC,e;;;;;;;;AAER,qBAAKnN,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AAAExE,kBAAAA,OAAO,EAAEyE,6BAAiBI;AAA5B,iBAAzB;;;AAEF,qBAAKV,6BAAL;;;;;;;;;;;;;;;;;;;8GAIwB9I,kB;;;;;;;;AAElB0D,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CACd,UAACvB,CAAD;AAAA,yBAAgBA,CAAC,CAACI,EAAF,KAASF,kBAAzB;AAAA,iBADc,C;;sBAGZ0D,O,aAAAA,O,gDAAAA,OAAO,CAAEnC,gB,oFAAT,sBAA2BgE,K,2DAA3B,uBAAkCmE,K;;;;;;uBAC9BhG,OAAO,CAACzI,MAAR,E;;;;;;;;;;;;;;;;;;;;;;;;;;;oGAYM+E,kB;;;;;;;;AAEd,qBAAK6I,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CACd,UAACvB,CAAD;AAAA,yBAAgBA,CAAC,CAACI,EAAF,KAASF,kBAAzB;AAAA,iBADc,C;AAGV2J,gBAAAA,W,GAAc,KAAKC,cAAL,CAAoBlG,OAApB,C;;uBACdA,OAAO,CAACmG,WAAR,CAAoB;AAAEF,kBAAAA,WAAW,EAAXA;AAAF,iBAApB,C;;;AACN,qBAAKb,6BAAL;mDACO,I;;;;;AAEP,qBAAKA,6BAAL;;uBAC+B,cAAM7H,QAAN,CAAe+H,KAAf,GAAuB9H,IAAvB,E;;;;;;;;;;gCAAkC,E;;;;qCAAzD4I,M;AAAAA,gBAAAA,M,6BAAS,E;;AACjB,oBAAIA,MAAM,CAAC1J,MAAX,EAAmB;AAAA,yDACG0J,MADH;;AAAA;AACjB,wEAA4B;AAAjBC,sBAAAA,MAAiB;AAC1BtJ,sBAAAA,OAAO,CAACsJ,KAAR,CAAc,cAAd,EAA8BA,MAA9B;AACD;AAHgB;AAAA;AAAA;AAAA;AAAA;;AAIjB,uBAAK3N,KAAL,CAAW8M,KAAX,CAAiBc,MAAjB,CAAwB;AACtBrF,oBAAAA,OAAO,EAAEsF,+BAAeC,WADF;AAEtBC,oBAAAA,OAAO,EAAE;AACPC,sBAAAA,SAAS,EAAEN,MAAM,CAAC,CAAD,CAAN,CAAUM;AADd;AAFa,mBAAxB;AAMD;;;;;;;;;;;;;;;;;;mCAIU1G,O,EAAkB;AAC/B,UAAM2G,SAAS,GAAG3G,OAAO,CAACiD,UAAR,CAAmB,CAAnB,CAAlB;AACA,UAAM2D,UAAU,GAAGD,SAAS,IAAIA,SAAS,CAACnK,EAA1C;AACA,aAAOoK,UAAP;AACD;;;;mGAMgBtK,kB;;;;;;;AAEb,qBAAK6I,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CACd,UAACvB,CAAD;AAAA,yBAAgBA,CAAC,CAACI,EAAF,KAASF,kBAAzB;AAAA,iBADc,C;AAGV2J,gBAAAA,W,GAAc,KAAKC,cAAL,CAAoBlG,OAApB,C;;uBACdA,OAAO,CAACvI,UAAR,CAAmB;AAAEwO,kBAAAA,WAAW,EAAXA;AAAF,iBAAnB,C;;;AACN,qBAAKb,6BAAL;;;;;;;AAEArI,gBAAAA,OAAO,CAACC,GAAR,CAAY,oBAAZ;AACA,qBAAKoI,6BAAL;;;;;;;;;;;;;;;;;;;;+FASS9I,kB;;;;;;;;AAET,qBAAK6I,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CACd,UAACvB,CAAD;AAAA,yBAAgBA,CAAC,CAACI,EAAF,KAASF,kBAAzB;AAAA,iBADc,C;;uBAGV0D,OAAO,CAACtI,MAAR,E;;;AACN,oBAAI,OAAO,KAAKmC,cAAZ,KAA+B,UAAnC,EAA+C;AAC7C,uBAAKA,cAAL;AACD;;AACD,qBAAKuL,6BAAL;;;;;;;AAEArI,gBAAAA,OAAO,CAACsJ,KAAR,CAAc,cAAd;;iDACY,KAAK3N,KAAL,CAAWkN,mB,2DAAX,uBAAgCC,cAAhC,e;;;;;;;;AACV,qBAAKnN,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AAAExE,kBAAAA,OAAO,EAAEyE,6BAAiBI;AAA5B,iBAAzB;;;AAEF,qBAAKV,6BAAL;;;;;;;;;;;;;;;;;;;+FAQS9I,kB;;;;;;;;AAET,qBAAK6I,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CACd,UAACvB,CAAD;AAAA,yBAAgBA,CAAC,CAACI,EAAF,KAASF,kBAAzB;AAAA,iBADc,C;;uBAGV0D,OAAO,CAAC6G,WAAR,E;;;AACN,oBAAI7G,OAAO,IAAIA,OAAO,CAAC3D,eAAvB,EAAwC;AACtC2D,kBAAAA,OAAO,CAAC3D,eAAR,CAAwByK,kBAAxB,GAA6C,IAA7C;AACD;;AACD,qBAAK1B,6BAAL;;;;;;;;iDAEY,KAAK1M,KAAL,CAAWkN,mB,2DAAX,uBAAgCC,cAAhC,e;;;;;;;;AACV,qBAAKnN,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AAAExE,kBAAAA,OAAO,EAAEyE,6BAAiBI;AAA5B,iBAAzB;;;AAEF,qBAAKV,6BAAL;;;;;;;;;;;;;;;;;;;gGAQS9I,kB;;;;;;;;AAET,qBAAK6I,2BAAL;;uBACM,KAAKlH,qBAAL,CAA2B3B,kBAA3B,C;;;;uBACwB,KAAK5C,OAAL,CAAaqN,UAAb,CAC5BzK,kBAD4B,EAE5B;AACE8B,kBAAAA,aAAa,EAAE,KAAK1F,KAAL,CAAW2F,cAAX,CAA0BD;AAD3C,iBAF4B,C;;;AAAxB4I,gBAAAA,e;;AAMN,qBAAKC,sBAAL,CAA4B3K,kBAA5B;;;uBACM,KAAK4K,eAAL,CAAqB5K,kBAArB,C;;;AACN,qBAAK8I,6BAAL;;AACA,oBAAI,OAAO,KAAK/K,mBAAZ,KAAoC,UAAxC,EAAoD;AAClD,uBAAKA,mBAAL,CAAyB2M,eAAe,CAAC9D,SAAzC;AACD;;;;;;;;;iDAEW,KAAKxK,KAAL,CAAWkN,mB,2DAAX,uBAAgCC,cAAhC,e;;;;;;;;AACV,qBAAKnN,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AAAExE,kBAAAA,OAAO,EAAEyE,6BAAiBI;AAA5B,iBAAzB;;;AAEF,qBAAKV,6BAAL;;;;;;;;;;;;;;;;;;;6FAQO9I,kB;;;;;;;;AAEP,qBAAK6I,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CACd,UAACvB,CAAD;AAAA,yBAAgBA,CAAC,CAACI,EAAF,KAASF,kBAAzB;AAAA,iBADc,C;AAGRD,gBAAAA,e,GAAuC2D,O,CAAvC3D,e,0BAAuC2D,O,CAAtBgD,Y,EAAAA,Y,sCAAe,E;;uBAEtC;AACA;AACChD,gBAAAA,OAAO,CAAC+B,SAAR,KAAsBoF,8BAAcC,QAApC,KACE,mBAAApE,YAAY,CAAC,CAAD,CAAZ,kEAAiBI,MAAjB,CAAwBiE,IAAxB,MAAiCC,yBAAgBC,UAAjD,IACC,oBAAAvE,YAAY,CAAC,CAAD,CAAZ,oEAAiBI,MAAjB,CAAwBiE,IAAxB,MAAiCC,yBAAgB3P,SAFpD,CAAD,IAGA,4CAA8BqI,OAA9B,C;;;;;;uBAEM3D,eAAe,CAACxE,IAAhB,E;;;;;;;;uBAEAmI,OAAO,CAACnI,IAAR,E;;;AAER,oBAAIwE,eAAe,IAAIA,eAAe,CAACmL,eAAvC,EAAwD;AACtDnL,kBAAAA,eAAe,CAACmL,eAAhB,GAAkCC,6BAAcC,MAAhD;AACD;;AACD,qBAAKtC,6BAAL;;;;;;;;sBAEI,cAAM7H,QAAN,IAAkB,CAAC,cAAMA,QAAN,CAAe8H,K;;;;;;uBACP,cAAM9H,QAAN,CAAe+H,KAAf,GAAuBC,IAAvB,E;;;AAA7B,8BAAMhI,QAAN,CAAe8H,K;;;qBAEb,0C;;;;;AACF,qBAAK3M,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AACvBxE,kBAAAA,OAAO,EAAEyE,6BAAiBiC;AADH,iBAAzB;;;;;;;iDAIQ,KAAKjP,KAAL,CAAWkN,mB,2DAAX,uBAAgCC,cAAhC,e;;;;;;;;AAER,qBAAKnN,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AAAExE,kBAAAA,OAAO,EAAEyE,6BAAiBI;AAA5B,iBAAzB;;;AAEF,qBAAKV,6BAAL;;;;;;;;;;;;;;;;;;;+FAQS9I,kB;;;;;;;;AAET,qBAAK6I,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CACd,UAACvB,CAAD;AAAA,yBAAgBA,CAAC,CAACI,EAAF,KAASF,kBAAzB;AAAA,iBADc,C;;uBAGV,KAAK4K,eAAL,CAAqB5K,kBAArB,C;;;;uBACA0D,OAAO,CAAClI,MAAR,E;;;AACN,qBAAKwC,cAAL,GAAsB0F,OAAtB;AACQ3D,gBAAAA,e,GAAoB2D,O,CAApB3D,e;;AACR,oBAAIA,eAAe,IAAIA,eAAe,CAACmL,eAAvC,EAAwD;AACtDnL,kBAAAA,eAAe,CAACmL,eAAhB,GAAkCC,6BAAc9G,SAAhD;AACD;;AACD,qBAAKiH,kBAAL,CAAwBtL,kBAAxB;;AACA,qBAAKkC,wBAAL;;AACA,qBAAK4G,6BAAL;;;;;;;;sBAEI,cAAM7H,QAAN,IAAkB,CAAC,cAAMA,QAAN,CAAe8H,K;;;;;;uBACP,cAAM9H,QAAN,CAAe+H,KAAf,GAAuBC,IAAvB,E;;;AAA7B,8BAAMhI,QAAN,CAAe8H,K;;;qBAEb,0C;;;;;AACF,qBAAK3M,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AACvBxE,kBAAAA,OAAO,EAAEyE,6BAAiBmC;AADH,iBAAzB;;;;;;;iDAIQ,KAAKnP,KAAL,CAAWkN,mB,2DAAX,uBAAgCC,cAAhC,e;;;;;;;;AAER,qBAAKnN,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AACvBxE,kBAAAA,OAAO,EAAEyE,6BAAiBI;AADH,iBAAzB;;;AAIF,qBAAKV,6BAAL;;;;;;;;;;;;;;;;;;;iGAMW0C,c,EAAwBxL,kB;;;;;;;;;;AAEnC,qBAAK6I,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CACd,UAACvB,CAAD;AAAA,yBAAgBA,CAAC,CAACI,EAAF,KAASF,kBAAzB;AAAA,iBADc,C;;uBAGc,KAAK5D,KAAL,CAAWqP,cAAX,CAA0BC,eAA1B,CAA0C,CACtEF,cADsE,CAA1C,C;;;AAAxBG,gBAAAA,e;;oBAGDA,eAAe,CAACC,M;;;;;AACnBD,gBAAAA,eAAe,CAAC7B,MAAhB,CAAuBpI,OAAvB;AAAA,sFAA+B,mBAAOqI,KAAP;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,4DAErB,OAAI,CAAC3N,KAAL,CAAWkN,mBAFU,0DAErB,sBAAgCC,cAAhC,CAA+CQ,KAA/C,CAFqB;;AAAA;AACvB8B,4BAAAA,SADuB;;AAG7B,gCAAI,CAACA,SAAL,EAAgB;AACd;AACA,8BAAA,OAAI,CAACzP,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AACvBxE,gCAAAA,OAAO,EAAGmH,sBAAD,CAAoB/B,KAAK,CAAC5E,IAA1B,CADc;AAEvBgF,gCAAAA,OAAO,EAAE;AACP4B,kCAAAA,WAAW,EAAEhC,KAAK,CAACgC;AADZ;AAFc,+BAAzB;AAMD;;AAX4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAA/B;;AAAA;AAAA;AAAA;AAAA;;;;AAeF;AACMC,gBAAAA,gB,GACHL,eAAD,CAAyBM,OAAzB,CAAiC,CAAjC,KACCN,eAAD,CAAyBM,OAAzB,CAAiC,CAAjC,EAAoCC,I;AAClCH,gBAAAA,W,GAAcC,gB;;AAClB,oBAAIA,gBAAgB,CAAClE,OAAjB,CAAyB,GAAzB,MAAkC,CAAC,CAAvC,EAA0C;AACxCiE,kBAAAA,WAAW,GAAG,CACZ,KAAK3P,KAAL,CAAWiH,WAAX,CAAuB8I,iBADX,EAEZH,gBAFY,EAGZI,IAHY,CAGP,GAHO,CAAd;AAID;;AACD1I,gBAAAA,OAAO,CAACjI,QAAR,CAAiBsQ,WAAjB;AACA,qBAAKjD,6BAAL;;;;;;;;iDAEY,KAAK1M,KAAL,CAAWkN,mB,2DAAX,uBAAgCC,cAAhC,e;;;;;;;;AACV,qBAAKnN,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AAAExE,kBAAAA,OAAO,EAAEyE,6BAAiBI;AAA5B,iBAAzB;;;AAEF,qBAAKV,6BAAL;;;;;;;;;;;;;;;QAIJ;;;;;6FAEWuD,S,EAAmBrM,kB;;;;;;;AAE1B,qBAAK6I,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CAA2B,UAACvB,CAAD,EAAgB;AACzD,yBAAOA,CAAC,CAACI,EAAF,KAASF,kBAAhB;AACD,iBAFe,C;;uBAGV0D,OAAO,CAAC4I,IAAR,CAAa;AAAEC,kBAAAA,UAAU,EAAEF;AAAd,iBAAb,C;;;AACN,qBAAKvD,6BAAL;;;;;;;AAEArI,gBAAAA,OAAO,CAACsJ,KAAR,CAAc,YAAd;AACA,qBAAKjB,6BAAL;;;;;;;;;;;;;;;;;;;;gGASU0D,a,EAAuBxM,kB;;;;;;;;;8BACD,KAAK5D,K,EAA/B2F,c,eAAAA,c,EAAgB0K,K,eAAAA,K;AAClB/I,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CAA2B,UAACvB,CAAD,EAAgB;AACzD,yBAAOA,CAAC,CAACI,EAAF,KAASF,kBAAhB;AACD,iBAFe,C;;oBAGX0D,O;;;;;mDACI,K;;;;;oBAKF,KAAKhG,gB;;;;;AACRiO,gBAAAA,eAAe,GAAG,iCAChB,CAACa,aAAD,CADgB,EAEhBzK,cAFgB,EAGhB0K,KAAK,CAACvM,EAHU,CAAlB;AAKA8L,gBAAAA,gBAAgB,GAAGL,eAAe,CAAC,CAAD,CAAlC;;;;;;uBAEwB,KAAKvP,KAAL,CAAWqP,cAAX,CAA0BC,eAA1B,CAA0C,CAChEc,aADgE,CAA1C,C;;;AAAxBb,gBAAAA,e;;oBAGKA,eAAe,CAACC,M;;;;;AACnBD,gBAAAA,eAAe,CAAC7B,MAAhB,CAAuBpI,OAAvB,CAA+B,UAACqI,KAAD,EAAW;AACxC,kBAAA,OAAI,CAAC3N,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AACvBxE,oBAAAA,OAAO,EAAGmH,sBAAD,CAAoB/B,KAAK,CAAC5E,IAA1B,CADc;AAEvBgF,oBAAAA,OAAO,EAAE;AACP4B,sBAAAA,WAAW,EAAEhC,KAAK,CAACgC;AADZ;AAFc,mBAAzB;AAMD,iBAPD;mDAQO,K;;;AAETC,gBAAAA,gBAAgB,GACbL,eAAD,CAAyBM,OAAzB,CAAiC,CAAjC,KACCN,eAAD,CAAyBM,OAAzB,CAAiC,CAAjC,EAAoCC,IAFtC;;;AAIF,oBAAIxI,OAAO,IAAIA,OAAO,CAAC3D,eAAvB,EAAwC;AACtC2D,kBAAAA,OAAO,CAAC3D,eAAR,CAAwB2M,gBAAxB,GAA2C,IAA3C;AACD;;;uBAEKhJ,OAAO,CAAC/G,OAAR,CAAgBqP,gBAAhB,EAAkC,KAAKW,aAAvC,C;;;AACN,qBAAKvQ,KAAL,CAAW8M,KAAX,CAAiB0D,OAAjB,CAAyB;AACvBjI,kBAAAA,OAAO,EAAEyE,6BAAiByD;AADH,iBAAzB;;AAGA,oBAAI,OAAO,KAAKtP,cAAZ,KAA+B,UAAnC,EAA+C;AAC7C,uBAAKA,cAAL;AACD;;mDACM,I;;;;;AAEPkD,gBAAAA,OAAO,CAACsJ,KAAR;;AACA,qBAAK3N,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AACvBxE,kBAAAA,OAAO,EAAEsF,+BAAe6C;AADD,iBAAzB;;mDAGO,K;;;;;;;;;;;;;;;QAIX;;;;;iGAEeC,S,EAAmB/M,kB;;;;;;;AAExB0D,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CAA2B,UAACvB,CAAD,EAAgB;AACzD,yBAAOA,CAAC,CAACI,EAAF,KAASF,kBAAhB;AACD,iBAFe,C,EAGhB;;AACQD,gBAAAA,e,GAAoB2D,O,CAApB3D,e;;qBACJA,e;;;;;;uBACIA,eAAe,CAACiN,IAAhB,CAAqBD,SAArB,EAAgC,GAAhC,C;;;;;;;;;AAGRtM,gBAAAA,OAAO,CAACC,GAAR,CAAY,iBAAZ;;;;;;;;;;;;;;;;;;;sCAKcgD,O,EAA0B;AAAA;;AAC1C,UAAM3D,eAAe,GAAG2D,OAAxB;AACA,UAAI,CAAC3D,eAAL,EAAsB;;AACtB,UAAI,CAACA,eAAe,CAACkN,iBAArB,EAAwC;AACtClN,QAAAA,eAAe,CAACkN,iBAAhB,GAAoCjH,IAAI,CAACC,GAAL,EAApC;AACD;;AACD,UAAI,CAAClG,eAAe,CAACmN,mBAArB,EAA0C;AACxCnN,QAAAA,eAAe,CAACmN,mBAAhB,GAAsClH,IAAI,CAACC,GAAL,EAAtC;AACD;;AACDlG,MAAAA,eAAe,CAACwD,EAAhB,CAAmB,YAAnB,EAAiC,YAAM;AACrC9C,QAAAA,OAAO,CAACC,GAAR,CAAY,wBAAZ,EADqC,CAErC;;AAFqC,oBAInC,OAAI,CAAC0B,cAAL,CAAoBf,IAApB,CACE,UAACvB,CAAD;AAAA,iBAAgBA,CAAC,CAACC,eAAF,KAAsBA,eAAtC;AAAA,SADF,KAEK,EAN8B;AAAA,YAG7BC,kBAH6B,SAG7BA,kBAH6B;;AAOrC,QAAA,OAAI,CAACmN,kCAAL,CAAwCnN,kBAAxC;AACD,OARD;AASAD,MAAAA,eAAe,CAACwD,EAAhB,CAAmB,UAAnB,EAA+B,YAAM;AAAA,oBAEjC,OAAI,CAACnB,cAAL,CAAoBf,IAApB,CACE,UAACvB,CAAD;AAAA,iBAAgBA,CAAC,CAACC,eAAF,KAAsBA,eAAtC;AAAA,SADF,KAEK,EAJ4B;AAAA,YAC3BC,kBAD2B,SAC3BA,kBAD2B;;AAKnC,YAAI,OAAI,CAAClC,6BAAL,CAAmCiD,GAAnC,CAAuChB,eAAvC,CAAJ,EAA6D;AAC3D,UAAA,OAAI,CAACjC,6BAAL,WAA0CiC,eAA1C;AACD,SAFD,MAEO;AACL,UAAA,OAAI,CAACuL,kBAAL,CAAwBtL,kBAAxB;;AACA,UAAA,OAAI,CAACoN,eAAL,CAAqBpN,kBAArB;;AACA,UAAA,OAAI,CAAC4K,eAAL,CAAqB5K,kBAArB;;AACA,UAAA,OAAI,CAACkC,wBAAL;AACD;;AACD,QAAA,OAAI,CAAChE,oBAAL;AACD,OAdD;AAeD;;;sCAGiB0I,S,EAAmB;AACnC,WAAKzG,IAAL,CAAUlE,aAAV,GAA0B2K,SAA1B;AACD;AAED;AACF;AACA;AACA;AACA;AACA;;;;uDACqC5G,kB,EAA4B;AAC7D,UAAI,CAACA,kBAAL,EAAyB;;AACzB,UAAI,KAAKjE,eAAL,KAAyBiE,kBAA7B,EAAiD;AAC/C,YAAMqN,cAA8C,GAAG,iBACrD,UAACC,CAAD,EAAIC,CAAJ;AAAA,iBACE,4CACE,sCAAyBD,CAAC,CAACvN,eAA3B,CADF,EAEE,sCAAyBwN,CAAC,CAACxN,eAA3B,CAFF,CADF;AAAA,SADqD,EAMrD,mBACE,UAACD,CAAD;AAAA,iBACE,wBAAUA,CAAV,KAAgB,CAAC,CAACA,CAAC,CAACC,eADtB;AAAA,SADF,EAGE,KAAK7D,QAHP,CANqD,CAAvD;;AAYA,YAAImR,cAAc,CAACjN,MAAnB,EAA2B;AACzB,eAAKkL,kBAAL,CAAwB+B,cAAc,CAAC,CAAD,CAAd,CAAkBrN,kBAA1C;AACD;AACF;AACF;;;;wGAGqBA,kB;;;;;;AACdwN,gBAAAA,a,GAAgB,mBAAO,UAAC1N,CAAD,EAAgB;AAC3C,yBACEA,CAAC,CAACE,kBAAF,KAAyBA,kBAAzB,IACAF,CAAC,CAACgH,MAAF,KAAakE,yBAAgByC,QAD7B,IAEA3N,CAAC,CAACC,eAFF,IAGA,CAACD,CAAC,CAACC,eAAF,CAAkB2N,SAJrB;AAMD,iBAPqB,EAOnB,KAAKtQ,OAAL,CAAalB,QAPM,C;;oBAQjBsR,aAAa,CAACpN,M;;;;;;;;AAGbuN,gBAAAA,iB,GAAoBH,aAAa,CAACvN,GAAd;AAAA,uFAAkB,mBAAOyD,OAAP;AAAA;;AAAA;AAAA;AAAA;AAAA;AAClC3D,4BAAAA,eADkC,GACK2D,OADL,CAClC3D,eADkC,2BACK2D,OADL,CACjBgD,YADiB,EACjBA,YADiB,uCACF,EADE;AAAA;;AAAA,mCAItC;AACA;AACChD,4BAAAA,OAAO,CAAC+B,SAAR,KAAsBoF,8BAAcC,QAApC,KACE,oBAAApE,YAAY,CAAC,CAAD,CAAZ,oEAAiBI,MAAjB,CAAwBiE,IAAxB,MAAiCC,yBAAgBC,UAAjD,IACC,oBAAAvE,YAAY,CAAC,CAAD,CAAZ,oEAAiBI,MAAjB,CAAwBiE,IAAxB,MAAiCC,yBAAgB3P,SAFpD,CAAD,IAGA,4CAA8BqI,OAA9B,CATsC;AAAA;AAAA;AAAA;;AAAA;AAAA,mCAWhC3D,eAAe,CAACxE,IAAhB,EAXgC;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,mCAahCmI,OAAO,CAACnI,IAAR,EAbgC;;AAAA;AAexC,gCAAIwE,eAAe,IAAIA,eAAe,CAACmL,eAAvC,EAAwD;AACtDnL,8BAAAA,eAAe,CAACmL,eAAhB,GAAkCC,6BAAcC,MAAhD;AACD;;AAjBuC;AAAA;;AAAA;AAAA;AAAA;AAmBxC3K,4BAAAA,OAAO,CAACC,GAAR,CAAY,iBAAZ;;AAnBwC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAlB;;AAAA;AAAA;AAAA;AAAA,oB;;uBAsBpBkN,OAAO,CAACC,GAAR,CAAYF,iBAAZ,C;;;;;;;;;;;;;;;;;;;gGAIM3N,kB;;;;;;;;AACZ,qBAAK2K,sBAAL,CAA4B3K,kBAA5B;;AACA,qBAAK6I,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CAA2B,UAACvB,CAAD,EAAgB;AACzD,yBAAOA,CAAC,CAACI,EAAF,KAASF,kBAAhB;AACD,iBAFe,C;AAGhB,qBAAKhC,cAAL,GAAsB0F,OAAtB;;uBACM,KAAKkH,eAAL,CAAqB5K,kBAArB,C;;;AACED,gBAAAA,e,GAAoB2D,O,CAApB3D,e;AACF+N,gBAAAA,Q,4BAAW,KAAK1R,KAAL,CAAWiG,Q,mFAAX,sBAAqB0L,M,0DAArB,sBAA6B7N,E;;uBACxCwD,OAAO,CAAC/H,MAAR,CAAe;AAAEmS,kBAAAA,QAAQ,EAARA;AAAF,iBAAf,C;;;AACN,qBAAKE,sBAAL;;AACA,oBAAIjO,eAAe,IAAIA,eAAe,CAACmL,eAAvC,EAAwD;AACtDnL,kBAAAA,eAAe,CAACmL,eAAhB,GAAkCC,6BAAc9G,SAAhD;AACD;;AACD,qBAAKyE,6BAAL;;;;;;;;;;;;;;;;;;;gGAOW9I,kB;;;;;;;uBAEH,KAAKiO,OAAL,CAAajO,kBAAb,C;;;;;;;;;AAENS,gBAAAA,OAAO,CAACC,GAAR,CAAY,gBAAZ;;;;;;;;;;;;;;;;;;;sGAQgBV,kB;;;;;;;uBAGV,KAAKiO,OAAL,CAAajO,kBAAb,C;;;;;;;;;AAENS,gBAAAA,OAAO,CAACC,GAAR,CAAY,qBAAZ;;;;;;;;;;;;;;;;AAIJ;AACF;AACA;AACA;AACA;AACA;AACA;;;;;+FAKeV,kB;;;;;;;;;AAET,qBAAK6I,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CAA2B,UAACvB,CAAD,EAAgB;AACzD,yBAAOA,CAAC,CAACI,EAAF,KAASF,kBAAhB;AACD,iBAFe,C;AAGRD,gBAAAA,e,GAAoB2D,O,CAApB3D,e;;uBACFA,eAAe,CAACmO,MAAhB,E;;;AACN;AACAnI,gBAAAA,UAAU,CAAC;AAAA,yBAAM,OAAI,CAAC7H,oBAAL,EAAN;AAAA,iBAAD,EAAoC,CAApC,CAAV;AACA,qBAAK4K,6BAAL;;;;;;;AAEArI,gBAAAA,OAAO,CAACC,GAAR,CAAY,gBAAZ;;;;;;;;;;;;;;;;;;;qGAQeV,kB;;;;;;;;;qBAEX,KAAKmO,I;;;;;;;;AACT,qBAAKtF,2BAAL;AACMnF,gBAAAA,O,GAAU,KAAKtG,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CAA2B,UAACvB,CAAD,EAAgB;AACzD,yBAAOA,CAAC,CAACI,EAAF,KAASF,kBAAhB;AACD,iBAFe,C;AAGVoO,gBAAAA,iB,GAAoB,KAAKhR,OAAL,CAAalB,QAAb,CAAsBmF,IAAtB,CACxB,UAACvB,CAAD;AAAA,yBACEA,CAAC,CAACI,EAAF,KAASF,kBAAT,IACAF,CAAC,CAACC,eADF,IAEAD,CAAC,CAACgH,MAAF,KAAakE,yBAAgByC,QAH/B;AAAA,iBADwB,C;;qBAMtBW,iB;;;;;;uBACIA,iBAAiB,CAAChT,MAAlB,E;;;AAEF0S,gBAAAA,Q,4BAAW,KAAK1R,KAAL,CAAWiG,Q,mFAAX,sBAAqB0L,M,0DAArB,sBAA6B7N,E;;uBACxCwD,OAAO,CAAC/H,MAAR,CAAe;AAAEmS,kBAAAA,QAAQ,EAARA;AAAF,iBAAf,C;;;AACN,qBAAKE,sBAAL;;AACQjO,gBAAAA,e,GAAoB2D,O,CAApB3D,e;;AACR,oBAAIA,eAAe,IAAIA,eAAe,CAACmL,eAAvC,EAAwD;AACtDnL,kBAAAA,eAAe,CAACmL,eAAhB,GAAkCC,6BAAc9G,SAAhD;AACD;;AACD,qBAAKyE,6BAAL;;;;;;;AAEArI,gBAAAA,OAAO,CAACC,GAAR,CAAY,sBAAZ;AACAD,gBAAAA,OAAO,CAACsJ,KAAR;;;;;;;;;;;;;;;;;;;iGAKWsE,M;;;;;;;;;;sBAGTA,MAAM,CAACC,QAAP,CAAgBlO,MAAhB,GAAyB,CAAzB,KACC,CAAC,KAAKhE,KAAL,CAAWkN,mBAAZ,IACC,CAAC,KAAKlN,KAAL,CAAWkN,mBAAX,CAA+BiF,cAFlC,C;;;;;;uBAIyB,KAAKC,QAAL,E;;;AAAnBC,gBAAAA,U;;sBACFA,UAAU,CAACrO,MAAX,KAAsB,C;;;;;AACxB,qBAAKhE,KAAL,CAAW8M,KAAX,CAAiBC,OAAjB,CAAyB;AACvBxE,kBAAAA,OAAO,EAAEsF,+BAAeyE;AADD,iBAAzB;;mDAGO,I;;;;uBAGL,KAAK9D,eAAL,E;;;AACA+D,gBAAAA,iB,GAAoC;AACxC;AACAxJ,kBAAAA,IAAI,EAAE,UAFkC;AAGxCmJ,kBAAAA,QAAQ,EAAED,MAAM,CAACC,QAHuB;AAIxCM,kBAAAA,UAAU,EAAEP,MAAM,CAACO,UAJqB;AAKxC9M,kBAAAA,aAAa,EAAEuM,MAAM,CAACvM;AALkB,iB;;uBAOpB,KAAK1E,OAAL,CAAayR,QAAb,CAAsBF,iBAAtB,C;;;AAAhBjL,gBAAAA,O;AACN,qBAAK1F,cAAL,GAAsB0F,OAAtB;AACAA,gBAAAA,OAAO,CAAC3D,eAAR,CAAwBwD,EAAxB,CAA2B,UAA3B,EAAuC,YAAM;AAC3C,sBACEG,OAAO,CAAC1D,kBAAR,IACA,OAAI,CAACjE,eAAL,KAAyB2H,OAAO,CAAC1D,kBAFnC,EAGE;AACA,oBAAA,OAAI,CAACsL,kBAAL,CAAwB5H,OAAO,CAAC1D,kBAAhC;AACD;AACF,iBAPD;;AAQA,qBAAK2K,sBAAL;;mDACOjH,O;;;;;AAEPjD,gBAAAA,OAAO,CAACC,GAAR,CAAY,iBAAZ;;;;;;;;;;;;;;;;;;;;;;;;;;uBAKqB,KAAKtE,KAAL,CAAWwE,MAAX,CACpBwC,OADoB,GAEpB0L,SAFoB,GAGpBf,MAHoB,GAIpBgB,IAJoB,E;;;AAAjB9N,gBAAAA,Q;AAKA+N,gBAAAA,O,GAAU/N,QAAQ,CAACgO,O;AACrBR,gBAAAA,U,GAAoB,E;AACxBO,gBAAAA,OAAO,CAACtN,OAAR,CAAgB,UAACqM,MAAD,EAAY;AAC1B;AACA,sBAAI,CAACA,MAAM,CAACU,UAAR,IAAuBV,MAAM,CAACU,UAAR,CAA2BrO,MAA3B,KAAsC,CAAhE,EAAmE;AACjE;AACD;;AACDqO,kBAAAA,UAAU,GAAGA,UAAU,CAAC1G,MAAX,CAAkBgG,MAAM,CAACU,UAAzB,CAAb;AACD,iBAND;mDAOOA,U;;;;;;;;;;;;;;;;;;qCAGQzO,kB,EAA4B;AAC3C,UAAI,CAACA,kBAAL,EAAyB;AACvB,eAAO,IAAP;AACD;;AACD,aAAO,KAAKhE,cAAL,CAAoBgE,kBAApB,CAAP;AACD;;;qCAEgBL,kB,EAA4B;AAC3C,aAAO,KAAKyC,cAAL,CAAoBf,IAApB,CACL,UAACqC,OAAD;AAAA,eAAsBA,OAAO,CAAC1D,kBAAR,KAA+BL,kBAArD;AAAA,OADK,CAAP;AAGD;;;6CAqHwB,CAAE;;;uCAGR,CAAE;;;wCAGD,CAAE;;;yCAKD,CAAE;;;wCAKH,CAAE;;;uCAKH,CAAE;;;wBApID;AAClB,aAAO,KAAKuP,gBAAL,CAAsB,KAAKnT,eAA3B,CAAP;AACD;;;wBAMiB;AAChB,aAAO,KAAKmT,gBAAL,CAAsB,KAAKjT,aAA3B,CAAP;AACD;;;wBAGkB;AACjB,UAAI,CAAC,KAAKC,QAAV,EAAoB;AAClB,eAAO,EAAP;AACD;;AACD,aAAO,KAAKA,QAAL,CAAc2D,MAAd,CAAqB,UAAC6D,OAAD;AAAA,eAC1B,wBAAUA,OAAV,CAD0B;AAAA,OAArB,CAAP;AAGD;;;wBAGoB;AACnB,aAAO,KAAKxH,QAAL,CAAciT,MAAd,CAAqB,UAACC,WAAD,EAAc1L,OAAd,EAA0B;AAAA,YAC5CxD,EAD4C,GACrCwD,OADqC,CAC5CxD,EAD4C;AAEpDkP,QAAAA,WAAW,CAAClP,EAAD,CAAX,GAAkB,+BAAiB;AAAEwD,UAAAA,OAAO,EAAPA;AAAF,SAAjB,CAAlB;AACA,eAAO0L,WAAP;AACD,OAJM,EAIJ,EAJI,CAAP;AAKD;;;wBAG0C;AACzC,aAAO,KAAKhT,KAAL,CAAWC,QAAX,CAAoBC,KAApB,CAA0B6S,MAA1B,CAAiC,UAACC,WAAD,EAAc3N,IAAd,EAAuB;AAAA,YACrDzB,kBADqD,GACnByB,IADmB,CACrDzB,kBADqD;AAAA,YACjC4G,SADiC,GACnBnF,IADmB,CACjCmF,SADiC;AAE7DwI,QAAAA,WAAW,CAACxI,SAAD,CAAX,GAAyB5G,kBAAzB;AACA,eAAOoP,WAAP;AACD,OAJM,EAIJ,EAJI,CAAP;AAKD;AAED;AACF;AACA;AACA;AACA;;;;wBACa;AACT,aAAOpJ,IAAI,CAACC,GAAL,KAAa,KAAKzB,aAAlB,GAAkCrK,oBAAzC;AACD,K,CAED;;;;wBACoB;AAAA;;AAClB,aACE,+BAAKiC,KAAL,CAAWiT,IAAX,CAAgBC,KAAhB,CAAsBC,KAAtB,gFAA6BzH,OAA7B,CAAqC,aAArC,KAAsD,CAAC,CAAvD,IACA,gCAAK1L,KAAL,CAAWiT,IAAX,CAAgBC,KAAhB,CAAsBC,KAAtB,kFAA6BzH,OAA7B,CAAqC,kBAArC,KAA2D,CAAC,CAF9D;AAID;;;wBAEiB;AAChB,aAAO,KAAK9K,YAAZ;AACD;;;wBAES;AACR,aAAO,KAAKD,IAAZ;AACD;;;wBAEmB;AAAA;;AAClB,aAAO;AACLyS,QAAAA,gCAAgC,EAAE;AAChCC,UAAAA,WAAW,EAAE;AACXC,YAAAA,KAAK,EAAE;AACL5B,cAAAA,QAAQ,2BAAE,KAAK1R,KAAL,CAAWuT,aAAb,0DAAE,sBAA0BC;AAD/B,aADI;AAIXC,YAAAA,KAAK,EAAE;AAJI;AADmB;AAD7B,OAAP;AAUD;;;wBAEwB;AACvB,aAAO,KAAK3T,QAAL,CAAc4T,IAAd,CAAmB,UAACpM,OAAD;AAAA,eAAa,0BAAYA,OAAZ,CAAb;AAAA,OAAnB,CAAP;AACD,K,CAED;;;;wBACqB;AAAA;;AACnB,aAAO,mBACL,UAACA,OAAD;AAAA,eAAsB,sCAAwBA,OAAxB,CAAtB;AAAA,OADK,EAEL,wBAAKtG,OAAL,kEAAclB,QAAd,KAA0B,EAFrB,CAAP;AAID;;;wBAEqB;AACpB,aAAO,KAAKiE,IAAL,CAAUpE,eAAjB;AACD;;;wBAEmB;AAClB,aAAO,KAAKoE,IAAL,CAAUqE,aAAjB;AACD;;;wBAEe;AACd,aAAO,KAAKrE,IAAL,CAAUhE,SAAjB;AACD;;;wBAEc;AACb,aAAO,KAAKgE,IAAL,CAAUjE,QAAjB;AACD;;;wBAEmB;AAClB,aAAO,KAAKiE,IAAL,CAAUlE,aAAjB;AACD;;;;EA33CoC8T,gB,wEAuLpC5H,a,EACA6H,W;;;;;WAOG;AACFjU,MAAAA,eAAe,EAAE,IADf;AAEFyI,MAAAA,aAAa,EAAE,CAFb;AAGFrI,MAAAA,SAAS,EAAE,CAHT;AAIFD,MAAAA,QAAQ,EAAE,EAJR;AAKFD,MAAAA,aAAa,EAAE;AALb,K;;wFAQH+T,W;;;;;WAC+B,E;;mFAG/BA,W;;;;;WAC0B,E;;4DAE1BC,gB,iJAmEAC,Y,oJAYAD,gB,oJAuEAA,gB,qJAuDAA,gB,0JAUAC,Y,oKAQAA,Y,wKAsDAA,Y,sKAMAA,Y,yKAMAA,Y,kLAwEAA,Y,yLAKAA,Y,yKAQAD,gB,kJA6BAA,gB,yJA2CAA,gB,6JAqCAA,gB,wJAoBAA,gB,oJAwBAA,gB,oJAuBAA,gB,kJA4BAA,gB,mJA4CAA,gB,uJAqCAA,gB,6IAgDAA,gB,oJAmBAA,gB,gJA4DAA,gB,0JAoDAC,Y,iKAgCAD,gB,uJAsCAA,gB,sJAsBAA,gB,4JAYAA,gB,4JAoBAA,gB,2JAoBAA,gB,qJA+BAA,gB","sourcesContent":["import { ExtensionTelephonySessionsEvent } from '@rc-ex/core/definitions';\nimport {\n  action,\n  computed,\n  RcModuleV2,\n  state,\n  storage,\n  track,\n  watch,\n} from '@ringcentral-integration/core';\nimport { filter, forEach, isEmpty, sort, find } from 'ramda';\nimport {\n  ActiveCallInfo,\n  events as callEvents,\n  MakeCallParams,\n  RingCentralCall,\n} from 'ringcentral-call';\nimport { PartyStatusCode } from 'ringcentral-call-control/lib/Session';\nimport { events as eventsEnum, Session } from 'ringcentral-call/lib/Session';\nimport { WebPhoneSession } from 'ringcentral-web-phone/lib/session';\nimport { v4 as uuidV4 } from 'uuid';\nimport { callDirection } from '../../enums/callDirections';\n// eslint-disable-next-line import/no-named-as-default\nimport subscriptionFilters from '../../enums/subscriptionFilters';\nimport { Module } from '../../lib/di';\nimport { proxify } from '../../lib/proxy/proxify';\nimport validateNumbers from '../../lib/validateNumbers';\nimport callControlError from '../ActiveCallControl/callControlError';\nimport { trackEvents } from '../Analytics';\nimport callErrors from '../Call/callErrors';\nimport { sessionStatus } from '../WebphoneV2/sessionStatus';\nimport { webphoneErrors } from '../WebphoneV2/webphoneErrors';\nimport {\n  normalizeSession as normalizeWebphoneSession,\n  sortByCreationTimeDesc,\n} from '../WebphoneV2/webphoneHelper';\nimport {\n  ActiveCallControlSessionData,\n  ActiveSession,\n  Deps,\n  ModuleMakeCallParams,\n} from './ActiveCallControl.interface';\nimport {\n  conflictError,\n  filterDisconnectedCalls,\n  isAtMainNumberPromptToneStage,\n  isHolding,\n  isRecording,\n  isRinging,\n  normalizeSession,\n  normalizeTelephonySession,\n} from './helpers';\n\nconst DEFAULT_TTL = 30 * 60 * 1000;\nconst DEFAULT_TIME_TO_RETRY = 62 * 1000;\nconst DEFAULT_BUSY_TIMEOUT = 3 * 1000;\nconst telephonySessionsEndPoint = /\\/telephony\\/sessions$/;\nconst subscribeEvent = subscriptionFilters.telephonySessions;\n\n@Module({\n  name: 'ActiveCallControl',\n  deps: [\n    'Auth',\n    'Alert',\n    'Brand',\n    'Client',\n    'Presence',\n    'AccountInfo',\n    'Subscription',\n    'ExtensionInfo',\n    'NumberValidate',\n    'RegionSettings',\n    'ConnectivityMonitor',\n    { dep: 'Prefix', optional: true },\n    { dep: 'Storage', optional: true },\n    { dep: 'Webphone', optional: true },\n    { dep: 'TabManager', optional: true },\n    { dep: 'AudioSettings', optional: true },\n    { dep: 'AvailabilityMonitor', optional: true },\n    { dep: 'ActiveCallControlOptions', optional: true },\n    { dep: 'RouterInteraction', optional: true },\n  ],\n})\nexport class ActiveCallControl extends RcModuleV2<Deps> {\n  _ttl: number;\n  _timeToRetry: number;\n  _polling: boolean;\n  _enableCache: boolean;\n  private _promise: Promise<void> = null;\n  private _rcCall: RingCentralCall;\n  private _tabActive: boolean;\n  private _connectivity: boolean;\n  private _onCallEndFunc: () => void;\n  private _timeoutId: ReturnType<typeof setTimeout> = null;\n  private _lastSubscriptionMessage: string;\n  private _permissionCheck: boolean;\n  private _autoMergeSignCallIdKey: string;\n  private _autoMergeCallsKey: string;\n  private _enableAutoSwitchFeature: boolean;\n  private _autoMergeWebphoneSessionsMap: Map<WebPhoneSession, boolean>;\n  private _onCallSwitchedFunc: (args: any) => any;\n  private _activeSession: Session;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: deps.activeCallControlOptions?.enableCache ?? true,\n      storageKey: 'activeCallControl',\n    });\n    const { activeCallControlOptions } = this._deps;\n    this._ttl = activeCallControlOptions?.ttl ?? DEFAULT_TTL;\n    this._timeToRetry =\n      activeCallControlOptions?.timeToRetry ?? DEFAULT_TIME_TO_RETRY;\n    this._polling = activeCallControlOptions?.polling ?? false;\n    this._enableCache = activeCallControlOptions?.enableCache ?? true;\n    this._promise = null;\n    this._rcCall = null;\n    this._permissionCheck = activeCallControlOptions?.permissionCheck ?? true;\n    this._enableAutoSwitchFeature =\n      activeCallControlOptions?.enableAutoSwitchFeature ?? false;\n    this._autoMergeSignCallIdKey = `${deps.prefix}-auto-merge-sign-call-id-key`;\n    this._autoMergeCallsKey = `${deps.prefix}-auto-merge-calls-key`;\n    this._autoMergeWebphoneSessionsMap = new Map();\n  }\n\n  async onStateChange() {\n    if (this.ready && this.hasPermission) {\n      this._subscriptionHandler();\n      this._checkConnectivity();\n      await this._checkTabActive();\n    }\n  }\n\n  async _initModule() {\n    this._createOtherInstanceListener();\n    await super._initModule();\n  }\n\n  _createOtherInstanceListener() {\n    if (!this._deps.tabManager || !this._enableAutoSwitchFeature) {\n      return;\n    }\n    window.addEventListener('storage', (e) => {\n      this._onStorageChangeEvent(e);\n    });\n  }\n\n  _onStorageChangeEvent(e: StorageEvent) {\n    switch (e.key) {\n      case this._autoMergeSignCallIdKey:\n        this._triggerCurrentClientAutoMerge(e);\n        break;\n      case this._autoMergeCallsKey:\n        this._autoMergeCallsHandler(e);\n        break;\n      default:\n        break;\n    }\n  }\n\n  _triggerCurrentClientAutoMerge(e: StorageEvent) {\n    try {\n      const { telephoneSessionId }: { telephoneSessionId: string } = JSON.parse(\n        e.newValue,\n      );\n      const ids = this.sessions\n        .filter(\n          (s: ActiveCallControlSessionData) =>\n            !isRinging(s) &&\n            !!s.webphoneSession &&\n            s.telephonySessionId !== telephoneSessionId,\n        )\n        .map((s: ActiveCallControlSessionData) => s.telephonySessionId);\n      const id = uuidV4();\n      const data = { id, ids };\n      if (ids.length) {\n        localStorage.setItem(this._autoMergeCallsKey, JSON.stringify(data));\n      }\n    } catch (err) {\n      console.log('AutoMerge sign event parse error');\n    }\n  }\n\n  async _autoMergeCallsHandler(e: StorageEvent) {\n    if (!this._deps.tabManager.active) return;\n\n    try {\n      const { ids }: { ids: string[] } = JSON.parse(e.newValue);\n      const response = await this._deps.client.service\n        .platform()\n        .get(subscriptionFilters.detailedPresence);\n      const data = await response.json();\n      const activeCalls: ActiveCallInfo[] = data.activeCalls;\n      const callsList = ids\n        // filter calls which are already in current instance.\n        .filter((id) =>\n          this.sessions.find(\n            (item: ActiveCallControlSessionData) =>\n              item.telephonySessionId === id &&\n              !!item.telephonySession &&\n              !isEmpty(item.telephonySession),\n          ),\n        )\n        // transfer id to ActiveCallInfo.\n        .map((telephonySessionId: string) => {\n          const activeCall = activeCalls.find(\n            (call) => call.telephonySessionId === telephonySessionId,\n          );\n          if (!activeCall)\n            console.log(\n              `Auto Switch failed with telephonySessionId ${telephonySessionId}`,\n            );\n          return activeCall;\n        })\n        .filter((item: any) => !!item);\n\n      if (callsList.length) {\n        callsList.forEach(async (activeCall: ActiveCallInfo) => {\n          await this.transferUnmuteHandler(activeCall.telephonySessionId);\n          const switchSession = this._rcCall.switchCallFromActiveCall(\n            activeCall,\n            {\n              homeCountryId: this._deps.regionSettings.homeCountryId,\n            },\n          );\n          this._autoMergeWebphoneSessionsMap.set(\n            switchSession.webphoneSession,\n            true,\n          );\n          switchSession.webphoneSession.mute();\n          switchSession.webphoneSession.once('accepted', async () => {\n            switchSession.webphoneSession.unmute();\n            await switchSession.webphoneSession.hold();\n            this._addTrackToActiveSession();\n          });\n        });\n      }\n    } catch (err) {\n      console.log(err);\n      console.log('auto merge calls from other tabs failed');\n    }\n  }\n\n  _triggerAutoMergeEvent(telephoneSessionId?: string) {\n    if (!this._deps.tabManager || !this._enableAutoSwitchFeature) return;\n\n    const id = uuidV4();\n    const data = {\n      id,\n      telephoneSessionId,\n    };\n    localStorage.setItem(this._autoMergeSignCallIdKey, JSON.stringify(data));\n  }\n\n  _addTrackToActiveSession() {\n    const telephonySessionId = this.activeSessionId;\n    const activeRCCallSession =\n      this.rcCallSessions.find(\n        (s) => s.telephonySessionId === telephonySessionId,\n      ) || this._activeSession;\n    if (activeRCCallSession && activeRCCallSession.webphoneSession) {\n      const { _remoteVideo, _localVideo } = this._deps.webphone;\n      activeRCCallSession.webphoneSession.addTrack(_remoteVideo, _localVideo);\n    }\n  }\n\n  @storage\n  @state\n  data: {\n    activeSessionId: string;\n    busyTimestamp: number;\n    timestamp: number;\n    sessions: ActiveCallControlSessionData[];\n    ringSessionId: string;\n  } = {\n    activeSessionId: null,\n    busyTimestamp: 0,\n    timestamp: 0,\n    sessions: [],\n    ringSessionId: null,\n  };\n\n  @state\n  lastEndedSessionIds: string[] = [];\n\n  // TODO conference call using\n  @state\n  cachedSessions: object[] = [];\n\n  @proxify\n  async onInit() {\n    if (!this.hasPermission) return;\n    this._deps.subscription.subscribe([subscribeEvent]);\n    this._rcCall = new RingCentralCall({\n      sdk: this._deps.client.service,\n      subscriptions: null,\n      enableSubscriptionHander: false,\n      callControlOptions: {\n        preloadDevices: false,\n        preloadSessions: false,\n        extensionInfo: {\n          ...this._deps.extensionInfo.info,\n          // TODO: add info type in 'AccountInfo'\n          // @ts-ignore\n          account: this._deps.accountInfo.info,\n        },\n      },\n      webphone: this._deps.webphone?._webphone,\n    });\n    this._rcCall.on(callEvents.NEW, (session: Session) => {\n      this._newSessionHandler(session);\n    });\n    this._rcCall.on(callEvents.WEBPHONE_INVITE, (session: WebPhoneSession) =>\n      this._onWebphoneInvite(session),\n    );\n    this._rcCall.on(\n      callEvents.WEBPHONE_INVITE_SENT,\n      (session: WebPhoneSession) => this._onWebphoneInvite(session),\n    );\n    // workaround of bug:\n    // WebRTC outbound call with wrong sequences of telephony sessions then call log section will not show\n    this._rcCall?._callControl?.on('new', (session: Session) =>\n      this._onNewCall(session),\n    );\n    this._tabActive = this._deps.tabManager?.active;\n    if (this._shouldFetch()) {\n      try {\n        await this.fetchData();\n      } catch (e) {\n        this._retry();\n      }\n    } else if (this._polling) {\n      this._startPolling();\n    } else {\n      this._retry();\n    }\n  }\n\n  onInitOnce() {\n    if (this._deps.webphone) {\n      watch(\n        this,\n        () => this._deps.webphone.connected,\n        (newValue) => {\n          if (newValue && this._deps.webphone._webphone) {\n            this._rcCall.setWebphone(this._deps.webphone._webphone);\n          }\n        },\n      );\n    }\n  }\n\n  onReset() {\n    this.resetState();\n  }\n\n  @action\n  resetState() {\n    this.data.activeSessionId = null;\n    this.data.busyTimestamp = 0;\n    this.data.timestamp = 0;\n    this.data.sessions = [];\n  }\n\n  _shouldFetch() {\n    return !this._deps.tabManager || this._deps.tabManager.active;\n  }\n\n  @proxify\n  async fetchData() {\n    if (!this._promise) {\n      this._promise = this._fetchData();\n    }\n    await this._promise;\n  }\n\n  _clearTimeout() {\n    if (this._timeoutId) clearTimeout(this._timeoutId);\n  }\n\n  _subscriptionHandler() {\n    if (!this.ready) {\n      return;\n    }\n    let { message } = this._deps.subscription;\n    if (\n      message &&\n      message !== this._lastSubscriptionMessage &&\n      telephonySessionsEndPoint.test(message.event) &&\n      message.body\n    ) {\n      message = this._checkRingOutCallDirection(message);\n      this._lastSubscriptionMessage = message;\n      if (this._rcCall) {\n        this._rcCall.onNotificationEvent(message);\n      }\n    }\n  }\n\n  // workaround of PLA bug: https://jira.ringcentral.com/browse/PLA-52742, remove these code after PLA\n  // fixed this bug\n  _checkRingOutCallDirection(message: ExtensionTelephonySessionsEvent) {\n    const { body } = message;\n    const originType = body?.origin?.type;\n    if (originType === 'RingOut') {\n      const { parties } = body;\n      if (Array.isArray(parties) && parties.length) {\n        forEach((party: any) => {\n          if (\n            party.ringOutRole &&\n            party.ringOutRole === 'Initiator' &&\n            party.direction === 'Inbound'\n          ) {\n            const tempFrom = { ...party.from };\n            party.direction = 'Outbound';\n            party.from = party.to;\n            party.to = tempFrom;\n          }\n        }, parties);\n      }\n    }\n    return message;\n  }\n\n  _retry(t = this.timeToRetry) {\n    this._clearTimeout();\n    this._timeoutId = setTimeout(() => {\n      this._timeoutId = null;\n      if (!this.timestamp || Date.now() - this.timestamp > this.ttl) {\n        if (!this._deps.tabManager || this._deps.tabManager.active) {\n          this.fetchData();\n        } else {\n          // continue retry checks in case tab becomes main tab\n          this._retry();\n        }\n      }\n    }, t);\n  }\n\n  @proxify\n  async _fetchData() {\n    try {\n      await this._syncData();\n      if (this._polling) {\n        this._startPolling();\n      }\n      this._promise = null;\n    } catch (error) {\n      this._promise = null;\n      if (this._polling) {\n        this._startPolling(this.timeToRetry);\n      } else {\n        this._retry();\n      }\n      throw error;\n    }\n  }\n\n  _startPolling(t = this.timestamp + this.ttl + 10 - Date.now()) {\n    this._clearTimeout();\n    this._timeoutId = setTimeout(() => {\n      this._timeoutId = null;\n      if (!this._deps.tabManager || this._deps.tabManager?.active) {\n        if (!this.timestamp || Date.now() - this.timestamp > this.ttl) {\n          this.fetchData();\n        } else {\n          this._startPolling();\n        }\n      } else if (this.timestamp && Date.now() - this.timestamp < this.ttl) {\n        this._startPolling();\n      } else {\n        this._startPolling(this.timeToRetry);\n      }\n    }, t);\n  }\n\n  async _syncData() {\n    try {\n      const activeCalls = this._deps.presence.calls;\n      await this._rcCall.loadSessions(activeCalls);\n      this.updateActiveSessions();\n      this._rcCall.sessions.forEach((session: Session) => {\n        this._newSessionHandler(session);\n      });\n    } catch (error) {\n      console.log('sync data error:', error);\n      throw error;\n    }\n  }\n\n  _updateSessionsHandler = () => {\n    this.updateActiveSessions();\n  };\n\n  @proxify\n  async _onNewCall(session: Session) {\n    this.updateActiveSessions();\n    const ringSession = find(\n      (x) => isRinging(x) && x.id === session.id,\n      this.sessions,\n    );\n    this._setRingSessionId(ringSession?.id);\n  }\n\n  @action\n  _onCallAccepted(telephonySessionId: string) {\n    if (this.ringSessionId === telephonySessionId) {\n      const ringSessions = this.sessions.filter((x) => isRinging(x));\n      this.data.ringSessionId = (ringSessions[0] && ringSessions[0].id) || null;\n    }\n  }\n\n  @action\n  updateActiveSessions() {\n    this.data.timestamp = Date.now();\n    const callControlSessions = (this._rcCall?.sessions || [])\n      .filter((session: Session) => filterDisconnectedCalls(session))\n      .map((session: Session) => {\n        return {\n          ...session.data,\n          activeCallId: session.activeCallId,\n          direction: session.direction,\n          from: session.from,\n          id: session.id,\n          otherParties: session.otherParties,\n          party: session.party || {},\n          recordings: session.recordings,\n          sessionId: session.sessionId,\n          startTime: session.startTime,\n          status: session.status,\n          telephonySessionId: session.telephonySessionId,\n          telephonySession: normalizeTelephonySession(session.telephonySession),\n          to: session.to,\n          webphoneSessionConnected: session.webphoneSessionConnected,\n          webphoneSession: normalizeWebphoneSession(session.webphoneSession),\n          webphoneSessionId: session.webphoneSession?.id,\n        };\n      });\n    this.data.sessions = callControlSessions || [];\n  }\n\n  _newSessionHandler(session: Session) {\n    session.removeListener(eventsEnum.STATUS, this._updateSessionsHandler);\n    session.removeListener(eventsEnum.MUTED, this._updateSessionsHandler);\n    session.removeListener(eventsEnum.RECORDINGS, this._updateSessionsHandler);\n    session.removeListener(\n      eventsEnum.DISCONNECTED,\n      this._updateSessionsHandler,\n    );\n    session.removeListener(\n      eventsEnum.WEBPHONE_SESSION_CONNECTED,\n      this._updateSessionsHandler,\n    );\n    session.on(eventsEnum.STATUS, this._updateSessionsHandler);\n    session.on(eventsEnum.MUTED, this._updateSessionsHandler);\n    session.on(eventsEnum.RECORDINGS, this._updateSessionsHandler);\n    session.on(eventsEnum.DISCONNECTED, this._updateSessionsHandler);\n    session.on(\n      eventsEnum.WEBPHONE_SESSION_CONNECTED,\n      this._updateSessionsHandler,\n    );\n    // Handle the session update at the end of function to reduce the probability of empty rc call\n    // sessions\n    this._updateSessionsHandler();\n  }\n\n  @action\n  removeActiveSession() {\n    this.data.activeSessionId = null;\n  }\n\n  // count it as load (should only call on container init step)\n  @action\n  setActiveSessionId(telephonySessionId: string) {\n    if (!telephonySessionId) return;\n    this.data.activeSessionId = telephonySessionId;\n  }\n\n  @action\n  setLastEndedSessionIds(session: WebPhoneSession) {\n    /**\n     * don't add incoming call that isn't relied by current app\n     *   to end sessions. this call can be answered by other apps\n     */\n    const normalizedWebphoneSession = normalizeWebphoneSession(session);\n    if (\n      !normalizedWebphoneSession.startTime &&\n      !normalizedWebphoneSession.isToVoicemail &&\n      !normalizedWebphoneSession.isForwarded &&\n      !normalizedWebphoneSession.isReplied\n    ) {\n      return;\n    }\n    const { partyData } = normalizedWebphoneSession;\n    if (!partyData) return;\n    if (this.lastEndedSessionIds.indexOf(partyData.sessionId) === -1) {\n      this.lastEndedSessionIds = [partyData.sessionId]\n        .concat(this.lastEndedSessionIds)\n        .slice(0, 5);\n    }\n  }\n\n  _checkConnectivity() {\n    if (\n      this._deps.connectivityMonitor &&\n      this._deps.connectivityMonitor.ready &&\n      this._connectivity !== this._deps.connectivityMonitor.connectivity\n    ) {\n      this._connectivity = this._deps.connectivityMonitor.connectivity;\n      if (this._connectivity) {\n        this.fetchData();\n      }\n    }\n  }\n\n  async _checkTabActive() {\n    if (!this._deps.tabManager || !this._deps.storage || !this._enableCache) {\n      return;\n    }\n    if (this._tabActive !== this._deps.tabManager?.active) {\n      this._tabActive = this._deps.tabManager?.active;\n      if (this._deps.tabManager?.active && this._rcCall) {\n        await this._rcCall.restoreSessions(this.sessions);\n        this._rcCall.sessions.forEach((session: Session) => {\n          this._newSessionHandler(session);\n        });\n      }\n    }\n  }\n\n  _getTrackEventName(name: string) {\n    // TODO: refactor to remove `this.parentModule`.\n    const currentPath = this._deps.routerInteraction?.currentPath;\n    const showCallLog = this.parentModule.callLogSection?.show;\n    const showNotification = this.parentModule.callLogSection?.showNotification;\n    if (showNotification) {\n      return `${name}/Call notification page`;\n    }\n    if (showCallLog) {\n      return `${name}/Call log page`;\n    }\n    if (currentPath === '/calls') {\n      return `${name}/All calls page`;\n    }\n    if (currentPath.includes('/simplifycallctrl')) {\n      return `${name}/Small call control`;\n    }\n    return name;\n  }\n\n  @action\n  setCallControlBusyTimestamp() {\n    this.data.busyTimestamp = Date.now();\n  }\n\n  @action\n  clearCallControlBusyTimestamp() {\n    this.data.busyTimestamp = 0;\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.mute),\n  ])\n  @proxify\n  async mute(telephonySessionId: string) {\n    try {\n      this.setCallControlBusyTimestamp();\n      const session = this._rcCall.sessions.find(\n        (s: Session) => s.id === telephonySessionId,\n      );\n      await session.mute();\n      this.clearCallControlBusyTimestamp();\n    } catch (error) {\n      if (error.response && !error.response._text) {\n        error.response._text = await error.response.clone().text();\n      }\n      if (conflictError(error)) {\n        this._deps.alert.warning({\n          message: callControlError.muteConflictError,\n        });\n      } else if (\n        !(await this._deps.availabilityMonitor?.checkIfHAError(error))\n      ) {\n        this._deps.alert.warning({ message: callControlError.generalError });\n      }\n      this.clearCallControlBusyTimestamp();\n    }\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.unmute),\n  ])\n  @proxify\n  async unmute(telephonySessionId: string) {\n    try {\n      this.setCallControlBusyTimestamp();\n      const session = this._rcCall.sessions.find(\n        (s: Session) => s.id === telephonySessionId,\n      );\n      await session.unmute();\n      this.clearCallControlBusyTimestamp();\n    } catch (error) {\n      if (error.response && !error.response._text) {\n        error.response._text = await error.response.clone().text();\n      }\n      if (conflictError(error)) {\n        this._deps.alert.warning({\n          message: callControlError.unMuteConflictError,\n        });\n      } else if (\n        !(await this._deps.availabilityMonitor?.checkIfHAError(error))\n      ) {\n        this._deps.alert.warning({ message: callControlError.generalError });\n      }\n      this.clearCallControlBusyTimestamp();\n    }\n  }\n\n  async transferUnmuteHandler(telephonySessionId: string) {\n    try {\n      const session = this._rcCall.sessions.find(\n        (s: Session) => s.id === telephonySessionId,\n      );\n      if (session?.telephonySession?.party?.muted) {\n        await session.unmute();\n      }\n    } catch (error) {\n      // https://jira.ringcentral.com/browse/NTP-1308\n      // Unmute before transfer due to we can not sync the mute status after transfer.\n    }\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.record),\n  ])\n  @proxify\n  async startRecord(telephonySessionId: string) {\n    try {\n      this.setCallControlBusyTimestamp();\n      const session = this._rcCall.sessions.find(\n        (s: Session) => s.id === telephonySessionId,\n      );\n      const recordingId = this.getRecordingId(session);\n      await session.startRecord({ recordingId });\n      this.clearCallControlBusyTimestamp();\n      return true;\n    } catch (error) {\n      this.clearCallControlBusyTimestamp();\n      const { errors = [] } = (await error.response.clone().json()) || {};\n      if (errors.length) {\n        for (const error of errors) {\n          console.error('record fail:', error);\n        }\n        this._deps.alert.danger({\n          message: webphoneErrors.recordError,\n          payload: {\n            errorCode: errors[0].errorCode,\n          },\n        });\n      }\n    }\n  }\n\n  getRecordingId(session: Session) {\n    const recording = session.recordings[0];\n    const recodingId = recording && recording.id;\n    return recodingId;\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.stopRecord),\n  ])\n  @proxify\n  async stopRecord(telephonySessionId: string) {\n    try {\n      this.setCallControlBusyTimestamp();\n      const session = this._rcCall.sessions.find(\n        (s: Session) => s.id === telephonySessionId,\n      );\n      const recordingId = this.getRecordingId(session);\n      await session.stopRecord({ recordingId });\n      this.clearCallControlBusyTimestamp();\n    } catch (error) {\n      console.log('stop record error:', error);\n      this.clearCallControlBusyTimestamp();\n      throw error;\n    }\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.hangup),\n  ])\n  @proxify\n  async hangUp(telephonySessionId: string) {\n    try {\n      this.setCallControlBusyTimestamp();\n      const session = this._rcCall.sessions.find(\n        (s: Session) => s.id === telephonySessionId,\n      );\n      await session.hangup();\n      if (typeof this._onCallEndFunc === 'function') {\n        this._onCallEndFunc();\n      }\n      this.clearCallControlBusyTimestamp();\n    } catch (error) {\n      console.error('hangup error', error);\n      if (!(await this._deps.availabilityMonitor?.checkIfHAError(error))) {\n        this._deps.alert.warning({ message: callControlError.generalError });\n      }\n      this.clearCallControlBusyTimestamp();\n    }\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.voicemail),\n  ])\n  @proxify\n  async reject(telephonySessionId: string) {\n    try {\n      this.setCallControlBusyTimestamp();\n      const session = this._rcCall.sessions.find(\n        (s: Session) => s.id === telephonySessionId,\n      );\n      await session.toVoicemail();\n      if (session && session.webphoneSession) {\n        session.webphoneSession.__rc_isToVoicemail = true;\n      }\n      this.clearCallControlBusyTimestamp();\n    } catch (error) {\n      if (!(await this._deps.availabilityMonitor?.checkIfHAError(error))) {\n        this._deps.alert.warning({ message: callControlError.generalError });\n      }\n      this.clearCallControlBusyTimestamp();\n    }\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.confirmSwitch),\n  ])\n  @proxify\n  async switch(telephonySessionId: string) {\n    try {\n      this.setCallControlBusyTimestamp();\n      await this.transferUnmuteHandler(telephonySessionId);\n      const switchedSession = await this._rcCall.switchCall(\n        telephonySessionId,\n        {\n          homeCountryId: this._deps.regionSettings.homeCountryId,\n        },\n      );\n      this._triggerAutoMergeEvent(telephonySessionId);\n      await this._holdOtherCalls(telephonySessionId);\n      this.clearCallControlBusyTimestamp();\n      if (typeof this._onCallSwitchedFunc === 'function') {\n        this._onCallSwitchedFunc(switchedSession.sessionId);\n      }\n    } catch (error) {\n      if (!(await this._deps.availabilityMonitor?.checkIfHAError(error))) {\n        this._deps.alert.warning({ message: callControlError.generalError });\n      }\n      this.clearCallControlBusyTimestamp();\n    }\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.hold),\n  ])\n  @proxify\n  async hold(telephonySessionId: string) {\n    try {\n      this.setCallControlBusyTimestamp();\n      const session = this._rcCall.sessions.find(\n        (s: Session) => s.id === telephonySessionId,\n      );\n      const { webphoneSession, otherParties = [] } = session;\n      if (\n        // when call is connecting or in voicemail then call control's Hold API will not work\n        // so use webphone hold here\n        (session.direction === callDirection.outbound &&\n          (otherParties[0]?.status.code === PartyStatusCode.proceeding ||\n            otherParties[0]?.status.code === PartyStatusCode.voicemail)) ||\n        isAtMainNumberPromptToneStage(session)\n      ) {\n        await webphoneSession.hold();\n      } else {\n        await session.hold();\n      }\n      if (webphoneSession && webphoneSession.__rc_callStatus) {\n        webphoneSession.__rc_callStatus = sessionStatus.onHold;\n      }\n      this.clearCallControlBusyTimestamp();\n    } catch (error) {\n      if (error.response && !error.response._text) {\n        error.response._text = await error.response.clone().text();\n      }\n      if (conflictError(error)) {\n        this._deps.alert.warning({\n          message: callControlError.holdConflictError,\n        });\n      } else if (\n        !(await this._deps.availabilityMonitor?.checkIfHAError(error))\n      ) {\n        this._deps.alert.warning({ message: callControlError.generalError });\n      }\n      this.clearCallControlBusyTimestamp();\n    }\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.unhold),\n  ])\n  @proxify\n  async unhold(telephonySessionId: string) {\n    try {\n      this.setCallControlBusyTimestamp();\n      const session = this._rcCall.sessions.find(\n        (s: Session) => s.id === telephonySessionId,\n      );\n      await this._holdOtherCalls(telephonySessionId);\n      await session.unhold();\n      this._activeSession = session;\n      const { webphoneSession } = session;\n      if (webphoneSession && webphoneSession.__rc_callStatus) {\n        webphoneSession.__rc_callStatus = sessionStatus.connected;\n      }\n      this.setActiveSessionId(telephonySessionId);\n      this._addTrackToActiveSession();\n      this.clearCallControlBusyTimestamp();\n    } catch (error) {\n      if (error.response && !error.response._text) {\n        error.response._text = await error.response.clone().text();\n      }\n      if (conflictError(error)) {\n        this._deps.alert.warning({\n          message: callControlError.unHoldConflictError,\n        });\n      } else if (\n        !(await this._deps.availabilityMonitor?.checkIfHAError(error))\n      ) {\n        this._deps.alert.warning({\n          message: callControlError.generalError,\n        });\n      }\n      this.clearCallControlBusyTimestamp();\n    }\n  }\n\n  @track(trackEvents.transfer)\n  @proxify\n  async transfer(transferNumber: string, telephonySessionId: string) {\n    try {\n      this.setCallControlBusyTimestamp();\n      const session = this._rcCall.sessions.find(\n        (s: Session) => s.id === telephonySessionId,\n      );\n      const validatedResult = await this._deps.numberValidate.validateNumbers([\n        transferNumber,\n      ]);\n      if (!validatedResult.result) {\n        validatedResult.errors.forEach(async (error) => {\n          const isHAError: boolean =\n            await this._deps.availabilityMonitor?.checkIfHAError(error);\n          if (!isHAError) {\n            // TODO: fix `callErrors` type\n            this._deps.alert.warning({\n              message: (callErrors as any)[error.type],\n              payload: {\n                phoneNumber: error.phoneNumber,\n              },\n            });\n          }\n        });\n        return;\n      }\n      // TODO: fix `validatedResult` type in `numberValidate` module.\n      const validPhoneNumber =\n        (validatedResult as any).numbers[0] &&\n        (validatedResult as any).numbers[0].e164;\n      let phoneNumber = validPhoneNumber;\n      if (validPhoneNumber.indexOf('+') === -1) {\n        phoneNumber = [\n          this._deps.accountInfo.mainCompanyNumber,\n          validPhoneNumber,\n        ].join('*');\n      }\n      session.transfer(phoneNumber);\n      this.clearCallControlBusyTimestamp();\n    } catch (error) {\n      if (!(await this._deps.availabilityMonitor?.checkIfHAError(error))) {\n        this._deps.alert.warning({ message: callControlError.generalError });\n      }\n      this.clearCallControlBusyTimestamp();\n    }\n  }\n\n  // FIXME: Incomplete Implementation?\n  @proxify\n  async flip(flipValue: string, telephonySessionId: string) {\n    try {\n      this.setCallControlBusyTimestamp();\n      const session = this._rcCall.sessions.find((s: Session) => {\n        return s.id === telephonySessionId;\n      });\n      await session.flip({ callFlipId: flipValue });\n      this.clearCallControlBusyTimestamp();\n    } catch (error) {\n      console.error('flip error', error);\n      this.clearCallControlBusyTimestamp();\n      throw error;\n    }\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.confirmForward),\n  ])\n  @proxify\n  async forward(forwardNumber: string, telephonySessionId: string) {\n    const { regionSettings, brand } = this._deps;\n    const session = this._rcCall.sessions.find((s: Session) => {\n      return s.id === telephonySessionId;\n    });\n    if (!session) {\n      return false;\n    }\n    try {\n      let validatedResult;\n      let validPhoneNumber;\n      if (!this._permissionCheck) {\n        validatedResult = validateNumbers(\n          [forwardNumber],\n          regionSettings,\n          brand.id,\n        );\n        validPhoneNumber = validatedResult[0];\n      } else {\n        validatedResult = await this._deps.numberValidate.validateNumbers([\n          forwardNumber,\n        ]);\n        if (!validatedResult.result) {\n          validatedResult.errors.forEach((error) => {\n            this._deps.alert.warning({\n              message: (callErrors as any)[error.type],\n              payload: {\n                phoneNumber: error.phoneNumber,\n              },\n            });\n          });\n          return false;\n        }\n        validPhoneNumber =\n          (validatedResult as any).numbers[0] &&\n          (validatedResult as any).numbers[0].e164;\n      }\n      if (session && session.webphoneSession) {\n        session.webphoneSession.__rc_isForwarded = true;\n      }\n\n      await session.forward(validPhoneNumber, this.acceptOptions);\n      this._deps.alert.success({\n        message: callControlError.forwardSuccess,\n      });\n      if (typeof this._onCallEndFunc === 'function') {\n        this._onCallEndFunc();\n      }\n      return true;\n    } catch (e) {\n      console.error(e);\n      this._deps.alert.warning({\n        message: webphoneErrors.forwardError,\n      });\n      return false;\n    }\n  }\n\n  // DTMF handing by webphone session temporary, due to rc call session doesn't support currently\n  @proxify\n  async sendDTMF(dtmfValue: string, telephonySessionId: string) {\n    try {\n      const session = this._rcCall.sessions.find((s: Session) => {\n        return s.id === telephonySessionId;\n      });\n      // TODO: using rc call session\n      const { webphoneSession } = session;\n      if (webphoneSession) {\n        await webphoneSession.dtmf(dtmfValue, 100);\n      }\n    } catch (error) {\n      console.log('send dtmf error', error);\n      throw error;\n    }\n  }\n\n  _onWebphoneInvite(session: WebPhoneSession) {\n    const webphoneSession = session;\n    if (!webphoneSession) return;\n    if (!webphoneSession.__rc_creationTime) {\n      webphoneSession.__rc_creationTime = Date.now();\n    }\n    if (!webphoneSession.__rc_lastActiveTime) {\n      webphoneSession.__rc_lastActiveTime = Date.now();\n    }\n    webphoneSession.on('terminated', () => {\n      console.log('Call Event: terminated');\n      // this.setLastEndedSessionIds(webphoneSession);\n      const { telephonySessionId } =\n        this.rcCallSessions.find(\n          (s: Session) => s.webphoneSession === webphoneSession,\n        ) || {};\n      this._setActiveSessionIdFromOnHoldCalls(telephonySessionId);\n    });\n    webphoneSession.on('accepted', () => {\n      const { telephonySessionId } =\n        this.rcCallSessions.find(\n          (s: Session) => s.webphoneSession === webphoneSession,\n        ) || {};\n      if (this._autoMergeWebphoneSessionsMap.get(webphoneSession)) {\n        this._autoMergeWebphoneSessionsMap.delete(webphoneSession);\n      } else {\n        this.setActiveSessionId(telephonySessionId);\n        this._onCallAccepted(telephonySessionId);\n        this._holdOtherCalls(telephonySessionId);\n        this._addTrackToActiveSession();\n      }\n      this.updateActiveSessions();\n    });\n  }\n\n  @action\n  _setRingSessionId(sessionId: string) {\n    this.data.ringSessionId = sessionId;\n  }\n\n  /**\n   *if current call is terminated, then pick the first onhold call as active current call;\n   *\n   * @param {Session} session\n   * @memberof ActiveCallControl\n   */\n  _setActiveSessionIdFromOnHoldCalls(telephonySessionId: string) {\n    if (!telephonySessionId) return;\n    if (this.activeSessionId === telephonySessionId) {\n      const onHoldSessions: ActiveCallControlSessionData[] = sort(\n        (l, r) =>\n          sortByCreationTimeDesc(\n            normalizeWebphoneSession(l.webphoneSession),\n            normalizeWebphoneSession(r.webphoneSession),\n          ),\n        filter(\n          (s: ActiveCallControlSessionData) =>\n            isHolding(s) && !!s.webphoneSession,\n          this.sessions,\n        ),\n      );\n      if (onHoldSessions.length) {\n        this.setActiveSessionId(onHoldSessions[0].telephonySessionId);\n      }\n    }\n  }\n\n  @proxify\n  async _holdOtherCalls(telephonySessionId?: string) {\n    const otherSessions = filter((s: Session) => {\n      return (\n        s.telephonySessionId !== telephonySessionId &&\n        s.status === PartyStatusCode.answered &&\n        s.webphoneSession &&\n        !s.webphoneSession.localHold\n      );\n    }, this._rcCall.sessions);\n    if (!otherSessions.length) {\n      return;\n    }\n    const holdOtherSessions = otherSessions.map(async (session) => {\n      const { webphoneSession, otherParties = [] } = session;\n      try {\n        if (\n          // when call is connecting or in voicemail then call control's Hold API will not work\n          // so use webphone hold here\n          (session.direction === callDirection.outbound &&\n            (otherParties[0]?.status.code === PartyStatusCode.proceeding ||\n              otherParties[0]?.status.code === PartyStatusCode.voicemail)) ||\n          isAtMainNumberPromptToneStage(session)\n        ) {\n          await webphoneSession.hold();\n        } else {\n          await session.hold();\n        }\n        if (webphoneSession && webphoneSession.__rc_callStatus) {\n          webphoneSession.__rc_callStatus = sessionStatus.onHold;\n        }\n      } catch (error) {\n        console.log('Hold call fail.', error);\n      }\n    });\n    await Promise.all(holdOtherSessions);\n  }\n\n  @proxify\n  async _answer(telephonySessionId: string) {\n    this._triggerAutoMergeEvent(telephonySessionId);\n    this.setCallControlBusyTimestamp();\n    const session = this._rcCall.sessions.find((s: Session) => {\n      return s.id === telephonySessionId;\n    });\n    this._activeSession = session;\n    await this._holdOtherCalls(telephonySessionId);\n    const { webphoneSession } = session;\n    const deviceId = this._deps.webphone?.device?.id;\n    await session.answer({ deviceId });\n    this._trackWebRTCCallAnswer();\n    if (webphoneSession && webphoneSession.__rc_callStatus) {\n      webphoneSession.__rc_callStatus = sessionStatus.connected;\n    }\n    this.clearCallControlBusyTimestamp();\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.answer),\n  ])\n  @proxify\n  async answer(telephonySessionId: string) {\n    try {\n      await this._answer(telephonySessionId);\n    } catch (error) {\n      console.log('answer failed.');\n    }\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.holdAndAnswer),\n  ])\n  @proxify\n  async answerAndHold(telephonySessionId: string) {\n    // currently, the logic is same as answer\n    try {\n      await this._answer(telephonySessionId);\n    } catch (error) {\n      console.log('answer hold failed.', error);\n    }\n  }\n\n  /**\n   * ignore an incoming WebRTC call, after action executed, call will be ignored at current\n   * device and move to \"calls on other device\" section. This call still can be answered at other\n   * device\n   * @param {string} telephonySessionId\n   * @memberof ActiveCallControl\n   */\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.ignore),\n  ])\n  @proxify\n  async ignore(telephonySessionId: string) {\n    try {\n      this.setCallControlBusyTimestamp();\n      const session = this._rcCall.sessions.find((s: Session) => {\n        return s.id === telephonySessionId;\n      });\n      const { webphoneSession } = session;\n      await webphoneSession.reject();\n      // hack for update sessions, then incoming call log page can re-render\n      setTimeout(() => this.updateActiveSessions(), 0);\n      this.clearCallControlBusyTimestamp();\n    } catch (error) {\n      console.log('ignore failed.', error);\n    }\n  }\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.endAndAnswer),\n  ])\n  @proxify\n  async answerAndEnd(telephonySessionId: string) {\n    try {\n      if (this.busy) return;\n      this.setCallControlBusyTimestamp();\n      const session = this._rcCall.sessions.find((s: Session) => {\n        return s.id === telephonySessionId;\n      });\n      const currentActiveCall = this._rcCall.sessions.find(\n        (s: Session) =>\n          s.id !== telephonySessionId &&\n          s.webphoneSession &&\n          s.status === PartyStatusCode.answered,\n      );\n      if (currentActiveCall) {\n        await currentActiveCall.hangup();\n      }\n      const deviceId = this._deps.webphone?.device?.id;\n      await session.answer({ deviceId });\n      this._trackWebRTCCallAnswer();\n      const { webphoneSession } = session;\n      if (webphoneSession && webphoneSession.__rc_callStatus) {\n        webphoneSession.__rc_callStatus = sessionStatus.connected;\n      }\n      this.clearCallControlBusyTimestamp();\n    } catch (error) {\n      console.log('answer and end fail.');\n      console.error(error);\n    }\n  }\n\n  @proxify\n  async makeCall(params: ModuleMakeCallParams) {\n    try {\n      if (\n        params.toNumber.length > 6 &&\n        (!this._deps.availabilityMonitor ||\n          !this._deps.availabilityMonitor.isVoIPOnlyMode)\n      ) {\n        const phoneLines = await this._fetchDL();\n        if (phoneLines.length === 0) {\n          this._deps.alert.warning({\n            message: webphoneErrors.noOutboundCallWithoutDL,\n          });\n          return null;\n        }\n      }\n      await this._holdOtherCalls();\n      const sdkMakeCallParams: MakeCallParams = {\n        // type 'callControl' not support webphone's sip device currently.\n        type: 'webphone',\n        toNumber: params.toNumber,\n        fromNumber: params.fromNumber,\n        homeCountryId: params.homeCountryId,\n      };\n      const session = await this._rcCall.makeCall(sdkMakeCallParams);\n      this._activeSession = session;\n      session.webphoneSession.on('progress', () => {\n        if (\n          session.telephonySessionId &&\n          this.activeSessionId !== session.telephonySessionId\n        ) {\n          this.setActiveSessionId(session.telephonySessionId);\n        }\n      });\n      this._triggerAutoMergeEvent();\n      return session;\n    } catch (error) {\n      console.log('make call fail.', error);\n    }\n  }\n\n  async _fetchDL() {\n    const response = await this._deps.client\n      .account()\n      .extension()\n      .device()\n      .list();\n    const devices = response.records;\n    let phoneLines: any[] = [];\n    devices.forEach((device) => {\n      // wrong type of phoneLines, temporary treat it as any\n      if (!device.phoneLines || (device.phoneLines as any).length === 0) {\n        return;\n      }\n      phoneLines = phoneLines.concat(device.phoneLines);\n    });\n    return phoneLines;\n  }\n\n  getActiveSession(telephonySessionId: string) {\n    if (!telephonySessionId) {\n      return null;\n    }\n    return this.activeSessions[telephonySessionId];\n  }\n\n  getRcCallSession(telephoneSessionId: string) {\n    return this.rcCallSessions.find(\n      (session: Session) => session.telephonySessionId === telephoneSessionId,\n    );\n  }\n\n  @computed(({ activeSessionId, activeSessions }: ActiveCallControl) => [\n    activeSessionId,\n    activeSessions,\n  ])\n  get activeSession() {\n    return this.getActiveSession(this.activeSessionId);\n  }\n\n  @computed(({ ringSessionId, activeSessions }: ActiveCallControl) => [\n    ringSessionId,\n    activeSessions,\n  ])\n  get ringSession() {\n    return this.getActiveSession(this.ringSessionId);\n  }\n\n  @computed(({ sessions }: ActiveCallControl) => [sessions])\n  get ringSessions() {\n    if (!this.sessions) {\n      return [];\n    }\n    return this.sessions.filter((session: ActiveCallControlSessionData) =>\n      isRinging(session),\n    );\n  }\n\n  @computed((that: ActiveCallControl) => [that.sessions, that.timestamp])\n  get activeSessions() {\n    return this.sessions.reduce((accumulator, session) => {\n      const { id } = session;\n      accumulator[id] = normalizeSession({ session });\n      return accumulator;\n    }, {} as Record<string, ActiveSession>);\n  }\n\n  @computed((that: ActiveCallControl) => [that._deps.presence.calls])\n  get sessionIdToTelephonySessionIdMapping() {\n    return this._deps.presence.calls.reduce((accumulator, call) => {\n      const { telephonySessionId, sessionId } = call;\n      accumulator[sessionId] = telephonySessionId;\n      return accumulator;\n    }, {} as Record<string, string>);\n  }\n\n  /**\n   * Mitigation strategy for avoiding 404/409 on call control endpoints.\n   * This should gradually move towards per session controls rather than\n   * a global busy timeout.\n   */\n  get busy() {\n    return Date.now() - this.busyTimestamp < DEFAULT_BUSY_TIMEOUT;\n  }\n\n  // This should reflect on the app permissions setting in DWP\n  get hasPermission() {\n    return (\n      this._deps.auth.token.scope?.indexOf('CallControl') > -1 ||\n      this._deps.auth.token.scope?.indexOf('TelephonySession') > -1\n    );\n  }\n\n  get timeToRetry() {\n    return this._timeToRetry;\n  }\n\n  get ttl() {\n    return this._ttl;\n  }\n\n  get acceptOptions() {\n    return {\n      sessionDescriptionHandlerOptions: {\n        constraints: {\n          audio: {\n            deviceId: this._deps.audioSettings?.inputDeviceId,\n          },\n          video: false,\n        },\n      },\n    };\n  }\n\n  get hasCallInRecording() {\n    return this.sessions.some((session) => isRecording(session));\n  }\n\n  // TODO:refactor, use this.sessions instead\n  get rcCallSessions() {\n    return filter(\n      (session: Session) => filterDisconnectedCalls(session),\n      this._rcCall?.sessions || [],\n    );\n  }\n\n  get activeSessionId() {\n    return this.data.activeSessionId;\n  }\n\n  get busyTimestamp() {\n    return this.data.busyTimestamp;\n  }\n\n  get timestamp() {\n    return this.data.timestamp;\n  }\n\n  get sessions() {\n    return this.data.sessions;\n  }\n\n  get ringSessionId() {\n    return this.data.ringSessionId;\n  }\n\n  @track(trackEvents.inboundWebRTCCallConnected)\n  _trackWebRTCCallAnswer() {}\n\n  @track(trackEvents.dialpadOpen)\n  dialpadOpenTrack() {}\n\n  @track(trackEvents.dialpadClose)\n  dialpadCloseTrack() {}\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.clickTransfer),\n  ])\n  clickTransferTrack() {}\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.forward),\n  ])\n  clickForwardTrack() {}\n\n  @track((that: ActiveCallControl) => [\n    that._getTrackEventName(trackEvents.switch),\n  ])\n  clickSwitchTrack() {}\n}\n"],"file":"ActiveCallControl.js"}