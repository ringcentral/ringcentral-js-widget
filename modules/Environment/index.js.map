{"version":3,"sources":["modules/Environment/index.js"],"names":["Environment","deps","dep","client","globalStorage","defaultRecordingHost","sdkConfig","options","actionTypes","_client","_globalStorage","_sdkConfig","_reducer","_serverStorageKey","_recordingHostStoragekey","_enabledStorageKey","registerReducer","key","reducer","types","defaultServer","SDK","server","sandbox","store","subscribe","_onStateChange","_shouldInit","_initClientService","dispatch","type","initSuccess","ready","enabled","service","newConfig","recordingHost","environmentChanged","_changeEnvironment","setData","state","status","moduleStatuses","getItem","changeCounter","RcModule","proxify"],"mappings":"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","sourcesContent":["import SDK from 'ringcentral';\nimport RcModule from '../../lib/RcModule';\nimport { Module } from '../../lib/di';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport proxify from '../../lib/proxy/proxify';\nimport actionTypes from './actionTypes';\nimport getEnvironmentReducer, {\n  getServerReducer,\n  getRecordingHostReducer,\n  getEnabledReducer,\n} from './getEnvironmentReducer';\n\n/**\n * @class\n * @description Environment module manages which api server the app calls.\n */\n@Module({\n  deps: ['Client', 'GlobalStorage', { dep: 'EnvironmentOptions' }],\n})\nexport default class Environment extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {GlobalStorage} params.globalStorage - globalStorage module instance\n   * @param {String} params.defaultRecordingHost - default recording host uri\n   * @param {Object} params.sdkConfig - sdk config\n   */\n  constructor({\n    client,\n    globalStorage,\n    defaultRecordingHost,\n    sdkConfig,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._client = client;\n    this._globalStorage = globalStorage;\n    this._sdkConfig = sdkConfig;\n    this._reducer = getEnvironmentReducer(this.actionTypes);\n    this._serverStorageKey = 'environmentServer';\n    this._recordingHostStoragekey = 'environmentRecordingHost';\n    this._enabledStorageKey = 'environmentEnabled';\n    this._globalStorage.registerReducer({\n      key: this._serverStorageKey,\n      reducer: getServerReducer({\n        types: this.actionTypes,\n        defaultServer: SDK.server.sandbox,\n      }),\n    });\n    this._globalStorage.registerReducer({\n      key: this._recordingHostStoragekey,\n      reducer: getRecordingHostReducer({\n        types: this.actionTypes,\n        defaultRecordingHost:\n          defaultRecordingHost ||\n          'https://s3.ap-northeast-2.amazonaws.com/fetch-call-recording/test/index.html',\n      }),\n    });\n    this._globalStorage.registerReducer({\n      key: this._enabledStorageKey,\n      reducer: getEnabledReducer(this.actionTypes),\n    });\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _onStateChange() {\n    if (this._shouldInit()) {\n      this._initClientService();\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    }\n  }\n\n  _shouldInit() {\n    return this._globalStorage.ready && !this.ready;\n  }\n\n  _initClientService() {\n    if (this.enabled) {\n      this._client.service = new SDK({\n        ...this._sdkConfig,\n        server: this.server,\n      });\n    }\n  }\n\n  _changeEnvironment(enabled, server) {\n    const newConfig = {\n      ...this._sdkConfig,\n    };\n    if (enabled) {\n      newConfig.server = server;\n    }\n    this._client.service = new SDK(newConfig);\n  }\n\n  @proxify\n  async setData({ server, recordingHost, enabled }) {\n    const environmentChanged =\n      this.enabled !== enabled || (enabled && this.server !== server);\n    if (environmentChanged) {\n      // recordingHost changed no need to set to SDK\n      this._changeEnvironment(enabled, server);\n    }\n\n    this.store.dispatch({\n      type: this.actionTypes.setData,\n      server,\n      recordingHost,\n      enabled,\n      environmentChanged,\n    });\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get server() {\n    return this._globalStorage.getItem(this._serverStorageKey);\n  }\n\n  get recordingHost() {\n    return this._globalStorage.getItem(this._recordingHostStoragekey);\n  }\n\n  get enabled() {\n    return this._globalStorage.getItem(this._enabledStorageKey);\n  }\n\n  get changeCounter() {\n    return this.state.changeCounter;\n  }\n}\n"],"file":"index.js"}