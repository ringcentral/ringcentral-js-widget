{"version":3,"sources":["modules/CallV2/Call.ts"],"names":["TO_NUMBER","FROM_NUMBER","ANONYMOUS","Call","name","deps","dep","optional","enableCache","storageKey","_internationalCheck","_permissionCheck","_callSettingMode","_deps","callOptions","internationalCheck","permissionCheck","data","toNumberEntities","push","isConference","phoneNumber","recipient","callStatus","connecting","lastPhoneNumber","lastRecipient","idle","ready","_processCall","_initCallModule","_resetCallModule","cleanToNumberEntities","callingSettings","callingMode","callingModes","webphone","connect","disconnect","oldCallSettingMode","entityId","startTime","isIdle","toNumberMatched","input","fromNumber","session","extendedControls","toNumber","extension","trim","length","alert","warning","message","callErrors","noToNumber","_getValidatedNumbers","validatedNumbers","_getNumbers","_makeCall","connectSuccess","connectError","type","payload","ringoutErrors","firstLegConnectFailed","connectFailed","danger","networkError","availabilityMonitor","checkIfHAError","internalError","isWebphone","theFromNumber","myLocation","waitingValidateNumbers","number","parsedToNumber","parsedFromNumber","numbers","map","x","validatedResult","regionSettings","brand","id","toNumberIndex","findIndex","fromNumberIndex","numberValidate","validateNumbers","result","errors","forEach","error","international","rolesAndPermissions","permissions","InternationalCalls","originalString","parsedToNumberE164","e164","subAddress","join","parsedFromNumberE164","homeCountryId","softphone","jupiter","ringout","makeCall","split","prompt","ringoutPrompt","RcModuleV2","state","storage","action","proxify"],"mappings":"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","sourcesContent":["// TODO: fix `@ringcentral-integration/phone-number` type\n// @ts-ignore\nimport extractControls from '@ringcentral-integration/phone-number/lib/extractControls';\nimport {\n  RcModuleV2,\n  state,\n  storage,\n  action,\n} from '@ringcentral-integration/core';\nimport { Module } from '../../lib/di';\nimport callingModes from '../CallingSettings/callingModes';\nimport proxify from '../../lib/proxy/proxify';\nimport { Deps, ToNumberMatched, Recipient } from './Call.interface';\n\nimport { callStatus } from './callStatus';\nimport { callErrors } from './callErrors';\nimport { ringoutErrors } from '../Ringout/ringoutErrors';\nimport validateNumbers from '../../lib/validateNumbers';\n\nconst TO_NUMBER = 'toNumber';\nconst FROM_NUMBER = 'fromNumber';\nconst ANONYMOUS = 'anonymous';\n\n/**\n * @class\n * @description Call managing module\n */\n@Module({\n  name: 'Call',\n  deps: [\n    'Alert',\n    'Storage',\n    'Brand',\n    'Softphone',\n    'Ringout',\n    'NumberValidate',\n    'RegionSettings',\n    'CallingSettings',\n    'RolesAndPermissions',\n    { dep: 'Webphone', optional: true },\n    { dep: 'AvailabilityMonitor', optional: true },\n    { dep: 'CallOptions', optional: true },\n  ],\n})\nexport class Call extends RcModuleV2<Deps> {\n  _internationalCheck: boolean;\n  _permissionCheck: boolean;\n  _callSettingMode: string = null;\n\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Brand} params.brand - brand module instance\n   * @param {Alert} params.alert - alert module instance\n   * @param {Client} params.client - client module instance\n   * @param {Storage} params.storage - storage module instance\n   * @param {CallingSettings} params.callingSettings - callingSettings module instance\n   * @param {Softphone} params.softphone - softphone module instance\n   * @param {Ringout} params.ringout - ringout module instance\n   * @param {Webphone} params.webphone - webphone module instance\n   * @param {NumberValidate} params.numberValidate - numberValidate module instance\n   * @param {RegionSettings} params.regionSettings - regionSettings module instance\n   */\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'callData',\n    });\n    this._internationalCheck =\n      this._deps.callOptions?.internationalCheck ?? true;\n    this._permissionCheck = this._deps.callOptions?.permissionCheck ?? true;\n  }\n\n  @state\n  callStatus = callStatus.idle;\n\n  @state\n  toNumberEntities: ToNumberMatched[] = [];\n\n  @storage\n  @state\n  lastPhoneNumber: string = null;\n\n  @storage\n  @state\n  lastRecipient: Recipient = null;\n\n  @action\n  toNumberMatched(data: ToNumberMatched) {\n    this.toNumberEntities.push(data);\n  }\n\n  @action\n  cleanToNumberEntities() {\n    this.toNumberEntities = [];\n  }\n\n  @action\n  connect({\n    isConference,\n    phoneNumber = null,\n    recipient = null,\n  }: {\n    isConference: boolean;\n    phoneNumber: string;\n    recipient: Recipient;\n  }) {\n    this.callStatus = callStatus.connecting;\n    if (!isConference) {\n      this.lastPhoneNumber = phoneNumber;\n      this.lastRecipient = recipient;\n    }\n  }\n\n  @action\n  connectSuccess() {\n    this.callStatus = callStatus.idle;\n  }\n\n  @action\n  connectError() {\n    this.callStatus = callStatus.idle;\n  }\n\n  async onStateChange() {\n    if (this.ready) {\n      await this._processCall();\n    }\n  }\n\n  onInit() {\n    this._initCallModule();\n  }\n\n  onReset() {\n    this._resetCallModule();\n    this.cleanToNumberEntities();\n  }\n\n  async _initCallModule() {\n    this._callSettingMode = this._deps.callingSettings.callingMode;\n    if (\n      this._callSettingMode === callingModes.webphone &&\n      this._deps.webphone\n    ) {\n      await this._deps.webphone.connect();\n    }\n  }\n\n  _resetCallModule() {\n    this._callSettingMode = this._deps.callingSettings.callingMode;\n    if (\n      this._callSettingMode === callingModes.webphone &&\n      this._deps.webphone\n    ) {\n      this._deps.webphone.disconnect();\n    }\n  }\n\n  async _processCall() {\n    const oldCallSettingMode = this._callSettingMode;\n    if (\n      this._deps.callingSettings.callingMode !== oldCallSettingMode &&\n      this._deps.webphone\n    ) {\n      this._callSettingMode = this._deps.callingSettings.callingMode;\n      if (oldCallSettingMode === callingModes.webphone) {\n        this._deps.webphone.disconnect();\n      } else if (this._callSettingMode === callingModes.webphone) {\n        await this._deps.webphone.connect();\n      }\n    }\n  }\n\n  // save the click to dial entity, only when call took place\n  onToNumberMatch({ entityId, startTime }: ToNumberMatched) {\n    if (this.isIdle) {\n      this.toNumberMatched({ entityId, startTime });\n    }\n  }\n\n  @proxify\n  async call({\n    phoneNumber: input,\n    recipient,\n    fromNumber,\n    isConference = false,\n  }: {\n    phoneNumber: string;\n    recipient: Recipient;\n    fromNumber: string;\n    isConference?: boolean;\n  }) {\n    let session = null;\n    if (this.isIdle) {\n      const { phoneNumber, extendedControls } = extractControls(input);\n      const toNumber =\n        (recipient && (recipient.phoneNumber || recipient.extension)) ||\n        phoneNumber;\n      if (!toNumber || `${toNumber}`.trim().length === 0) {\n        this._deps.alert.warning({\n          message: callErrors.noToNumber,\n        });\n      } else {\n        this.connect({\n          isConference,\n          phoneNumber,\n          recipient,\n        });\n        // TODO: callSettingMode: this._callSettingMode, // for Track\n        try {\n          let validatedNumbers;\n          if (this._permissionCheck) {\n            validatedNumbers = await this._getValidatedNumbers({\n              toNumber,\n              fromNumber,\n              isConference,\n            });\n          } else {\n            validatedNumbers = this._getNumbers({\n              toNumber,\n              fromNumber,\n              isConference,\n            });\n          }\n          if (validatedNumbers) {\n            session = await this._makeCall({\n              ...validatedNumbers,\n              extendedControls,\n            });\n            this.connectSuccess();\n            // TODO: callSettingMode: this._callSettingMode, // for Track\n          } else {\n            this.connectError();\n          }\n        } catch (error) {\n          if (!error.message && error.type && (callErrors as any)[error.type]) {\n            // validate format error\n            this._deps.alert.warning({\n              message: (callErrors as any)[error.type],\n              payload: {\n                phoneNumber: error.phoneNumber,\n              },\n            });\n          } else if (error.message === ringoutErrors.firstLegConnectFailed) {\n            this._deps.alert.warning({\n              message: callErrors.connectFailed,\n              payload: error,\n            });\n          } else if (error.message === 'Failed to fetch') {\n            this._deps.alert.danger({\n              message: callErrors.networkError,\n              payload: error,\n            });\n          } else if (error.message !== 'Refresh token has expired') {\n            if (\n              !this._deps.availabilityMonitor ||\n              !this._deps.availabilityMonitor.checkIfHAError(error)\n            ) {\n              this._deps.alert.danger({\n                message: callErrors.internalError,\n                payload: error,\n              });\n            }\n          }\n          this.connectError();\n          throw error;\n        }\n      }\n    }\n    return session;\n  }\n\n  @proxify\n  _getNumbers({\n    toNumber,\n    fromNumber,\n    isConference,\n  }: {\n    toNumber: string;\n    fromNumber: string;\n    isConference: boolean;\n  }) {\n    const isWebphone =\n      this._deps.callingSettings.callingMode === callingModes.webphone;\n    const theFromNumber =\n      fromNumber ||\n      (isWebphone\n        ? this._deps.callingSettings.fromNumber\n        : this._deps.callingSettings.myLocation);\n\n    if (isWebphone && (theFromNumber === null || theFromNumber === '')) {\n      return null;\n    }\n\n    const waitingValidateNumbers = [];\n\n    if (!isConference) {\n      waitingValidateNumbers.push({\n        type: TO_NUMBER,\n        number: toNumber,\n      });\n    }\n\n    if (\n      theFromNumber &&\n      theFromNumber.length > 0 &&\n      !(isWebphone && theFromNumber === ANONYMOUS)\n    ) {\n      waitingValidateNumbers.push({\n        type: FROM_NUMBER,\n        number: theFromNumber,\n      });\n    }\n\n    let parsedToNumber;\n    let parsedFromNumber;\n\n    if (waitingValidateNumbers.length) {\n      const numbers = waitingValidateNumbers.map((x) => x.number);\n      const validatedResult = validateNumbers(\n        numbers,\n        this._deps.regionSettings,\n        this._deps.brand.id,\n      );\n      const toNumberIndex = waitingValidateNumbers.findIndex(\n        (x) => x.type === TO_NUMBER,\n      );\n      const fromNumberIndex = waitingValidateNumbers.findIndex(\n        (x) => x.type === FROM_NUMBER,\n      );\n      parsedToNumber = validatedResult[toNumberIndex];\n      parsedFromNumber = validatedResult[fromNumberIndex];\n    }\n    if (isWebphone && theFromNumber === ANONYMOUS) {\n      parsedFromNumber = ANONYMOUS;\n    }\n    return {\n      toNumber: parsedToNumber || toNumber,\n      fromNumber: parsedFromNumber,\n    };\n  }\n\n  @proxify\n  async _getValidatedNumbers({\n    toNumber,\n    fromNumber,\n    isConference,\n  }: {\n    toNumber: string;\n    fromNumber: string;\n    isConference: boolean;\n  }) {\n    const isWebphone =\n      this._deps.callingSettings.callingMode === callingModes.webphone;\n    const theFromNumber =\n      fromNumber ||\n      (isWebphone\n        ? this._deps.callingSettings.fromNumber\n        : this._deps.callingSettings.myLocation);\n\n    if (isWebphone && (theFromNumber === null || theFromNumber === '')) {\n      return null;\n    }\n\n    const waitingValidateNumbers = [];\n\n    if (!isConference) {\n      waitingValidateNumbers.push({\n        type: TO_NUMBER,\n        number: toNumber,\n      });\n    }\n\n    if (\n      theFromNumber &&\n      theFromNumber.length > 0 &&\n      !(isWebphone && theFromNumber === ANONYMOUS)\n    ) {\n      waitingValidateNumbers.push({\n        type: FROM_NUMBER,\n        number: theFromNumber,\n      });\n    }\n\n    let parsedToNumber;\n    let parsedFromNumber;\n    if (waitingValidateNumbers.length) {\n      const numbers = waitingValidateNumbers.map((x) => x.number);\n      const validatedResult = await this._deps.numberValidate.validateNumbers(\n        numbers,\n      );\n      if (!validatedResult.result) {\n        validatedResult.errors.forEach((error) => {\n          // this._deps.alert.warning({\n          //   message: callErrors[error.type],\n          //   payload: {\n          //     phoneNumber: error.phoneNumber\n          //   }\n          // });\n          throw error;\n        });\n        return null;\n      }\n      const toNumberIndex = waitingValidateNumbers.findIndex(\n        (x) => x.type === TO_NUMBER,\n      );\n      const fromNumberIndex = waitingValidateNumbers.findIndex(\n        (x) => x.type === FROM_NUMBER,\n      );\n      // TODO: fix `validatedResult` type in `numberValidate` module.\n      parsedToNumber = (validatedResult as any).numbers[toNumberIndex];\n      parsedFromNumber = (validatedResult as any).numbers[fromNumberIndex];\n    }\n    if (this._internationalCheck) {\n      if (\n        parsedToNumber &&\n        parsedToNumber.international &&\n        // TODO: fix `rolesAndPermissions` module type\n        !(this._deps.rolesAndPermissions.permissions as any).InternationalCalls\n      ) {\n        const error = {\n          phoneNumber: parsedToNumber.originalString,\n          type: 'noInternational',\n        };\n        throw error;\n      }\n    }\n\n    let parsedToNumberE164 = toNumber;\n    if (parsedToNumber) {\n      parsedToNumberE164 = parsedToNumber.e164;\n      // add ext back if any\n      if (parsedToNumber.e164 && parsedToNumber.subAddress) {\n        parsedToNumberE164 = [\n          parsedToNumber.e164,\n          parsedToNumber.subAddress,\n        ].join('*');\n      }\n    }\n\n    // using e164 in response to call\n    let parsedFromNumberE164;\n    if (parsedFromNumber) {\n      parsedFromNumberE164 = parsedFromNumber.e164;\n      // add ext back if any\n      if (parsedFromNumber.e164 && parsedFromNumber.subAddress) {\n        parsedFromNumberE164 = [\n          parsedFromNumber.e164,\n          parsedFromNumber.subAddress,\n        ].join('*');\n      }\n    }\n    if (isWebphone && theFromNumber === ANONYMOUS) {\n      parsedFromNumberE164 = ANONYMOUS;\n    }\n    return {\n      toNumber: parsedToNumberE164,\n      fromNumber: parsedFromNumberE164,\n    };\n  }\n\n  @proxify\n  async _makeCall({\n    toNumber,\n    fromNumber,\n    callingMode = this._deps.callingSettings.callingMode,\n    extendedControls = [],\n  }: {\n    toNumber: string;\n    fromNumber: string;\n    callingMode?: string;\n    extendedControls?: string[];\n  }) {\n    const homeCountryId = this._deps.regionSettings.homeCountryId;\n    let session;\n    switch (callingMode) {\n      case callingModes.softphone:\n      case callingModes.jupiter:\n        session = this._deps.softphone.makeCall(toNumber, callingMode);\n        break;\n      case callingModes.ringout:\n        session = await this._deps.ringout.makeCall({\n          fromNumber,\n          toNumber: toNumber && toNumber.split('*')[0], // remove extension number in ringout mode\n          prompt: this._deps.callingSettings.ringoutPrompt,\n        });\n        break;\n      case callingModes.webphone:\n        if (this._deps.webphone) {\n          // TODO: fix `webphone` module type\n          session = (await this._deps.webphone.makeCall({\n            fromNumber,\n            toNumber,\n            homeCountryId,\n            extendedControls,\n          })) as any;\n        }\n        break;\n      default:\n        break;\n    }\n    return session;\n  }\n\n  get isIdle() {\n    return this.callStatus === callStatus.idle;\n  }\n}\n"],"file":"Call.js"}