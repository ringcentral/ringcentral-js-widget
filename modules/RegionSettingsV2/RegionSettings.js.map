{"version":3,"sources":["modules/RegionSettingsV2/RegionSettings.ts"],"names":["RegionSettings","name","deps","dep","optional","that","_deps","dialingPlan","plans","extensionInfo","country","availableCountries","enableCache","storageKey","storage","migrationMapping","countryCode","areaCode","data","ready","tabManager","active","checkRegionSettings","alert","warning","allowDuplicates","message","regionSettingsMessages","dialingPlansChanged","ttl","plan","isoCode","brand","id","_alertSettingsChanged","_setData","danger","areaCodeInvalid","trim","info","saveSuccess","setData","length","homeCountry","find","homeCountryId","RcModuleV2","state","action","proxify"],"mappings":"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","sourcesContent":["import { find } from 'ramda';\nimport {\n  action,\n  RcModuleV2,\n  state,\n  storage,\n  watch,\n  computed,\n} from '@ringcentral-integration/core';\nimport { Module } from '../../lib/di';\nimport { regionSettingsMessages } from './regionSettingsMessages';\nimport validateAreaCode from '../../lib/validateAreaCode';\nimport proxify from '../../lib/proxy/proxify';\nimport { Deps, RegionSettingsData } from './RegionSettings.interface';\n\n@Module({\n  name: 'RegionSettings',\n  deps: [\n    'Brand',\n    'Alert',\n    'DialingPlan',\n    'ExtensionInfo',\n    'Storage',\n    { dep: 'TabManager', optional: true },\n    { dep: 'RegionSettingsOptions', optional: true },\n  ],\n})\nexport class RegionSettings extends RcModuleV2<Deps> {\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'RegionSettings',\n    });\n    /* migration storage v1 to v2 */\n    if (this._deps.storage) {\n      this._deps.storage.migrationMapping =\n        this._deps.storage.migrationMapping ?? {};\n      this._deps.storage.migrationMapping['RegionSettings-data'] = {\n        countryCode: 'regionSettingsCountryCode',\n        areaCode: 'regionSettingsAreaCode',\n      };\n    }\n    /* migration storage v1 to v2 */\n  }\n\n  @storage\n  @state\n  data = {\n    countryCode: 'US',\n    areaCode: '',\n  };\n\n  get countryCode() {\n    return this.data.countryCode || 'US';\n  }\n\n  get areaCode() {\n    return this.data.areaCode || '';\n  }\n\n  @action\n  _setData({\n    countryCode = this.data.countryCode,\n    areaCode = this.data.areaCode,\n  }: RegionSettingsData) {\n    this.data.countryCode = countryCode;\n    this.data.areaCode = areaCode;\n  }\n\n  onInitOnce() {\n    watch(\n      this,\n      () => this.availableCountries,\n      () => {\n        if (\n          this.ready &&\n          (!this._deps.tabManager || this._deps.tabManager.active)\n        ) {\n          this.checkRegionSettings();\n        }\n      },\n    );\n  }\n\n  @computed<RegionSettings>((that) => [\n    that._deps.dialingPlan.plans,\n    that._deps.extensionInfo.country,\n  ])\n  get availableCountries() {\n    const plans = this._deps.dialingPlan.plans;\n    const country = this._deps.extensionInfo.country;\n    if (plans && plans.length > 0) {\n      return plans;\n    }\n    return country ? [country] : [];\n  }\n\n  _alertSettingsChanged() {\n    this._deps.alert.warning({\n      allowDuplicates: false,\n      message: regionSettingsMessages.dialingPlansChanged,\n      ttl: 0,\n    });\n  }\n\n  @proxify\n  async checkRegionSettings() {\n    let { countryCode } = this;\n    if (\n      countryCode &&\n      !find((plan) => plan.isoCode === countryCode, this.availableCountries)\n    ) {\n      countryCode = null;\n      if (this._deps.brand.id === '1210') {\n        this._alertSettingsChanged();\n      }\n    }\n    if (!countryCode) {\n      const country =\n        find(\n          (plan) => plan.isoCode === this._deps.extensionInfo.country.isoCode,\n          this.availableCountries,\n        ) || this.availableCountries[0];\n      countryCode = country && country.isoCode;\n      this._setData({\n        countryCode,\n        areaCode: '',\n      });\n    }\n  }\n\n  @proxify\n  async setData({ areaCode, countryCode }: RegionSettingsData) {\n    if (!validateAreaCode(areaCode)) {\n      this._deps.alert.danger({\n        message: regionSettingsMessages.areaCodeInvalid,\n      });\n      return;\n    }\n    this._setData({\n      countryCode,\n      areaCode: areaCode && areaCode.trim(),\n    });\n    this._deps.alert.info({\n      message: regionSettingsMessages.saveSuccess,\n    });\n  }\n\n  setCountryCode(countryCode: RegionSettingsData['countryCode']) {\n    this.setData({\n      countryCode,\n    });\n  }\n\n  setAreaCode(areaCode: RegionSettingsData['areaCode']) {\n    this.setData({\n      areaCode,\n    });\n  }\n\n  @computed<RegionSettings>(({ availableCountries }) => [availableCountries])\n  get showReginSetting() {\n    if (this.availableCountries.length > 1) {\n      return true;\n    }\n    if (\n      this.availableCountries.length === 1 &&\n      (this.availableCountries[0].isoCode === 'US' ||\n        this.availableCountries[0].isoCode === 'CA')\n    ) {\n      return true;\n    }\n    return false;\n  }\n\n  @computed<RegionSettings>(({ availableCountries }) => [availableCountries])\n  get homeCountryId() {\n    const homeCountry = this.availableCountries.find(\n      (country) => country.isoCode === this.countryCode,\n    );\n    const homeCountryId = (homeCountry && homeCountry.id) || '1';\n    return homeCountryId;\n  }\n}\n"],"file":"RegionSettings.js"}