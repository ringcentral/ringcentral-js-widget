{"version":3,"sources":["modules/Ringout/index.js"],"names":["DEFAULT_MONITOR_INTERVAL","DEFAULT_TIME_BETWEEN_CALLS","Ringout","deps","dep","optional","auth","client","contactMatcher","monitorInterval","timeBetweenCalls","options","actionTypes","_auth","_client","_contactMatcher","_reducer","_monitorInterval","_timeBetweenCalls","store","subscribe","loggedIn","ready","dispatch","type","initSuccess","resetSuccess","fromNumber","toNumber","prompt","status","moduleStatuses","startToConnect","account","extension","ringOut","post","from","phoneNumber","to","playPrompt","resp","forceMatchBatchNumbers","phoneNumbers","startTime","Date","now","_monitorRingout","id","connectSuccess","connectError","message","ringoutErrors","pollingCancelled","ringoutId","_fetchRingoutStatus","callerStatus","Error","firstLegConnectFailed","get","error","apiResponse","_response","callStatus","exception","pollingFailed","state","ringoutStatus","RcModule","proxify"],"mappings":"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","sourcesContent":["import sleep from '../../lib/sleep';\nimport { Module } from '../../lib/di';\nimport proxify from '../../lib/proxy/proxify';\nimport RcModule from '../../lib/RcModule';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport actionTypes from './actionTypes';\nimport getRingoutReducer from './getRingoutReducer';\nimport ringoutErrors from './ringoutErrors';\n\nconst DEFAULT_MONITOR_INTERVAL = 2500;\nconst DEFAULT_TIME_BETWEEN_CALLS = 10000;\n\n/**\n * @class\n * @description Ringout managing module\n */\n@Module({\n  deps: [\n    'Auth',\n    'Client',\n    { dep: 'ContactMatcher', optional: true },\n    { dep: 'RingoutOptions', optional: true },\n  ],\n})\nexport default class Ringout extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {Auth} params.auth - auth module instance\n   * @param {Number} params.monitorInterval - monitor interval, default 2500\n   * @param {Number} params.timeBetweenCalls - time between calls, default 10000\n   * @param {MontactMatcher} param.contactMatcher - contactMatcher module instance, optional\n   */\n  constructor({\n    auth,\n    client,\n    contactMatcher,\n    monitorInterval = DEFAULT_MONITOR_INTERVAL,\n    timeBetweenCalls = DEFAULT_TIME_BETWEEN_CALLS,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._auth = auth;\n    this._client = client;\n    this._contactMatcher = contactMatcher;\n    this._reducer = getRingoutReducer(this.actionTypes);\n    this._monitorInterval = monitorInterval;\n    this._timeBetweenCalls = timeBetweenCalls;\n  }\n\n  initialize() {\n    this.store.subscribe(() => {\n      if (this._auth.loggedIn && !this.ready) {\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n        });\n      } else if (!this._auth.loggedIn && this.ready) {\n        this.store.dispatch({\n          type: this.actionTypes.resetSuccess,\n        });\n      }\n    });\n  }\n\n  @proxify\n  async makeCall({ fromNumber, toNumber, prompt }) {\n    if (this.status === moduleStatuses.ready) {\n      this.store.dispatch({\n        type: this.actionTypes.startToConnect,\n      });\n      try {\n        const resp = await this._client\n          .account()\n          .extension()\n          .ringOut()\n          .post({\n            from: { phoneNumber: fromNumber },\n            to: { phoneNumber: toNumber },\n            playPrompt: prompt,\n          });\n\n        if (this._contactMatcher) {\n          await this._contactMatcher.forceMatchBatchNumbers({\n            phoneNumbers: [fromNumber, toNumber],\n          });\n        }\n\n        const startTime = Date.now();\n        await this._monitorRingout(resp.id, startTime);\n\n        this.store.dispatch({\n          type: this.actionTypes.connectSuccess,\n        });\n      } catch (e) {\n        this.store.dispatch({\n          type: this.actionTypes.connectError,\n        });\n        if (e.message !== ringoutErrors.pollingCancelled) {\n          throw e;\n        }\n      }\n    } else {\n      // TODO: Need to dispatch a generic error action\n    }\n  }\n\n  @proxify\n  async _monitorRingout(ringoutId, startTime) {\n    let callerStatus = await this._fetchRingoutStatus(ringoutId);\n    while (callerStatus === 'InProgress') {\n      if (Date.now() - startTime > this._timeBetweenCalls) {\n        throw new Error(ringoutErrors.pollingCancelled);\n      }\n      await sleep(this._monitorInterval);\n      callerStatus = await this._fetchRingoutStatus(ringoutId);\n    }\n    if (callerStatus !== 'Success' && callerStatus !== 'NoAnswer') {\n      throw new Error(ringoutErrors.firstLegConnectFailed);\n    }\n  }\n\n  @proxify\n  async _fetchRingoutStatus(ringoutId) {\n    try {\n      let callStatus;\n      const resp = await this._client\n        .account()\n        .extension()\n        .ringOut(ringoutId)\n        .get()\n        .catch((error) => {\n          if (\n            error &&\n            error.apiResponse &&\n            error.apiResponse._response &&\n            error.apiResponse._response.status === 404\n          ) {\n            callStatus = 'Success';\n          }\n        });\n      return callStatus || resp.status.callerStatus;\n    } catch (e) {\n      const exception = new Error(ringoutErrors.pollingFailed);\n      exception.error = e;\n      throw exception;\n    }\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ringoutStatus() {\n    return this.state.ringoutStatus;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n}\n"],"file":"index.js"}