{"version":3,"sources":["modules/PresenceV2/Presence.ts"],"names":["DEFAULT_TTL","DEFAULT_POLLING_INTERVAL","DEFAULT_FETCH_DELAY","DEFAULT_MAX_FETCH_DELAY","presenceRegExp","detailedPresenceRegExp","Presence","name","deps","dep","optional","data","activeCalls","calls","_debouncedFetchData","_stopWatchingConnectivity","_stopWatchingSubscription","presenceOptions","ttl","pollingInterval","_source","DataSource","key","cleanOnReset","fetchFunction","_deps","client","service","platform","get","_endPoint","response","json","dndStatus","meetingStatus","presenceStatus","telephonyStatus","userStatus","_processRawActiveCalls","totalActiveCalls","Date","now","lastDndStatus","_lastDndStatus","sequence","_sequence","readyCheckFunction","auth","ready","loggedIn","subscription","rolesAndPermissions","connectivityMonitor","dataFetcherV2","permissionCheckFunction","_checkPermission","register","fn","fetchData","threshold","_fetchDelay","maxThreshold","_maxFetchDelay","hasPresencePermission","timestamp","length","activeCall","existingCall","find","call","sessionId","normalizedCall","startTime","offset","Math","min","message","regExp","_detailed","disableCache","tabManager","active","test","event","body","_updateData","_calculateLastDndStatus","activeCallsLength","subscribe","connectivity","_handleConnectivity","_handleSubscription","cancel","newDndStatus","doNotAcceptAnyCalls","params","hasEditPresencePermission","ownerId","put","updateData","takeAllCalls","doNotAcceptDepartmentCalls","available","_getUpdateStatusParams","_update","busy","offline","presenceData","setAvailable","setBusy","setDoNotDisturb","setInvisible","subscriptionFilters","detailedPresence","presence","detailed","max","fetchDelay","maxFetchDelay","DataFetcherV2Consumer","proxify"],"mappings":"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","sourcesContent":["import {\n  DetailedExtensionPresenceEvent,\n  GetPresenceInfo,\n  PresenceInfoResponse,\n} from '@rc-ex/core/definitions';\nimport { computed, watch } from '@ringcentral-integration/core';\nimport { ObjectMapValue } from '@ringcentral-integration/core/lib/ObjectMap';\nimport { filter, map } from 'ramda';\nimport { Unsubscribe } from 'redux';\n\nimport { presenceStatus } from '../../enums/presenceStatus.enum';\nimport { subscriptionFilters } from '../../enums/subscriptionFilters';\nimport {\n  isEnded,\n  normalizeFromTo,\n  normalizeStartTime,\n  removeInboundRingOutLegs,\n} from '../../lib/callLogHelpers';\nimport { debounce, DebouncedFunction } from '../../lib/debounce-throttle';\nimport { Module } from '../../lib/di';\nimport proxify from '../../lib/proxy/proxify';\nimport { DataFetcherV2Consumer, DataSource } from '../DataFetcherV2';\nimport { dndStatus } from '../Presence/dndStatus';\nimport { removeIntermediateCall } from '../Presence/getPresenceReducer';\nimport {\n  Deps,\n  PresenceInfoModel,\n  UpdatePresenceParams,\n} from './Presence.interface';\n\nexport const DEFAULT_TTL = 62 * 1000;\nexport const DEFAULT_POLLING_INTERVAL = 3 * 60 * 1000;\nexport const DEFAULT_FETCH_DELAY = 2 * 1000;\nexport const DEFAULT_MAX_FETCH_DELAY = 4 * 1000;\n\nexport const presenceRegExp = /.*\\/presence(\\?.*)?/;\nexport const detailedPresenceRegExp = /.*\\/presence\\?detailedTelephonyState=true&sipData=true/;\n\n@Module({\n  name: 'Presence',\n  deps: [\n    'Auth',\n    'Client',\n    'ConnectivityMonitor',\n    'DataFetcherV2',\n    'RolesAndPermissions',\n    'Subscription',\n    { dep: 'TabManager', optional: true },\n    { dep: 'PresenceOptions', optional: true },\n  ],\n})\nexport class Presence extends DataFetcherV2Consumer<Deps, PresenceInfoModel> {\n  protected _debouncedFetchData: DebouncedFunction<Presence['fetchData']>;\n\n  protected _stopWatchingConnectivity: Unsubscribe = null;\n  protected _stopWatchingSubscription: Unsubscribe = null;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n    });\n    const presenceOptions = deps.presenceOptions ?? {};\n    const {\n      ttl = DEFAULT_TTL,\n      pollingInterval = DEFAULT_POLLING_INTERVAL,\n    } = presenceOptions;\n    this._source = new DataSource({\n      ...presenceOptions,\n      key: 'presence',\n      cleanOnReset: true,\n      ttl,\n      pollingInterval,\n      fetchFunction: async (): Promise<PresenceInfoModel> => {\n        const response = await this._deps.client.service\n          .platform()\n          .get(this._endPoint);\n        const data = await response.json();\n        const {\n          dndStatus = this.dndStatus,\n          meetingStatus = this.meetingStatus,\n          presenceStatus = this.presenceStatus,\n          telephonyStatus = this.telephonyStatus,\n          userStatus = this.userStatus,\n        } = data;\n        const activeCalls = this._processRawActiveCalls(\n          data.activeCalls,\n          data.totalActiveCalls,\n          Date.now(),\n        );\n        return {\n          lastDndStatus: this._lastDndStatus,\n          sequence: this._sequence,\n          activeCalls,\n          dndStatus,\n          meetingStatus,\n          presenceStatus,\n          telephonyStatus,\n          userStatus,\n        };\n      },\n      readyCheckFunction: () =>\n        this._deps.auth.ready &&\n        this._deps.auth.loggedIn &&\n        this._deps.subscription.ready &&\n        this._deps.rolesAndPermissions.ready &&\n        this._deps.connectivityMonitor.ready &&\n        this._deps.dataFetcherV2.ready,\n      permissionCheckFunction: () => this._checkPermission(),\n    });\n    this._deps.dataFetcherV2.register(this._source);\n    this._debouncedFetchData = debounce({\n      fn: this.fetchData,\n      threshold: this._fetchDelay,\n      maxThreshold: this._maxFetchDelay,\n    });\n  }\n\n  get _endPoint() {\n    return this._detailed\n      ? subscriptionFilters.detailedPresence\n      : subscriptionFilters.presence;\n  }\n\n  get _detailed() {\n    return !!(this._deps.presenceOptions?.detailed ?? true);\n  }\n\n  get _fetchDelay() {\n    return Math.max(\n      0,\n      this._deps.presenceOptions?.fetchDelay ?? DEFAULT_FETCH_DELAY,\n    );\n  }\n\n  get _maxFetchDelay() {\n    return Math.max(\n      this._fetchDelay,\n      this._deps.presenceOptions?.maxFetchDelay ?? DEFAULT_MAX_FETCH_DELAY,\n    );\n  }\n\n  protected _checkPermission() {\n    return this._deps.rolesAndPermissions.hasPresencePermission;\n  }\n\n  _processRawActiveCalls(\n    activeCalls: GetPresenceInfo['activeCalls'] = [],\n    totalActiveCalls: number = 0,\n    timestamp: number,\n  ) {\n    if (activeCalls.length < totalActiveCalls) {\n      return this.activeCalls;\n    }\n    return map((activeCall) => {\n      const existingCall = this.activeCalls.find(\n        (call) => call.sessionId === activeCall.sessionId,\n      );\n      if (!existingCall) {\n        const normalizedCall = normalizeStartTime(normalizeFromTo(activeCall));\n        const startTime = normalizedCall.startTime || timestamp;\n        const offset = Math.min(timestamp - startTime, 0);\n        return {\n          ...normalizedCall,\n          startTime,\n          offset,\n        };\n      }\n      return {\n        ...existingCall,\n        ...normalizeStartTime(normalizeFromTo(activeCall)),\n      };\n    }, removeIntermediateCall([], activeCalls));\n  }\n\n  protected _handleSubscription(message: DetailedExtensionPresenceEvent) {\n    const regExp = this._detailed ? detailedPresenceRegExp : presenceRegExp;\n    if (\n      this.ready &&\n      (this._source.disableCache || (this._deps.tabManager?.active ?? true)) &&\n      regExp.test(message.event) &&\n      message.body\n    ) {\n      if (message.body.sequence && message.body.sequence < this._sequence) {\n        return;\n      }\n      const timestamp = Date.now();\n      const {\n        sequence = this._sequence,\n        dndStatus = this.dndStatus,\n        meetingStatus = this.meetingStatus,\n        presenceStatus = this.presenceStatus,\n        telephonyStatus = this.telephonyStatus,\n        userStatus = this.userStatus,\n      } = message.body;\n      const activeCalls = this._processRawActiveCalls(\n        message.body.activeCalls,\n        message.body.totalActiveCalls,\n        timestamp,\n      );\n      this._updateData(\n        {\n          sequence,\n          activeCalls,\n          dndStatus,\n          meetingStatus,\n          presenceStatus,\n          telephonyStatus,\n          userStatus,\n          lastDndStatus: this._calculateLastDndStatus(dndStatus),\n        },\n        timestamp,\n      );\n      /**\n       * as pointed out by Igor in https://jira.ringcentral.com/browse/PLA-33391,\n       * when the real calls count larger than the active calls returned by the pubnub,\n       * we need to pulling the calls manually.\n       */\n      const activeCallsLength = message.body.activeCalls?.length ?? 0;\n      const totalActiveCalls = message.body.totalActiveCalls ?? 0;\n      if (this._detailed && activeCallsLength < totalActiveCalls) {\n        this._debouncedFetchData();\n      }\n    }\n  }\n\n  onInit() {\n    this._deps.subscription.subscribe([this._endPoint]);\n    this._stopWatchingConnectivity = watch(\n      this,\n      () => this._deps.connectivityMonitor.connectivity,\n      (connectivity) => this._handleConnectivity(connectivity),\n    );\n    this._stopWatchingSubscription = watch(\n      this,\n      () => this._deps.subscription.message,\n      (message) => this._handleSubscription(message),\n    );\n  }\n\n  protected _handleConnectivity(connectivity: boolean) {\n    if (\n      this.ready &&\n      (this._source.disableCache || (this._deps.tabManager?.active ?? true)) &&\n      connectivity &&\n      this._checkPermission()\n    ) {\n      this.fetchData();\n    }\n  }\n\n  onReset() {\n    this._stopWatchingConnectivity?.();\n    this._stopWatchingConnectivity = null;\n    this._stopWatchingSubscription?.();\n    this._stopWatchingSubscription = null;\n    this._debouncedFetchData.cancel();\n  }\n\n  get _lastDndStatus() {\n    return this.data?.lastDndStatus ?? null;\n  }\n\n  get _sequence() {\n    return this.data?.sequence ?? 0;\n  }\n\n  @computed<Presence>(({ data }) => [data])\n  get activeCalls() {\n    return this.data?.activeCalls ?? [];\n  }\n\n  @computed<Presence>(({ activeCalls }) => [activeCalls])\n  get calls() {\n    return filter(\n      (call) => !isEnded(call),\n      removeInboundRingOutLegs(this.activeCalls),\n    );\n  }\n\n  _calculateLastDndStatus(\n    newDndStatus: ObjectMapValue<typeof dndStatus>,\n  ): ObjectMapValue<typeof dndStatus> {\n    return newDndStatus !== this.dndStatus &&\n      newDndStatus !== dndStatus.doNotAcceptAnyCalls\n      ? newDndStatus\n      : this._lastDndStatus;\n  }\n\n  @proxify\n  async _update(params: UpdatePresenceParams) {\n    if (!this._deps.rolesAndPermissions.hasEditPresencePermission) {\n      return;\n    }\n    const ownerId = this._deps.auth.ownerId;\n    const response = await this._deps.client.service\n      .platform()\n      .put('/restapi/v1.0/account/~/extension/~/presence', params);\n    const data: PresenceInfoResponse = await response.json();\n\n    if (ownerId === this._deps.auth.ownerId) {\n      const newDndStatus = ((data.dndStatus !== 'Unknown' && data.dndStatus) ??\n        this.data.dndStatus) as ObjectMapValue<typeof dndStatus>;\n      this._updateData({\n        presenceStatus: data.presenceStatus,\n        userStatus: data.userStatus,\n        telephonyStatus: data.telephonyStatus,\n        dndStatus: newDndStatus,\n        meetingStatus: data.meetingStatus,\n        lastDndStatus: this._calculateLastDndStatus(newDndStatus),\n      });\n    }\n  }\n\n  @proxify\n  _updateData(data: PresenceInfoModel, timestamp = Date.now()) {\n    this._deps.dataFetcherV2.updateData(\n      this._source,\n      {\n        ...this.data,\n        ...data,\n      },\n      timestamp,\n    );\n  }\n\n  _getUpdateStatusParams(userStatus: GetPresenceInfo['userStatus']) {\n    const params: UpdatePresenceParams = {\n      dndStatus: this.dndStatus,\n      userStatus,\n    };\n    if (\n      params.dndStatus !== dndStatus.takeAllCalls &&\n      params.dndStatus !== dndStatus.doNotAcceptDepartmentCalls\n    ) {\n      params.dndStatus = this._lastDndStatus ?? dndStatus.takeAllCalls;\n    }\n    return params;\n  }\n\n  async setAvailable() {\n    if (\n      this.userStatus === presenceStatus.available &&\n      this.dndStatus !== dndStatus.doNotAcceptAnyCalls\n    ) {\n      return;\n    }\n    const params = this._getUpdateStatusParams(presenceStatus.available);\n    await this._update(params);\n  }\n\n  async setBusy() {\n    if (\n      this.userStatus === presenceStatus.busy &&\n      this.dndStatus !== dndStatus.doNotAcceptAnyCalls\n    ) {\n      return;\n    }\n    const params = this._getUpdateStatusParams(presenceStatus.busy);\n    await this._update(params);\n  }\n\n  async setDoNotDisturb() {\n    if (this.dndStatus === dndStatus.doNotAcceptAnyCalls) {\n      return;\n    }\n    const params = {\n      dndStatus: dndStatus.doNotAcceptAnyCalls,\n    };\n    await this._update(params);\n  }\n\n  async setInvisible() {\n    if (\n      this.userStatus === presenceStatus.offline &&\n      this.dndStatus !== dndStatus.doNotAcceptAnyCalls\n    ) {\n      return;\n    }\n    const params = this._getUpdateStatusParams(presenceStatus.offline);\n    await this._update(params);\n  }\n\n  async setPresence(\n    presenceData:\n      | ObjectMapValue<typeof presenceStatus>\n      | ObjectMapValue<typeof dndStatus>,\n  ) {\n    switch (presenceData) {\n      case presenceStatus.available:\n        await this.setAvailable();\n        break;\n      case presenceStatus.busy:\n        await this.setBusy();\n        break;\n      case dndStatus.doNotAcceptAnyCalls:\n        await this.setDoNotDisturb();\n        break;\n      case presenceStatus.offline:\n        await this.setInvisible();\n        break;\n      default:\n        await this.setAvailable();\n        break;\n    }\n  }\n\n  async toggleAcceptCallQueueCalls() {\n    const params: UpdatePresenceParams = {\n      userStatus: this.userStatus,\n    };\n    if (this.dndStatus === dndStatus.takeAllCalls) {\n      params.dndStatus = dndStatus.doNotAcceptDepartmentCalls;\n    } else if (this.dndStatus === dndStatus.doNotAcceptDepartmentCalls) {\n      params.dndStatus = dndStatus.takeAllCalls;\n    }\n    if (params.dndStatus) {\n      await this._update(params);\n    }\n  }\n\n  @computed<Presence>(({ calls }) => [calls])\n  get sessionIdList() {\n    return map((call) => call.sessionId, this.calls);\n  }\n\n  get telephonyStatus() {\n    return this.data?.telephonyStatus ?? null;\n  }\n\n  get dndStatus() {\n    return this.data?.dndStatus ?? null;\n  }\n\n  get userStatus() {\n    return this.data?.userStatus ?? null;\n  }\n\n  get presenceStatus() {\n    return this.data?.presenceStatus ?? null;\n  }\n\n  get meetingStatus() {\n    return this.data?.meetingStatus ?? null;\n  }\n\n  get presenceOption() {\n    // doNotDisturb\n    if (this.dndStatus === dndStatus.doNotAcceptAnyCalls) {\n      return dndStatus.doNotAcceptAnyCalls;\n    }\n\n    // busy\n    if (this.userStatus === presenceStatus.busy) {\n      return presenceStatus.busy;\n    }\n\n    // invisible\n    if (this.userStatus === presenceStatus.offline) {\n      return presenceStatus.offline;\n    }\n\n    // available\n    return presenceStatus.available;\n  }\n\n  async fetchData() {\n    this._debouncedFetchData.cancel();\n    return this._deps.dataFetcherV2.fetchData(this._source);\n  }\n}\n"],"file":"Presence.js"}