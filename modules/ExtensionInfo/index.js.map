{"version":3,"sources":["modules/ExtensionInfo/index.js"],"names":["DEFAULT_MASK","join","DEFAULT_COUNTRY","id","isoCode","callingCode","extensionRegExp","extractData","info","serviceFeatures","forEach","f","featureName","enabled","reason","output","DEFAULT_TTL","DEFAULT_TIME_TO_RETRY","ExtensionInfo","deps","dep","optional","client","ttl","timeToRetry","polling","alert","extensionInfoOptions","options","subscriptionFilters","extensionInfo","subscriptionHandler","message","_subscriptionHandleFn","cleanOnReset","fetchFunction","_client","account","extension","get","forbiddenHandler","_auth","logout","_alert","danger","permissionsMessages","insufficientPrivilege","_extensionInfoOptions","body","test","event","hints","includes","subscriptionHints","companyNumbers","limits","features","permissions","videoConfiguration","fetchData","isMultipleSiteEnabled","extensionNumber","regionalSettings","homeCountry","departments","Array","isArray","length","DataFetcher","selector","data","isEnabled","site","console","warn"],"mappings":"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","sourcesContent":["import mask from 'json-mask';\nimport { path } from 'ramda';\nimport { Module } from '../../lib/di';\nimport { selector } from '../../lib/selector';\nimport DataFetcher from '../../lib/DataFetcher';\nimport subscriptionHints from '../../enums/subscriptionHints';\nimport subscriptionFilters from '../../enums/subscriptionFilters';\nimport permissionsMessages from '../RolesAndPermissions/permissionsMessages';\n\nconst DEFAULT_MASK = [\n  'id',\n  'extensionNumber',\n  'contact(*)',\n  'name',\n  'type',\n  'status',\n  'permissions',\n  'profileImage',\n  'departments',\n  'site',\n  `regionalSettings(${[\n    'timezone(id,name,bias)',\n    'homeCountry(id,isoCode,callingCode)',\n    'language(localeCode)',\n    'formattingLocale(localeCode)',\n    'timeFormat',\n  ].join(',')})`,\n].join(',');\n\nconst DEFAULT_COUNTRY = {\n  id: '1',\n  isoCode: 'US',\n  callingCode: '1',\n};\n\nconst extensionRegExp = /.*\\/extension\\/\\d+$/;\n\nfunction extractData(info) {\n  const serviceFeatures = {};\n  info.serviceFeatures.forEach((f) => {\n    serviceFeatures[f.featureName] = {\n      enabled: f.enabled,\n    };\n    if (!f.enabled) {\n      serviceFeatures[f.featureName].reason = f.reason;\n    }\n  });\n  const output = mask(info, DEFAULT_MASK);\n  output.serviceFeatures = serviceFeatures;\n  return output;\n}\n\nconst DEFAULT_TTL = 30 * 60 * 1000; // half hour update\nconst DEFAULT_TIME_TO_RETRY = 62 * 1000;\n\n/**\n * @class\n * @description Extension info module\n */\n@Module({\n  deps: [\n    'Client',\n    { dep: 'Alert', optional: true },\n    { dep: 'ExtensionInfoOptions', optional: true },\n  ],\n})\nexport default class ExtensionInfo extends DataFetcher {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {ExtensionInfoOptions} params.isMultipleSiteEnable - extension info options: Is multiple site enabled\n   */\n  constructor({\n    client,\n    ttl = DEFAULT_TTL,\n    timeToRetry = DEFAULT_TIME_TO_RETRY,\n    polling = true,\n    alert,\n    extensionInfoOptions,\n    ...options\n  }) {\n    super({\n      client,\n      ttl,\n      polling,\n      timeToRetry,\n      subscriptionFilters: [subscriptionFilters.extensionInfo],\n      subscriptionHandler: async (message) => {\n        await this._subscriptionHandleFn(message);\n      },\n      cleanOnReset: true,\n      fetchFunction: async () =>\n        extractData(\n          await this._client\n            .account()\n            .extension()\n            .get(),\n        ),\n      forbiddenHandler: async () => {\n        await this._auth.logout();\n        if (this._alert) {\n          this._alert.danger({\n            message: permissionsMessages.insufficientPrivilege,\n            ttl: 0,\n          });\n        }\n        return {};\n      },\n      ...options,\n    });\n    this._alert = alert;\n    this._extensionInfoOptions = extensionInfoOptions;\n  }\n\n  get _name() {\n    return 'extensionInfo';\n  }\n\n  get isMultipleSiteEnabled() {\n    return this._extensionInfoOptions?.isMultipleSiteEnabled ?? false;\n  }\n\n  async _subscriptionHandleFn(message) {\n    if (\n      message &&\n      message.body &&\n      extensionRegExp.test(message.event) &&\n      !(\n        message.body.hints &&\n        (message.body.hints.includes(subscriptionHints.companyNumbers) ||\n          message.body.hints.includes(subscriptionHints.limits) ||\n          message.body.hints.includes(subscriptionHints.features) ||\n          message.body.hints.includes(subscriptionHints.permissions) ||\n          message.body.hints.includes(subscriptionHints.videoConfiguration))\n      )\n    ) {\n      await this.fetchData();\n    }\n  }\n\n  @selector\n  info = [() => this.data, (data) => data || {}];\n\n  @selector\n  serviceFeatures = [() => this.info, (info) => info.serviceFeatures || {}];\n\n  get id() {\n    return this.info.id;\n  }\n\n  get extensionNumber() {\n    return this.info.extensionNumber;\n  }\n\n  get country() {\n    return (\n      (this.info.regionalSettings && this.info.regionalSettings.homeCountry) ||\n      DEFAULT_COUNTRY\n    );\n  }\n\n  get departments() {\n    return this.info.departments;\n  }\n\n  @selector\n  site = [\n    () => this.info,\n    (info) => {\n      if (!this.isMultipleSiteEnabled) {\n        return null;\n      }\n      const isEnabled = path(['SiteCodes', 'enabled'], this.serviceFeatures);\n      if (!isEnabled) {\n        return null;\n      }\n      if (!info.site) {\n        console.warn('site code enabled, but cannot retrieve site info');\n      }\n      return info.site || null;\n    },\n  ];\n\n  get isCallQueueMember() {\n    return (\n      !!this.departments &&\n      Array.isArray(this.departments) &&\n      this.departments.length > 0\n    );\n  }\n}\n"],"file":"index.js"}