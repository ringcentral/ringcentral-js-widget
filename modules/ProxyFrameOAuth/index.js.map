{"version":3,"sources":["modules/ProxyFrameOAuth/index.js"],"names":["DEFAULT_PROXY_RETRY","ProxyFrameOAuth","name","deps","dep","optional","loginPath","redirectUri","proxyUri","defaultProxyRetry","routerInteraction","options","_callbackHandler","origin","data","callbackUri","proxyLoaded","_handleCallbackUri","clearTimeout","_retryTimeoutId","store","dispatch","type","actionTypes","setupOAuth","_createProxyFrame","_proxyFrame","document","createElement","src","style","display","isEdge","window","navigator","userAgent","indexOf","isIE","test","setAttribute","join","body","appendChild","addEventListener","setTimeout","_retrySetupProxyFrame","_defaultProxyRetry","_uuid","uuid","v4","_proxyUri","_routerInteraction","_loginPath","_reducer","_loggedIn","ready","_auth","loggedIn","currentPath","oAuthReady","destroyOAuth","isImplicit","_createImplicitRefreshTimeout","_clearImplicitRefreshIframe","_implicitRefreshTimeoutId","refresh","proxyRetry","_destroyProxyFrame","removeChild","removeEventListener","setupProxy","contentWindow","postMessage","oAuthUri","_implicitRefreshFrame","implictRefreshOAuthUri","_implictitRefreshCallBack","refreshCallbackUri","authData","token","refreshTokenExpiresIn","expiresIn","expireTime","refreshTokenTimeoutTime","parseInt","Date","now","_tabManager","active","_createImplicitRefreshIframe","url","resolve","location","href","encodeURIComponent","btoa","prefix","state","proxyRetryCount","OAuthBase","background","proxify"],"mappings":"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","sourcesContent":["import background from 'ringcentral-integration/lib/background';\nimport proxify from 'ringcentral-integration/lib/proxy/proxify';\nimport { Module } from 'ringcentral-integration/lib/di';\nimport ensureExist from 'ringcentral-integration/lib/ensureExist';\nimport url from 'url';\nimport * as uuid from 'uuid';\nimport actionTypes from './actionTypes';\nimport getProxyFrameOAuthReducer from './getProxyFrameOAuthReducer';\n\nimport OAuthBase from '../../lib/OAuthBase';\n\nconst DEFAULT_PROXY_RETRY = 5000;\n\n@Module({\n  name: 'OAuth',\n  deps: ['RouterInteraction', { dep: 'OAuthOptions', optional: true }],\n})\nexport default class ProxyFrameOAuth extends OAuthBase {\n  constructor({\n    loginPath = '/',\n    redirectUri = './redirect.html',\n    proxyUri = './proxy.html',\n    defaultProxyRetry = DEFAULT_PROXY_RETRY,\n    routerInteraction,\n    ...options\n  }) {\n    super({\n      redirectUri,\n      ...options,\n    });\n    this._uuid = uuid.v4();\n    this._proxyUri = ensureExist(proxyUri, 'proxyUri');\n    this._routerInteraction = ensureExist(\n      routerInteraction,\n      'routerInteraction',\n    );\n    this._defaultProxyRetry = defaultProxyRetry;\n    this._loginPath = loginPath;\n\n    this._reducer = getProxyFrameOAuthReducer(this.actionTypes);\n\n    this._loggedIn = false;\n  }\n\n  _onStateChange() {\n    super._onStateChange();\n    if (\n      this.ready &&\n      !this._auth.loggedIn &&\n      this._routerInteraction.currentPath === this._loginPath &&\n      !this.oAuthReady &&\n      !this._proxyFrame\n    ) {\n      this.setupOAuth();\n    }\n    if (\n      this._proxyFrame &&\n      (this._auth.loggedIn ||\n        this._routerInteraction.currentPath !== this._loginPath)\n    ) {\n      this.destroyOAuth();\n    }\n    if (this._auth.loggedIn === this._loggedIn) {\n      return;\n    }\n    this._loggedIn = this._auth.loggedIn;\n    if (this._loggedIn && this._auth.isImplicit) {\n      this._createImplicitRefreshTimeout();\n    }\n    if (!this._loggedIn && this._auth.isImplicit) {\n      this._clearImplicitRefreshIframe();\n      if (this._implicitRefreshTimeoutId) {\n        clearTimeout(this._implicitRefreshTimeoutId);\n      }\n    }\n  }\n\n  async _handleCallbackUri(callbackUri, refresh) {\n    await super._handleCallbackUri(callbackUri, refresh);\n    if (this._auth.isImplicit && this._auth.loggedIn) {\n      this._createImplicitRefreshTimeout();\n    }\n  }\n\n  get name() {\n    return 'proxyFrameOAuth';\n  }\n\n  get _actionTypes() {\n    return actionTypes;\n  }\n\n  get proxyUri() {\n    return `${url.resolve(\n      window.location.href,\n      this._proxyUri,\n    )}?hash=${encodeURIComponent(btoa(this._uuid))}&prefix=${encodeURIComponent(\n      this.prefix,\n    )}`;\n  }\n\n  get proxyRetryCount() {\n    return this.state.proxyRetryCount;\n  }\n\n  _callbackHandler = async ({ origin, data }) => {\n    // TODO origin check\n    if (data) {\n      const { callbackUri, proxyLoaded } = data;\n      if (callbackUri) {\n        this._handleCallbackUri(callbackUri);\n      } else if (proxyLoaded) {\n        clearTimeout(this._retryTimeoutId);\n        this._retryTimeoutId = null;\n        this.store.dispatch({\n          type: this.actionTypes.setupOAuth,\n        });\n      }\n    }\n  };\n\n  _createProxyFrame = () => {\n    this._proxyFrame = document.createElement('iframe');\n    this._proxyFrame.src = this.proxyUri;\n    this._proxyFrame.style.display = 'none';\n    const isEdge =\n      window &&\n      window.navigator &&\n      window.navigator.userAgent.indexOf('Edge') > -1;\n    const isIE =\n      window &&\n      window.navigator &&\n      /MSIE|Trident/i.test(window.navigator.userAgent);\n    if (!isEdge && !isIE) {\n      this._proxyFrame.setAttribute(\n        'sandbox',\n        [\n          'allow-scripts',\n          'allow-popups',\n          'allow-same-origin',\n          'allow-forms',\n        ].join(' '),\n      );\n    }\n    document.body.appendChild(this._proxyFrame);\n    window.addEventListener('message', this._callbackHandler);\n    this._retryTimeoutId = setTimeout(() => {\n      this._retrySetupProxyFrame();\n    }, this._defaultProxyRetry);\n  };\n\n  _retrySetupProxyFrame() {\n    this._retryTimeoutId = null;\n    if (!this.oAuthReady) {\n      this.store.dispatch({\n        type: this.actionTypes.proxyRetry,\n      });\n      this._destroyProxyFrame();\n      this._createProxyFrame();\n    }\n  }\n\n  _destroyProxyFrame() {\n    document.body.removeChild(this._proxyFrame);\n    this._proxyFrame = null;\n    window.removeEventListener('message', this._callbackHandler);\n  }\n\n  @background\n  async setupOAuth() {\n    if (!this._proxyFrame) {\n      this._createProxyFrame();\n      this.store.dispatch({\n        type: this.actionTypes.setupProxy,\n      });\n    }\n  }\n\n  @background\n  async destroyOAuth() {\n    if (this._proxyFrame) {\n      if (this._retryTimeoutId) {\n        clearTimeout(this._retryTimeoutId);\n        this._retryTimeoutId = null;\n      }\n      this._destroyProxyFrame();\n      this.store.dispatch({\n        type: this.actionTypes.destroyOAuth,\n      });\n    }\n  }\n\n  @proxify\n  openOAuthPage() {\n    if (this.oAuthReady) {\n      this._proxyFrame.contentWindow.postMessage(\n        {\n          oAuthUri: this.oAuthUri,\n        },\n        '*',\n      );\n    }\n  }\n\n  _createImplicitRefreshIframe() {\n    this._clearImplicitRefreshIframe();\n    this._implicitRefreshFrame = document.createElement('iframe');\n    this._implicitRefreshFrame.src = this.implictRefreshOAuthUri;\n    this._implicitRefreshFrame.style.display = 'none';\n    document.body.appendChild(this._implicitRefreshFrame);\n    // eslint-disable-next-line\n    this._implictitRefreshCallBack = ({ origin, data }) => {\n      const { refreshCallbackUri } = data;\n      if (refreshCallbackUri && this._auth.loggedIn) {\n        this._handleCallbackUri(refreshCallbackUri, true);\n        this._clearImplicitRefreshIframe();\n      }\n    };\n    window.addEventListener('message', this._implictitRefreshCallBack);\n  }\n\n  _clearImplicitRefreshIframe() {\n    if (this._implicitRefreshFrame) {\n      document.body.removeChild(this._implicitRefreshFrame);\n      this._implicitRefreshFrame = null;\n      window.removeEventListener('message', this._implictitRefreshCallBack);\n      this._callbackHandler = null;\n    }\n  }\n\n  // create a time out to refresh implicit flow token\n  _createImplicitRefreshTimeout() {\n    if (this._implicitRefreshTimeoutId) {\n      clearTimeout(this._implicitRefreshTimeoutId);\n    }\n    const authData = this._auth.token;\n    const refreshTokenExpiresIn = authData.expiresIn;\n    const { expireTime } = authData;\n    if (!refreshTokenExpiresIn || !expireTime) {\n      return;\n    }\n    // set refresh time to (token exposre time) / 3\n    let refreshTokenTimeoutTime =\n      (parseInt(refreshTokenExpiresIn, 10) * 1000) / 3;\n    if (refreshTokenTimeoutTime + Date.now() > expireTime) {\n      refreshTokenTimeoutTime = expireTime - Date.now() - 5000;\n      if (refreshTokenTimeoutTime < 0) {\n        return;\n      }\n    }\n    this._implicitRefreshTimeoutId = setTimeout(() => {\n      if (!this._auth.loggedIn) {\n        return;\n      }\n      if (this._tabManager && !this._tabManager.active) {\n        this._createImplicitRefreshTimeout();\n        return;\n      }\n      this._createImplicitRefreshIframe();\n      this._implicitRefreshTimeoutId = null;\n    }, refreshTokenTimeoutTime);\n  }\n}\n"],"file":"index.js"}