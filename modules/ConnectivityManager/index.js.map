{"version":3,"sources":["modules/ConnectivityManager/index.js"],"names":["ConnectivityManager","deps","dep","optional","auth","oAuth","alert","callingSettings","audioSettings","webphone","connectivityMonitor","availabilityMonitor","options","actionTypes","_auth","_oAuth","_callingSettings","_audioSettings","_webphone","_availabilityMonitor","_alert","ensureExist","_connectivityMonitor","_reducer","showConnectivityAlert","checkWebphoneAndConnect","_oldConnectivityType","_shouldInit","store","dispatch","type","initSuccess","ready","connectivityType","subscribe","_onStateChange","pending","isWebphoneMode","showAlert","getUserMedia","connect","force","skipConnectDelay","healthCheck","message","danger","allowDuplicates","alertIds","messages","filter","m","connectivityTypes","map","id","length","dismiss","webphoneUnavailable","_hideAlerts","_showAlert","state","status","moduleStatuses","loggedIn","userMedia","connected","disconnected","connecting","connectFailed","reconnecting","connectError","inactive","proxyRetryCount","isVoIPOnlyMode","isLimitedMode","hasLimitedStatusError","mode","offline","voipOnly","RcModule","proxify","selector","networkLoss","connectivity","isVoIPOnlyModeActivated","isLimitedModeActivated","webphoneAvailable","serverUnavailable","survival"],"mappings":"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","sourcesContent":["import RcModule from 'ringcentral-integration/lib/RcModule';\nimport { Module } from 'ringcentral-integration/lib/di';\nimport ensureExist from 'ringcentral-integration/lib/ensureExist';\nimport { selector } from 'ringcentral-integration/lib/selector';\nimport proxify from 'ringcentral-integration/lib/proxy/proxify';\nimport moduleStatuses from 'ringcentral-integration/enums/moduleStatuses';\nimport actionTypes from './actionTypes';\nimport getConnectivityMangerReducer from './getConnectivityMangerReducer';\nimport connectivityTypes from './connectivityTypes';\n\n/**\n * @class\n * @description Connectivity monitor module\n */\n@Module({\n  deps: [\n    'Alert',\n    'OAuth',\n    'Auth',\n    'ConnectivityMonitor',\n    { dep: 'AvailabilityMonitor', optional: true },\n    { dep: 'CallingSettings', optional: true },\n    { dep: 'AudioSettings', optional: true },\n    { dep: 'Webphone', optional: true },\n  ],\n})\nexport default class ConnectivityManager extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Alert} params.alert - alert module instance\n   * @param {Client} params.client - client module instance\n   * @param {Environment} params.environment - environment module instance\n   * @param {Number} params.timeToRetry - time to Retry\n   * @param {Number} params.heartBeatInterval - heart beat interval\n   * @param {Function} params.checkConnectionFunc - function to check network\n   */\n  constructor({\n    auth,\n    oAuth,\n    alert,\n    callingSettings,\n    audioSettings,\n    webphone,\n    connectivityMonitor,\n    availabilityMonitor,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._auth = auth;\n    this._oAuth = oAuth;\n    this._callingSettings = callingSettings;\n    this._audioSettings = audioSettings;\n    this._webphone = webphone;\n    this._availabilityMonitor = availabilityMonitor;\n    this._alert = this::ensureExist(alert, 'alert');\n    this._connectivityMonitor = this::ensureExist(\n      connectivityMonitor,\n      'connectivityMonitor',\n    );\n    this._reducer = getConnectivityMangerReducer(this.actionTypes);\n    this.showConnectivityAlert = this::this.showConnectivityAlert;\n    this.checkWebphoneAndConnect = this::this.checkWebphoneAndConnect;\n    this._oldConnectivityType = '';\n  }\n\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (\n      this.ready &&\n      this.connectivityType !== this._oldConnectivityType\n    ) {\n      this._oldConnectivityType = this.connectivityType;\n      this.showConnectivityAlert();\n    }\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _shouldInit() {\n    return (\n      (!this._callingSettings || this._callingSettings.ready) &&\n      (!this._audioSettings || this._audioSettings.ready) &&\n      (!this._webphone || this._webphone.ready) &&\n      (!this._availabilityMonitor || this._availabilityMonitor.ready) &&\n      this.pending\n    );\n  }\n\n  @proxify\n  checkWebphoneAndConnect() {\n    if (\n      !this._callingSettings ||\n      !this._callingSettings.ready ||\n      !this._callingSettings.isWebphoneMode\n    ) {\n      return;\n    }\n    if (this._audioSettings && this._audioSettings.ready) {\n      this._audioSettings.showAlert();\n      this._audioSettings.getUserMedia();\n    }\n    if (this._webphone && this._webphone.ready) {\n      this._webphone.connect({ force: true, skipConnectDelay: true });\n    }\n  }\n\n  @proxify\n  checkStatus() {\n    if (!this._availabilityMonitor) {\n      return;\n    }\n\n    this._availabilityMonitor.healthCheck();\n  }\n\n  _showAlert(message) {\n    if (message) {\n      this._alert.danger({\n        message,\n        allowDuplicates: false,\n      });\n    }\n  }\n\n  _hideAlerts() {\n    const alertIds = this._alert.messages\n      .filter((m) => {\n        for (const type in connectivityTypes) {\n          if (m.message === connectivityTypes[type]) return true;\n        }\n        return false;\n      })\n      .map((m) => m.id);\n    if (alertIds.length) {\n      this._alert.dismiss(alertIds);\n    }\n  }\n\n  @proxify\n  showConnectivityAlert() {\n    if (\n      !this.connectivityType ||\n      this.connectivityType === connectivityTypes.webphoneUnavailable\n    ) {\n      this._hideAlerts();\n    } else {\n      this._showAlert(this.connectivityType);\n    }\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.state.status === moduleStatuses.pending;\n  }\n\n  get webphoneAvailable() {\n    return (\n      this._webphone &&\n      this._callingSettings &&\n      this._audioSettings &&\n      this._audioSettings.ready &&\n      this._callingSettings.ready &&\n      this._auth.ready &&\n      this._auth.loggedIn &&\n      this._callingSettings.isWebphoneMode &&\n      this._audioSettings.userMedia &&\n      this._webphone.connected\n    );\n  }\n\n  get isWebphoneInitializing() {\n    return (\n      this._callingSettings.isWebphoneMode &&\n      (!this._webphone.ready ||\n        this._webphone.disconnected ||\n        this._webphone.connecting ||\n        this._webphone.connectFailed)\n    );\n  }\n\n  get webphoneConnecting() {\n    return (\n      this._webphone &&\n      this._webphone.ready &&\n      (this._webphone.connecting || this._webphone.reconnecting)\n    );\n  }\n\n  get webphoneUnavailable() {\n    return (\n      this._webphone &&\n      this._callingSettings &&\n      this._audioSettings &&\n      this._audioSettings.ready &&\n      this._auth.ready &&\n      this._auth.loggedIn &&\n      this._callingSettings.isWebphoneMode &&\n      (!this._audioSettings.userMedia ||\n        (this._webphone.reconnecting ||\n          this._webphone.connectError ||\n          this._webphone.inactive))\n    );\n  }\n\n  get proxyRetryCount() {\n    return this._oAuth && this._oAuth.proxyRetryCount > 0;\n  }\n\n  get isVoIPOnlyModeActivated() {\n    return (\n      !!this._availabilityMonitor && this._availabilityMonitor.isVoIPOnlyMode\n    );\n  }\n\n  get isLimitedModeActivated() {\n    return (\n      !!this._availabilityMonitor && this._availabilityMonitor.isLimitedMode\n    );\n  }\n\n  get hasLimitedStatusError() {\n    return (\n      !!this._availabilityMonitor &&\n      this._availabilityMonitor.hasLimitedStatusError\n    );\n  }\n\n  @selector\n  connectivityType = [\n    () => this._connectivityMonitor.networkLoss,\n    () => this._connectivityMonitor.connectivity,\n    () => this.proxyRetryCount,\n    () => this.isVoIPOnlyModeActivated,\n    () => this.isLimitedModeActivated,\n    () => this.webphoneAvailable,\n    () => this.webphoneUnavailable,\n    (\n      networkLoss,\n      connectivity,\n      proxyRetryCount,\n      isVoIPOnlyModeActivated,\n      isLimitedModeActivated,\n      webphoneAvailable,\n      webphoneUnavailable,\n    ) => {\n      if (networkLoss) return connectivityTypes.networkLoss;\n      if (proxyRetryCount) return connectivityTypes.offline;\n      if (!connectivity) return connectivityTypes.offline;\n      if (isVoIPOnlyModeActivated) {\n        if (webphoneAvailable) return connectivityTypes.voipOnly;\n        return connectivityTypes.serverUnavailable;\n      }\n      if (webphoneUnavailable) return connectivityTypes.webphoneUnavailable;\n      if (isLimitedModeActivated) return connectivityTypes.survival;\n      return null;\n    },\n  ];\n\n  @selector\n  mode = [\n    () => this.connectivityType,\n    (connectivityType) => {\n      if (\n        connectivityType === connectivityTypes.networkLoss ||\n        connectivityType === connectivityTypes.serverUnavailable\n      )\n        return connectivityTypes.offline;\n      return connectivityType;\n    },\n  ];\n\n  get isWebphoneUnavailableMode() {\n    return this.mode === connectivityTypes.webphoneUnavailable;\n  }\n\n  get isOfflineMode() {\n    return this.mode === connectivityTypes.offline;\n  }\n\n  get isVoipOnlyMode() {\n    return this.mode === connectivityTypes.voipOnly;\n  }\n}\n"],"file":"index.js"}