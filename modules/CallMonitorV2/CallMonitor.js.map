{"version":3,"sources":["modules/CallMonitorV2/CallMonitor.ts"],"names":["CallMonitor","name","deps","dep","optional","trackEvents","callInboundCallConnected","callOutboundRingOutCallConnected","clickCallItem","clickHoldAllCalls","clickHangupAllCalls","clickRejectAllCalls","clickAddCallControl","clickHangupMergeCallControl","that","Object","values","_deps","conferenceCall","state","mergingPair","length","clickMergeCallControl","clickMergeMergeCallControl","clickCloseConfirmMergeModal","clickMergeConfirmMergeModal","clickAddCallsOnHold","clickMergeCallsOnHold","clickHangupCallsOnHold","clickParticipantAreaCallControl","normalizedCalls","contactMatcher","dataMapping","activityMatcher","callMatched","normalizedCallsFromPresence","normalizedCallsFromTelephonySessions","useTelephonySession","presence","calls","accountInfo","countryCode","webphone","sessions","cachedSessions","activeCallControl","allCalls","isMerging","_activeOnHoldCalls","_activeCurrentCalls","lastEndedSessions","lastEndedSessionIds","otherDeviceCalls","enableCache","storageKey","_eventEmitter","EventEmitter","_useTelephonySession","callMonitorOptions","_normalizedCalls","addQuerySource","getQueriesFn","uniqueNumbers","readyCheckFn","ready","sessionIds","console","warn","sessionId","toEntityId","callback","on","callEvents","newCall","callRinging","callEnded","callUpdated","lastProcessedNumbers","tabManager","active","newNumbers","match","queries","ignoreQueue","lastProcessedIds","newSessions","_","lastProcessedCalls","handleCalls","slice","oldCalls","call","toNumberEntities","cleanToNumberEntities","entities","sortByStartTime","oldCallIndex","item","emit","oldCall","splice","telephonyStatus","from","phoneNumber","inboundCallConnectedTrack","outboundCallConnectedTrack","entity","index","indexOf","toEntity","toMatch","id","entityId","toMatches","undefined","_removeMatched","setMatchedData","log","onCallRinging","contactMapping","activityMapping","callItem","fromNumber","toNumber","to","fromMatches","toNumberEntity","activityMatches","cachedCalls","x","webphoneSession","i","combinedCalls","cachedCall","push","theSessions","l","r","startTime","currentRcCallSession","rcCallSessions","find","direction","party","telephonySessionId","originalWebphoneSession","_activeCallId","presenceCall","toName","fromName","partyId","telephonySession","status","code","filter","sessionsCache","res","endCall","output","numberMap","addIfNotExist","number","onNewCall","onCallUpdated","onCallEnded","RcModuleV2","storage","action"],"mappings":"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","sourcesContent":["import {\n  difference,\n  filter,\n  find,\n  findIndex,\n  forEach,\n  map,\n  reduce,\n  sort,\n} from 'ramda';\nimport { EventEmitter } from 'events';\nimport {\n  RcModuleV2,\n  state,\n  storage,\n  action,\n  computed,\n  watch,\n  track,\n} from '@ringcentral-integration/core';\nimport { trackEvents } from '../Analytics';\nimport { Module } from '../../lib/di';\nimport normalizeNumber from '../../lib/normalizeNumber';\nimport {\n  matchWephoneSessionWithAcitveCall,\n  isCurrentDeviceEndCall,\n  mapTelephonyStatus,\n  normalizeTelephonySession,\n} from './callMonitorHelper';\n\nimport {\n  isRinging,\n  isInbound,\n  hasRingingCalls,\n  sortByStartTime,\n  isRingingInboundCall,\n  isOnHold as isRingOutOnHold,\n} from '../../lib/callLogHelpers';\nimport {\n  isRing,\n  isOnHold,\n  isConferenceSession,\n  sortByLastActiveTimeDesc,\n  normalizeSession as normalizeWebphoneSession,\n} from '../WebphoneV2/webphoneHelper';\nimport {\n  isRinging as isProceeding,\n  isHolding,\n  isForwardedToVoiceMail,\n  isOnSetupStage,\n} from '../ActiveCallControlV2/helpers';\nimport { callEvents } from './callEvents';\nimport { Deps, CallEventCallback } from './CallMonitor.interface';\nimport {\n  Call,\n  NormalizedCall,\n  NormalizedCalls,\n} from '../../interfaces/Call.interface';\nimport { NormalizedSession } from '../../interfaces/Webphone.interface';\nimport { ToNumberMatched } from '../CallV2';\nimport { ActiveCall } from '../../interfaces/Presence.model';\n\n@Module({\n  name: 'CallMonitor',\n  deps: [\n    'AccountInfo',\n    'Storage',\n    'Presence',\n    { dep: 'ContactMatcher', optional: true },\n    { dep: 'Webphone', optional: true },\n    { dep: 'Call', optional: true },\n    { dep: 'ConferenceCall', optional: true },\n    { dep: 'ActivityMatcher', optional: true },\n    { dep: 'TabManager', optional: true },\n    { dep: 'ActiveCallControl', optional: true },\n    { dep: 'CallMonitorOptions', optional: true },\n  ],\n})\nexport class CallMonitor extends RcModuleV2<Deps> {\n  private _eventEmitter = new EventEmitter();\n\n  protected _useTelephonySession =\n    this._deps.callMonitorOptions?.useTelephonySession ?? false;\n\n  protected _normalizedCalls: NormalizedCalls = null;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'CallMonitor',\n    });\n    if (this._deps.contactMatcher) {\n      this._deps.contactMatcher.addQuerySource({\n        getQueriesFn: () => this.uniqueNumbers,\n        readyCheckFn: () =>\n          this._deps.accountInfo.ready && this._deps.presence.ready,\n      });\n    }\n\n    if (this._deps.activityMatcher) {\n      this._deps.activityMatcher.addQuerySource({\n        getQueriesFn: () => this.sessionIds,\n        readyCheckFn: () => this._deps.presence.ready,\n      });\n    }\n    if (this._useTelephonySession && !this._deps.activeCallControl) {\n      console.warn(\n        'Use telephonySession at CallMonitor module requires ActiveCallControlV2 module',\n      );\n      this._useTelephonySession = false;\n    }\n  }\n\n  @storage\n  @state\n  callMatched: Record<string, string> = {};\n\n  @action\n  setMatchedData({\n    sessionId,\n    toEntityId,\n  }: {\n    sessionId: string;\n    toEntityId: string;\n  }) {\n    this.callMatched[sessionId] = toEntityId;\n  }\n\n  onNewCall(callback: CallEventCallback) {\n    this._eventEmitter.on(callEvents.newCall, callback);\n    return this;\n  }\n\n  onCallRinging(callback: CallEventCallback) {\n    this._eventEmitter.on(callEvents.callRinging, callback);\n    return this;\n  }\n\n  onCallEnded(callback: CallEventCallback) {\n    this._eventEmitter.on(callEvents.callEnded, callback);\n    return this;\n  }\n\n  onCallUpdated(callback: CallEventCallback) {\n    this._eventEmitter.on(callEvents.callUpdated, callback);\n    return this;\n  }\n\n  onInitOnce() {\n    watch(\n      this,\n      () => this.uniqueNumbers,\n      (uniqueNumbers, lastProcessedNumbers) => {\n        if (!this.ready || !this._deps.tabManager?.active) return;\n        const newNumbers = difference(\n          uniqueNumbers,\n          lastProcessedNumbers || [],\n        );\n        if (this._deps.contactMatcher && this._deps.contactMatcher.ready) {\n          this._deps.contactMatcher.match({\n            queries: newNumbers,\n            ignoreQueue: true,\n          });\n        }\n      },\n    );\n\n    watch(\n      this,\n      () => this.sessionIds,\n      (sessionIds, lastProcessedIds) => {\n        if (!this.ready || !this._deps.tabManager?.active) return;\n        const newSessions = difference(sessionIds, lastProcessedIds || []);\n        if (this._deps.activityMatcher && this._deps.activityMatcher.ready) {\n          this._deps.activityMatcher.match({\n            queries: newSessions,\n            ignoreQueue: true,\n          });\n        }\n      },\n    );\n\n    watch(\n      this,\n      () => this.calls,\n      (_, lastProcessedCalls) => {\n        if (!this.ready) return;\n        this.handleCalls(lastProcessedCalls?.slice() ?? []);\n      },\n    );\n  }\n\n  handleCalls(oldCalls: Call[]) {\n    // no ringing calls\n    if (\n      this._deps.call &&\n      oldCalls.length &&\n      !this.calls.length &&\n      this._deps.call.toNumberEntities?.length\n    ) {\n      this._deps.call.cleanToNumberEntities();\n    }\n\n    const entities: ToNumberMatched[] = this._deps.call\n      ? sort(sortByStartTime, this._deps.call.toNumberEntities)\n      : [];\n    forEach((call) => {\n      const oldCallIndex = findIndex(\n        (item) => item.sessionId === call.sessionId,\n        oldCalls,\n      );\n      if (oldCallIndex === -1) {\n        this._eventEmitter.emit(callEvents.newCall, call);\n        // loop to execut the onRinging handlers\n        if (isRinging(call)) {\n          this._eventEmitter.emit(callEvents.callRinging, call);\n        }\n      } else {\n        const oldCall = oldCalls[oldCallIndex];\n        oldCalls.splice(oldCallIndex, 1);\n        if (\n          call.telephonyStatus !== oldCall.telephonyStatus ||\n          (oldCall.from && oldCall.from.phoneNumber) !==\n            (call.from && call.from.phoneNumber)\n        ) {\n          this._eventEmitter.emit(callEvents.callUpdated, call);\n          if (call.telephonyStatus === 'CallConnected') {\n            if (isInbound(call)) {\n              this.inboundCallConnectedTrack();\n            } else {\n              this.outboundCallConnectedTrack();\n            }\n          }\n        }\n      }\n      forEach((entity) => {\n        const index = entities.indexOf(entity);\n        const toEntity = find(\n          (toMatch) => toMatch.id === entity.entityId,\n          call.toMatches,\n        );\n        if (toEntity !== undefined) {\n          this._removeMatched(index, entities);\n          this.setMatchedData({\n            sessionId: call.sessionId,\n            toEntityId: toEntity.id,\n          });\n        }\n      }, entities);\n    }, this.calls);\n\n    forEach((call) => {\n      this._eventEmitter.emit(callEvents.callEnded, call);\n    }, oldCalls);\n  }\n\n  _removeMatched(index: number, entities: ToNumberMatched[]) {\n    console.log('removeMatched:', index);\n    entities.splice(index, 1);\n    console.log('entities after splice:', entities);\n    return entities;\n  }\n\n  @track(trackEvents.callInboundCallConnected)\n  inboundCallConnectedTrack() {}\n\n  @track(trackEvents.callOutboundRingOutCallConnected)\n  outboundCallConnectedTrack() {}\n\n  @track(trackEvents.clickCallItem)\n  callItemClickTrack() {}\n\n  @track(trackEvents.clickHoldAllCalls)\n  allCallsClickHoldTrack() {}\n\n  @track(trackEvents.clickHangupAllCalls)\n  allCallsClickHangupTrack() {}\n\n  @track(trackEvents.clickRejectAllCalls)\n  allCallsClickRejectTrack() {}\n\n  @track(trackEvents.clickAddCallControl)\n  callControlClickAddTrack() {}\n\n  @track(trackEvents.clickHangupMergeCallControl)\n  mergeControlClickHangupTrack() {}\n\n  @track((that: CallMonitor) => [\n    Object.values(that._deps.conferenceCall?.state.mergingPair ?? {}).length\n      ? trackEvents.clickMergeCallControl\n      : trackEvents.clickMergeMergeCallControl,\n  ])\n  callControlClickMergeTrack() {}\n\n  @track(trackEvents.clickCloseConfirmMergeModal)\n  confirmMergeClickCloseTrack() {}\n\n  @track(trackEvents.clickMergeConfirmMergeModal)\n  confirmMergeClickMergeTrack() {}\n\n  @track(trackEvents.clickAddCallsOnHold)\n  callsOnHoldClickAddTrack() {}\n\n  @track(trackEvents.clickMergeCallsOnHold)\n  callsOnHoldClickMergeTrack() {}\n\n  @track(trackEvents.clickHangupCallsOnHold)\n  callsOnHoldClickHangupTrack() {}\n\n  @track(trackEvents.clickParticipantAreaCallControl)\n  callControlClickParticipantAreaTrack() {}\n\n  get hasRingingCalls() {\n    return hasRingingCalls(this.calls);\n  }\n\n  get useTelephonySession() {\n    return this._useTelephonySession;\n  }\n\n  @computed<CallMonitor>((that) => [\n    that.normalizedCalls,\n    that._deps.contactMatcher?.dataMapping,\n    that._deps.activityMatcher?.dataMapping,\n    that.callMatched,\n  ])\n  get allCalls(): Call[] {\n    const contactMapping = this._deps.contactMatcher?.dataMapping ?? {};\n    const activityMapping = this._deps.activityMatcher?.dataMapping ?? {};\n    const calls = map((callItem) => {\n      const fromNumber = callItem.from && callItem.from.phoneNumber;\n      const toNumber = callItem.to && callItem.to.phoneNumber;\n      const fromMatches = (fromNumber && contactMapping[fromNumber]) || [];\n      const toMatches = (toNumber && contactMapping[toNumber]) || [];\n      const toNumberEntity = this.callMatched[callItem.sessionId];\n      return {\n        ...callItem,\n        fromMatches,\n        toMatches,\n        activityMatches: activityMapping[callItem.sessionId] || [],\n        toNumberEntity,\n      };\n    }, this.normalizedCalls);\n    return calls;\n  }\n\n  @computed<CallMonitor>((that) => [\n    that.normalizedCallsFromPresence,\n    that.normalizedCallsFromTelephonySessions,\n    that.useTelephonySession,\n  ])\n  get normalizedCalls() {\n    if (this.useTelephonySession) {\n      return this.normalizedCallsFromTelephonySessions;\n    }\n    return this.normalizedCallsFromPresence;\n  }\n\n  @computed<CallMonitor>((that) => [\n    that._deps.presence.calls,\n    that._deps.accountInfo.countryCode,\n    that._deps.webphone?.sessions,\n    that._deps.webphone?.cachedSessions,\n  ])\n  get normalizedCallsFromPresence() {\n    // match cached calls\n    let cachedCalls: NormalizedCalls = [];\n    if (this._normalizedCalls && this._deps.webphone?.cachedSessions?.length) {\n      cachedCalls = filter(\n        (x) =>\n          !!(\n            x.webphoneSession &&\n            find(\n              (i) => i.id === x.webphoneSession.id,\n              this._deps.webphone?.cachedSessions,\n            )\n          ),\n        this._normalizedCalls,\n      );\n    }\n\n    // combine\n    const combinedCalls: (NormalizedCall | ActiveCall)[] = [\n      ...this._deps.presence.calls,\n    ]; // clone\n    forEach((cachedCall) => {\n      if (!find((x) => x.id === cachedCall.id, this._deps.presence.calls)) {\n        combinedCalls.push(cachedCall);\n      }\n    }, cachedCalls);\n\n    // mapping and sort\n    let theSessions = this._deps.webphone?.sessions ?? [];\n    this._normalizedCalls = sort(\n      (l, r) => sortByLastActiveTimeDesc(l.webphoneSession, r.webphoneSession),\n      map((callItem) => {\n        // use account countryCode to normalize number due to API issues [RCINT-3419]\n        const fromNumber = normalizeNumber({\n          phoneNumber: callItem.from && callItem.from.phoneNumber,\n          countryCode: this._deps.accountInfo.countryCode,\n        });\n        const toNumber = normalizeNumber({\n          phoneNumber: callItem.to && callItem.to.phoneNumber,\n          countryCode: this._deps.accountInfo.countryCode,\n        });\n        const webphoneSession = matchWephoneSessionWithAcitveCall(\n          theSessions,\n          callItem,\n        );\n        theSessions = filter((x) => x !== webphoneSession, theSessions);\n        return {\n          ...callItem,\n          from: {\n            phoneNumber: fromNumber,\n          },\n          to: {\n            phoneNumber: toNumber,\n          },\n          startTime:\n            (webphoneSession && webphoneSession.startTime) ||\n            callItem.startTime,\n          webphoneSession,\n        };\n      }, combinedCalls),\n    );\n    return this._normalizedCalls;\n  }\n\n  @computed<CallMonitor>((that) => [\n    that._deps.activeCallControl?.sessions,\n    that._deps.accountInfo.countryCode,\n    that._deps.presence.calls,\n  ])\n  get normalizedCallsFromTelephonySessions() {\n    // TODO match cached calls when there are conference merging calls, refer to `normalizedCallsFromPresence` function\n    if (!this._deps.activeCallControl?.sessions) return [];\n    const combinedCalls = [...this._deps.activeCallControl?.sessions]; // clone\n\n    // mapping and sort\n    this._normalizedCalls = sort(\n      (l, r) => sortByLastActiveTimeDesc(l.webphoneSession, r.webphoneSession),\n      map((callItem) => {\n        const currentRcCallSession = this._deps.activeCallControl.rcCallSessions?.find(\n          (x) => x.id === callItem.id,\n        );\n        // sessionId arrives when telephony session event push and it's a required\n        // reference https://github.com/ringcentral/ringcentral-call-js/blob/master/src/Session.ts\n        if (\n          !currentRcCallSession ||\n          !currentRcCallSession.sessionId ||\n          isForwardedToVoiceMail(currentRcCallSession) ||\n          (isInbound(currentRcCallSession) &&\n            isOnSetupStage(currentRcCallSession))\n        ) {\n          return null;\n        }\n        const {\n          to,\n          from,\n          direction,\n          party,\n          telephonySessionId,\n          sessionId,\n          startTime,\n          webphoneSession: originalWebphoneSession,\n        } = currentRcCallSession;\n        let { _activeCallId: id } = (currentRcCallSession as any) as {\n          _activeCallId: string;\n        };\n        // find id from presence call one time, due to telephony session event not push call id back\n        // with ringout call\n        if (!id) {\n          const presenceCall = this._deps.presence.calls.find(\n            (presenceCall) => presenceCall.telephonySessionId === callItem.id,\n          );\n          id = presenceCall?.id;\n        }\n        const fromNumber = normalizeNumber({\n          phoneNumber: from?.phoneNumber,\n          countryCode: this._deps.accountInfo.countryCode,\n        });\n        const toNumber = normalizeNumber({\n          phoneNumber: to?.phoneNumber,\n          countryCode: this._deps.accountInfo.countryCode,\n        });\n        const webphoneSession = originalWebphoneSession\n          ? normalizeWebphoneSession(originalWebphoneSession)\n          : null;\n        const toName = to?.name;\n        const fromName = from?.name;\n        const partyId = party?.id;\n        const telephonySession = normalizeTelephonySession(\n          currentRcCallSession,\n        );\n        const telephonyStatus = mapTelephonyStatus(party?.status.code);\n\n        // TODO: add sipData here\n        // const sipData = {};\n        return {\n          id,\n          partyId,\n          direction,\n          telephonySession,\n          telephonySessionId,\n          toName,\n          fromName,\n          from: {\n            phoneNumber: fromNumber,\n          },\n          to: {\n            phoneNumber: toNumber,\n          },\n          startTime,\n          sessionId,\n          webphoneSession,\n          telephonyStatus,\n        };\n      }, combinedCalls).filter((x) => !!x),\n    );\n    return this._normalizedCalls;\n  }\n\n  @computed<CallMonitor>((that) => [\n    that.allCalls,\n    that._deps.conferenceCall?.isMerging,\n  ])\n  get calls() {\n    return filter((callItem) => {\n      // filtering out the conferece during merging\n      if (this._deps.conferenceCall?.isMerging) {\n        return !isConferenceSession(callItem.webphoneSession);\n      }\n      return true;\n    }, this.allCalls);\n  }\n\n  @computed<CallMonitor>((that) => [that.calls, that.useTelephonySession])\n  get activeRingCalls() {\n    return filter((callItem) => {\n      if (this.useTelephonySession) {\n        return (\n          callItem.webphoneSession &&\n          callItem.telephonySession &&\n          isProceeding(callItem.telephonySession)\n        );\n      }\n      return callItem.webphoneSession && isRing(callItem.webphoneSession);\n    }, this.calls);\n  }\n\n  @computed<CallMonitor>((that) => [that.calls, that.useTelephonySession])\n  get _activeOnHoldCalls() {\n    if (this.useTelephonySession) {\n      return filter(\n        (callItem) =>\n          callItem.webphoneSession &&\n          callItem.telephonySession &&\n          isHolding(callItem.telephonySession),\n        this.calls,\n      );\n    }\n    return filter(\n      (callItem) =>\n        callItem.webphoneSession && isOnHold(callItem.webphoneSession),\n      this.calls,\n    );\n  }\n\n  @computed<CallMonitor>((that) => [that.calls, that.useTelephonySession])\n  get _activeCurrentCalls() {\n    return filter((callItem) => {\n      if (this.useTelephonySession) {\n        return (\n          callItem.webphoneSession &&\n          callItem.telephonySession &&\n          !isProceeding(callItem.telephonySession) &&\n          !isHolding(callItem.telephonySession)\n        );\n      }\n      return (\n        callItem.webphoneSession &&\n        !isOnHold(callItem.webphoneSession) &&\n        !isRing(callItem.webphoneSession)\n      );\n    }, this.calls);\n  }\n\n  @computed<CallMonitor>((that) => [\n    that._activeOnHoldCalls,\n    that._activeCurrentCalls,\n  ])\n  get activeOnHoldCalls() {\n    if (this._activeOnHoldCalls.length && !this._activeCurrentCalls.length) {\n      return this._activeOnHoldCalls.slice(1);\n    }\n    return this._activeOnHoldCalls;\n  }\n\n  @computed<CallMonitor>((that) => [\n    that._activeCurrentCalls,\n    that._activeOnHoldCalls,\n  ])\n  get activeCurrentCalls() {\n    return !this._activeCurrentCalls.length && this._activeOnHoldCalls.length\n      ? this._activeOnHoldCalls.slice(0, 1)\n      : this._activeCurrentCalls;\n  }\n\n  @computed<CallMonitor>((that) => [\n    that.calls,\n    that._deps.webphone?.lastEndedSessions,\n    that.useTelephonySession,\n    that._deps.activeCallControl?.lastEndedSessionIds,\n  ])\n  get otherDeviceCalls() {\n    return reduce(\n      ({ sessionsCache, res }, callItem) => {\n        if (callItem.webphoneSession) {\n          return {\n            sessionsCache,\n            res,\n          };\n        }\n\n        if (!sessionsCache || !sessionsCache.length) {\n          return {\n            sessionsCache,\n            res: [...res, callItem],\n          };\n        }\n        // TODO: refactor\n        let endCall: boolean | NormalizedSession = null;\n        if (this.useTelephonySession) {\n          endCall = isCurrentDeviceEndCall(sessionsCache as string[], callItem);\n        } else {\n          endCall = matchWephoneSessionWithAcitveCall(\n            sessionsCache as NormalizedSession[],\n            callItem,\n          );\n        }\n\n        return {\n          sessionsCache: filter(\n            (x) => x !== endCall,\n            sessionsCache as NormalizedSession[],\n          ),\n          res: endCall ? res : [...res, callItem],\n        };\n      },\n      {\n        sessionsCache: this.useTelephonySession\n          ? this._deps.activeCallControl?.lastEndedSessionIds\n          : this._deps.webphone?.lastEndedSessions,\n        res: [],\n      },\n      this.calls,\n    ).res;\n  }\n\n  @computed<CallMonitor>((that) => [that.normalizedCalls])\n  get uniqueNumbers() {\n    const output: string[] = [];\n    const numberMap: Record<string, boolean> = {};\n    function addIfNotExist(number: string) {\n      if (!numberMap[number]) {\n        output.push(number);\n        numberMap[number] = true;\n      }\n    }\n    forEach((callItem) => {\n      if (callItem.from && callItem.from.phoneNumber) {\n        addIfNotExist(callItem.from.phoneNumber);\n      }\n      if (callItem.to && callItem.to.phoneNumber) {\n        addIfNotExist(callItem.to.phoneNumber);\n      }\n    }, this.normalizedCalls);\n    return output;\n  }\n\n  @computed<CallMonitor>((that) => [that._deps.presence.calls])\n  get sessionIds() {\n    return map((callItem) => callItem.sessionId, this._deps.presence.calls);\n  }\n\n  @computed<CallMonitor>((that) => [that.otherDeviceCalls])\n  get ringoutRingCalls() {\n    return filter(\n      (callItem) => isRingingInboundCall(callItem),\n      this.otherDeviceCalls,\n    );\n  }\n\n  @computed<CallMonitor>((that) => [that.otherDeviceCalls])\n  get ringoutCurrentCalls() {\n    return filter(\n      (callItem) =>\n        !isRingingInboundCall(callItem) && !isRingOutOnHold(callItem),\n      this.otherDeviceCalls,\n    );\n  }\n\n  @computed<CallMonitor>((that) => [that.otherDeviceCalls])\n  get ringoutOnHoldCalls() {\n    return filter(\n      (callItem) => isRingOutOnHold(callItem),\n      this.otherDeviceCalls,\n    );\n  }\n\n  /**\n   * @deprecated\n   */\n  onRingings(callback: CallEventCallback) {\n    this.onCallRinging(callback);\n    console.warn('\"onRingings\" is deprecated. Use \"onCallRinging\" instead.');\n  }\n\n  /**\n   * @deprecated\n   */\n  set _onNewCall(callback: CallEventCallback) {\n    this.onNewCall(callback);\n    console.warn('\"_onNewCall\" is deprecated. Use \"onNewCall\" instead.');\n  }\n\n  /**\n   * @deprecated\n   */\n  set _onCallUpdated(callback: CallEventCallback) {\n    this.onCallUpdated(callback);\n    console.warn(\n      '\"_onCallUpdated\" is deprecated. Use \"onCallUpdated\" instead.',\n    );\n  }\n\n  /**\n   * @deprecated\n   */\n  set _onCallEnded(callback: CallEventCallback) {\n    this.onCallEnded(callback);\n    console.warn('\"_onCallEnded\" is deprecated. Use \"onCallEnded\" instead.');\n  }\n\n  /**\n   * @deprecated\n   */\n  set _onRinging(callback: CallEventCallback) {\n    this.onCallRinging(callback);\n    console.warn('\"_onRinging\" is deprecated. Use \"onCallRinging\" instead.');\n  }\n}\n"],"file":"CallMonitor.js"}