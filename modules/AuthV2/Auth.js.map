{"version":3,"sources":["modules/AuthV2/Auth.ts"],"names":["LoginStatusChangeEvent","Auth","name","deps","dep","optional","_loggedIn","_beforeLogoutHandlers","Set","_afterLoggedInHandlers","_unbindEvents","_lastEnvironmentCounter","_proxyUri","_redirectUri","token","loginStatus","loggedIn","ownerId","owner_id","endpointId","endpoint_id","accessToken","access_token","expireTime","expire_time","expiresIn","expires_in","scope","notLoggedIn","isFreshLogin","refreshTokenValid","loggingIn","beforeLogout","loggingOut","platform","_deps","client","service","_client","onRequestError","error","Error","message","logout","onLoginSuccess","auth","data","setLoginSuccess","handlers","handler","onLoginError","setLoginError","onLogoutSuccess","setLogoutSuccess","onLogoutError","_cache","clean","setLogoutError","alert","danger","authMessages","logoutError","payload","onRefreshSuccess","setRefreshSuccess","onRefreshError","isOffline","resStatus","response","status","setRefreshError","sessionExpired","ttl","addListener","events","loginSuccess","loginError","logoutSuccess","refreshSuccess","refreshError","requestError","removeListener","moduleStatuses","pending","locale","ready","tabManager","environment","send","event","args","fetchToken","changeCounter","_bindEvents","setInitLogin","username","password","extension","remember","code","redirectUri","tokenType","setLogin","setData","token_type","refresh_token_expires_in","account","get","extensionData","id","login","state","brandId","display","prompt","force","implicit","loginUrl","usePKCE","dismissAllAlert","dismissAll","setBeforeLogout","result","setCancelLogout","Promise","reject","console","beforeLogoutError","setLogout","isImplicit","add","removeBeforeLogoutHandler","String","newAuthData","emit","url","resolve","window","location","href","_clientSecret","length","authOptions","RcModuleV2","action","proxify"],"mappings":"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","sourcesContent":["import { GetExtensionInfoResponse } from '@rc-ex/core/definitions';\nimport { action, RcModuleV2, state } from '@ringcentral-integration/core';\nimport url from 'url';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport { Module } from '../../lib/di';\nimport proxify from '../../lib/proxy/proxify';\nimport validateIsOffline from '../../lib/validateIsOffline';\nimport { Deps, Token, TokenInfo } from './Auth.interface';\nimport { authMessages } from './authMessages';\nimport { loginStatus } from './loginStatus';\n\nconst LoginStatusChangeEvent = 'loginStatusChange';\n\n@Module({\n  name: 'Auth',\n  deps: [\n    'Client',\n    'Alert',\n    'Locale',\n    { dep: 'TabManager', optional: true },\n    { dep: 'Environment', optional: true },\n    { dep: 'AuthOptions', optional: true },\n  ],\n})\nclass Auth extends RcModuleV2<Deps> {\n  private _loggedIn: boolean = null;\n  _beforeLogoutHandlers: Set<Function> = new Set();\n  _afterLoggedInHandlers: Set<() => any> = new Set();\n  _unbindEvents: any = null;\n  _lastEnvironmentCounter: number = 0;\n  _proxyUri: string;\n  _redirectUri: string;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n    });\n  }\n\n  @state\n  loginStatus: string = null;\n\n  @state\n  isFreshLogin: boolean = null;\n\n  @state\n  token: Token = {};\n\n  @action\n  setLoginSuccess(token: TokenInfo) {\n    this.loginStatus = loginStatus.loggedIn;\n    this.token = {\n      ownerId: token.owner_id,\n      endpointId: token.endpoint_id,\n      accessToken: token.access_token,\n      expireTime: token.expire_time,\n      expiresIn: token.expires_in,\n      scope: token.scope,\n    };\n  }\n\n  @action\n  setLoginError() {\n    this.loginStatus = loginStatus.notLoggedIn;\n    this.token = {};\n    this.isFreshLogin = null;\n  }\n\n  @action\n  setLogoutSuccess() {\n    this.loginStatus = loginStatus.notLoggedIn;\n    this.token = {};\n    this.isFreshLogin = null;\n  }\n\n  @action\n  setRefreshSuccess(token: TokenInfo) {\n    this.loginStatus = loginStatus.loggedIn;\n    this.token = {\n      ownerId: token.owner_id,\n      endpointId: token.endpoint_id,\n      accessToken: token.access_token,\n      expireTime: token.expire_time,\n      expiresIn: token.expires_in,\n      scope: token.scope,\n    };\n  }\n\n  @action\n  setRefreshError(refreshTokenValid: boolean) {\n    this.isFreshLogin = null;\n    if (!refreshTokenValid) {\n      this.token = {};\n      this.loginStatus = loginStatus.notLoggedIn;\n    }\n  }\n\n  @action\n  setLogoutError() {\n    this.loginStatus = loginStatus.notLoggedIn;\n    this.token = {};\n    this.isFreshLogin = null;\n  }\n\n  @action\n  setLogin() {\n    this.loginStatus = loginStatus.loggingIn;\n    this.isFreshLogin = true;\n  }\n\n  @action\n  setBeforeLogout() {\n    this.loginStatus = loginStatus.beforeLogout;\n  }\n\n  @action\n  setCancelLogout() {\n    this.loginStatus = loginStatus.loggedIn;\n  }\n\n  @action\n  setLogout() {\n    this.loginStatus = loginStatus.loggingOut;\n  }\n\n  @action\n  setInitLogin({ loggedIn, token }: { loggedIn: boolean; token: TokenInfo }) {\n    this.loginStatus = loggedIn\n      ? loginStatus.loggedIn\n      : loginStatus.notLoggedIn;\n    this.isFreshLogin = loggedIn ? false : null;\n    this.token = token\n      ? {\n          ownerId: token.owner_id,\n          endpointId: token.endpoint_id,\n          accessToken: token.access_token,\n          expireTime: token.expire_time,\n          expiresIn: token.expires_in,\n          scope: token.scope,\n        }\n      : {};\n  }\n\n  _bindEvents() {\n    if (this._unbindEvents) this._unbindEvents();\n\n    const platform = this._deps.client.service.platform();\n    const client = this._deps.client.service._client;\n    const onRequestError = (error: Error) => {\n      if (error instanceof Error && error.message === 'Token revoked') {\n        this.logout();\n      }\n    };\n\n    const onLoginSuccess = async () => {\n      const token: TokenInfo = await platform.auth().data();\n      this.setLoginSuccess(token);\n      const handlers = [...this._afterLoggedInHandlers];\n      for (const handler of handlers) {\n        handler();\n      }\n    };\n    const onLoginError = () => {\n      this.setLoginError();\n    };\n    const onLogoutSuccess = () => {\n      this.setLogoutSuccess();\n    };\n    const onLogoutError = (error: Error) => {\n      platform._cache.clean();\n      this.setLogoutError();\n      if (error) {\n        this._deps.alert.danger({\n          message: authMessages.logoutError,\n          payload: error,\n        });\n      }\n    };\n    const onRefreshSuccess = async () => {\n      const token: TokenInfo = await platform.auth().data();\n      this.setRefreshSuccess(token);\n    };\n    // TODO: fix `error` type.\n    const onRefreshError = async (error: any) => {\n      // user is still considered logged in if the refreshToken is still valid\n      const isOffline = validateIsOffline(error.message);\n\n      const resStatus = (error.response && error.response.status) || null;\n      const refreshTokenValid =\n        (isOffline || resStatus >= 500) &&\n        (await platform.auth().refreshTokenValid());\n      this.setRefreshError(refreshTokenValid);\n\n      if (\n        !refreshTokenValid &&\n        (await platform.auth().data()).access_token !== ''\n      ) {\n        this._deps.alert.danger({\n          message: authMessages.sessionExpired,\n          payload: error,\n          ttl: 0,\n        });\n        // clean the cache so the error doesn't show again\n        platform._cache.clean();\n      }\n    };\n    platform.addListener(platform.events.loginSuccess, onLoginSuccess);\n    platform.addListener(platform.events.loginError, onLoginError);\n    platform.addListener(platform.events.logoutSuccess, onLogoutSuccess);\n    platform.addListener(platform.events.logoutError, onLogoutError);\n    platform.addListener(platform.events.refreshSuccess, onRefreshSuccess);\n    platform.addListener(platform.events.refreshError, onRefreshError);\n    client.addListener(client.events.requestError, onRequestError);\n    this._unbindEvents = () => {\n      platform.removeListener(platform.events.loginSuccess, onLoginSuccess);\n      platform.removeListener(platform.events.loginError, onLoginError);\n      platform.removeListener(platform.events.logoutSuccess, onLogoutSuccess);\n      platform.removeListener(platform.events.logoutError, onLogoutError);\n      platform.removeListener(platform.events.refreshSuccess, onRefreshSuccess);\n      platform.removeListener(platform.events.refreshError, onRefreshError);\n      client.removeListener(client.events.requestError, onRequestError);\n    };\n  }\n\n  _shouldInit() {\n    return (\n      this.status === moduleStatuses.pending &&\n      this._deps.locale.ready &&\n      (!this._deps.tabManager || this._deps.tabManager.ready) &&\n      (!this._deps.environment || this._deps.environment.ready)\n    );\n  }\n\n  async onStateChange() {\n    if (this._deps.tabManager && this._deps.tabManager.ready && this.ready) {\n      if (\n        (this._loggedIn && this.loginStatus === loginStatus.notLoggedIn) ||\n        (!this._loggedIn && this.loginStatus === loginStatus.loggedIn)\n      ) {\n        this._loggedIn = !this._loggedIn;\n        this._deps.tabManager.send(LoginStatusChangeEvent, this._loggedIn);\n      } else if (\n        this._deps.tabManager.event &&\n        this._deps.tabManager.event.name === LoginStatusChangeEvent &&\n        this._deps.tabManager.event.args[0] !== this.loggedIn\n      ) {\n        /* eslint { \"prefer-destructuring\": 0 } */\n        this._loggedIn = this._deps.tabManager.event.args[0];\n        await this.fetchToken();\n      }\n    }\n    if (\n      this.ready &&\n      this._deps.environment &&\n      this._deps.environment.changeCounter !== this._lastEnvironmentCounter\n    ) {\n      this._lastEnvironmentCounter = this._deps.environment.changeCounter;\n      this._bindEvents();\n    }\n  }\n\n  async onInit() {\n    const platform = this._deps.client.service.platform();\n    this._loggedIn = await platform.loggedIn();\n    this._bindEvents();\n  }\n\n  async fetchToken() {\n    const platform = this._deps.client.service.platform();\n    const token: TokenInfo = this._loggedIn\n      ? await platform.auth().data()\n      : null;\n    this.setInitLogin({\n      loggedIn: this._loggedIn,\n      token,\n    });\n  }\n\n  async onInitSuccess() {\n    await this.fetchToken();\n  }\n\n  get redirectUri() {\n    return url.resolve(window.location.href, this._redirectUri);\n  }\n\n  get proxyUri() {\n    return this._proxyUri;\n  }\n\n  get ownerId() {\n    return this.token.ownerId;\n  }\n\n  get endpointId() {\n    return this.token.endpointId;\n  }\n\n  get accessToken() {\n    return this.token.accessToken;\n  }\n\n  /**\n   * @description Login either with username/password or with authorization code\n   */\n  @proxify\n  async login({\n    username,\n    password,\n    extension,\n    remember,\n    code,\n    redirectUri,\n    accessToken,\n    expiresIn,\n    endpointId,\n    tokenType,\n    scope,\n  }: {\n    username: string;\n    password: string;\n    extension: string;\n    remember: boolean | number;\n    code: string;\n    redirectUri: string;\n    accessToken: TokenInfo['access_token'];\n    expiresIn: TokenInfo['expires_in'];\n    endpointId: TokenInfo['endpoint_id'];\n    tokenType: TokenInfo['token_type'];\n    scope: TokenInfo['scope'];\n  }) {\n    this.setLogin();\n    let ownerId: number;\n    if (accessToken) {\n      await this._deps.client.service\n        .platform()\n        .auth()\n        .setData({\n          token_type: tokenType,\n          access_token: accessToken,\n          expires_in: expiresIn,\n          refresh_token_expires_in: expiresIn,\n          scope,\n        });\n      const extensionData: GetExtensionInfoResponse = await this._deps.client\n        .account()\n        .extension()\n        .get();\n      ownerId = extensionData.id;\n    }\n    // TODO: support to set redirectUri in js sdk v4 login function\n    if (!this._deps.client.service.platform()._redirectUri) {\n      this._deps.client.service.platform()._redirectUri = redirectUri;\n    }\n    return this._deps.client.service.platform().login({\n      username,\n      password,\n      extension,\n      remember,\n      code,\n      redirectUri,\n      endpoint_id: endpointId,\n      expires_in: expiresIn,\n      access_token: accessToken,\n      token_type: tokenType,\n      owner_id: ownerId,\n    });\n  }\n\n  getLoginUrl({\n    redirectUri,\n    state,\n    brandId,\n    display,\n    prompt,\n    force,\n    implicit = false,\n  }: {\n    redirectUri: string;\n    state: string;\n    brandId: string;\n    display: string;\n    prompt: string;\n    force: boolean;\n    implicit?: boolean;\n  }) {\n    // TODO: support to set redirectUri in js sdk v4 login function\n    if (!this._deps.client.service.platform()._redirectUri) {\n      this._deps.client.service.platform()._redirectUri = redirectUri;\n    }\n    return `${this._deps.client.service.platform().loginUrl({\n      redirectUri,\n      state,\n      brandId,\n      display,\n      prompt,\n      implicit,\n      usePKCE: this.usePKCE,\n    })}${force ? '&force' : ''}`;\n  }\n\n  /**\n   * @description Triggers the beforeLogoutHandlers to run\n   *  and then proceed to logout from ringcentral.\n   */\n  @proxify\n  async logout({ dismissAllAlert = true } = {}) {\n    if (dismissAllAlert) {\n      this._deps.alert.dismissAll();\n    }\n    this.setBeforeLogout();\n    const handlers = [...this._beforeLogoutHandlers];\n    try {\n      if (this._deps.tabManager && this._deps.tabManager.ready) {\n        this._deps.tabManager.send(LoginStatusChangeEvent, false);\n      }\n      for (const handler of handlers) {\n        const result = await (async () => handler())();\n        if (result) {\n          this.setCancelLogout();\n          if (this._deps.tabManager && this._deps.tabManager.ready) {\n            this._deps.tabManager.send(LoginStatusChangeEvent, true);\n          }\n          return Promise.reject(result);\n        }\n      }\n    } catch (error) {\n      console.error(error);\n      this._deps.alert.danger({\n        message: authMessages.beforeLogoutError,\n        payload: error,\n      });\n    }\n    this.setLogout();\n    if (this.isImplicit) {\n      this._deps.client.service.platform()._cache.clean();\n      this.setLogoutSuccess();\n      return null;\n    }\n    return this._deps.client.service.platform().logout();\n  }\n\n  /**\n   * @function\n   * @param {Function} handler\n   * @returns {Function} return that delete handler event, call that will delete that event\n   */\n  addBeforeLogoutHandler(handler: Function): Function {\n    this._beforeLogoutHandlers.add(handler);\n    return () => {\n      this.removeBeforeLogoutHandler(handler);\n    };\n  }\n\n  /**\n   * @function\n   * @param {Function} handler\n   */\n  removeBeforeLogoutHandler(handler: Function) {\n    this._beforeLogoutHandlers.delete(handler);\n  }\n\n  addAfterLoggedInHandler(handler: () => any) {\n    this._afterLoggedInHandlers.add(handler);\n    return () => {\n      this._afterLoggedInHandlers.delete(handler);\n    };\n  }\n\n  @proxify\n  async refreshImplicitToken({\n    tokenType,\n    accessToken,\n    expiresIn,\n    endpointId,\n  }: {\n    tokenType: TokenInfo['token_type'];\n    accessToken: TokenInfo['access_token'];\n    expiresIn: TokenInfo['expires_in'];\n    endpointId: TokenInfo['endpoint_id'];\n  }) {\n    try {\n      const extensionData: GetExtensionInfoResponse = await this._deps.client\n        .account()\n        .extension()\n        .get();\n      const ownerId = String(extensionData.id);\n      if (ownerId !== String(this.ownerId)) {\n        return;\n      }\n      const platform = this._deps.client.service.platform();\n      const newAuthData = {\n        token_type: tokenType,\n        access_token: accessToken,\n        expires_in: expiresIn,\n        refresh_token_expires_in: expiresIn,\n        endpoint_id: endpointId,\n      };\n      platform.auth().setData(newAuthData);\n      platform.emit(platform.events.refreshSuccess, newAuthData);\n    } catch (error) {\n      console.error('refreshImplicitToken error:', error);\n    }\n  }\n\n  @proxify\n  async checkIsLoggedIn() {\n    // SDK would return false when there's temporary network issues,\n    // but we should not return use back to welcome string and should\n    // still consider the user as being logged in.\n    await this._deps.client.service.platform().loggedIn();\n    return this.loginStatus === loginStatus.loggedIn;\n  }\n\n  get loggedIn() {\n    return (\n      this.loginStatus === loginStatus.loggedIn ||\n      this.loginStatus === loginStatus.beforeLogout\n    );\n  }\n\n  get notLoggedIn() {\n    return this.loginStatus === loginStatus.notLoggedIn;\n  }\n\n  get isImplicit() {\n    return !(\n      this.usePKCE ||\n      (this._deps.client.service.platform()._clientSecret &&\n        this._deps.client.service.platform()._clientSecret.length > 0)\n    );\n  }\n\n  get usePKCE() {\n    return this._deps.authOptions?.usePKCE ?? false;\n  }\n}\n\nexport { Auth };\n"],"file":"Auth.js"}