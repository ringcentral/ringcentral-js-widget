{"version":3,"sources":["lib/usm-redux/core/module.ts"],"names":["Module","params","Array","isArray","_actionTypes","forEach","name","_reducersMaps","types","_state","_initialValue","type","states","indexOf","store","_store","subscribe","getState","dispatch","console","warn","constructor","action","callback","key","_proto","_getModuleKey","isFactoryModule","actionTypes","reducers","getReducers","subReducers","Object","entries","_modules","filter","module","reduce","assign","__$$default$$__","_setStore","map","prototype","getPrototypeOf","_getReducers","combineReducers","__$$state$$__","_getState","_reducers","Error","reducer","BaseModule"],"mappings":"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","sourcesContent":["/* eslint-disable no-nested-ternary */\nimport { createStore, combineReducers, ReducersMapObject, Store } from 'redux';\nimport BaseModule from '../../usm';\nimport { Action, Reducer, Params } from '../../usm/core/module';\nimport { Properties } from '../../usm/utils/flatten';\n\nexport type Attribute<T = unknown> = {\n  [P in string]: T;\n};\n\ntype ActionTypes = Attribute<string>;\n\ninterface Module {\n  _initialValue: Properties;\n  __selectors__: Properties;\n  _reducersMaps: Attribute<Callback<ActionTypes, Reducer>>;\n  __$$state$$__: Record<string, unknown> | undefined;\n}\ninterface Callback<T = undefined, S = void> {\n  (params: T): S;\n}\n\nexport interface Dispatch {\n  (action: Action): void;\n}\n\nclass Module<T extends Record<string, any> = {}> extends BaseModule<T> {\n  public _makeInstance(params: Params<T>) {\n    if (Array.isArray(this._actionTypes)) {\n      this._actionTypes.forEach((name) => {\n        this._reducersMaps[name] = (types) => (\n          _state = this._initialValue[name],\n          { type, states },\n        ) => (type.indexOf(types[name]) > -1 && states ? states[name] : _state);\n      });\n    }\n    super._makeInstance(params);\n  }\n\n  protected get _proto(): typeof Module {\n    const prototype = Object.getPrototypeOf(this);\n    return prototype.constructor;\n  }\n\n  protected get _reducers() {\n    const reducers = this._getReducers(this.actionTypes);\n    return this._proto.combineReducers(reducers);\n  }\n\n  protected static combineReducers(reducers: ReducersMapObject<{}, any>) {\n    return combineReducers(reducers) as Reducer;\n  }\n\n  protected static createStore(reducer: Reducer): Store {\n    return createStore(reducer);\n  }\n\n  protected _setStore(store: Store) {\n    if (this._store) return;\n    this._store = store;\n    if (\n      typeof this._store.subscribe !== 'function' ||\n      typeof this._store.getState !== 'function' ||\n      typeof this._store.dispatch !== 'function'\n    ) {\n      console.warn(\n        `${this.constructor.name} Module did't correctly set custom 'Store'.`,\n      );\n    }\n  }\n\n  public _dispatch(action: Action) {\n    if (typeof this._store.dispatch === 'function') {\n      return this._store.dispatch(action);\n    }\n  }\n\n  public _subscribe(callback: () => void) {\n    return this._store.subscribe(callback);\n  }\n\n  public _getState() {\n    const key = this._proto._getModuleKey(this);\n    return this.isFactoryModule || !this.getState\n      ? this.isFactoryModule\n        ? this._store.getState()\n        : key\n        ? this._store.getState()[key]\n        : {}\n      : this.getState();\n  }\n\n  public _getReducers(actionTypes: ActionTypes) {\n    const reducers = this.getReducers(actionTypes);\n    const subReducers: Properties<Reducer> = !this.isFactoryModule\n      ? {}\n      : Object.entries(this._modules)\n          .filter(([, module]) => module instanceof Module)\n          .reduce(\n            (reducers, [key, module]) =>\n              Object.assign(reducers, { [key]: module.reducers }),\n            {},\n          );\n    return {\n      __$$default$$__: (): null => null,\n      ...reducers,\n      ...subReducers,\n    };\n  }\n\n  public get state() {\n    return this.__$$state$$__ || this._getState() || {};\n  }\n\n  public setStore(store: Store) {\n    this._setStore(store);\n  }\n\n  public get reducers() {\n    return this._reducers;\n  }\n\n  public get store() {\n    if (!this._store) {\n      throw new Error(\n        `${this.constructor.name} Module has not been initialized...`,\n      );\n    }\n    return this._store;\n  }\n\n  public getReducers(actionTypes: ActionTypes) {\n    return (this._actionTypes || []).reduce(\n      (map: Properties<Reducer>, name: string) => {\n        map[name] = this._reducersMaps[name](actionTypes);\n        return map;\n      },\n      {},\n    );\n  }\n}\n\nexport { Module as default };\n"],"file":"module.js"}