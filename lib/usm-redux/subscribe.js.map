{"version":3,"sources":["lib/usm-redux/subscribe.ts"],"names":["subscribe","module","listener","Error","service","className","Object","getPrototypeOf","constructor","name","unsubscribe","storeKey","subscriptions","subscriptionsKey","_unsubscribe","push","assign","watch","selector","watcher","oldValue","newValue","lastValue","watchEffect","oldValues","Array","isArray","newValues","length","i","lastValues"],"mappings":"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","sourcesContent":["import {\n  Subscribe,\n  Watch,\n  Unsubscribe,\n  Subscription,\n  Service,\n  WatchEffect,\n} from './interface';\nimport { storeKey, subscriptionsKey } from './constant';\nimport { isEqual } from './utils/index';\n\nconst subscribe: Subscribe = (module, listener) => {\n  if (typeof module !== 'object') {\n    throw new Error(`The subscription target '${module}' is not an object.`);\n  }\n  const service: Service = module;\n  const className = Object.getPrototypeOf(service).constructor.name;\n  if (typeof listener !== 'function') {\n    throw new Error(\n      `The 'listener' should be a function in the class '${className}'.`,\n    );\n  }\n  let unsubscribe: Unsubscribe;\n  if (service[storeKey]) {\n    unsubscribe = service[storeKey].subscribe(listener);\n  } else {\n    // When constructing\n    const subscriptions: Subscription[] = service[subscriptionsKey] || [];\n    let _unsubscribe: Unsubscribe;\n    subscriptions.push(() => {\n      if (typeof service[storeKey] !== 'object') {\n        throw new Error(\n          `The subscription target class '${className}' should be created via 'createStore()'.`,\n        );\n      }\n      _unsubscribe = service[storeKey].subscribe(listener);\n    });\n    unsubscribe = () => _unsubscribe();\n    Object.assign(service, {\n      [subscriptionsKey]: subscriptions,\n    });\n  }\n  return unsubscribe;\n};\n\nconst watch: Watch = (module, selector, watcher) => {\n  if (typeof watcher !== 'function') {\n    const className = Object.getPrototypeOf(module).constructor.name;\n    throw new Error(\n      `The 'watcher' should be a function in the class '${className}'.`,\n    );\n  }\n  let oldValue = selector();\n  return subscribe(module, () => {\n    const newValue = selector();\n    if (!isEqual(newValue, oldValue)) {\n      const lastValue = oldValue;\n      oldValue = newValue;\n      watcher(newValue, lastValue);\n    }\n  });\n};\n\nconst watchEffect: WatchEffect = (module, selector, watcher) => {\n  if (typeof watcher !== 'function') {\n    const className = Object.getPrototypeOf(module).constructor.name;\n    throw new Error(\n      `The 'watcher' should be a function in the class '${className}'.`,\n    );\n  }\n  let oldValues = selector();\n  if (!Array.isArray(oldValues)) {\n    const className = Object.getPrototypeOf(module).constructor.name;\n    throw new Error(\n      `The 'selector' should be a function that returns an array in the class '${className}'.`,\n    );\n  }\n  return subscribe(module, () => {\n    const newValues = selector();\n    const length = oldValues.length;\n    for (let i = 0; i < length; i++) {\n      if (!isEqual(newValues[i], oldValues[i])) {\n        const lastValues = oldValues;\n        oldValues = newValues;\n        watcher(newValues, lastValues);\n        break;\n      }\n    }\n  });\n};\n\nexport { subscribe, watch, watchEffect };\n"],"file":"subscribe.js"}