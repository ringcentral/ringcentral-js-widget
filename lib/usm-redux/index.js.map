{"version":3,"sources":["lib/usm-redux/index.ts"],"names":["createState","target","name","descriptor","_actionTypes","_reducersMaps","_initialValue","initializer","call","undefined","get","_store","state","set","value","enumerable","configurable","action","fn","args","states","__$$state$$__","_dispatch","type","Object","keys","map","key","actionTypes","reducer","apply","WRAPPER","setComputed","Error","_selector","selector","slice","computed"],"mappings":"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","sourcesContent":["/* eslint-disable func-names */\nimport produce from 'immer';\nimport { createSelector } from 'reselect';\nimport { event, Event } from '../usm';\nimport Module from './core/module';\n\ninterface ComputedFactory {\n  (target: Module, name: string, descriptor?: Descriptor<any>): any;\n}\ninterface StateFactory {\n  (target: Module, name: string, descriptor?: Descriptor<any>): any;\n}\ninterface Descriptor<T> extends TypedPropertyDescriptor<T> {\n  initializer(): T;\n}\n\nfunction createState(\n  target: Module,\n  name: string,\n  descriptor?: Descriptor<unknown>,\n) {\n  target._actionTypes = [...(target._actionTypes || []), name];\n  target._reducersMaps = {\n    ...(target._reducersMaps || {}),\n  };\n  target._initialValue = {\n    ...(target._initialValue || {}),\n  };\n  target._initialValue[name] =\n    descriptor && descriptor.initializer\n      ? descriptor.initializer.call(target)\n      : undefined;\n  const get = function(this: Module) {\n    return this._store ? this.state[name] : this._initialValue[name];\n  };\n  const set = function(this: Module, value: unknown) {\n    this.state[name] = value;\n  };\n  return {\n    enumerable: true,\n    configurable: true,\n    get,\n    set,\n  };\n}\n\nfunction action(\n  target: Module,\n  name: string,\n  descriptor: TypedPropertyDescriptor<any>,\n) {\n  const fn = descriptor.value;\n  descriptor.value = function(this: Module, ...args: []) {\n    const states = produce(this.state, (state: any) => {\n      this.__$$state$$__ = state;\n      fn.call(this, ...args);\n    });\n    this.__$$state$$__ = undefined;\n    this._dispatch({\n      type: Object.keys(this.state).map(\n        (key) => (this.actionTypes as Record<string, string>)[key],\n      ),\n      states,\n    });\n  };\n  return descriptor;\n}\n\nfunction reducer(\n  target: Module,\n  name: string,\n  descriptor: TypedPropertyDescriptor<any>,\n) {\n  const fn = descriptor.value;\n  descriptor.value = function(this: Module, ...args: []) {\n    const states = fn.apply(this, [...args, this.state]);\n    this._dispatch({\n      type: Object.keys(this.state).map(\n        (key) => (this.actionTypes as Record<string, string>)[key],\n      ),\n      states,\n    });\n  };\n  return descriptor;\n}\n\nconst WRAPPER = '__selectors__';\n\nfunction setComputed(\n  target: Module,\n  name: string,\n  descriptor?: Descriptor<any>,\n) {\n  if (descriptor && typeof descriptor.initializer !== 'function') {\n    throw new Error(\n      `${name} must be used in properties setter value with Array type`,\n    );\n  }\n  return {\n    configurable: true,\n    enumerable: true,\n    get<T extends Module>(this: T) {\n      if (!this[WRAPPER]) {\n        this[WRAPPER] = {};\n      }\n      if (!this[WRAPPER][name] && descriptor) {\n        const _selector = descriptor.initializer.call(this);\n        const selector = createSelector(\n          _selector.slice(0, -1),\n          _selector.slice(-1)[0],\n        );\n        this[WRAPPER][name] = () => selector(this.state);\n      }\n      return this[WRAPPER][name]();\n    },\n  };\n}\n\nconst state: StateFactory = createState;\nconst computed: ComputedFactory = setComputed;\n\nexport { Module as default, state, action, reducer, computed, event, Event };\n"],"file":"index.js"}