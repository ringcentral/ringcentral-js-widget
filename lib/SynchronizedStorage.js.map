{"version":3,"sources":["lib/SynchronizedStorage.js"],"names":["SynchronizedStorage","storageKey","Error","_storageKey","_id","uuid","v4","localStorage","window","_storageHandler","event","key","substring","length","JSON","parse","newValue","setter","value","id","emit","error","_localStorage","addEventListener","MemoryStorage","len","keys","i","push","output","getLocalStorageKeys","forEach","dataKey","getItem","undefined","setItem","stringify","removeItem","removeEventListener","EventEmitter"],"mappings":"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","sourcesContent":["import uuid from 'uuid';\nimport EventEmitter from 'events';\nimport MemoryStorage from './MemoryStorage';\n\n// TODO: experiment with a managed list of keys to watch rather than matching every event with\n// storageKey might provide better performance\n\nexport default class SynchronizedStorage extends EventEmitter {\n  constructor({ storageKey }) {\n    super();\n    if (!storageKey) {\n      throw Error('SynchronizedStorage must be created with a storage key');\n    }\n    this._storageKey = storageKey;\n    this._id = uuid.v4();\n    if (typeof localStorage !== 'undefined' && typeof window !== 'undefined') {\n      this._storageHandler = (event) => {\n        if (\n          event.key !== null &&\n          typeof event.key !== 'undefined' &&\n          event.key.substring(0, this._storageKey.length) === this._storageKey\n        ) {\n          try {\n            const { setter, value } = JSON.parse(event.newValue);\n            if (setter && setter !== this.id) {\n              const key = event.key.substring(this._storageKey.length + 1);\n              // fire storage event directly from the native event\n              // may reduce the chance of failing to get updated data\n              // if there is heavy localStorage load\n              this.emit('storage', {\n                key,\n                value,\n              });\n              // It seems that IE11 does not update the actual localStorage object\n              // in the same event cycle...\n              // setTimeout(() => {\n              //   this.emit('storage', {\n              //     key,\n              //     value: this.getItem(key),\n              //   });\n              // }, 0);\n            }\n          } catch (error) {\n            /* ignore error */\n          }\n        }\n      };\n      this._localStorage = localStorage;\n      window.addEventListener('storage', this._storageHandler);\n    } else {\n      this._localStorage = new MemoryStorage();\n    }\n  }\n\n  getLocalStorageKeys() {\n    const len = this._localStorage.length;\n    const keys = [];\n    for (let i = 0; i < len; i += 1) {\n      const key = this._localStorage.key(i);\n      if (key && key !== '') {\n        keys.push(key);\n      }\n    }\n    return keys;\n  }\n\n  getData() {\n    const output = {};\n    this.getLocalStorageKeys().forEach((key) => {\n      if (key.substring(0, this._storageKey.length) === this._storageKey) {\n        const dataKey = key.substring(this._storageKey.length + 1);\n        output[dataKey] = this.getItem(dataKey);\n      }\n    });\n    return output;\n  }\n\n  getItem(key) {\n    try {\n      const { value } = JSON.parse(\n        this._localStorage.getItem(`${this._storageKey}-${key}`),\n      );\n      return value;\n    } catch (error) {\n      return undefined;\n    }\n  }\n\n  setItem(key, value) {\n    this._localStorage.setItem(\n      `${this._storageKey}-${key}`,\n      JSON.stringify({\n        value,\n        setter: this.id,\n      }),\n    );\n  }\n\n  removeItem(key) {\n    this._localStorage.removeItem(`${this._storageKey}-${key}`);\n  }\n\n  destroy() {\n    if (this._storageHandler) {\n      window.removeEventListener('storage', this._storageHandler);\n    }\n  }\n\n  get id() {\n    return this._id;\n  }\n\n  get driver() {\n    if (this._localStorage === localStorage) {\n      return 'LOCALSTORAGE';\n    }\n    return 'MEMORYSTORAGE';\n  }\n}\n"],"file":"SynchronizedStorage.js"}