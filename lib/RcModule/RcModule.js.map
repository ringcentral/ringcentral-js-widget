{"version":3,"sources":["lib/RcModule/RcModule.ts"],"names":["ModuleStatus","onceKey","Symbol","onInitOnceKey","noReadyModulesKey","checkStatusChangeKey","enableCacheKey","enableGlobalCacheKey","storageKey","storageStateKey","globalStorageStateKey","spawnReducersKey","spawnStorageReducersKey","RcModuleV2","deps","enableCache","enableGlobalCache","options","_deps","_modulePath","_initialized","_suppressInit","_reducers","_getStateV2","state","key","onStateChange","storage","forEach","stateKey","globalStorage","status","onInitOnce","_shouldInit","_setStatus","Initializing","onInit","Ready","onInitSuccess","_shouldReset","Resetting","onReset","Pending","areAllReady","length","pending","areNotReady","ready","descriptors","descriptor","Object","getOwnPropertyDescriptor","initialState","value","storageReducerKey","registerReducer","reducer","action","_usm","usmAction","_state","data","assign","enumerable","configurable","get","stagedState","set","defineProperties","_initModule","storeKey","getState","identifierKey","keys","reduce","serviceReducersMapObject","stateDescriptor","parentModule","subscriptionsKey","subscribe","subModule","subRcModule","name","module","prototype","hasOwnProperty","call","Error","defineProperty","modulePath","modules","values","filter","store"],"mappings":"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","sourcesContent":["import { combineReducers, ReducersMapObject } from 'redux';\nimport {\n  state,\n  action,\n  subscribe,\n  computed,\n  createStore,\n  watch,\n  watchEffect,\n  Service,\n  storeKey,\n  identifierKey,\n  Action,\n  stateKey,\n  getStagedState,\n  enablePatches,\n  setPatchesToggle,\n  subscriptionsKey,\n  Subscription,\n  Store,\n  setAutoFreeze,\n  applyPatches,\n  usm as usmAction,\n  enableES5,\n} from '../usm-redux';\n\nsetAutoFreeze(false);\nsetPatchesToggle(true);\nenablePatches();\n\nexport const enum ModuleStatus {\n  Pending = 'PENDING',\n  Initializing = 'INITIALIZING',\n  Ready = 'READY',\n  Resetting = 'RESETTING',\n}\n\nexport const onceKey: unique symbol = Symbol('once');\nexport const onInitOnceKey: unique symbol = Symbol('onInitOnce');\nexport const noReadyModulesKey: unique symbol = Symbol('noReadyModules');\nexport const checkStatusChangeKey: unique symbol = Symbol('checkStatusChange');\nexport const enableCacheKey: unique symbol = Symbol('enableCache');\nexport const enableGlobalCacheKey: unique symbol = Symbol('enableGlobalCache');\nexport const storageKey: unique symbol = Symbol('storage');\nexport const storageStateKey: unique symbol = Symbol('storageState');\nexport const globalStorageStateKey: unique symbol = Symbol(\n  'globalStorageState',\n);\nexport const spawnReducersKey: unique symbol = Symbol('spawnReducers');\nexport const spawnStorageReducersKey: unique symbol = Symbol(\n  'spawnStorageReducers',\n);\n\nexport interface RcModuleOptions<T> {\n  deps?: T & {\n    storage?: any;\n    globalStorage?: any;\n  };\n  enableCache?: boolean;\n  enableGlobalCache?: boolean;\n  storageKey?: string;\n}\n\ninterface RcModuleV2 {\n  parentModule: RcModuleV2;\n  [storageStateKey]?: string[];\n  [globalStorageStateKey]?: string[];\n  [stateKey]: Record<string, any>;\n  [identifierKey]: string;\n  [subscriptionsKey]: Subscription[];\n  [storeKey]: Store;\n}\n\n// eslint-disable-next-line no-redeclare\nabstract class RcModuleV2<T = {}> {\n  private [onceKey] = false;\n\n  private [storageKey]: string;\n\n  private [enableCacheKey]: boolean;\n\n  private [enableGlobalCacheKey]: boolean;\n\n  protected initializeProxy?(): Promise<void> | void;\n  /**\n   * `onInit` life cycle for current initialization before all deps modules are all ready.\n   */\n  protected onInit?(): Promise<void> | void;\n  /**\n   * `onInitOnce` once life cycle for current initialization before all deps modules are all ready.\n   */\n  protected onInitOnce?(): Promise<void> | void;\n  /**\n   * `onInitSuccess` life cycle for current initialization after this module is ready.\n   */\n  protected onInitSuccess?(): Promise<void> | void;\n  /**\n   * `onReset` life cycle for current reset before one of deps modules is not ready.\n   */\n  protected onReset?(): Promise<void> | void;\n  /**\n   * Each Redux dispatch action will trigger `onStateChange` once.\n   */\n  protected onStateChange?(): Promise<void> | void;\n\n  protected _deps: T & { storage?: any; globalStorage?: any };\n\n  constructor({\n    deps,\n    enableCache = false,\n    enableGlobalCache = false,\n    ...options\n  }: RcModuleOptions<T> = {}) {\n    this._deps = deps;\n    this[storageKey] = options.storageKey;\n    this[enableCacheKey] = enableCache;\n    this[enableGlobalCacheKey] = enableGlobalCache;\n    subscribe(this, () => {\n      if (typeof this.onStateChange === 'function') {\n        this.onStateChange();\n      }\n      this[checkStatusChangeKey]();\n    });\n    if (\n      !this[storageStateKey] ||\n      !this[enableCacheKey] ||\n      !this._deps.storage\n    ) {\n      this[storageStateKey] = [];\n    }\n    this[storageStateKey].forEach((key) => delete this[stateKey][key]);\n    if (\n      !this[globalStorageStateKey] ||\n      !this[enableGlobalCacheKey] ||\n      !this._deps.globalStorage\n    ) {\n      this[globalStorageStateKey] = [];\n    }\n    this[globalStorageStateKey].forEach((key) => delete this[stateKey][key]);\n  }\n\n  @state\n  status = ModuleStatus.Pending;\n\n  @action\n  private _setStatus(status: ModuleStatus) {\n    this.status = status;\n  }\n\n  private async [onInitOnceKey]() {\n    if (!this[onceKey]) {\n      this[onceKey] = true;\n      if (typeof this.onInitOnce === 'function') {\n        await this.onInitOnce();\n      }\n    }\n  }\n\n  private async [checkStatusChangeKey]() {\n    if (this._shouldInit()) {\n      this._setStatus(ModuleStatus.Initializing);\n      await this[onInitOnceKey]();\n      if (typeof this.onInit === 'function') {\n        await this.onInit();\n      }\n      this._setStatus(ModuleStatus.Ready);\n      if (typeof this.onInitSuccess === 'function') {\n        await this.onInitSuccess();\n      }\n    } else if (this._shouldReset()) {\n      this._setStatus(ModuleStatus.Resetting);\n      if (typeof this.onReset === 'function') {\n        await this.onReset();\n      }\n      this._setStatus(ModuleStatus.Pending);\n    }\n  }\n\n  private get [noReadyModulesKey]() {\n    const modules = Object.values(this._deps || {}).filter(\n      // In order to be compatible with RcModuleV1\n      (module: RcModuleV2) => module && typeof module.ready !== 'undefined',\n    );\n    return modules.filter((module: RcModuleV2) => !module.ready);\n  }\n\n  _shouldInit() {\n    const areAllReady = this[noReadyModulesKey].length === 0;\n    return areAllReady && this.pending;\n  }\n\n  _shouldReset() {\n    const areNotReady = this[noReadyModulesKey].length > 0;\n    return areNotReady && this.ready;\n  }\n\n  get pending() {\n    return this.status === ModuleStatus.Pending;\n  }\n\n  get ready() {\n    return this.status === ModuleStatus.Ready;\n  }\n\n  get resetting() {\n    return this.status === ModuleStatus.Resetting;\n  }\n\n  get initializing() {\n    return this.status === ModuleStatus.Initializing;\n  }\n\n  get store() {\n    return this[storeKey];\n  }\n\n  private [spawnStorageReducersKey]() {\n    const descriptors: PropertyDescriptorMap = {};\n    /**\n     * make storage reducer and state\n     */\n    this[storageStateKey].forEach((key) => {\n      const descriptor = Object.getOwnPropertyDescriptor(this, key);\n      if (typeof descriptor === 'undefined') return;\n      const initialState = descriptor.value;\n      const storageReducerKey = `${this[storageKey]}-${key}`;\n      this._deps.storage.registerReducer({\n        key: storageReducerKey,\n        reducer: (state = initialState, action: Action) =>\n          action._usm === usmAction\n            ? this._getStateV2(action._state, 'storage').data[storageReducerKey]\n            : state,\n      });\n      Object.assign(descriptors, {\n        [key]: {\n          enumerable: true,\n          configurable: false,\n          get(this: Service) {\n            const stagedState: any = getStagedState();\n            return stagedState\n              ? this._getStateV2(stagedState, 'storage').data![\n                  storageReducerKey\n                ]\n              : this._deps.storage.data![storageReducerKey];\n          },\n          set(this: Service, value: unknown) {\n            const stagedState = getStagedState();\n            if (stagedState) {\n              this._getStateV2(stagedState, 'storage').data![\n                storageReducerKey\n              ] = value;\n              return;\n            }\n            this._deps.storage.data![storageReducerKey] = value;\n          },\n        },\n      });\n    });\n\n    /**\n     * make global storage reducer and state\n     */\n    this[globalStorageStateKey].forEach((key) => {\n      const descriptor = Object.getOwnPropertyDescriptor(this, key);\n      if (typeof descriptor === 'undefined') return;\n      const initialState = descriptor.value;\n      const storageReducerKey = `${this[storageKey]}-${key}`;\n      this._deps.globalStorage.registerReducer({\n        key: storageReducerKey,\n        reducer: (state = initialState, action: Action) =>\n          action._usm === usmAction\n            ? this._getStateV2(action._state, 'globalStorage').data[\n                storageReducerKey\n              ]\n            : state,\n      });\n      Object.assign(descriptors, {\n        [key]: {\n          enumerable: true,\n          configurable: false,\n          get(this: Service) {\n            const stagedState = getStagedState();\n            return stagedState\n              ? this._getStateV2(stagedState, 'globalStorage').data![\n                  storageReducerKey\n                ]\n              : this._deps.globalStorage.data![storageReducerKey];\n          },\n          set(this: Service, value: unknown) {\n            const stagedState = getStagedState();\n            if (stagedState) {\n              this._getStateV2(stagedState, 'globalStorage').data![\n                storageReducerKey\n              ] = value;\n              return;\n            }\n            this._deps.globalStorage.data![storageReducerKey] = value;\n          },\n        },\n      });\n    });\n\n    Object.defineProperties(this, descriptors);\n  }\n\n  // TODO: Refactor without RcModuleV1\n  // harmony with RcModule V1 for modules initialization\n\n  private _modulePath = 'root';\n\n  private _initialized = false;\n\n  private _suppressInit?: boolean;\n\n  protected _reducers: ReducersMapObject;\n\n  protected _getStateV2 = (state: Record<string, any>, key: string) =>\n    state[key];\n\n  private _setStore() {\n    return this._initModule();\n  }\n\n  get _store() {\n    return this.store;\n  }\n\n  private [spawnReducersKey]() {\n    const descriptors: PropertyDescriptorMap = {\n      [stateKey]: {\n        enumerable: false,\n        configurable: false,\n        get(this: Service) {\n          const stagedState = getStagedState();\n          return this._getStateV2(\n            stagedState ?? this[storeKey]?.getState(),\n            this[identifierKey],\n          );\n        },\n      },\n    };\n    this._reducers = Object.keys(this[stateKey] ?? {}).reduce(\n      (serviceReducersMapObject: ReducersMapObject, key) => {\n        const descriptor = Object.getOwnPropertyDescriptor(this, key);\n        if (typeof descriptor === 'undefined') return serviceReducersMapObject;\n        const initialState = descriptor.value;\n        Object.assign(descriptors, {\n          [key]: {\n            enumerable: true,\n            configurable: false,\n            get(this: Service) {\n              return this[stateKey][key];\n            },\n            set(this: Service, value: unknown) {\n              this[stateKey][key] = value;\n            },\n          },\n        });\n        return Object.assign(serviceReducersMapObject, {\n          [key]: (state = initialState, action: Action) =>\n            action._usm === usmAction\n              ? this._getStateV2(action._state, this[identifierKey])[key]\n              : state,\n        });\n      },\n      {},\n    );\n    const stateDescriptor = Object.getOwnPropertyDescriptor(this, stateKey);\n    if (stateDescriptor && typeof stateDescriptor.get === 'function') return;\n    Object.defineProperties(this, descriptors);\n  }\n\n  get reducer() {\n    if (this._reducers) return combineReducers(this._reducers);\n    this[spawnStorageReducersKey]();\n    this[spawnReducersKey]();\n    return combineReducers(this._reducers);\n  }\n\n  async _initModule() {\n    this._initialized = true;\n    if (\n      (this.parentModule && !(this.parentModule instanceof RcModuleV2)) ||\n      (!this.parentModule && !(this instanceof RcModuleV2))\n    ) {\n      for (const subscribe of this[subscriptionsKey] ?? []) {\n        subscribe();\n      }\n      this[subscriptionsKey] = [];\n    }\n    await this[checkStatusChangeKey]();\n    // eslint-disable-next-line guard-for-in\n    for (const subModule in this) {\n      const subRcModule = this[subModule] as any;\n      if (\n        subRcModule &&\n        typeof subRcModule._initModule === 'function' &&\n        !subRcModule._initialized &&\n        !subRcModule._suppressInit\n      ) {\n        subRcModule._initModule();\n      }\n    }\n  }\n\n  private get proxyReady() {\n    return this.ready;\n  }\n\n  private get modulePath() {\n    return this._modulePath;\n  }\n\n  private addModule(name: string, module: unknown) {\n    if (Object.prototype.hasOwnProperty.call(this, name)) {\n      throw new Error(`Property '${name}' already exists...`);\n    }\n    Object.defineProperty(this, name, {\n      get() {\n        return module;\n      },\n      enumerable: true,\n    });\n    if ((this as any)[name]._modulePath === 'root') {\n      (this as any)[name]._modulePath = `${this.modulePath}.${name}`;\n    }\n  }\n\n  private get state() {\n    return this[stateKey];\n  }\n\n  private actionTypes() {\n    return {};\n  }\n}\n\nexport {\n  RcModuleV2,\n  state,\n  action,\n  subscribe,\n  computed,\n  createStore,\n  watch,\n  watchEffect,\n  stateKey,\n  storeKey,\n  identifierKey,\n  applyPatches,\n  usmAction,\n  enableES5,\n  setAutoFreeze,\n};\n"],"file":"RcModule.js"}