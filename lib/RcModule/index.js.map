{"version":3,"sources":["lib/RcModule/index.ts"],"names":["defaultReducer","defaultGetState","store","getState","defaultGetProxyState","RcModule","deps","dep","optional","required","warn","options","_getState","_getProxyState","_prefix","_prefixedActionTypes","_reducer","_proxyReducer","_modulePath","_store","_suppressInit","_initialized","getProxyState","prefix","actionTypes","Object","entries","key","value","RcModuleV2","prototype","hasOwnProperty","call","parentModule","__key__","_actionTypes","Error","ObjectMap","prefixValues","name","module","defineProperty","get","enumerable","subRcModule","modulePath","_setStore","_initModule","subModule","subscribe","_onStateChange","initialize","initModule","status","moduleStatuses","ready","pending","proxyStatuses","proxyStatus","Injector","bootstrap","once"],"mappings":"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","sourcesContent":["import { Store } from 'redux';\nimport { ObjectMap } from '@ringcentral-integration/core/lib/ObjectMap';\nimport { RcModuleV2 } from '@ringcentral-integration/core';\nimport { Injector, Library } from '../di';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport proxyStatuses from '../../enums/proxyStatuses';\nimport once from '../once';\nimport required from '../required';\n\n/**\n * @function\n * @param {Object} state\n * @return {Object}\n * @description Default reducer if module does not has its own reducer.\n */\nfunction defaultReducer(): null {\n  return null;\n}\n\n/**\n * @function\n * @return any\n * @description Default getState function\n */\nfunction defaultGetState<S extends Record<string, any>>(this: RcModule): S {\n  return this.store.getState();\n}\n\nfunction defaultGetProxyState<S extends Record<string, any>>(): S {\n  return {} as any;\n}\n\nexport interface RcModuleOptions<S, T> {\n  prefix?: string;\n  getState?(): S;\n  getProxyState?(): S;\n  actionTypes?: T;\n  [P: string]: any;\n}\n\n/**\n * @class\n * @default\n * @description Base module class.\n */\n@Library({\n  deps: [{ dep: 'ModuleOptions', optional: true }],\n})\nexport default abstract class RcModule<\n  S extends Record<string, any> = Record<string, any>,\n  T extends object = Record<string, string>\n> {\n  private _getState: () => S;\n  private _getProxyState: () => S;\n  private _prefix: string;\n  private _prefixedActionTypes: any; // TODO: refactor with usm\n  public _reducer: any; // TODO: refactor with usm\n  public _proxyReducer: any; // TODO: refactor with usm\n  private _modulePath: string = 'root';\n  private _store?: Store;\n  public _suppressInit: boolean;\n  public _initialized: boolean;\n  /**\n   * @constructor\n   * @param {Function} options.getState\n   * @param {String} options.prefix\n   * @param {Enum} options.actionTypes\n   */\n  constructor(options: RcModuleOptions<S, T> = {}) {\n    const {\n      getState = defaultGetState,\n      getProxyState = defaultGetProxyState,\n      prefix,\n      actionTypes,\n    } = options;\n    for (const [key, value] of Object.entries(options)) {\n      if (\n        value instanceof RcModuleV2 &&\n        !Object.prototype.hasOwnProperty.call(value, 'parentModule')\n      ) {\n        value.parentModule = this as any;\n        value.__key__ = key;\n      }\n    }\n    const _actionTypes =\n      typeof actionTypes === 'undefined' ? this._actionTypes : actionTypes;\n    if (typeof getState !== 'function') {\n      throw new Error(\n        'The `getState` options property must be of type function',\n      );\n    }\n    this._getState = getState;\n    this._getProxyState = getProxyState;\n    if (prefix && typeof prefix !== 'string') {\n      throw new Error(\n        'The `prefix` options property must be null, undefined, or a string',\n      );\n    }\n    this._prefix = prefix;\n    this._prefixedActionTypes =\n      _actionTypes && ObjectMap.prefixValues(_actionTypes, prefix);\n    this._reducer = defaultReducer;\n    this._proxyReducer = defaultReducer;\n  }\n\n  get _actionTypes(): any {\n    /* should be implemented by descendant */\n    return null;\n  }\n\n  /**\n   * @property\n   * @type any\n   * @description The state of the module\n   */\n  get state() {\n    return this._getState();\n  }\n\n  get proxyState() {\n    return this._getProxyState();\n  }\n\n  /**\n   * @property\n   * @type Function\n   * @description The reducer function of the module\n   */\n  get reducer() {\n    return this._reducer;\n  }\n\n  get proxyReducer() {\n    return this._proxyReducer;\n  }\n\n  /**\n   * @property\n   * @type Object\n   * @description The store object of the module\n   */\n  get store() {\n    if (!this._store) {\n      throw new Error('module has not been initialized...');\n    }\n    return this._store;\n  }\n\n  /**\n   * @property\n   * @type String\n   * @description The prefix string of this module\n   */\n  get prefix() {\n    return this._prefix;\n  }\n\n  /**\n   * @property\n   * @type Enum\n   * @description The actionTypes used by the module\n   */\n  get actionTypes(): { [V in keyof T]: string } {\n    return this._prefixedActionTypes;\n  }\n\n  /**\n   * @property\n   * @type String\n   * @description The canonical path of the module from the root module\n   */\n  get modulePath() {\n    return this._modulePath;\n  }\n\n  /**\n   * @function addModule\n   * @param {String} name - Name of the module. Also used for the property name.\n   * @param {any} module - The module to be attached, can be any type.\n   * @description Add the desired module to the\n   */\n  addModule<T extends RcModule, K extends keyof T>(\n    this: T,\n    name: K,\n    module: RcModule,\n  ) {\n    if (Object.prototype.hasOwnProperty.call(this, name)) {\n      throw new Error(`Property '${name}' already exists...`);\n    }\n    Object.defineProperty(this, name, {\n      get() {\n        return module;\n      },\n      enumerable: true,\n    });\n    // tag submodule with a modulePath for proxying function calls\n    // do nothing if module is already tagged\n    const subRcModule: RcModule = this[name] as any;\n    if (subRcModule._modulePath === 'root') {\n      subRcModule._modulePath = `${this.modulePath}.${name}`;\n    }\n  }\n\n  /**\n   * @function\n   * @param {Object} store\n   * @description Set the store to the modules and initialize the modules.\n   *   This should only be called once.\n   */\n  setStore(store: Store) {\n    if (this._modulePath !== 'root') {\n      throw new Error('setStore should only be called on root module');\n    }\n    if (!store) {\n      throw new Error('setStore must accept a store object');\n    }\n    if (this._store) {\n      throw new Error('setStore should only be called once');\n    }\n    this._setStore(store);\n    this._initModule();\n  }\n\n  _setStore(store: Store) {\n    this._store = store;\n    for (const subModule in this) {\n      if (\n        Object.prototype.hasOwnProperty.call(this, subModule) &&\n        this[subModule] instanceof RcModule\n      ) {\n        const subRcModule: RcModule = this[subModule] as any;\n        subRcModule._setStore(store);\n      }\n    }\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  @once\n  @required.warn\n  _onStateChange() {}\n\n  _initModule() {\n    if (!this._suppressInit) {\n      if (!this._initialized) {\n        this._initialized = true;\n        this.initialize();\n      }\n      for (const subModule in this) {\n        if (\n          Object.prototype.hasOwnProperty.call(this, subModule) &&\n          this[subModule] instanceof RcModule\n        ) {\n          const subRcModule: RcModule = this[subModule] as any;\n          subRcModule._initModule();\n        } else if (\n          Object.prototype.hasOwnProperty.call(this, subModule) &&\n          this[subModule] instanceof RcModuleV2 &&\n          !((this[subModule] as any) as RcModuleV2)._initialized &&\n          !((this[subModule] as any) as RcModuleV2)._suppressInit\n        ) {\n          const subRcModule: RcModuleV2 = this[subModule] as any;\n          subRcModule._initialized = true;\n          subRcModule.initModule();\n        }\n      }\n    }\n  }\n\n  static create() {\n    return Injector.bootstrap(this);\n  }\n\n  /**\n   * Represents for module status, should be implemented by child class.\n   */\n  abstract get status(): string;\n\n  get ready() {\n    return this.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.status === moduleStatuses.pending;\n  }\n\n  get proxyStatus() {\n    return proxyStatuses.ready;\n  }\n\n  get proxyReady() {\n    return this.proxyStatus === proxyStatuses.ready;\n  }\n\n  get proxyPending() {\n    return this.proxyStatus === proxyStatuses.pending;\n  }\n}\n"],"file":"index.js"}