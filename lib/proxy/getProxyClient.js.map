{"version":3,"sources":["lib/proxy/getProxyClient.js"],"names":["defaultVerifyModuleFunc","module","RcModule","getProxyClient","createTarget","verifyModuleFunc","transport","options","actionTypes","baseActionTypes","_id","uuid","v4","_target","_getState","state","target","_getProxyState","proxy","_transport","ensureExist","_setTransport","subModule","Object","prototype","hasOwnProperty","defineProperty","configurable","enumerable","get","_reducer","targetReducer","reducer","proxyReducer","types","_proxyActionTypes","_suppressInit","request","payload","type","sync","actionNumber","result","store","dispatch","_syncPromise","_sync","initializeProxy","_proxyInitialized","_initialize","on","events","push","action"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,uBAAuB,GAAG,SAA1BA,uBAA0B,CAACC,MAAD;AAAA,SAAYA,MAAM,YAAYC,qBAA9B;AAAA,CAAhC;;AAEe,SAASC,cAAT,CACbC,YADa,EAGb;AAAA,MADAC,gBACA,uEADmBL,uBACnB;AACA;AAAA;AAAA;AAAA;;AACE,4BAAuC;AAAA;;AAAA;;AAAA,YAAzBM,SAAyB,QAAzBA,SAAyB;AAAA,YAAXC,OAAW;;AAAA;;AACrC,sGACKA,OADL;AAEEC,UAAAA,WAAW,EAAEC;AAFf;AAIA,cAAKC,GAAL,GAAWC,iBAAKC,EAAL,EAAX;AACA,cAAKC,OAAL,GAAeT,YAAY,mBACtBG,OADsB,EAA3B;;AAGA,cAAKM,OAAL,CAAaC,SAAb,GAAyB;AAAA,iBAAM,MAAKC,KAAL,CAAWC,MAAjB;AAAA,SAAzB;;AACA,cAAKH,OAAL,CAAaI,cAAb,GAA8B;AAAA,iBAAM,MAAKF,KAAL,CAAWG,KAAjB;AAAA,SAA9B,CAVqC,CAWrC;AACA;AACA;AACA;AACA;;;AACA,cAAKC,UAAL,GAAkB,2CAAMC,uBAAN,iBAAkBd,SAAlB,EAA6B,WAA7B,CAAlB;;AACA,cAAKe,aAAL,CAAmB,MAAKR,OAAxB;;AAjBqC,mCAkB1BS,SAlB0B;AAAA;;AAmBnC,cACE,mBAAKT,OAAL,EAAcU,MAAM,CAACC,SAAP,CAAiBC,cAA/B,kBAA8CH,SAA9C,KACAjB,gBAAgB,CAAC,MAAKQ,OAAL,CAAaS,SAAb,CAAD,CAFlB,EAGE;AACAC,YAAAA,MAAM,CAACG,cAAP,gCAA4BJ,SAA5B,EAAuC;AACrCK,cAAAA,YAAY,EAAE,KADuB;AAErCC,cAAAA,UAAU,EAAE,IAFyB;AAGrCC,cAAAA,GAHqC,iBAG/B;AACJ,uBAAO,KAAKhB,OAAL,CAAaS,SAAb,CAAP;AACD;AALoC,aAAvC;AAOD;AA9BkC;;AAkBrC,aAAK,IAAMA,SAAX,IAAwB,MAAKT,OAA7B,EAAsC;AAAA,gBAA3BS,SAA2B;AAarC;;AAED,cAAKQ,QAAL,GAAgB,uCAAsB;AACpCC,UAAAA,aAAa,EAAE,MAAKlB,OAAL,CAAamB,OADQ;AAEpCC,UAAAA,YAAY,EAAE,MAAKpB,OAAL,CAAaoB,YAFS;AAGpC3B,UAAAA,SAAS,EAATA,SAHoC;AAIpC4B,UAAAA,KAAK,EAAE,MAAK1B;AAJwB,SAAtB,CAAhB;AAjCqC;AAuCtC;;AAxCH;AAAA;AAAA,sCA0CgBQ,MA1ChB,EA0CwB;AACpBA,UAAAA,MAAM,CAACG,UAAP,GAAoB,KAAKA,UAAzB;AACAH,UAAAA,MAAM,CAACmB,iBAAP,GAA2B,KAAK3B,WAAhC;AACAQ,UAAAA,MAAM,CAACoB,aAAP,GAAuB,IAAvB;;AACA,eAAK,IAAMd,SAAX,IAAwBN,MAAxB,EAAgC;AAC9B,gBACUO,MAAM,CAACC,SAAP,CAAiBC,cAAzB,MAAAT,MAAM,EAAkCM,SAAlC,CAAN,IACAjB,gBAAgB,CAACW,MAAM,CAACM,SAAD,CAAP,CAFlB,EAGE;AACAN,cAAAA,MAAM,CAACM,SAAD,CAAN,CAAkBH,UAAlB,GAA+B,KAAKA,UAApC;AACAH,cAAAA,MAAM,CAACM,SAAD,CAAN,CAAkBa,iBAAlB,GAAsC,KAAK3B,WAA3C;AACAQ,cAAAA,MAAM,CAACM,SAAD,CAAN,CAAkBc,aAAlB,GAAkC,IAAlC;AACD;AACF;AACF;AAxDH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kDA4D2B,KAAKjB,UAAL,CAAgBkB,OAAhB,CAAwB;AAC3CC,oBAAAA,OAAO,EAAE;AACPC,sBAAAA,IAAI,EAAE,KAAK/B,WAAL,CAAiBgC,IADhB;AAEPC,sBAAAA,YAAY,EAAE,KAAK1B,KAAL,CAAW0B;AAFlB;AADkC,mBAAxB,CA5D3B;;AAAA;AA4DYC,kBAAAA,MA5DZ;AAkEM,uBAAKC,KAAL,CAAWC,QAAX,mBACKF,MADL;AAEEH,oBAAAA,IAAI,EAAE,KAAK/B,WAAL,CAAiBgC;AAFzB;AAlEN;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAyEI,uBAAKK,YAAL,GAAoB,IAApB;;AAzEJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BA2ES;AACL,cAAI,CAAC,KAAKA,YAAV,EAAwB;AACtB,iBAAKA,YAAL,GAAoB,KAAKC,KAAL,EAApB;AACD;;AACD,iBAAO,KAAKD,YAAZ;AACD;AAhFH;AAAA;AAAA,oCAkFc7B,MAlFd,EAkFsB;AAClB,cACE,OAAOA,MAAM,CAAC+B,eAAd,KAAkC,UAAlC,IACA,CAAC/B,MAAM,CAACgC,iBAFV,EAGE;AACAhC,YAAAA,MAAM,CAACgC,iBAAP,GAA2B,IAA3B;AACAhC,YAAAA,MAAM,CAAC+B,eAAP;AACD;;AACD,eAAK,IAAMzB,SAAX,IAAwBN,MAAxB,EAAgC;AAC9B,gBACUO,MAAM,CAACC,SAAP,CAAiBC,cAAzB,MAAAT,MAAM,EAAkCM,SAAlC,CAAN,IACAjB,gBAAgB,CAACW,MAAM,CAACM,SAAD,CAAP,CADhB,IAEA,OAAON,MAAM,CAACM,SAAD,CAAN,CAAkByB,eAAzB,KAA6C,UAF7C,IAGA,CAAC/B,MAAM,CAACM,SAAD,CAAN,CAAkB0B,iBAJrB,EAKE;AACAhC,cAAAA,MAAM,CAACM,SAAD,CAAN,CAAkB0B,iBAAlB,GAAsC,IAAtC;AACAhC,cAAAA,MAAM,CAACM,SAAD,CAAN,CAAkByB,eAAlB;AACD;AACF;AACF;AArGH;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAuGI;AACA;AACA,uBAAKE,WAAL,CAAiB,KAAKpC,OAAtB;;AACA,uBAAKM,UAAL,CAAgB+B,EAAhB,CAAmB,KAAK/B,UAAL,CAAgBgC,MAAhB,CAAuBC,IAA1C,EAAgD,iBAAOd,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA,kCAC1CA,OAAO,CAACC,IAAR,KAAiB,MAAI,CAAC/B,WAAL,CAAiB6C,MADQ;AAAA;AAAA;AAAA;;AAAA,iCAExC,MAAI,CAACR,YAFmC;AAAA;AAAA;AAAA;;AAAA;AAAA,4DAEf,MAAI,CAACA,YAFU;;AAAA;AAAA,kCAGxCP,OAAO,CAACG,YAAR,KAAyB,MAAI,CAAC1B,KAAL,CAAW0B,YAAX,GAA0B,CAHX;AAAA;AAAA;AAAA;;AAI1C,4BAAA,MAAI,CAACE,KAAL,CAAWC,QAAX,mBACKN,OADL;AAEEC,8BAAAA,IAAI,EAAE,MAAI,CAAC/B,WAAL,CAAiB6C;AAFzB;;AAJ0C;AAAA;;AAAA;AAAA;AAAA,4DASpC,MAAI,CAACb,IAAL,EAToC;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAhD;;AA1GJ;AAAA,kDAuHU,KAAKA,IAAL,EAvHV;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA,MAAqBtC,qBAArB;AAAA;AA0HD","sourcesContent":["import uuid from 'uuid';\nimport RcModule from '../RcModule';\nimport getProxyClientReducer from './getProxyClientReducer';\nimport baseActionTypes from './baseActionTypes';\nimport ensureExist from '../ensureExist';\n\nconst defaultVerifyModuleFunc = (module) => module instanceof RcModule;\n\nexport default function getProxyClient(\n  createTarget,\n  verifyModuleFunc = defaultVerifyModuleFunc,\n) {\n  return class extends RcModule {\n    constructor({ transport, ...options }) {\n      super({\n        ...options,\n        actionTypes: baseActionTypes,\n      });\n      this._id = uuid.v4();\n      this._target = createTarget({\n        ...options,\n      });\n      this._target._getState = () => this.state.target;\n      this._target._getProxyState = () => this.state.proxy;\n      // this._target = new Target({\n      //   ...options,\n      //   getState: () => this.state.target,\n      //   getProxyState: () => this.state.proxy,\n      // });\n      this._transport = this::ensureExist(transport, 'transport');\n      this._setTransport(this._target);\n      for (const subModule in this._target) {\n        if (\n          this._target::Object.prototype.hasOwnProperty(subModule) &&\n          verifyModuleFunc(this._target[subModule])\n        ) {\n          Object.defineProperty(this, subModule, {\n            configurable: false,\n            enumerable: true,\n            get() {\n              return this._target[subModule];\n            },\n          });\n        }\n      }\n\n      this._reducer = getProxyClientReducer({\n        targetReducer: this._target.reducer,\n        proxyReducer: this._target.proxyReducer,\n        transport,\n        types: this.actionTypes,\n      });\n    }\n\n    _setTransport(target) {\n      target._transport = this._transport;\n      target._proxyActionTypes = this.actionTypes;\n      target._suppressInit = true;\n      for (const subModule in target) {\n        if (\n          target::Object.prototype.hasOwnProperty(subModule) &&\n          verifyModuleFunc(target[subModule])\n        ) {\n          target[subModule]._transport = this._transport;\n          target[subModule]._proxyActionTypes = this.actionTypes;\n          target[subModule]._suppressInit = true;\n        }\n      }\n    }\n\n    async _sync() {\n      try {\n        const result = await this._transport.request({\n          payload: {\n            type: this.actionTypes.sync,\n            actionNumber: this.state.actionNumber,\n          },\n        });\n        this.store.dispatch({\n          ...result,\n          type: this.actionTypes.sync,\n        });\n      } catch (_) {\n        /* Ignore */\n      }\n      this._syncPromise = null;\n    }\n    sync() {\n      if (!this._syncPromise) {\n        this._syncPromise = this._sync();\n      }\n      return this._syncPromise;\n    }\n\n    _initialize(target) {\n      if (\n        typeof target.initializeProxy === 'function' &&\n        !target._proxyInitialized\n      ) {\n        target._proxyInitialized = true;\n        target.initializeProxy();\n      }\n      for (const subModule in target) {\n        if (\n          target::Object.prototype.hasOwnProperty(subModule) &&\n          verifyModuleFunc(target[subModule]) &&\n          typeof target[subModule].initializeProxy === 'function' &&\n          !target[subModule]._proxyInitialized\n        ) {\n          target[subModule]._proxyInitialized = true;\n          target[subModule].initializeProxy();\n        }\n      }\n    }\n    async initialize() {\n      // initialize the instance before sync to avoid history object from\n      // becoming out of sync\n      this._initialize(this._target);\n      this._transport.on(this._transport.events.push, async (payload) => {\n        if (payload.type === this.actionTypes.action) {\n          if (this._syncPromise) await this._syncPromise;\n          if (payload.actionNumber === this.state.actionNumber + 1) {\n            this.store.dispatch({\n              ...payload,\n              type: this.actionTypes.action,\n            });\n          } else {\n            await this.sync();\n          }\n        }\n      });\n      await this.sync();\n    }\n  };\n}\n"],"file":"getProxyClient.js"}