{"version":3,"sources":["lib/proxy/getProxyClient.js"],"names":["defaultVerifyModuleFunc","module","RcModule","getProxyClient","createTarget","verifyModuleFunc","transport","options","actionTypes","baseActionTypes","_id","uuid","v4","_target","__proxyAction__","action","_getState","state","target","_getProxyState","proxy","_transport","ensureExist","call","_setTransport","subModule","Object","prototype","hasOwnProperty","defineProperty","configurable","enumerable","get","_reducer","targetReducer","reducer","proxyReducer","types","_proxyActionTypes","_suppressInit","request","payload","type","sync","actionNumber","result","store","dispatch","_syncPromise","_sync","initializeProxy","_proxyInitialized","_initialize","on","events","push"],"mappings":"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","sourcesContent":["import * as uuid from 'uuid';\nimport RcModule from '../RcModule';\nimport getProxyClientReducer from './getProxyClientReducer';\nimport baseActionTypes from './baseActionTypes';\nimport ensureExist from '../ensureExist';\nimport { pushStates } from './handleProxyAction';\n\nconst defaultVerifyModuleFunc = (module) => module instanceof RcModule;\n\nexport default function getProxyClient(\n  createTarget,\n  verifyModuleFunc = defaultVerifyModuleFunc,\n) {\n  return class extends RcModule {\n    constructor({ transport, ...options }) {\n      super({\n        ...options,\n        actionTypes: baseActionTypes,\n      });\n      this._id = uuid.v4();\n      this._target = createTarget({\n        ...options,\n      });\n      // Used by client to dispatch action.\n      this._target.__proxyAction__ = this.actionTypes.action;\n      this._target._getState = () => this.state.target;\n      this._target._getProxyState = () => this.state.proxy;\n      // this._target = new Target({\n      //   ...options,\n      //   getState: () => this.state.target,\n      //   getProxyState: () => this.state.proxy,\n      // });\n      this._transport = ensureExist.call(this, transport, 'transport');\n      this._setTransport(this._target);\n      for (const subModule in this._target) {\n        if (\n          Object.prototype.hasOwnProperty.call(this._target, subModule) &&\n          verifyModuleFunc(this._target[subModule])\n        ) {\n          Object.defineProperty(this, subModule, {\n            configurable: false,\n            enumerable: true,\n            get() {\n              return this._target[subModule];\n            },\n          });\n        }\n      }\n\n      this._reducer = getProxyClientReducer({\n        targetReducer: this._target.reducer,\n        proxyReducer: this._target.proxyReducer,\n        transport,\n        types: this.actionTypes,\n      });\n    }\n\n    _setTransport(target) {\n      target._transport = this._transport;\n      target._proxyActionTypes = this.actionTypes;\n      target._suppressInit = true;\n      for (const subModule in target) {\n        if (\n          Object.prototype.hasOwnProperty.call(target, subModule) &&\n          verifyModuleFunc(target[subModule])\n        ) {\n          target[subModule]._transport = this._transport;\n          target[subModule]._proxyActionTypes = this.actionTypes;\n          target[subModule]._suppressInit = true;\n        }\n      }\n    }\n\n    async _sync() {\n      try {\n        const result = await this._transport.request({\n          payload: {\n            type: this.actionTypes.sync,\n            actionNumber: this.state.actionNumber,\n          },\n        });\n        this.store.dispatch({\n          ...result,\n          type: this.actionTypes.sync,\n        });\n      } catch (_) {\n        /* Ignore */\n      }\n      this._syncPromise = null;\n    }\n\n    sync() {\n      if (!this._syncPromise) {\n        this._syncPromise = this._sync();\n      }\n      return this._syncPromise;\n    }\n\n    _initialize(target) {\n      if (\n        typeof target.initializeProxy === 'function' &&\n        !target._proxyInitialized\n      ) {\n        target._proxyInitialized = true;\n        target.initializeProxy();\n      }\n      for (const subModule in target) {\n        if (\n          Object.prototype.hasOwnProperty.call(target, subModule) &&\n          verifyModuleFunc(target[subModule]) &&\n          typeof target[subModule].initializeProxy === 'function' &&\n          !target[subModule]._proxyInitialized\n        ) {\n          target[subModule]._proxyInitialized = true;\n          target[subModule].initializeProxy();\n        }\n      }\n    }\n\n    async initialize() {\n      // initialize the instance before sync to avoid history object from\n      // becoming out of sync\n      this._initialize(this._target);\n      this._transport.on(this._transport.events.push, async (payload) => {\n        if (payload.type === this.actionTypes.action) {\n          if (this._syncPromise) await this._syncPromise;\n          if (payload.actionNumber === this.state.actionNumber + 1) {\n            const action = pushStates(this._target, payload.action);\n            this.store.dispatch({\n              ...payload,\n              action,\n              type: this.actionTypes.action,\n            });\n          } else {\n            await this.sync();\n          }\n        }\n      });\n      await this.sync();\n    }\n  };\n}\n"],"file":"getProxyClient.js"}