{"version":3,"sources":["lib/proxy/getProxyClient.js"],"names":["defaultVerifyModuleFunc","module","RcModule","getProxyClient","createTarget","verifyModuleFunc","transport","options","actionTypes","baseActionTypes","_id","uuid","v4","_target","_getState","state","target","_getProxyState","proxy","_transport","ensureExist","call","_setTransport","subModule","Object","prototype","hasOwnProperty","defineProperty","configurable","enumerable","get","_reducer","targetReducer","reducer","proxyReducer","types","_proxyActionTypes","_suppressInit","request","payload","type","sync","actionNumber","result","store","dispatch","_syncPromise","_sync","initializeProxy","_proxyInitialized","_initialize","on","events","push","action"],"mappings":"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","sourcesContent":["import uuid from 'uuid';\nimport RcModule from '../RcModule';\nimport getProxyClientReducer from './getProxyClientReducer';\nimport baseActionTypes from './baseActionTypes';\nimport ensureExist from '../ensureExist';\n\nconst defaultVerifyModuleFunc = (module) => module instanceof RcModule;\n\nexport default function getProxyClient(\n  createTarget,\n  verifyModuleFunc = defaultVerifyModuleFunc,\n) {\n  return class extends RcModule {\n    constructor({ transport, ...options }) {\n      super({\n        ...options,\n        actionTypes: baseActionTypes,\n      });\n      this._id = uuid.v4();\n      this._target = createTarget({\n        ...options,\n      });\n      this._target._getState = () => this.state.target;\n      this._target._getProxyState = () => this.state.proxy;\n      // this._target = new Target({\n      //   ...options,\n      //   getState: () => this.state.target,\n      //   getProxyState: () => this.state.proxy,\n      // });\n      this._transport = ensureExist.call(this, transport, 'transport');\n      this._setTransport(this._target);\n      for (const subModule in this._target) {\n        if (\n          Object.prototype.hasOwnProperty.call(this._target, subModule) &&\n          verifyModuleFunc(this._target[subModule])\n        ) {\n          Object.defineProperty(this, subModule, {\n            configurable: false,\n            enumerable: true,\n            get() {\n              return this._target[subModule];\n            },\n          });\n        }\n      }\n\n      this._reducer = getProxyClientReducer({\n        targetReducer: this._target.reducer,\n        proxyReducer: this._target.proxyReducer,\n        transport,\n        types: this.actionTypes,\n      });\n    }\n\n    _setTransport(target) {\n      target._transport = this._transport;\n      target._proxyActionTypes = this.actionTypes;\n      target._suppressInit = true;\n      for (const subModule in target) {\n        if (\n          Object.prototype.hasOwnProperty.call(target, subModule) &&\n          verifyModuleFunc(target[subModule])\n        ) {\n          target[subModule]._transport = this._transport;\n          target[subModule]._proxyActionTypes = this.actionTypes;\n          target[subModule]._suppressInit = true;\n        }\n      }\n    }\n\n    async _sync() {\n      try {\n        const result = await this._transport.request({\n          payload: {\n            type: this.actionTypes.sync,\n            actionNumber: this.state.actionNumber,\n          },\n        });\n        this.store.dispatch({\n          ...result,\n          type: this.actionTypes.sync,\n        });\n      } catch (_) {\n        /* Ignore */\n      }\n      this._syncPromise = null;\n    }\n\n    sync() {\n      if (!this._syncPromise) {\n        this._syncPromise = this._sync();\n      }\n      return this._syncPromise;\n    }\n\n    _initialize(target) {\n      if (\n        typeof target.initializeProxy === 'function' &&\n        !target._proxyInitialized\n      ) {\n        target._proxyInitialized = true;\n        target.initializeProxy();\n      }\n      for (const subModule in target) {\n        if (\n          Object.prototype.hasOwnProperty.call(target, subModule) &&\n          verifyModuleFunc(target[subModule]) &&\n          typeof target[subModule].initializeProxy === 'function' &&\n          !target[subModule]._proxyInitialized\n        ) {\n          target[subModule]._proxyInitialized = true;\n          target[subModule].initializeProxy();\n        }\n      }\n    }\n\n    async initialize() {\n      // initialize the instance before sync to avoid history object from\n      // becoming out of sync\n      this._initialize(this._target);\n      this._transport.on(this._transport.events.push, async (payload) => {\n        if (payload.type === this.actionTypes.action) {\n          if (this._syncPromise) await this._syncPromise;\n          if (payload.actionNumber === this.state.actionNumber + 1) {\n            this.store.dispatch({\n              ...payload,\n              type: this.actionTypes.action,\n            });\n          } else {\n            await this.sync();\n          }\n        }\n      });\n      await this.sync();\n    }\n  };\n}\n"],"file":"getProxyClient.js"}